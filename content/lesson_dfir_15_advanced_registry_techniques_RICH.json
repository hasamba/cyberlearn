{
  "lesson_id": "f2d8b5a1-4e7c-4b3f-9a2d-6e8f1c3a7b9d",
  "domain": "dfir",
  "title": "Advanced Registry Analysis and Timeline Forensics",
  "difficulty": 3,
  "order_index": 15,
  "prerequisites": [
    "11f8e2a3-9b4c-4d7e-8f1a-2c5b6e9d3a7f",
    "a7f3c9d2-8e5b-4a1f-9c3d-7b2e6f8a4d1c"
  ],
  "concepts": [
    "Registry Transaction Logs",
    "Deleted Key Recovery",
    "Last Write Time Analysis",
    "RegRipper Automation",
    "Registry Timeline Generation",
    "Hive Reconstruction",
    "Volume Shadow Copy Analysis",
    "RECmd Batch Processing",
    "Registry Diff Analysis",
    "Forensic Reporting"
  ],
  "estimated_time": 50,
  "learning_objectives": [
    "Extract and analyze Registry transaction logs for deleted key recovery",
    "Use Volume Shadow Copies to track Registry changes over time",
    "Generate comprehensive Registry timelines using RegRipper and RECmd",
    "Perform Registry diff analysis to identify unauthorized modifications",
    "Reconstruct deleted Registry artifacts using transaction logs",
    "Automate Registry forensics workflows with batch processing",
    "Correlate Registry timestamps with other forensic artifacts",
    "Identify timestomping and anti-forensics in Registry data",
    "Create professional forensic reports from Registry analysis",
    "Apply advanced techniques to APT and insider threat investigations"
  ],
  "post_assessment": [
    {
      "question_id": "q15_1",
      "type": "multiple_choice",
      "difficulty": 3,
      "question": "An attacker deleted USBSTOR Registry keys to hide device usage. You find SYSTEM.LOG1 and SYSTEM.LOG2 transaction logs. What is the MOST reliable method to recover the deleted keys?",
      "options": [
        "Parse transaction logs manually with a hex editor",
        "Use Volume Shadow Copies to restore a previous version of the SYSTEM hive",
        "Run RegRipper plugins on the transaction log files directly",
        "Check setupapi.dev.log as an alternative artifact"
      ],
      "correct_answer": 1,
      "explanation": "Volume Shadow Copies provide the most reliable recovery method because they contain complete snapshots of the SYSTEM hive from previous points in time. While transaction logs (LOG1/LOG2) contain uncommitted changes, they require complex parsing and may be incomplete. VSS snapshots are fully formed Registry hives that can be analyzed with standard tools like Registry Explorer. Option D (setupapi.dev.log) is a good backup artifact but doesn't recover the actual Registry keys—it only shows device installation events."
    },
    {
      "question_id": "q15_2",
      "type": "multiple_choice",
      "difficulty": 3,
      "question": "You're performing Registry diff analysis between two timeframes. You notice a new Run key entry: `HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\SecurityUpdate = C:\\Users\\Public\\svchost.exe`. The Last Write Time of the Run key is 2024-03-15 14:32:18. What does this MOST likely indicate?",
      "options": [
        "Legitimate Windows update created a new service",
        "User manually added a startup program",
        "Malware persistence mechanism (suspicious executable path and name)",
        "Scheduled task created this entry automatically"
      ],
      "correct_answer": 2,
      "explanation": "This is a classic malware persistence indicator. Red flags: (1) Executable named 'svchost.exe' (mimicking legitimate Windows process) but located in C:\\Users\\Public\\ instead of C:\\Windows\\System32\\, (2) Run key name 'SecurityUpdate' designed to look benign, (3) Users\\Public is a common malware staging location with write permissions. Legitimate Windows updates don't create Run key entries, and legitimate svchost.exe only exists in System32\\. The Last Write Time (14:32:18) would correlate with infection timestamp—check other artifacts (Prefetch, MFT, AmCache) at this time to identify the infection vector."
    },
    {
      "question_id": "q15_3",
      "type": "multiple_choice",
      "difficulty": 3,
      "question": "During timeline analysis, you notice the NTUSER.DAT hive's Last Write Time is 2024-03-20 09:15:00, but the newest Registry key modification inside the hive is 2024-03-18 16:30:00 (2 days earlier). What is the MOST likely explanation?",
      "options": [
        "The system clock was changed between March 18 and March 20",
        "Volume Shadow Copy restoration occurred on March 20",
        "Registry hive was timestomped by an attacker",
        "Normal behavior—hive file timestamp doesn't always match key modifications"
      ],
      "correct_answer": 1,
      "explanation": "This pattern strongly suggests Volume Shadow Copy restoration. When a VSS snapshot is restored, the hive FILE timestamp reflects the restoration time (March 20, 09:15), but the Registry KEY timestamps inside remain from the original snapshot timeframe (March 18 or earlier). This is forensically significant because: (1) Someone deliberately restored a previous version of the user profile (possibly to remove evidence), (2) Any Registry changes between March 18-20 are now lost, (3) Correlation with other artifacts will show timeline gaps. To investigate: Check VSS logs (Event ID 8224), look for vssadmin commands in PowerShell logs, compare with other users' NTUSER.DAT timestamps to see if only this user was restored."
    },
    {
      "question_id": "q15_4",
      "type": "scenario",
      "difficulty": 3,
      "question": "You're investigating an APT intrusion. RegRipper timeline shows 47 new Registry modifications in a 3-minute window (14:22:15-14:25:18) across multiple hives (SYSTEM, SOFTWARE, SAM). Changes include: new service installations, modified firewall rules, new user accounts, and RDP configuration changes. What is your IMMEDIATE next investigative step?",
      "options": [
        "Search for malware samples in common directories (Temp, AppData)",
        "Check Prefetch for executables run during 14:22-14:25 timeframe",
        "Examine network logs for connections during this window",
        "Review all 47 Registry changes manually to understand each modification"
      ],
      "correct_answer": 1,
      "explanation": "The 3-minute burst of 47 Registry modifications indicates automated tool execution (post-exploitation framework like Cobalt Strike, Metasploit, or custom implant). Immediately check Prefetch for executables run during 14:22-14:25 because: (1) Prefetch timestamps show EXACTLY which programs ran during this window, (2) Common attacker tools (psexec.exe, wmic.exe, reg.exe, powershell.exe, cmd.exe) will appear, (3) This identifies the infection vector or lateral movement method. After Prefetch analysis: (4) Cross-reference with AmCache for SHA-1 hashes (VirusTotal lookup), (5) Check MFT for file creation times in Temp/AppData matching this window, (6) Review Event Logs (Security 4688 process creation, System 7045 service installation). The Prefetch artifact provides the fastest path to identifying attacker tools and tactics."
    },
    {
      "question_id": "q15_5",
      "type": "scenario",
      "difficulty": 3,
      "question": "You're performing Registry diff analysis between baseline (pre-incident) and compromised system. You find NO differences in persistence locations (Run keys, Services, Tasks), but network logs show data exfiltration occurred. Where should you look next for Registry-based evidence?",
      "options": [
        "TypedURLs and browser history (web-based exfiltration)",
        "MountPoints2 and Network keys (network share or cloud storage)",
        "RecentDocs and OpenSaveMRU (file access activity)",
        "All of the above—check user activity artifacts comprehensively"
      ],
      "correct_answer": 3,
      "explanation": "When traditional persistence mechanisms show no changes, the attacker likely used legitimate user activity rather than malware. Check ALL user activity Registry artifacts: (1) TypedURLs/TypedPaths (browser): Detect file upload to cloud services (Dropbox, Google Drive, WeTransfer), (2) MountPoints2: Network share exfiltration (attacker's C2 server SMB share or compromised internal file server), (3) Network mapped drives: Persistent connections to data staging locations, (4) RecentDocs: Files accessed before exfiltration (identify what was stolen), (5) OpenSaveMRU: 'Save As' dialog history showing files saved to USB/network locations. This comprehensive approach is critical because sophisticated attackers avoid noisy persistence mechanisms and blend into normal user activity. Cross-correlate findings with Prefetch (file transfer tools: robocopy, xcopy, curl, browsers), LNK files (recent documents), and ShellBags (folder navigation)."
    }
  ],
  "jim_kwik_principles": [
    "teach_like_im_10",
    "memory_hooks",
    "connect_to_what_i_know",
    "active_learning",
    "meta_learning",
    "minimum_effective_dose",
    "reframe_limiting_beliefs",
    "gamify_it",
    "learning_sprint",
    "multiple_memory_pathways"
  ],
  "content_blocks": [
    {
      "type": "explanation",
      "content": {
        "text": "# Advanced Registry Analysis and Timeline Forensics\n\n## Opening: You're Now Building Complete Forensic Stories\n\nYou've mastered the fundamentals—NTUSER.DAT, ShellBags, USBSTOR, network shares. Now you're ready for advanced techniques that separate expert forensic analysts from beginners.\n\n**What makes this lesson different**: You'll learn how to recover DELETED Registry keys, track changes over time using Volume Shadow Copies, automate analysis with batch processing, and generate comprehensive timelines that correlate Registry artifacts with Prefetch, MFT, and Event Logs.\n\n**Why this matters**: APT groups and sophisticated insiders use anti-forensics—deleting Registry keys, timestomping, restoring system snapshots. Standard analysis won't catch them. Advanced techniques will.\n\n**Real-world impact**: In a 2023 ransomware investigation, standard Registry analysis found nothing suspicious. Advanced transaction log analysis revealed the attackers had deleted 23 persistence keys after encryption. Recovery of these keys identified the C2 servers, encryption tools, and lateral movement path—enabling network-wide containment.\n\nLet's elevate your Registry forensics to the expert level.\n\n---\n\n## Part 1: Registry Transaction Logs and Deleted Key Recovery\n\n### Understanding Registry Transaction Logs\n\n**What are transaction logs?**\n\nWindows uses transaction logs to ensure Registry integrity. When a change is written to a Registry hive, it's first written to a transaction log, then committed to the hive file.\n\n**Log files**:\n- **SYSTEM.LOG1**, **SYSTEM.LOG2** (for SYSTEM hive)\n- **SOFTWARE.LOG1**, **SOFTWARE.LOG2** (for SOFTWARE hive)\n- **NTUSER.DAT.LOG1**, **NTUSER.DAT.LOG2** (for user profiles)\n- **UsrClass.dat.LOG1**, **UsrClass.dat.LOG2** (for ShellBags)\n\n**Location**: Same directory as the hive file\n- System hives: `C:\\Windows\\System32\\config\\`\n- User hives: `C:\\Users\\<username>\\`\n\n**Forensic value**:\n- **Uncommitted changes**: Modifications not yet written to main hive (system crashed before commit)\n- **Recent activity**: Most recent Registry operations (logs rotate frequently)\n- **Deleted key remnants**: Keys deleted from main hive may still exist in transaction logs\n\n### Recovery Techniques\n\n**Method 1: Volume Shadow Copies (Most Reliable)**\n\n**What are VSS snapshots?**\n\nWindows automatically creates Volume Shadow Copies (snapshots) at scheduled intervals and before major system events (Windows Updates, software installations).\n\n**Forensic power**:\n- **Complete Registry hive snapshots** from days, weeks, or months ago\n- **Track changes over time**: Compare baseline vs. compromised system\n- **Recover deleted keys**: Load older VSS snapshots and extract deleted artifacts\n\n**Locating VSS snapshots**:\n```\nC:\\System Volume Information\\{GUID}\\...\n```\n\n**Mounting VSS snapshots** (Windows forensic workstation):\n```powershell\nvssadmin list shadows\nmklink /d C:\\VSS_Mount \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\\n```\n\n**Extracting Registry hives from VSS**:\n```\nC:\\VSS_Mount\\Windows\\System32\\config\\SYSTEM\nC:\\VSS_Mount\\Windows\\System32\\config\\SOFTWARE\nC:\\VSS_Mount\\Users\\<username>\\NTUSER.DAT\n```\n\n**Analysis workflow**:\n1. Extract SYSTEM hive from VSS snapshot (e.g., March 1)\n2. Load in Registry Explorer\n3. Navigate to USBSTOR, extract device list\n4. Compare with current SYSTEM hive (March 20)\n5. Identify DELETED devices (present in VSS, absent in current)\n\n**Real-world case - 2022 Insider Threat**:\n\nEmployee used \"USB Oblivion\" to delete all USBSTOR entries before resignation.\n\n**Standard analysis**: No USB devices found in current SYSTEM hive.\n\n**Advanced VSS analysis**:\n- VSS snapshot from 2 weeks prior contained 3 USB device entries\n- Serial numbers: Kingston DataTraveler (DT101G2), SanDisk Cruzer (4C5300), Generic Flash (0000000001)\n- Cross-referenced with setupapi.dev.log (survived USB Oblivion)\n- Correlated with Prefetch volume serials\n- **Result**: All 3 USB devices confirmed, timeline reconstructed, employee arrested\n\n**Method 2: Transaction Log Parsing (Advanced)**\n\n**Tools**:\n- **Registry Explorer**: Can load hive + transaction logs together (automatic recovery)\n- **Registry Transaction Log Parser** (open-source): Extracts uncommitted changes\n\n**Workflow with Registry Explorer**:\n1. File → Load Hive → Select SYSTEM\n2. Registry Explorer automatically detects SYSTEM.LOG1/LOG2\n3. Prompts: \"Transaction logs found. Recover uncommitted changes?\"\n4. Click \"Yes\" → Registry Explorer merges logs into hive view\n5. Recovered keys marked with indicator\n\n**Limitation**: Transaction logs only contain recent changes (typically last few hours or days). For older deletions, use VSS.\n\n---\n\n## Part 2: Registry Diff Analysis\n\n### Baseline vs. Compromised Comparison\n\n**Concept**: Compare a known-good Registry baseline with a potentially compromised system to identify unauthorized changes.\n\n**Use cases**:\n- **Golden image comparison**: Corporate workstations should match baseline (detect policy violations)\n- **Pre/post incident**: Compare VSS snapshot before incident with current state\n- **Malware detection**: Identify persistence mechanisms added by malware\n\n**Tools**:\n- **Registry Explorer**: Manual comparison (load two hives, navigate side-by-side)\n- **RECmd**: Batch export to CSV, use diff tools (Excel, Python scripts)\n- **RegShot**: Before/after Registry snapshots (primarily for malware analysis)\n\n### Critical Keys to Monitor for Changes\n\n**Persistence locations** (high priority for diff analysis):\n```\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nHKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\nHKLM\\System\\CurrentControlSet\\Services (new services)\nHKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce\nHKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders (Startup)\n```\n\n**Network configuration** (APT lateral movement):\n```\nHKLM\\System\\CurrentControlSet\\Services\\Tcpip\\Parameters (DNS, DHCP changes)\nHKLM\\System\\CurrentControlSet\\Control\\Terminal Server (RDP configuration)\nHKLM\\System\\CurrentControlSet\\Services\\LanmanServer\\Shares (new network shares)\n```\n\n**User accounts** (privilege escalation, backdoor accounts):\n```\nHKLM\\SAM\\SAM\\Domains\\Account\\Users (new users, modified privileges)\n```\n\n**Firewall rules** (malware communication):\n```\nHKLM\\System\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\FirewallRules\n```\n\n### RECmd Diff Workflow\n\n**Step 1: Export baseline to CSV**\n```bash\nRECmd.exe -f \"Baseline_SYSTEM\" --bn \"BatchPersistence.reb\" --csv \"C:\\Output\\Baseline\"\n```\n\n**Step 2: Export compromised system to CSV**\n```bash\nRECmd.exe -f \"Compromised_SYSTEM\" --bn \"BatchPersistence.reb\" --csv \"C:\\Output\\Compromised\"\n```\n\n**Step 3: Compare CSV files**\nUse Excel, Python pandas, or PowerShell:\n```powershell\n$baseline = Import-Csv \"Baseline\\Run_Keys.csv\"\n$compromised = Import-Csv \"Compromised\\Run_Keys.csv\"\n$diff = Compare-Object $baseline $compromised -Property KeyPath, ValueName, ValueData\n$diff | Where-Object {$_.SideIndicator -eq \"=>\"} | Format-Table\n```\n\n**Output**: New entries in compromised system (malware persistence)\n\n**Real-world example - 2023 APT29 Intrusion**:\n\nDiff analysis revealed:\n- **New Run key**: `HKLM\\...\\Run\\WindowsDefender = C:\\ProgramData\\WinDefender\\WinDefend.exe`\n- **New service**: `HKLM\\...\\Services\\WinDefendSvc` (startup type = Automatic)\n- **Modified RDP setting**: `HKLM\\...\\Terminal Server\\fDenyTSConnections = 0` (RDP enabled)\n- **New firewall rule**: Allow inbound TCP 3389 from 10.0.0.0/8\n\n**Analysis**: APT29 installed persistent backdoor (disguised as Windows Defender), enabled RDP, and configured firewall to allow internal network connections—classic lateral movement preparation.\n\n---\n\n## Part 3: Registry Timeline Generation\n\n### Why Timelines Are Critical\n\n**The power of chronology**:\n- **Sequence of events**: Understand attack progression (initial compromise → persistence → lateral movement → exfiltration)\n- **Correlation**: Link Registry changes to Prefetch, MFT, Event Logs at precise timestamps\n- **Anomaly detection**: Identify bursts of activity (malware installation, bulk changes)\n\n### RegRipper Timeline Workflow\n\n**Command**:\n```bash\nrip.exe -r \"SYSTEM\" -a > SYSTEM_timeline.txt\n```\n\n**What this does**:\n- Runs ALL RegRipper plugins on the SYSTEM hive\n- Extracts timestamps from every key analyzed\n- Outputs chronological timeline\n\n**Sample output**:\n```\n2024-03-15 09:30:42 - USBSTOR: Kingston DataTraveler first install\n2024-03-15 14:22:15 - Services: New service 'WinDefendSvc' created\n2024-03-15 14:22:47 - Run Keys: New entry 'WindowsDefender' added\n2024-03-15 14:23:12 - Firewall: New rule 'RDP Allow' created\n2024-03-20 15:47:22 - MountPoints2: User accessed USB device\n```\n\n**Analysis approach**:\n1. **Identify bursts**: Multiple entries in short timeframes = automated tool activity\n2. **Correlate with Prefetch**: Which executables ran at these timestamps?\n3. **Cross-reference Event Logs**: Security 4688 (process creation), System 7045 (service installation)\n\n### RECmd Timeline (More Granular)\n\n**Command**:\n```bash\nRECmd.exe -f \"SYSTEM\" --bn \"BatchTimeline.reb\" --csv \"C:\\Output\" --dt \"yyyy-MM-dd HH:mm:ss\"\n```\n\n**Output**: CSV with LastWriteTime for every extracted Registry key\n\n**Advantages over RegRipper**:\n- **CSV format**: Easy to filter, sort, pivot in Excel or Python\n- **Batch processing**: Run multiple hives (SYSTEM, SOFTWARE, NTUSER.DAT) in one command\n- **Customizable**: Create custom batch scripts targeting specific keys\n\n**Example batch script** (BatchTimeline.reb):\n```\nDescription: Extract all persistence and user activity timestamps\nHive: SYSTEM\nPath: CurrentControlSet\\Services\nRecursive: True\n\nHive: SOFTWARE\nPath: Microsoft\\Windows\\CurrentVersion\\Run\nRecursive: True\n\nHive: NTUSER.DAT\nPath: Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\RecentDocs\nRecursive: True\n```\n\n**Processing in Python** (timeline correlation):\n```python\nimport pandas as pd\n\n# Load Registry timeline\nreg_timeline = pd.read_csv('SYSTEM_timeline.csv', parse_dates=['LastWriteTime'])\n\n# Load Prefetch timeline\nprefetch_timeline = pd.read_csv('Prefetch_timeline.csv', parse_dates=['LastRunTime'])\n\n# Merge on timestamps (within 5-minute window)\nmerged = pd.merge_asof(\n    reg_timeline.sort_values('LastWriteTime'),\n    prefetch_timeline.sort_values('LastRunTime'),\n    left_on='LastWriteTime',\n    right_on='LastRunTime',\n    direction='nearest',\n    tolerance=pd.Timedelta('5min')\n)\n\nprint(merged[['LastWriteTime', 'RegistryKey', 'PrefetchFile']])\n```\n\n**Output**: Correlation showing which executables ran at the same time as Registry modifications.\n\n---\n\n## Part 4: Advanced Anti-Forensics Detection\n\n### Timestomping Detection\n\n**What is timestomping?**\n\nAttackers modify Registry key Last Write Times to hide recent changes (make them appear old/benign).\n\n**Detection method 1: Transaction Log Comparison**\n\nTransaction logs contain original timestamps. If hive shows old timestamp but transaction log shows recent activity → timestomping.\n\n**Detection method 2: Inconsistency Analysis**\n\n**Example**:\n- Parent key Last Write Time: 2024-01-15 10:00:00\n- Child subkey Last Write Time: 2024-01-10 09:00:00\n\n**Anomaly**: Child key timestamp is OLDER than parent. This violates normal behavior (creating a subkey updates parent's Last Write Time).\n\n**Tool**: Registry Explorer highlights timestamp inconsistencies.\n\n**Detection method 3: Cross-Artifact Correlation**\n\n**Scenario**:\n- Registry Run key Last Write Time: 2023-06-01 12:00:00 (1 year ago)\n- Prefetch for malware executable: Last Run Time: 2024-03-15 14:22:00 (recent)\n- Contradiction: If Run key was last modified a year ago, how did the malware run last week?\n\n**Conclusion**: Run key timestamp was manipulated. True modification time = when Prefetch shows first execution.\n\n### Registry Hive Restoration Detection\n\n**Tactic**: Attacker restores old VSS snapshot of Registry hive to erase recent malicious changes.\n\n**Detection indicators**:\n1. **Hive file timestamp** (NTUSER.DAT modification time) is NEWER than newest key inside\n2. **Missing expected entries**: User's RecentDocs should show files accessed yesterday, but newest entry is from 3 days ago\n3. **VSS event logs**: Event ID 8224 (VSS snapshot restoration)\n4. **User activity gap**: Other users show continuous activity, but this user's Registry shows 3-day gap\n\n**Example timeline**:\n```\nMarch 15: Malware infection, persistence keys created\nMarch 18: Attacker realizes forensics is coming\nMarch 18: Attacker runs: vssadmin restore shadow /file:C:\\Users\\victim\\NTUSER.DAT /shadow={GUID}\nMarch 18: NTUSER.DAT file timestamp = March 18, but newest key inside = March 12 (pre-infection)\n```\n\n**Forensic response**: Check other artifacts (Prefetch, MFT, Event Logs) that can't be easily restored to prove malicious activity occurred March 15-18.\n\n---\n\n## Part 5: Automation and Reporting\n\n### KAPE Integration\n\n**Full forensic workflow**:\n\n**Step 1: Evidence Collection**\n```bash\nkape.exe --tsource C: --tdest D:\\Evidence --target RegistryHives,Prefetch,EventLogs,LNK\n```\n\nCollects:\n- All Registry hives (SYSTEM, SOFTWARE, SAM, SECURITY, NTUSER.DAT, UsrClass.dat)\n- Transaction logs (.LOG1, .LOG2)\n- Prefetch files\n- Event logs\n- LNK files\n\n**Step 2: Processing**\n```bash\nkape.exe --msource D:\\Evidence --mdest D:\\Output --module RECmd_FullBatch,RegRipper_All,PECmd\n```\n\nRuns:\n- RECmd with comprehensive batch scripts\n- RegRipper with all plugins\n- PECmd (Prefetch analysis)\n\n**Output**: Hundreds of CSV files with parsed artifacts\n\n**Step 3: Timeline Creation**\n```bash\nkape.exe --msource D:\\Output --mdest D:\\Timeline --module Timeline_Super\n```\n\nGenerates:\n- Super timeline combining Registry, Prefetch, MFT, Event Logs\n- Chronological CSV sorted by timestamp\n- Ready for analysis in Timeline Explorer\n\n### Professional Reporting\n\n**Report structure**:\n\n1. **Executive Summary**\n   - What happened (one paragraph)\n   - Timeline (first compromise → exfiltration)\n   - Impact (data stolen, systems affected)\n   - Recommendations (containment, remediation)\n\n2. **Technical Findings**\n   - **Persistence mechanisms**: Run keys, Services, Scheduled Tasks\n   - **User activity**: RecentDocs, TypedURLs, MountPoints2\n   - **Device usage**: USBSTOR, network shares\n   - **Timeline**: Chronological sequence with supporting evidence\n\n3. **Evidence Appendix**\n   - Screenshots (Registry Explorer showing malicious keys)\n   - CSV exports (Run keys, Services, USB devices)\n   - Correlation tables (Registry timestamp + Prefetch + Event Log)\n\n**Sample findings table**:\n\n| Timestamp | Artifact | Finding | Significance |\n|---|---|---|---|\n| 2024-03-15 14:22:15 | SYSTEM\\Services | New service 'WinDefendSvc' | Malware persistence |\n| 2024-03-15 14:22:47 | SOFTWARE\\Run | WindowsDefender = C:\\ProgramData\\... | Backdoor autostart |\n| 2024-03-15 14:22:50 | PREFETCH | WinDefend.exe-AB12CD34.pf (First run) | Malware execution |\n| 2024-03-15 14:23:05 | Event 7045 | Service installation 'WinDefendSvc' | Corroborates Registry |\n\n**Key principle**: Every Registry finding should be CORROBORATED with at least one other artifact (Prefetch, Event Log, MFT).\n\n---\n\n## Part 6: Real-World Case Study\n\n### Case: 2023 Healthcare Ransomware (Lockbit 3.0)\n\n**Initial Discovery**: Ransomware encrypted 300 servers, ransom demand $5 million.\n\n**Investigation Question**: How did attackers gain initial access and move laterally?\n\n**Registry Forensics Process**:\n\n**Step 1: Diff Analysis** (baseline vs. compromised domain controller)\n\nNew entries found:\n- Run key: `HKLM\\...\\Run\\MicrosoftUpdate = C:\\Windows\\Temp\\msupdate.exe`\n- Service: `HKLM\\...\\Services\\LockbitSvc` (binary = `C:\\ProgramData\\Lockbit\\agent.exe`)\n- RDP config: `fDenyTSConnections = 0` (RDP enabled—previously disabled by policy)\n- New user: `HKLM\\SAM\\...\\Users\\AdminSupport` (local admin rights)\n\n**Step 2: Timeline Generation** (RegRipper)\n\n```\nFeb 10, 2024 08:15:42 - USBSTOR: Unknown USB device (no serial number)\nFeb 10, 2024 08:17:15 - Services: New service 'LockbitSvc' created\nFeb 10, 2024 08:17:33 - Run Keys: 'MicrosoftUpdate' added\nFeb 10, 2024 08:18:05 - SAM: User 'AdminSupport' created\nFeb 10, 2024 08:18:42 - Terminal Server: RDP enabled\nFeb 10, 2024 08:45:00 - MountPoints2: Access to \\\\DC01\\SYSVOL\nFeb 10, 2024 09:22:15 - MountPoints2: Access to \\\\FileServer01\\Backup\n```\n\n**Step 3: Correlation with Prefetch**\n\n- **08:15:50** - `PSEXEC.EXE` (remote execution tool)\n- **08:17:20** - `MSUPDATE.EXE` (malware binary, first run)\n- **08:17:40** - `NET.EXE` (user creation commands)\n- **08:18:50** - `REG.EXE` (Registry modification via command line)\n- **08:45:10** - `POWERSHELL.EXE` (lateral movement scripts)\n\n**Step 4: VSS Snapshot Analysis**\n\nLoaded VSS from Feb 8 (2 days before incident):\n- No malicious Run keys\n- No 'LockbitSvc' service\n- No 'AdminSupport' user\n- RDP was disabled\n\n**Conclusion**: Attackers gained access on Feb 10, 08:15 (likely via compromised VPN credentials).\n\n**Attack timeline**:\n1. **08:15** - Initial access via VPN, dropped tools to `C:\\Windows\\Temp`\n2. **08:17** - Installed persistence (service, Run key)\n3. **08:18** - Created backdoor admin account, enabled RDP\n4. **08:45** - Lateral movement to Domain Controller (SYSVOL access = Group Policy modification capability)\n5. **09:22** - Accessed backup file server (disabled backups before encryption)\n6. **Feb 10-25** - Reconnaissance, credential harvesting, data exfiltration\n7. **Feb 25** - Ransomware deployment across network\n\n**Registry artifacts that solved the case**:\n- **USBSTOR**: No USB device (ruled out insider threat)\n- **MountPoints2**: Proved lateral movement path\n- **Run/Services**: Identified persistence mechanisms\n- **SAM**: Backdoor account for re-entry\n- **VSS comparison**: Established baseline, confirmed Feb 10 compromise date\n\n**Outcome**: \n- Timeline presented to executives, decision made to NOT pay ransom\n- IT restored from offline backups (taken before Feb 10)\n- Backdoor account, services, Run keys removed across all systems\n- RDP re-disabled, VPN credentials reset, MFA enforced\n- Total recovery time: 6 days, $0 ransom paid\n\n---\n\n## Closing: You're Now an Expert Registry Analyst\n\nYou've completed the advanced Registry forensics module. You can now:\n\n✅ Recover deleted Registry keys using transaction logs and VSS\n✅ Perform diff analysis to detect unauthorized changes\n✅ Generate comprehensive timelines with RegRipper and RECmd\n✅ Detect anti-forensics (timestomping, hive restoration)\n✅ Automate workflows with KAPE and batch processing\n✅ Correlate Registry with Prefetch, Event Logs, MFT\n✅ Create professional forensic reports with evidence tables\n✅ Apply techniques to APT, ransomware, and insider threat investigations\n\n**Your competitive advantage**: Most DFIR analysts stop at basic USBSTOR and Run key analysis. You now have advanced skills that solve complex cases—VSS analysis, timeline correlation, anti-forensics detection.\n\n**Next steps**:\n1. **Practice**: Download NIST CFReDS images, perform full Registry analysis\n2. **Certifications**: GCFA, EnCE, SANS FOR500 to formalize your skills\n3. **Next lesson**: **Execution Artifacts Deep Dive (Shimcache, BAM/DAM, UserAssist)** to correlate with Registry persistence\n\nYou're now equipped to handle the most sophisticated attacks. Keep building your timeline analysis skills—they're your most powerful investigative weapon."
      }
    },
    {
      "type": "code_exercise",
      "content": {
        "text": "## Hands-On Exercise: Advanced Registry Timeline Correlation\n\n### Scenario\n\nYou're investigating a suspected APT intrusion at a financial services company. A domain controller shows signs of compromise. You have access to:\n- Current SYSTEM and SOFTWARE hives\n- Volume Shadow Copy snapshot from 7 days ago\n- Prefetch files\n- Security Event Logs\n\n### Evidence Artifacts\n\n**Registry Diff Analysis Results** (Baseline VSS vs. Current):\n\n**New Run Key**:\n```\nHKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\n  Value: WindowsUpdateService\n  Data: C:\\ProgramData\\Microsoft\\WindowsUpdate\\wuaueng.exe\n  Last Write Time: 2024-03-18 14:25:33\n```\n\n**New Service**:\n```\nHKLM\\SYSTEM\\CurrentControlSet\\Services\\WUAUSvc\n  ImagePath: C:\\ProgramData\\Microsoft\\WindowsUpdate\\wuaueng.exe\n  Start: 2 (Automatic)\n  Last Write Time: 2024-03-18 14:25:18\n```\n\n**Modified RDP Configuration**:\n```\nHKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server\n  fDenyTSConnections: 0 (was 1 in baseline)\n  Last Write Time: 2024-03-18 14:26:05\n```\n\n**New Firewall Rule**:\n```\nHKLM\\SYSTEM\\CurrentControlSet\\Services\\SharedAccess\\Parameters\\FirewallPolicy\\FirewallRules\n  Rule: RDP-Allow-Internal\n  Action: Allow\n  Protocol: TCP\n  Port: 3389\n  Direction: Inbound\n  Last Write Time: 2024-03-18 14:26:22\n```\n\n**Prefetch Files** (timestamps from file system):\n```\nPSEXEC.EXE-A1B2C3D4.pf\n  Last Run Time: 2024-03-18 14:24:55\n  Run Count: 1\n\nREG.EXE-E5F6G7H8.pf\n  Last Run Time: 2024-03-18 14:25:25\n  Run Count: 3\n\nWUAUENG.EXE-I9J0K1L2.pf\n  Last Run Time: 2024-03-18 14:27:10\n  Run Count: 1\n\nPOWERSHELL.EXE-M3N4O5P6.pf\n  Last Run Time: 2024-03-18 14:28:45\n  Run Count: 1\n```\n\n**Event Logs** (Security.evtx):\n```\nEvent ID 4624 (Logon)\n  Time: 2024-03-18 14:24:30\n  Logon Type: 3 (Network)\n  Account: FINANCE\\administrator\n  Source IP: 10.50.30.15\n\nEvent ID 4688 (Process Creation)\n  Time: 2024-03-18 14:24:55\n  Process: C:\\Windows\\PsExec.exe\n  Account: FINANCE\\administrator\n\nEvent ID 7045 (Service Installation)\n  Time: 2024-03-18 14:25:20\n  Service Name: WUAUSvc\n  Service File: C:\\ProgramData\\Microsoft\\WindowsUpdate\\wuaueng.exe\n  Account: FINANCE\\administrator\n```\n\n### Your Tasks\n\n**Task 1: Build Complete Timeline**\n\nCombine all artifacts (Registry, Prefetch, Event Logs) into a single chronological timeline. Format:\n```\nTimestamp | Artifact Type | Finding | Interpretation\n```\n\n**Task 2: Identify Attack Phases**\n\nBased on your timeline, identify:\n1. **Initial Access**: When and how did the attacker first access the system?\n2. **Persistence**: Which mechanisms ensure the malware survives reboot?\n3. **Defense Evasion**: What did the attacker do to avoid detection?\n4. **Command & Control**: What evidence suggests ongoing C2 communication?\n\n**Task 3: Correlation Analysis**\n\nAnswer:\n1. Why did the attacker create BOTH a Run key AND a Service for the same executable?\n2. The RDP modification occurred 32 seconds AFTER the service installation. What does this sequence suggest?\n3. The malware (wuaueng.exe) first ran at 14:27:10, but the service was created at 14:25:18. What explains this 2-minute gap?\n\n**Task 4: Forensic Validation**\n\nFor each Registry finding, identify the corroborating artifact:\n- Run key (14:25:33) → Corroborated by: ____?\n- Service creation (14:25:18) → Corroborated by: ____?\n- RDP enabled (14:26:05) → Corroborated by: ____?\n\n**Task 5: Determine Source IP Attribution**\n\nThe Event Log shows source IP 10.50.30.15. Based on the attack timeline and methods (PsExec usage, Registry modification via command line), is this likely:\nA) External attacker pivoting from compromised workstation\nB) Insider threat using legitimate admin credentials\nC) Lateral movement from previously compromised server\n\nExplain your reasoning.\n\n**Challenge Task: Anti-Forensics Detection**\n\nYou notice:\n- Service Last Write Time: 2024-03-18 14:25:18\n- Service executable (wuaueng.exe) MFT birth time: 2024-03-18 14:24:58\n- Prefetch for REG.EXE shows 3 run counts, but only 1 relevant Registry modification visible\n\nWhat might explain the discrepancy in REG.EXE run count? What additional Registry keys would you check?\n\n### Answers\n\n<details>\n<summary>Click to reveal answers</summary>\n\n**Task 1: Complete Timeline**\n\n| Timestamp | Artifact | Finding | Interpretation |\n|---|---|---|---|\n| 14:24:30 | Event 4624 | Network logon from 10.50.30.15 | Initial access via lateral movement |\n| 14:24:55 | Event 4688 + Prefetch | PsExec.exe executed | Remote code execution tool |\n| 14:24:58 | MFT | wuaueng.exe created | Malware dropped to disk |\n| 14:25:18 | Registry (Services) | WUAUSvc service created | Persistence mechanism #1 |\n| 14:25:20 | Event 7045 | Service installation confirmed | Corroborates Registry |\n| 14:25:25 | Prefetch | REG.EXE run (3 times) | Registry modification via CLI |\n| 14:25:33 | Registry (Run key) | WindowsUpdateService added | Persistence mechanism #2 |\n| 14:26:05 | Registry (RDP) | RDP enabled | Backdoor access preparation |\n| 14:26:22 | Registry (Firewall) | RDP firewall rule created | Allow inbound RDP |\n| 14:27:10 | Prefetch | wuaueng.exe first execution | Malware started |\n| 14:28:45 | Prefetch | PowerShell executed | Post-exploitation activity |\n\n**Task 2: Attack Phases**\n\n1. **Initial Access**: 14:24:30 - Network logon from 10.50.30.15 using FINANCE\\administrator credentials (likely stolen via credential dumping on another system)\n2. **Persistence**:\n   - Service 'WUAUSvc' (automatic startup)\n   - Run key 'WindowsUpdateService' (user login trigger)\n3. **Defense Evasion**: \n   - Executable named 'wuaueng.exe' (mimics legitimate Windows Update service)\n   - Stored in 'C:\\ProgramData\\Microsoft\\WindowsUpdate' (looks like system folder)\n4. **Command & Control**: PowerShell execution at 14:28:45 suggests C2 beacon or post-exploitation framework (Cobalt Strike, Empire)\n\n**Task 3: Correlation Analysis**\n\n1. **Dual persistence** (Run key + Service):\n   - **Service**: Starts on system boot (works even if no user logs in)\n   - **Run key**: Starts on user login (redundancy if service fails)\n   - This is a common APT technique for resilience\n\n2. **RDP modification 32 seconds after service**:\n   - Service installation = primary persistence\n   - RDP enablement = secondary access method (backdoor for re-entry if primary C2 fails)\n   - Sequence suggests automated script/framework (not manual)\n\n3. **2-minute gap** (service created 14:25:18, malware ran 14:27:10):\n   - Service Start Type = Automatic (starts on boot, not immediately)\n   - Attacker used 'net start WUAUSvc' or 'sc start WUAUSvc' to manually start service\n   - 2-minute gap = time spent configuring RDP, testing connectivity\n\n**Task 4: Forensic Validation**\n\n- Run key (14:25:33) → Corroborated by: **REG.EXE Prefetch** (14:25:25) - shows reg.exe was used to add the key\n- Service creation (14:25:18) → Corroborated by: **Event 7045** (14:25:20) - service installation event\n- RDP enabled (14:26:05) → Corroborated by: **REG.EXE Prefetch** (14:25:25, run count 3) - one of the 3 runs modified RDP config\n\n**Task 5: Source IP Attribution**\n\n**Answer: C) Lateral movement from previously compromised server**\n\n**Reasoning**:\n- IP 10.50.30.15 is internal (RFC 1918 private range)\n- Use of PsExec (common lateral movement tool in enterprise attacks)\n- Valid domain admin credentials (FINANCE\\administrator)\n- Network logon type 3 (typical for SMB-based lateral movement)\n- This is NOT insider threat because insiders don't use PsExec (they have direct console access)\n- This is NOT external because external attackers don't have internal IPs (they'd use VPN or compromised edge device, which would show different logon type)\n\n**Next steps**: Investigate 10.50.30.15 (which server/workstation?) and determine how it was initially compromised.\n\n**Challenge Task Answer**:\n\n**REG.EXE run count = 3**, but only 1 Registry modification visible suggests:\n1. First run: Added Run key (14:25:33)\n2. Second run: Enabled RDP (14:26:05)\n3. Third run: **Deleted evidence or modified other keys not yet discovered**\n\n**Additional keys to check**:\n- `HKLM\\SYSTEM\\CurrentControlSet\\Services\\LanmanServer\\Shares` (new network shares?)\n- `HKLM\\SAM\\SAM\\Domains\\Account\\Users` (new user accounts?)\n- `HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest` (UseLogonCredential = 1 to enable plaintext password storage?)\n- Check **SYSTEM.LOG1/LOG2** transaction logs for deleted keys\n- Review **earlier VSS snapshots** (not just 7 days ago—check 1 day ago, 3 days ago) for more recent changes\n\n**Likely finding**: Attacker also created backdoor user account or modified credential storage settings (third REG.EXE run).\n\n</details>\n\n### Learning Takeaway\n\nThis exercise demonstrates the critical importance of **multi-artifact correlation**. Registry analysis alone shows unauthorized changes, but without Prefetch and Event Logs, you can't determine:\n- HOW changes were made (PsExec, command-line tools)\n- WHEN exactly they occurred (precise timestamps)\n- WHO made them (source IP, account name)\n\nExpert forensic analysis = Registry + Prefetch + Event Logs + MFT + Network Logs.\n"
      }
    }
  ],
  "tags": [
    "Course: 13Cubed-Investigating Windows Endpoints"
  ]
}