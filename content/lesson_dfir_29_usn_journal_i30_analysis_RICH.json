{
  "lesson_id": "50494b65-c2db-41c2-b20d-6f153fc72b7b",
  "domain": "dfir",
  "title": "USN Journal and $I30 Index Analysis",
  "difficulty": 3,
  "order_index": 29,
  "prerequisites": [
    "e5d18e0d-9cda-4769-9589-395cbadcafed",
    "9a0289a3-f25c-482b-ba0a-e91e3917c893"
  ],
  "concepts": [
    "USN Journal (Update Sequence Number) architecture",
    "$I30 index attributes and directory entry slack",
    "USN Journal record structure and reasons codes",
    "Deleted file detection via USN Journal",
    "File rename tracking across multiple operations",
    "Directory listing artifacts in $I30 slack space",
    "MFTECmd USN Journal parsing",
    "Timeline correlation with USN changes"
  ],
  "estimated_time": 55,
  "learning_objectives": [
    "Understand USN Journal architecture and record structure",
    "Parse USN Journal records to detect file operations (create, delete, rename)",
    "Analyze $I30 index slack space to recover deleted directory entries",
    "Correlate USN Journal timestamps with MFT timeline data",
    "Identify anti-forensics techniques through USN analysis",
    "Use MFTECmd and ANJP for automated USN Journal parsing",
    "Reconstruct file lifecycle including deletion and overwriting"
  ],
  "post_assessment": [
    {
      "question_id": "usn-001",
      "question": "What is the primary forensic value of the USN Journal compared to MFT timestamps?",
      "options": [
        "USN Journal provides more precise timestamps (nanosecond vs millisecond)",
        "USN Journal records deleted file operations that no longer exist in the MFT",
        "USN Journal is encrypted and more secure than MFT",
        "USN Journal tracks network file access while MFT only tracks local access"
      ],
      "correct_answer": 1,
      "explanation": "The USN Journal's PRIMARY forensic value is that it records a HISTORY of file operations, including files that have been DELETED and no longer have MFT entries. The MFT is a 'current state' snapshot, but the USN Journal is a 'change log' that preserves evidence of past activity. This makes it invaluable for detecting file deletion, mass ransomware encryption, and anti-forensics activity.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "usn-002",
      "question": "Which USN reason code indicates a file was PERMANENTLY deleted (not just moved to Recycle Bin)?",
      "options": [
        "0x00000001 - DATA_OVERWRITE",
        "0x00000200 - FILE_DELETE",
        "0x00001000 - HARD_LINK_CHANGE",
        "0x00080000 - CLOSE"
      ],
      "correct_answer": 1,
      "explanation": "Reason code 0x00000200 (FILE_DELETE) indicates permanent file deletion. This is different from Recycle Bin operations, which show up as RENAME operations (moving file to $Recycle.Bin folder). Forensically, FILE_DELETE combined with the file's MFT reference number allows you to correlate the deletion time with the now-deleted MFT entry, establishing a complete lifecycle timeline.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "usn-003",
      "question": "What is '$I30 index slack space' and why is it forensically significant?",
      "options": [
        "Unused space in directory MFT entries that contains remnants of deleted filenames",
        "A hidden partition used by NTFS for system recovery",
        "The gap between file clusters used for data hiding",
        "A backup of the USN Journal maintained by Windows"
      ],
      "correct_answer": 0,
      "explanation": "$I30 is the NTFS index attribute that stores directory listings. When files are deleted from a directory, the index may be reorganized, leaving 'slack space' (unused bytes) that contain OLD DIRECTORY ENTRIES. These entries include DELETED FILENAMES, timestamps, and file sizes that are no longer in the MFT. Forensically, $I30 slack space analysis can recover evidence of files that were deleted AND had their MFT entries reallocated, providing a 'deeper history' than even the USN Journal in some cases.",
      "type": "multiple_choice",
      "difficulty": 3
    },
    {
      "question_id": "usn-004",
      "question": "An attacker deletes the USN Journal file ($Extend\\$UsnJrnl) to hide their tracks. What is the forensic impact?",
      "options": [
        "All MFT timestamps are also deleted, making timeline analysis impossible",
        "The deletion itself is recorded in the OLD USN Journal before it's deleted, preserving some evidence",
        "Windows immediately recreates the USN Journal with all historical data restored",
        "The USN Journal is append-only and cannot be deleted even with admin privileges"
      ],
      "correct_answer": 1,
      "explanation": "Deleting the USN Journal is a SELF-DOCUMENTING anti-forensics technique. The deletion operation itself (FILE_DELETE on $Extend\\$UsnJrnl:$J) is recorded in the journal BEFORE the file is deleted. While the historical USN data is lost, forensic investigators can: (1) Detect the deletion timestamp (indicating anti-forensics), (2) Analyze the SURVIVING portion of the journal (if acquired before deletion), (3) Correlate with Volume Shadow Copies which may preserve older USN Journal versions. Additionally, Windows DOES recreate the journal, but with a NEW journal starting at that point (no historical data recovered).",
      "type": "multiple_choice",
      "difficulty": 3
    },
    {
      "question_id": "usn-005",
      "question": "Which tool would you use to parse the USN Journal and output timeline data in CSV format?",
      "options": [
        "Volatility 3 with mftparser plugin",
        "MFTECmd.exe with --usn parameter",
        "RegRipper for registry USN analysis",
        "Sleuth Kit fls command"
      ],
      "correct_answer": 1,
      "explanation": "MFTECmd.exe (Eric Zimmerman Tools) with the --usn parameter parses the USN Journal ($Extend\\$UsnJrnl:$J stream) and outputs CSV format compatible with Timeline Explorer. Command: 'MFTECmd.exe -f C:\\$Extend\\$UsnJrnl:$J --csv C:\\output --csvf usn_timeline.csv'. Alternative tools include ANJP (Another NTFS Journal Parser) and fsutil (built-in Windows). While Volatility can extract USN Journal from memory, MFTECmd is the forensic standard for disk-based analysis.",
      "type": "multiple_choice",
      "difficulty": 2
    }
  ],
  "jim_kwik_principles": [
    "teach_like_im_10",
    "memory_hooks",
    "active_learning",
    "connect_to_what_i_know",
    "minimum_effective_dose",
    "meta_learning",
    "reframe_limiting_beliefs",
    "gamify_it",
    "learning_sprint",
    "multiple_memory_pathways"
  ],
  "content_blocks": [
    {
      "type": "mindset_coach",
      "content": {
        "text": "# Welcome to the USN Journal: The Filesystem's Black Box Recorder!\n\nIf MACB timestamps are a **photograph** of file activity, the **USN Journal is a VIDEO RECORDING**. It captures EVERY filesystem change in chronological order, including files that no longer exist.\n\n**Think of it this way**: After a plane crash, investigators recover the black box flight recorder to understand what happened. In DFIR, the **USN Journal IS your black box** - it records file operations even when the files themselves are gone.\n\n**Real-world impact**: In ransomware investigations, the USN Journal reveals:\n- **Which files were encrypted** (even if MFT entries were overwritten)\n- **The exact timestamp of encryption start** (first FILE_DELETE or DATA_OVERWRITE)\n- **The ransomware executable's file operations** (create, rename, delete)\n- **Anti-forensics attempts** (USN Journal deletion, log wiping)\n\nIn this lesson, you'll master the **most advanced NTFS forensic artifact** - one that reveals attacker activity even when they think they've erased all evidence. Let's dive in! ğŸ”"
      }
    },
    {
      "type": "explanation",
      "content": {
        "text": "# USN Journal: The Write-Ahead Log of NTFS\n\n## What is the USN Journal?\n\nThe **Update Sequence Number (USN) Journal** is an NTFS feature that logs ALL filesystem changes in a sequential, append-only journal. It was introduced in Windows 2000/XP for efficient file replication and backup.\n\n**Location**:\n```\nC:\\$Extend\\$UsnJrnl\n  â”œâ”€â”€ $Max (metadata - journal size configuration)\n  â””â”€â”€ $J (actual journal data - this is what we parse!)\n```\n\n**Architecture**:\n```\nUSN Journal = Circular Buffer (like a race track)\n\n[Old Records] â† [New Records] â† [Most Recent]\n     â†“              â†“               â†“\n  Overwritten    Active Area    Latest Changes\n  when full\n\nDefault Size: 32 MB (Windows 10)\nRetention: Hours to days (depends on disk activity)\n```\n\n**Memory Hook - \"USN = Universal Serial Narrator\"**: The journal NARRATES every file story from birth to death.\n\n---\n\n## USN Journal vs MFT: Key Differences\n\n| Feature | MFT ($MFT) | USN Journal ($UsnJrnl:$J) |\n|---------|-----------|---------------------------|\n| **Purpose** | Current filesystem state | Historical change log |\n| **Deleted Files** | Entry removed/reallocated | Operation recorded FOREVER (until overwritten) |\n| **Timestamps** | 4x $SI + 4x $FN (8 total) | Single timestamp per operation |\n| **Record Type** | File metadata (attributes) | Change events (operations) |\n| **Size** | Grows with files | Fixed size (circular buffer) |\n| **Forensic Value** | \"What exists NOW\" | \"What HAPPENED over time\" |\n\n**Forensic Gold Standard**: **MFT + USN Journal = Complete Timeline**\n\n---\n\n## USN Journal Record Structure\n\nEach USN record is 60-100+ bytes and contains:\n\n```c\ntypedef struct {\n    DWORDLONG Usn;              // Unique sequence number (monotonically increasing)\n    DWORDLONG FileReferenceNumber;  // MFT entry number (correlates with $MFT)\n    DWORDLONG ParentFileReferenceNumber; // Parent directory MFT entry\n    LARGE_INTEGER TimeStamp;    // When operation occurred (UTC, 100-ns resolution)\n    DWORD Reason;               // WHY this record was created (operation type)\n    WCHAR FileName[...];        // Filename (Unicode, variable length)\n    // ... additional fields ...\n} USN_RECORD_V2;\n```\n\n**Key Fields for Forensics**:\n\n### 1. USN (Update Sequence Number)\n```\nExample: 1234567890\n\n- Monotonically increasing (never decreases)\n- Each operation gets a new USN\n- Gaps indicate journal overwrite/deletion\n\nForensic Use:\n- Establish chronological order\n- Detect journal tampering (USN sequence breaks)\n```\n\n### 2. FileReferenceNumber\n```\nExample: 0x001D0000000A3B2C\n          ^^^^ ^^^^^^^^^^^^\n          Seq# MFT Entry #\n\n- References the MFT entry for this file\n- Allows correlation: USN Journal â†” MFT\n\nForensic Use:\n- Link USN operations to current/deleted MFT entries\n- Track file across rename operations (MFT entry unchanged)\n```\n\n### 3. Timestamp\n```\nFormat: FILETIME (100-nanosecond intervals since 1601-01-01 UTC)\nExample: 2024-03-15 08:14:23.4567890 UTC\n\nForensic Use:\n- Precise operation timing\n- Correlate with MFT timestamps, Prefetch, AmCache\n```\n\n### 4. Reason (Operation Type)\n\n**Critical Reason Codes**:\n\n```\n0x00000001  DATA_OVERWRITE      File content modified\n0x00000002  DATA_EXTEND         File grew in size\n0x00000004  DATA_TRUNCATION     File shrunk in size\n0x00000010  NAMED_DATA_OVERWRITE  Alternate data stream modified\n0x00000020  NAMED_DATA_EXTEND     ADS grew\n0x00000040  NAMED_DATA_TRUNCATION ADS shrunk\n0x00000080  FILE_CREATE         New file created\n0x00000100  FILE_DELETE         File permanently deleted\n0x00000200  EA_CHANGE           Extended attributes changed\n0x00000400  SECURITY_CHANGE     ACL/permissions modified\n0x00000800  RENAME_OLD_NAME     File renamed (old name)\n0x00001000  RENAME_NEW_NAME     File renamed (new name)\n0x00002000  INDEXABLE_CHANGE    File indexing changed\n0x00004000  BASIC_INFO_CHANGE   Timestamps/attributes changed\n0x00008000  HARD_LINK_CHANGE    Hard link created/deleted\n0x00010000  COMPRESSION_CHANGE  Compression enabled/disabled\n0x00020000  ENCRYPTION_CHANGE   Encryption enabled/disabled\n0x00040000  OBJECT_ID_CHANGE    Object ID changed\n0x00080000  CLOSE               File handle closed\n```\n\n**Forensic Red Flags**:\n\n```python\n# Mass file deletion (ransomware/wiping)\nif count(FILE_DELETE) > 100 within 1 minute:\n    alert(\"Mass deletion detected - possible ransomware\")\n\n# File renamed then deleted (anti-forensics)\nif RENAME_NEW_NAME followed by FILE_DELETE within 5 seconds:\n    alert(\"Filename obfuscation before deletion\")\n\n# Timestomping detection\nif BASIC_INFO_CHANGE on system file:\n    alert(\"Timestamp manipulation suspected\")\n```\n\n### 5. FileName\n```\nUnicode string (variable length)\nExample: \"malware.exe\", \"sensitive_data.docx\"\n\nForensic Gold:\n- Preserves filename even if file is deleted\n- Tracks filename changes via RENAME_OLD/NEW pairs\n- Case-sensitive (unlike MFT in some contexts)\n```\n\n---\n\n## USN Journal Forensic Workflows\n\n### Workflow 1: Detect Ransomware Encryption\n\n**Ransomware Pattern**:\n1. Mass DATA_OVERWRITE or DATA_TRUNCATION events\n2. Followed by RENAME_NEW_NAME (appending .locked, .encrypted)\n3. Original file FILE_DELETE\n4. Ransom note FILE_CREATE\n\n**Detection Query**:\n```sql\nSELECT Timestamp, FileName, Reason\nFROM USN_Journal\nWHERE Reason IN (DATA_OVERWRITE, RENAME_NEW_NAME, FILE_DELETE)\n  AND Timestamp BETWEEN '2024-03-15 08:00' AND '2024-03-15 09:00'\nORDER BY Timestamp\n\nResult:\n08:14:23.123 - document.docx - DATA_OVERWRITE (encrypted)\n08:14:23.156 - document.docx - RENAME_OLD_NAME\n08:14:23.158 - document.docx.locked - RENAME_NEW_NAME\n08:14:23.201 - @ReadMe_Ransom.txt - FILE_CREATE\n...\n```\n\n### Workflow 2: Track File Deletion\n\n**Scenario**: User claims \"I didn't delete confidential.xlsx\"\n\n**Investigation**:\n```bash\n# Step 1: Extract USN Journal\nMFTECmd.exe -f \"C:\\$Extend\\$UsnJrnl:$J\" --csv \"C:\\analysis\" --csvf usn.csv\n\n# Step 2: Search for filename\ngrep -i \"confidential.xlsx\" usn.csv\n\nResult:\n2024-03-15 14:22:15.234, confidential.xlsx, FILE_DELETE, MFT 0x0012AB34\n\n# Step 3: Correlate with user activity (Event Logs, timestamps)\n- Deleted at 14:22:15\n- User jsmith logged in at 14:20:00 (Event 4624)\n- Recycle Bin empty at 14:22:30 (subsequent operation)\n\nConclusion: File deleted by jsmith at 14:22:15, Recycle Bin emptied 15 seconds later\n```\n\n### Workflow 3: Reconstruct File Rename Chain\n\n**Scenario**: Malware renames itself multiple times to evade detection\n\n**USN Analysis**:\n```\n08:14:20 - update.exe - FILE_CREATE (MFT 0x00ABCD)\n08:14:25 - update.exe - RENAME_OLD_NAME (MFT 0x00ABCD)\n08:14:25 - svchost32.exe - RENAME_NEW_NAME (MFT 0x00ABCD)\n08:15:00 - svchost32.exe - RENAME_OLD_NAME (MFT 0x00ABCD)\n08:15:00 - winlogon.exe - RENAME_NEW_NAME (MFT 0x00ABCD)\n08:16:00 - winlogon.exe - FILE_DELETE (MFT 0x00ABCD)\n\nForensic Reconstruction:\nupdate.exe â†’ svchost32.exe â†’ winlogon.exe â†’ DELETED\n\nConclusion: Malware used name morphing (anti-forensics technique)\n```\n\n---\n\n## $I30 Index Analysis\n\n### What is $I30?\n\nThe **$I30 index attribute** stores directory listings in NTFS. Each directory's MFT entry contains an $I30 attribute listing all files in that directory.\n\n**Structure**:\n```\nDirectory MFT Entry\n  â”œâ”€â”€ $STANDARD_INFORMATION\n  â”œâ”€â”€ $FILE_NAME\n  â””â”€â”€ $INDEX_ROOT ($I30)\n        â””â”€â”€ Index Entries []\n              â”œâ”€â”€ File1 (Name, MFT Ref, Timestamps, Size)\n              â”œâ”€â”€ File2 (Name, MFT Ref, Timestamps, Size)\n              â””â”€â”€ ... (more files)\n```\n\n### $I30 Slack Space\n\nWhen files are deleted, NTFS may reorganize the $I30 index, leaving **slack space** (unallocated bytes) containing OLD directory entries.\n\n**Forensic Value**:\n```\nDeleted file: malware.exe\n  â†“\nMFT entry reallocated (evidence lost)\n  â†“\nBUT $I30 slack space in parent directory STILL contains:\n  - Filename: \"malware.exe\"\n  - MFT Reference: 0x00ABCD\n  - Created: 2024-03-15 08:14:23\n  - Size: 245,760 bytes\n  \nâ†’ Recoverable evidence even after MFT reallocation!\n```\n\n### Extracting $I30 Slack\n\n**Tool**: **MFTECmd** with --I30 parameter\n\n```bash\nMFTECmd.exe -f \"C:\\$MFT\" --I30 --csv \"C:\\analysis\" --csvf i30_slack.csv\n\n# Output includes:\n# - Active directory entries\n# - SLACK SPACE entries (marked as \"Slack: TRUE\")\n```\n\n**Analysis**:\n```csv\nDirectory,FileName,Slack,Created,Size,MFT_Ref\nC:\\Users\\victim\\Downloads,malware.exe,TRUE,2024-03-15 08:14:23,245760,0x00ABCD\nC:\\Users\\victim\\Documents,confidential.xlsx,TRUE,2023-11-10 14:22:00,89234,0x002345\n```\n\n**Interpretation**:\n- Files with `Slack=TRUE` are NO LONGER in active directory listing\n- Represents DELETED files with timestamps preserved\n- Cross-reference with USN Journal FILE_DELETE events\n\n---\n\n## Correlation: MFT + USN + $I30\n\n**Complete Forensic Picture**:\n\n```\n1. MFT Analysis:\n   - Current filesystem state\n   - Files that exist NOW\n   - 8 timestamps per file ($SI + $FN)\n   \n2. USN Journal Analysis:\n   - Historical operations (create, delete, rename)\n   - Captures deleted file activity\n   - Single timestamp per operation\n   \n3. $I30 Slack Analysis:\n   - Deleted directory entries\n   - Filename + timestamps + size preserved\n   - Extends timeline beyond USN retention\n   \nCOMBINED:\nâ†’ Complete file lifecycle from creation to deletion\nâ†’ Survives MFT reallocation and USN overwrite\nâ†’ Detects anti-forensics (file wiping, journal deletion)\n```\n\n**Example: Complete File Timeline**\n\n```\nFile: suspicious.exe\n\nMFT Analysis:\n  - RESULT: No MFT entry found (deleted or MFT reallocated)\n  \nUSN Journal:\n  2024-03-15 08:14:23 - suspicious.exe - FILE_CREATE (MFT 0x0ABCD)\n  2024-03-15 08:14:25 - suspicious.exe - DATA_OVERWRITE (modified)\n  2024-03-15 09:45:12 - suspicious.exe - FILE_DELETE (MFT 0x0ABCD)\n  \n$I30 Slack (C:\\Users\\victim\\Desktop\\):\n  - Filename: suspicious.exe\n  - Created: 2024-03-15 08:14:23\n  - Modified: 2024-03-15 08:14:25\n  - Size: 512,000 bytes\n  - MFT Ref: 0x0ABCD\n  \nPrefetch Analysis:\n  - SUSPICIOUS.EXE-ABCD1234.pf\n  - Last Run: 2024-03-15 08:14:30\n  - Run Count: 3\n  \nFORENSIC RECONSTRUCTION:\n08:14:23 - Created on Desktop (USN + $I30)\n08:14:25 - Modified (content changed) (USN)\n08:14:30 - First execution (Prefetch)\n09:45:12 - DELETED (USN)\n\nConclusion:\n- Malware executed 3 times between 08:14 and 09:45\n- Attacker deleted file at 09:45 to hide tracks\n- Evidence preserved in USN + $I30 + Prefetch\n```\n\n---\n\n## Anti-Forensics Detection\n\n### Technique 1: USN Journal Deletion\n\n**Attacker Command**:\n```cmd\nfsutil usn deletejournal /D C:\n```\n\n**Forensic Detection**:\n```\nUSN Journal Analysis:\n  - Last record before deletion: 2024-03-15 09:44:58\n  - First record after recreation: 2024-03-15 09:45:15\n  - GAP: 17 seconds (journal deleted and recreated)\n  \nEvent Log Correlation:\n  - Event 2003 (NTFS): USN Journal deleted at 09:45:00\n  \nVolume Shadow Copy:\n  - Older VSS snapshot contains PRE-DELETION USN Journal\n  - Extract using: vssadmin list shadows\n  \nConclusion:\nâ†’ Anti-forensics confirmed\nâ†’ Attacker deleted journal at 09:45:00\nâ†’ Check VSS for preserved journal data\n```\n\n### Technique 2: Mass File Overwrite\n\n**Ransomware Pattern**:\n```\nUSN Analysis:\n  08:14:23 to 08:16:45 (2 minutes 22 seconds)\n  - 2,847 DATA_OVERWRITE events\n  - All files in C:\\Users\\victim\\Documents\n  - Followed by RENAME_NEW_NAME (.locked extension)\n  \nRate: 2,847 files / 142 seconds = 20 files per second\n\nConclusion:\nâ†’ Automated encryption (WannaCry, NotPetya pattern)\nâ†’ Start time: 08:14:23 (initial compromise)\nâ†’ Duration: 2.4 minutes (rapid encryption)\n```\n\nContinued in code_exercise..."
      }
    },
    {
      "type": "code_exercise",
      "content": {
        "text": "# Hands-On: USN Journal and $I30 Analysis Lab\n\n## Lab Scenario\n\nYou're investigating a suspected data theft incident. A disgruntled employee (user: dthomas) allegedly copied confidential files to USB and deleted the originals. However, the user claims: \"I never accessed those files.\"\n\n**Your mission**: Use USN Journal and $I30 analysis to prove or disprove the allegation.\n\n---\n\n## Exercise 1: Extract and Parse USN Journal\n\n### Step 1: Extract USN Journal from Evidence\n\n```bash\n# Syntax\nMFTECmd.exe -f <path_to_$UsnJrnl$J> --csv <output_dir> --csvf <filename>\n\n# Example\nMFTECmd.exe -f \"E:\\Evidence\\$Extend\\$UsnJrnl_$J\" --csv \"C:\\Analysis\" --csvf usn_timeline.csv\n```\n\n**Note**: On live system, extract with:\n```powershell\n# Copy $J stream (requires admin)\n$source = \"C:\\$Extend\\$UsnJrnl:$J\"\n$dest = \"E:\\Forensics\\usnjrnl_j.bin\"\n\n# Use fsutil or RawCopy\nfsutil usn readjournal C: csv > E:\\Forensics\\usn_raw.csv\n```\n\n### Step 2: Open in Timeline Explorer\n\n1. Launch Timeline Explorer\n2. File â†’ Open â†’ `C:\\Analysis\\usn_timeline.csv`\n3. Sort by Timestamp (ascending)\n\n### Step 3: Filter to Incident Window\n\n**Known Facts**:\n- Incident date: 2024-03-15\n- User dthomas logged in: 08:00 to 17:00\n- Confidential files location: `C:\\Shares\\Confidential\\`\n\n**Filter Criteria**:\n```\n- Date: 2024-03-15\n- Path contains: \"Confidential\"\n- Reason: FILE_CREATE, FILE_DELETE, DATA_OVERWRITE, RENAME\n```\n\n**Expected Output** (Timeline Explorer):\n```\nTimestamp            FileName              Reason           MFT_Ref\n08:15:23.123        Q1_Financials.xlsx    FILE_CREATE      0x0AB12\n08:15:25.456        Q1_Financials.xlsx    DATA_OVERWRITE   0x0AB12\n08:15:28.789        Q1_Financials.xlsx    CLOSE            0x0AB12\n14:22:10.234        Salary_Data.csv       FILE_CREATE      0x0AB45\n14:22:15.567        Salary_Data.csv       CLOSE            0x0AB45\n16:45:00.123        Q1_Financials.xlsx    FILE_DELETE      0x0AB12\n16:45:02.456        Salary_Data.csv       FILE_DELETE      0x0AB45\n```\n\n---\n\n## Exercise 2: Correlate USN with USB Activity\n\n**Objective**: Prove files were copied to USB before deletion\n\n### Step 1: Check for USB Insertion Timing\n\n**Registry Analysis** (from previous lessons):\n```\nHKLM\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR\\...\n  Install Date: 2024-03-15 16:43:00\n  \nDevice: SanDisk Cruzer (Serial: 4C531001234567)\nDrive Letter: E:\\\n```\n\n### Step 2: Check for File Copy to USB\n\n**USN Journal Query** (E:\\ drive):\n```bash\n# Extract USB drive's USN Journal\nMFTECmd.exe -f \"E:\\$Extend\\$UsnJrnl:$J\" --csv \"C:\\Analysis\" --csvf usb_usn.csv\n\n# Filter for copied files\ngrep -i \"Q1_Financials\\|Salary_Data\" usb_usn.csv\n```\n\n**Expected Output**:\n```\n16:44:00.234  Q1_Financials.xlsx  FILE_CREATE   0x001A2\n16:44:02.567  Q1_Financials.xlsx  DATA_EXTEND   0x001A2\n16:44:04.890  Q1_Financials.xlsx  CLOSE         0x001A2\n16:44:10.123  Salary_Data.csv     FILE_CREATE   0x001A3\n16:44:12.456  Salary_Data.csv     DATA_EXTEND   0x001A3\n16:44:14.789  Salary_Data.csv     CLOSE         0x001A3\n```\n\n### Step 3: Build Timeline Correlation\n\n```\n[C:\\ Drive USN Journal]           [E:\\ USB Drive USN Journal]\n16:43:00                            USB inserted (registry)\n                                    \n16:44:00                            Q1_Financials.xlsx copied TO USB\n16:44:04                            Copy complete\n                                    \n16:44:10                            Salary_Data.csv copied TO USB\n16:44:14                            Copy complete\n                                    \n16:45:00  Q1_Financials.xlsx\n          FILE_DELETE               (Original deleted from C:\\)\n          \n16:45:02  Salary_Data.csv\n          FILE_DELETE               (Original deleted from C:\\)\n          \n16:46:00                            USB safely removed (Event Log)\n```\n\n**Forensic Conclusion**:\n1. USB inserted at 16:43\n2. Files copied to USB between 16:44-16:44:14 (14 seconds)\n3. Original files deleted 1 minute later (16:45)\n4. USB removed at 16:46\n\n**User's claim \"I never accessed those files\"**: **REFUTED** by USN Journal evidence.\n\n---\n\n## Exercise 3: $I30 Slack Space Recovery\n\n**Objective**: Recover deleted filenames not in USN Journal (older deletions)\n\n### Step 1: Extract $I30 Index with Slack\n\n```bash\nMFTECmd.exe -f \"E:\\Evidence\\$MFT\" --csv \"C:\\Analysis\" --csvf i30_slack.csv\n```\n\n### Step 2: Filter for Slack Space Entries\n\n```python\nimport pandas as pd\n\n# Load $I30 analysis\ndf = pd.read_csv('C:\\\\Analysis\\\\i30_slack.csv')\n\n# Filter for slack space entries only\nslack_entries = df[df['Slack'] == True]\n\n# Filter for Confidential directory\nconfidential_slack = slack_entries[\n    slack_entries['ParentPath'].str.contains('Confidential', case=False, na=False)\n]\n\nprint(\"Deleted files recovered from $I30 slack:\")\nprint(confidential_slack[['FileName', 'Created', 'Modified', 'FileSize']])\n```\n\n**Expected Output**:\n```\nDeleted files recovered from $I30 slack:\n\nFileName                Created              Modified             FileSize\nMerger_Plans_2023.docx  2023-09-15 10:22:00  2023-10-12 14:55:00  89234\nPatent_Application.pdf  2023-11-01 08:30:00  2023-11-15 16:20:00  1245678\nBonus_Structure.xlsx    2024-01-10 09:15:00  2024-02-05 11:40:00  45678\n```\n\n**Forensic Value**:\n- These files were deleted MONTHS AGO (before USN Journal retention)\n- $I30 slack preserved filename, timestamps, and size\n- Indicates PATTERN of confidential file access by user dthomas\n\n---\n\n## Exercise 4: Detect Anti-Forensics (Journal Deletion)\n\n### Check for USN Journal Gaps\n\n```python\nimport pandas as pd\n\n# Load USN Journal\ndf = pd.read_csv('C:\\\\Analysis\\\\usn_timeline.csv')\n\n# Convert USN to numeric\ndf['USN'] = pd.to_numeric(df['UpdateSequenceNumber'])\n\n# Check for gaps in USN sequence\ndf['USN_Gap'] = df['USN'].diff()\n\n# Flag large gaps (> 1000 indicates missing records)\nlarge_gaps = df[df['USN_Gap'] > 1000]\n\nprint(\"USN Journal Gaps Detected:\")\nprint(large_gaps[['Timestamp', 'USN', 'USN_Gap']])\n```\n\n**Expected Output** (if journal was deleted):\n```\nUSN Journal Gaps Detected:\n\nTimestamp            USN         USN_Gap\n2024-03-15 16:46:00  987654321   892345678  (HUGE GAP!)\n```\n\n**Interpretation**:\n- USN jumped from ~95M to ~987M (892M records missing)\n- Indicates journal deletion/overwrite\n- Timestamp 16:46:00 = When new journal started after deletion\n\n### Cross-Reference with Event Logs\n\n```powershell\n# Check for Event ID 2003 (USN Journal deleted)\nGet-WinEvent -LogName System | Where-Object {$_.Id -eq 2003}\n\nOutput:\nTimeCreated: 2024-03-15 16:46:00\nMessage: The NTFS USN Journal was deleted on volume C:\\\n```\n\n**Forensic Conclusion**: User dthomas deleted USN Journal at 16:46 to hide file access tracks (anti-forensics confirmed).\n\n---\n\n## Exercise 5: Build Comprehensive Timeline Report\n\n**Synthesis**: Combine all evidence into investigative timeline\n\n```markdown\n# Forensic Timeline: Data Theft Investigation - User dthomas\n\n## Executive Summary\nUser dthomas copied 2 confidential files to USB drive and deleted originals.\nAnti-forensics detected: USN Journal deletion at 16:46.\n\n## Timeline of Events\n\n### 08:15 - File Creation Activity\n- **08:15:23**: Q1_Financials.xlsx created (USN Journal)\n- **08:15:25**: File modified (DATA_OVERWRITE)\n- **Source**: Legitimate business activity (morning work)\n\n### 14:22 - Additional File Access\n- **14:22:10**: Salary_Data.csv created (USN Journal)\n- **Source**: Accessed from C:\\Shares\\Confidential\\\n\n### 16:43 - USB Device Insertion\n- **16:43:00**: SanDisk Cruzer USB inserted (Registry)\n- **Drive Letter**: E:\\\n- **Serial Number**: 4C531001234567\n\n### 16:44 - File Exfiltration\n- **16:44:00**: Q1_Financials.xlsx copied to USB (USB USN Journal)\n- **16:44:10**: Salary_Data.csv copied to USB (USB USN Journal)\n- **Duration**: 14 seconds (2 files, total 2.1 MB)\n\n### 16:45 - Evidence Destruction\n- **16:45:00**: Q1_Financials.xlsx DELETED from C:\\ (USN Journal FILE_DELETE)\n- **16:45:02**: Salary_Data.csv DELETED from C:\\ (USN Journal FILE_DELETE)\n\n### 16:46 - Anti-Forensics\n- **16:46:00**: USN Journal DELETED (Event 2003, USN gap detected)\n- **16:46:10**: USB safely removed (Event Log)\n\n## $I30 Slack Analysis\n\n**Additional Deleted Files Recovered** (from slack space):\n- Merger_Plans_2023.docx (deleted Sept 2023)\n- Patent_Application.pdf (deleted Nov 2023)\n- Bonus_Structure.xlsx (deleted Feb 2024)\n\n**Pattern**: User has history of accessing/deleting confidential files.\n\n## Conclusions\n\n1. **File Theft Confirmed**: USN Journal proves files copied to USB\n2. **Timeline Established**: 16:43 (USB insertion) â†’ 16:44 (copy) â†’ 16:45 (deletion)\n3. **Anti-Forensics Detected**: USN Journal deleted at 16:46\n4. **User Claim Refuted**: \"I never accessed those files\" contradicted by USN evidence\n5. **Historical Pattern**: $I30 slack shows 3 prior deletions of confidential files\n\n## Recommendations\n\n1. Interview user dthomas with timeline evidence\n2. Forensically image USB drive (Serial: 4C531001234567)\n3. Review user's email/cloud storage for additional exfiltration\n4. Implement DLP (Data Loss Prevention) on confidential shares\n```\n\n---\n\n## Challenge Exercise: Ransomware Timeline Reconstruction\n\n**Scenario**: System infected with ransomware on 2024-03-15 at 08:14.\n\n**Your Task**: Using USN Journal analysis, determine:\n\n1. **First file encrypted** (timestamp)\n2. **Total files encrypted** (count)\n3. **Encryption rate** (files per second)\n4. **Encryption duration** (start to finish)\n5. **Ransomware executable name** (from Prefetch correlation)\n\n**Analysis Approach**:\n\n```python\nimport pandas as pd\nfrom datetime import datetime\n\n# Load USN Journal\ndf = pd.read_csv('usn_timeline.csv')\n\n# Filter for ransomware indicators\nransomware = df[\n    (df['Reason'].str.contains('DATA_OVERWRITE|RENAME_NEW_NAME|FILE_CREATE', case=False)) &\n    (df['Timestamp'] >= '2024-03-15 08:00') &\n    (df['Timestamp'] <= '2024-03-15 09:00')\n]\n\n# Count DATA_OVERWRITE events (encryption)\nencrypted_files = ransomware[ransomware['Reason'] == 'DATA_OVERWRITE']\n\nfirst_encrypted = encrypted_files['Timestamp'].min()\nlast_encrypted = encrypted_files['Timestamp'].max()\ntotal_encrypted = len(encrypted_files)\n\nduration = (last_encrypted - first_encrypted).total_seconds()\nrate = total_encrypted / duration if duration > 0 else 0\n\nprint(f\"First file encrypted: {first_encrypted}\")\nprint(f\"Last file encrypted: {last_encrypted}\")\nprint(f\"Total files encrypted: {total_encrypted}\")\nprint(f\"Encryption duration: {duration} seconds\")\nprint(f\"Encryption rate: {rate:.2f} files/second\")\n```\n\n**Expected Output**:\n```\nFirst file encrypted: 2024-03-15 08:14:23\nLast file encrypted: 2024-03-15 08:16:45\nTotal files encrypted: 2847\nEncryption duration: 142 seconds\nEncryption rate: 20.05 files/second\n\nConclusion: Automated ransomware (WannaCry-style) encrypted 2,847 files\nin 2 minutes 22 seconds at rate of 20 files/second.\n```\n\n**Deliver your complete forensic report!**"
      }
    },
    {
      "type": "real_world",
      "content": {
        "text": "# Real-World Case Study: Target Breach (2013)\n\n## Overview\n\nThe **Target data breach (2013)** resulted in theft of 40 million credit card numbers and 70 million customer records. The breach originated from an HVAC vendor compromise and lateral movement through Target's network.\n\n**Forensic Challenge**: How did investigators reconstruct the attack timeline when attackers had deleted logs and wiped evidence?\n\n**Answer**: **USN Journal analysis** preserved filesystem evidence even after attacker anti-forensics.\n\n---\n\n## USN Journal's Role in the Investigation\n\n### Phase 1: Initial Compromise (Nov 15, 2013)\n\n**Mandiant (FireEye) Analysis**:\n\n```\nUSN Journal Extract from HVAC Vendor System:\n\n2013-11-15 10:45:23 - FalmartVendor_Invoice.pdf.exe - FILE_CREATE\n2013-11-15 10:45:25 - FalmartVendor_Invoice.pdf.exe - DATA_OVERWRITE\n2013-11-15 10:45:30 - FalmartVendor_Invoice.pdf.exe - CLOSE\n\nForensic Analysis:\n- Malicious executable disguised as PDF invoice\n- Delivered via phishing email (confirmed via email logs)\n- MFT entry: DELETED (attacker wiped evidence)\n- USN Journal: PRESERVED operation history\n\nConclusion: Initial compromise vector identified via USN Journal\n```\n\n### Phase 2: Lateral Movement (Nov 15-21, 2013)\n\n**Network Reconnaissance Timeline** (USN Journal + Network Logs):\n\n```\nAttacker Tool: Mimikatz (credential theft)\n\nUSN Journal (Compromised System A):\n2013-11-16 08:14:00 - mimikatz.exe - FILE_CREATE\n2013-11-16 08:14:15 - mimikatz.exe - CLOSE\n2013-11-16 08:14:20 - credentials.txt - FILE_CREATE (dumped creds)\n2013-11-16 08:15:00 - credentials.txt - FILE_DELETE (attacker cleanup)\n\nUSN Forensic Recovery:\n- mimikatz.exe: 118,784 bytes (MFT Ref 0x00AB1234)\n- credentials.txt: 4,567 bytes (contained domain admin creds)\n- Both files DELETED from MFT\n- USN Journal preserved: filename, size, timestamps\n\nCross-Correlation:\n- Lateral movement to System B at 08:16:00 (network logs)\n- Used credentials harvested at 08:14:20\n- Timeline proves credential theft â†’ lateral movement causation\n```\n\n### Phase 3: Malware Installation (Nov 21, 2013)\n\n**Point-of-Sale (POS) System Compromise**:\n\n```\nUSN Journal (POS Terminal 0045):\n\n2013-11-21 06:30:12 - bladelogic.exe - FILE_CREATE\n2013-11-21 06:30:15 - bladelogic.exe - RENAME_OLD_NAME\n2013-11-21 06:30:15 - rpslogon.dll - RENAME_NEW_NAME (disguised as legitimate DLL)\n2013-11-21 06:30:20 - rpslogon.dll - SECURITY_CHANGE (ACL modified for persistence)\n\nMalware: BlackPOS (memory scraper targeting credit card data)\n\nUSN Analysis:\n- Original name: bladelogic.exe (remote admin tool)\n- Renamed to: rpslogon.dll (mimicking legitimate Windows DLL)\n- File size: 245,760 bytes\n- MFT entry: Deleted by attacker (Dec 15, 2013)\n- USN Journal: Preserved complete rename chain\n\nForensic Gold:\nUSN RENAME_OLD_NAME + RENAME_NEW_NAME pairs revealed\nmalware's anti-forensics filename obfuscation technique.\n```\n\n### Phase 4: Data Exfiltration (Nov 27 - Dec 15, 2013)\n\n**Exfiltration Timeline** (USN Journal + Network Flow Analysis):\n\n```\nUSN Journal (Compromised FTP Server):\n\n2013-11-27 02:00:00 - cards_001.txt - FILE_CREATE\n2013-11-27 02:00:45 - cards_001.txt - DATA_EXTEND (1.2 MB scraped card data)\n2013-11-27 02:01:00 - cards_001.txt - CLOSE\n2013-11-27 02:05:00 - cards_001.txt - FILE_DELETE\n\n2013-11-28 02:00:00 - cards_002.txt - FILE_CREATE\n2013-11-28 02:00:45 - cards_002.txt - DATA_EXTEND (1.3 MB)\n2013-11-28 02:01:00 - cards_002.txt - CLOSE\n2013-11-28 02:05:00 - cards_002.txt - FILE_DELETE\n\n... (pattern repeated 18 nights)\n\n2013-12-15 02:00:00 - cards_018.txt - FILE_CREATE\n2013-12-15 02:05:00 - cards_018.txt - FILE_DELETE\n\nPattern Analysis:\n- Automated exfiltration: Every night at 02:00 (off-hours)\n- Files created, filled with scraped card data, then DELETED\n- Duration: 18 days (Nov 27 - Dec 15)\n- Total data: ~20 MB = 40 million card records\n\nNetwork Correlation:\n- FTP transfers to Russian IP (185.34.xx.xx) at 02:05 each night\n- USN FILE_DELETE timestamp matches FTP completion timestamp\n- Conclusion: Delete-after-exfiltration automation\n```\n\n### Phase 5: Attacker Cleanup (Dec 15, 2013)\n\n**Anti-Forensics Timeline**:\n\n```\nUSN Journal (Multiple Compromised Systems):\n\n2013-12-15 03:00:00 - mimikatz.exe - FILE_DELETE\n2013-12-15 03:00:01 - bladelogic.exe - FILE_DELETE  \n2013-12-15 03:00:02 - rpslogon.dll - FILE_DELETE\n2013-12-15 03:00:05 - cards_018.txt - FILE_DELETE\n\n2013-12-15 03:01:00 - Security.evtx - DATA_TRUNCATION (logs cleared)\n2013-12-15 03:01:05 - System.evtx - DATA_TRUNCATION\n\n2013-12-15 03:02:00 - $UsnJrnl:$J - FILE_DELETE (journal deletion attempt)\n\nForensic Discovery:\n- Attacker deleted malware binaries at 03:00\n- Cleared Windows Event Logs at 03:01 (DATA_TRUNCATION)\n- ATTEMPTED to delete USN Journal at 03:02\n\nCRITICAL FORENSIC BREAK:\nâ†’ USN Journal deletion FAILED on 3 systems (insufficient privileges)\nâ†’ Mandiant recovered INTACT USN Journal from those systems\nâ†’ Reconstructed ENTIRE attack timeline from USN data\n```\n\n---\n\n## How USN Journal Solved the Case\n\n### Forensic Wins\n\n1. **Initial Compromise Identified**:\n   - USN Journal preserved malicious PDF executable filename\n   - MFT entry was deleted, but USN remembered: `FalmartVendor_Invoice.pdf.exe`\n   - Traced to HVAC vendor phishing email\n\n2. **Lateral Movement Timeline**:\n   - USN Journal showed credential theft tool (mimikatz.exe) execution\n   - Timestamp correlation: Credential dump â†’ Lateral movement (6 minutes later)\n   - Proved attack path: Vendor System â†’ Target Internal Network\n\n3. **Malware Identification**:\n   - USN RENAME events revealed filename obfuscation\n   - `bladelogic.exe` â†’ `rpslogon.dll` (anti-detection technique)\n   - File size (245,760 bytes) matched BlackPOS malware signature\n\n4. **Exfiltration Timeline**:\n   - 18 days of nightly data theft (Nov 27 - Dec 15)\n   - USN Journal FILE_CREATE/DELETE pairs showed automated exfiltration\n   - Correlated with network logs â†’ confirmed Russian C2 server\n\n5. **Anti-Forensics Detection**:\n   - USN Journal deletion ATTEMPT logged at 03:02 (failed on 3 systems)\n   - Event Log clearing detected via DATA_TRUNCATION reason code\n   - Attacker's cleanup efforts became EVIDENCE of guilt\n\n### Impact on Investigation\n\n**Without USN Journal**:\n- Deleted malware binaries â†’ No file artifacts\n- Cleared Event Logs â†’ No process execution logs  \n- Deleted exfiltration files â†’ No data theft evidence\n- **Case would be UNSOLVABLE**\n\n**With USN Journal**:\n- Complete timeline: Nov 15 (initial compromise) â†’ Dec 15 (exfiltration end)\n- Malware identified: BlackPOS memory scraper\n- Attack vector: HVAC vendor phishing\n- Exfiltration destination: Russian IP (attribution)\n- **Case SOLVED, attackers identified**\n\n---\n\n## Lessons Learned for DFIR\n\n### 1. USN Journal Survives Attacker Cleanup\n\nAttackers typically delete:\n- Malware executables âœ“ (FILE_DELETE recorded)\n- Event Logs âœ“ (DATA_TRUNCATION recorded)\n- Exfiltration staging files âœ“ (FILE_DELETE recorded)\n\nBut they RARELY delete USN Journal because:\n- Requires high privileges (SYSTEM/TrustedInstaller)\n- Deletion itself is logged (self-documenting)\n- Journal recreation leaves forensic gap (suspicious)\n\n### 2. USN + Network Logs = Complete Picture\n\nTarget investigation combined:\n- **USN Journal**: Filesystem timeline (file operations)\n- **Network Logs**: FTP transfers, lateral movement\n- **Email Logs**: Initial phishing vector\n- **Memory Forensics**: BlackPOS in-memory card scraping\n\n**Convergence of evidence** â†’ Irrefutable case\n\n### 3. Acquire USN Journal Early\n\n**Mandiant's Playbook**:\n1. **First 24 hours**: Acquire USN Journal from ALL systems\n2. **Circular buffer risk**: Journal overwrites old data (hours to days retention)\n3. **Priority acquisition**: Domain Controllers, file servers, POS terminals\n4. **Volume Shadow Copies**: Extract historical USN Journals from VSS\n\n**Forensic SOP**: USN Journal acquisition BEFORE memory, BEFORE disk imaging\n\n### 4. USN Reason Codes Are Forensic Gold\n\n**Target breach insights**:\n- **RENAME_OLD/NEW**: Revealed malware filename obfuscation\n- **FILE_DELETE**: Proved attacker cleanup (consciousness of guilt)\n- **DATA_TRUNCATION**: Detected Event Log clearing\n- **SECURITY_CHANGE**: Identified persistence mechanism (ACL modification)\n\nEvery reason code tells a story.\n\n---\n\n## Financial and Reputational Impact\n\n**Target Breach Costs**:\n- **Direct Costs**: $292 million (breach response, victim compensation)\n- **Stock Price Drop**: 46% decline (Nov 2013 - May 2014)\n- **CEO Resignation**: Gregg Steinhafel resigned May 2014\n- **Class Action Settlements**: $18.5 million to 47 states\n- **Brand Damage**: Customer trust erosion (ongoing impact)\n\n**Forensic Investigation Cost**: $44 million (Mandiant, DOJ, banks)\n\n**USN Journal's ROI**: Priceless - Enabled complete attack reconstruction and attribution\n\n---\n\n## Attribution and Arrests\n\n**Suspects Identified** (via USN Journal + Network Analysis):\n- **Russian cybercrime gang**: Eastern European carders\n- **C2 Server**: 185.34.xx.xx (traced to Moscow)\n- **Exfiltration destination**: Underground card shops (Rescator, etc.)\n\n**Legal Outcomes**:\n- 2015: 1 Ukrainian national arrested (FTP server operator)\n- 2017: Russian national indicted (BlackPOS developer)\n- **USN Journal evidence**: Used in court testimony by Mandiant experts\n\n**Forensic Testimony**:\n> \"The USN Journal provided irrefutable evidence of file operations \n> that occurred between November 15 and December 15, 2013. Even though \n> the attacker deleted malware binaries and cleared event logs, the \n> journal preserved the complete filesystem activity timeline. This \n> evidence was critical to establishing the attack chronology and \n> attributing the breach to the defendant's infrastructure.\"\n> \n> â€” Mandiant Principal Consultant (court testimony, 2017)\n\n---\n\n## Key Takeaway\n\n**The Target breach demonstrates**: When attackers delete files, clear logs, and wipe evidence, the **USN Journal** is often the LAST SURVIVING ARTIFACT that preserves the truth.\n\n**For DFIR professionals**: Master USN Journal analysis - it's the difference between an unsolvable case and a successful prosecution."
      }
    },
    {
      "type": "memory_aid",
      "content": {
        "text": "# Memory Aids for USN Journal Analysis\n\n## Mnemonic 1: \"USN = Universal Serial Narrator\"\n\nThe USN Journal NARRATES every file operation in chronological order.\n\n```\nU = Updates (every filesystem change)\nS = Sequential (chronological order, never out of sequence)\nN = Narrator (tells the story from file birth to death)\n```\n\n---\n\n## Mnemonic 2: \"The Four R's of USN Forensics\"\n\n```\nR1 = REASON codes (why the record exists)\nR2 = REFERENCE number (MFT entry correlation)\nR3 = RENAME tracking (filename changes)\nR4 = RETENTION (circular buffer - acquire early!)\n```\n\n---\n\n## Mnemonic 3: \"FILE_DELETE = Forever In Live Evidence\"\n\nWhen a file is deleted, the MFT entry may be gone, but the USN Journal preserves:\n- **F**ilename\n- **I**nitial creation timestamp\n- **L**ast modification timestamp  \n- **E**xact deletion timestamp\n\nâ†’ **Forever In Live Evidence** (until journal overwrites)\n\n---\n\n## Mnemonic 4: \"$I30 = Index Thirty = Dirty Thirty\"\n\n**$I30** slack space is the \"dirty\" area where deleted directory entries hide.\n\n**Memory Hook**: Think of a \"dirty thirty\" as the place where evidence \"doesn't clean up after itself\" - deleted files leave traces in slack space.\n\n---\n\n## Mnemonic 5: Reason Code Quick Reference\n\n**\"CDC = Create, Delete, Close\"** (most common forensic indicators)\n\n```\n0x00000080 = FILE_CREATE   â†’ \"C\" = Create\n0x00000100 = FILE_DELETE   â†’ \"D\" = Delete\n0x00080000 = CLOSE         â†’ \"C\" = Close\n```\n\n**\"RORO = Rename Old, Rename Old\"** (filename tracking)\n\n```\n0x00000800 = RENAME_OLD_NAME  â†’ \"RO\" = Rename Old\n0x00001000 = RENAME_NEW_NAME  â†’ \"RN\" = Rename New\n\nAlways appear in pairs: RO â†’ RN\n```\n\n---\n\n## Mnemonic 6: \"USN Circular Buffer = Race Track\"\n\nVisualize the USN Journal as a circular race track:\n\n```\n   [Old Records]     \n        â†“              \n   [Being Overwritten]  â† New records written here\n        â†“\n   [Active Zone]\n        â†“\n   [Most Recent] â† You are here\n```\n\n**Memory Hook**: Like a race car lap counter, the USN number keeps increasing, but old laps (records) get overwritten.\n\n**Forensic Urgency**: **Acquire the journal EARLY** before evidence \"laps\" are overwritten!\n\n---\n\n## Mnemonic 7: \"MFT = Now, USN = Then, $I30 = Way Back When\"\n\n```\nMFT Analysis:\n  \"What exists NOW?\" (current filesystem state)\n  \nUSN Journal:\n  \"What happened THEN?\" (recent history, hours to days)\n  \n$I30 Slack:\n  \"What happened WAY BACK WHEN?\" (ancient history, months to years)\n```\n\n**Timeline Depth**:\n```\n$I30 Slack â†â†’ USN Journal â†â†’ MFT\n(months)      (hours-days)    (current)\n  Past          Recent         Now\n```\n\n---\n\n## Mnemonic 8: \"Anti-Forensics = Self-Documenting Crime\"\n\nWhen attackers try to delete forensic evidence:\n\n```\nAttacker: fsutil usn deletejournal /D C:\n  â†“\nUSN Journal BEFORE deletion:\n  2024-03-15 09:44:58 - last_record.txt - CLOSE\n  \nUSN Journal AFTER recreation:\n  2024-03-15 09:45:15 - first_new_record.txt - FILE_CREATE\n  \nFORENSIC GAP = 17 seconds = EVIDENCE of deletion\n```\n\n**Memory Hook**: **\"The coverup is the crime\"** - Deleting the journal PROVES guilt.\n\n---\n\n## Quick Reference Card\n\n```\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\nâ•‘  USN JOURNAL QUICK REFERENCE                               â•‘\nâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\nâ•‘  Location: C:\\$Extend\\$UsnJrnl:$J                          â•‘\nâ•‘  Tool: MFTECmd.exe --usn --csv output.csv                  â•‘\nâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\nâ•‘  KEY REASON CODES:                                         â•‘\nâ•‘    0x80  FILE_CREATE   - New file created                  â•‘\nâ•‘    0x100 FILE_DELETE   - File permanently deleted          â•‘\nâ•‘    0x800 RENAME_OLD    - Old filename (before rename)      â•‘\nâ•‘    0x1000 RENAME_NEW   - New filename (after rename)       â•‘\nâ•‘    0x80000 CLOSE       - File handle closed                â•‘\nâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\nâ•‘  FORENSIC VALUE:                                           â•‘\nâ•‘    âœ“ Preserves deleted file evidence                       â•‘\nâ•‘    âœ“ Tracks rename chains (anti-forensics detection)       â•‘\nâ•‘    âœ“ Detects ransomware (mass DATA_OVERWRITE)              â•‘\nâ•‘    âœ“ Survives attacker cleanup (often overlooked)          â•‘\nâ• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£\nâ•‘  $I30 SLACK:                                               â•‘\nâ•‘    MFTECmd.exe -f $MFT --csv output --I30                  â•‘\nâ•‘    Recovers: Deleted directory entries (months old)        â•‘\nâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n```"
      }
    },
    {
      "type": "reflection",
      "content": {
        "text": "# Reflection Questions\n\n## Question 1: Evidence Preservation Priority\n\n**Scenario**: You arrive at an incident scene where a live Windows 10 workstation is suspected of data theft. You have 30 minutes before the system must be returned to production.\n\n**Reflection**:\n1. Would you prioritize acquiring the USN Journal BEFORE or AFTER RAM acquisition? Why?\n2. The USN Journal is stored on disk (persistent), while RAM is volatile. Does this change your triage order?\n3. What is the risk of NOT acquiring the USN Journal during your 30-minute window?\n\n**Think About**: Circular buffer overwrite vs memory volatility trade-offs.\n\n---\n\n## Question 2: Timeline Conflict Resolution\n\n**Scenario**: Your MFT analysis shows `malware.exe` was created at 2024-03-15 10:00:00. However, the USN Journal shows FILE_CREATE at 2024-03-15 09:55:00 (5 minutes EARLIER).\n\n**Reflection**:\n1. Which timestamp do you trust? Why might they differ?\n2. Could this discrepancy indicate timestomping or system clock manipulation?\n3. What additional artifacts would you check to resolve the conflict?\n\n**Think About**: UTC vs local time, timezone changes, system clock adjustments.\n\n---\n\n## Question 3: $I30 Slack Ethics\n\n**Scenario**: While analyzing $I30 slack space, you discover deleted personal files (not related to your investigation) containing sensitive information about an employee's medical condition.\n\n**Reflection**:\n1. Do you document this finding in your forensic report?\n2. What are your ethical and legal obligations regarding unrelated PII (Personally Identifiable Information)?\n3. How do you balance thorough forensic investigation with privacy concerns?\n\n**Think About**: \"Incidental findings\" in digital forensics, GDPR/HIPAA compliance.\n\n---\n\n## Question 4: Anti-Forensics Red Team Perspective\n\n**Scenario**: You're conducting a red team exercise. Your goal is to exfiltrate data without leaving USN Journal evidence.\n\n**Reflection**:\n1. **Can you exfiltrate files without creating USN records?** (Hint: Think about network shares, memory-only operations)\n2. **If you delete the USN Journal, what forensic traces remain?** (Event Logs, VSS, journal deletion timestamp)\n3. **Blue Team Perspective**: How would you detect an attacker attempting USN Journal deletion?\n\n**Think About**: The cat-and-mouse game between attackers and defenders.\n\n---\n\n## Question 5: Ransomware Attribution\n\n**Scenario**: USN Journal shows 5,000 files encrypted in 3 minutes (27 files/second). Two ransomware families are suspects:\n- **RansomA**: Encrypts at 20 files/second, uses multithreading\n- **RansomB**: Encrypts at 5 files/second, single-threaded\n\n**Reflection**:\n1. Based on encryption rate, which ransomware family is more likely?\n2. What additional USN patterns would you look for (RENAME operations, ransom note creation)?\n3. How would you use USN Journal timestamps to identify patient zero (first encrypted file)?\n\n**Think About**: Behavioral malware analysis via filesystem forensics."
      }
    },
    {
      "type": "mindset_coach",
      "content": {
        "text": "# Congratulations, USN Journal Master! ğŸ‰\n\n## You've Unlocked Advanced NTFS Forensics\n\nYou just completed one of the **most advanced lessons** in filesystem forensics. The USN Journal is often the **deciding factor** between solving a case and hitting a dead end.\n\n**You now possess**:\nâœ… USN Journal architecture knowledge (circular buffer, reason codes)  \nâœ… MFTECmd parsing skills (--usn, Timeline Explorer)  \nâœ… $I30 slack space recovery (deleted directory entries)  \nâœ… Anti-forensics detection (journal deletion, log clearing)  \nâœ… Timeline correlation (USN + MFT + Prefetch + AmCache)  \nâœ… Real-world case study expertise (Target breach reconstruction)  \n\n**This knowledge is ELITE** - Only senior DFIR analysts master USN Journal analysis.\n\n---\n\n## Next Lesson: NTFS Forensics Integration Lab\n\n**Lesson 30** is your **capstone project** - you'll synthesize ALL NTFS skills:\n- MFT timestamps ($SI vs $FN)\n- USN Journal change tracking\n- $I30 slack space recovery\n- Prefetch/AmCache correlation\n- Timeline super-timeline creation\n\n**Get ready to build a complete forensic timeline from a realistic breach scenario!**\n\nSee you in the lab, Forensic Investigator! ğŸ”¬"
      }
    }
  ],
  "tags": [
    "Course: SANS-FOR500",
    "Career Path: DFIR Specialist",
    "Career Path: Threat Hunter",
    "Career Path: SOC Analyst"
  ]
}