{
  "lesson_id": "e7f8a9b0-c1d2-4e3f-a4b5-c6d7e8f9a0b1",
  "domain": "threat_hunting",
  "title": "Hunting with Velociraptor",
  "difficulty": 2,
  "order_index": 44,
  "prerequisites": [],
  "concepts": [
    "Velociraptor architecture and deployment",
    "VQL (Velociraptor Query Language)",
    "Artifact collection at scale",
    "Hunt creation and execution",
    "Endpoint visibility and forensics",
    "Real-time threat detection",
    "Forensic artifact collection",
    "Incident response automation"
  ],
  "estimated_time": 60,
  "learning_objectives": [
    "Understand Velociraptor's client-server architecture and deployment models",
    "Write VQL queries to hunt for threats across thousands of endpoints",
    "Create and execute hunts to collect forensic artifacts at scale",
    "Build custom artifacts for organization-specific threat hunting",
    "Use Velociraptor for live incident response and forensic triage",
    "Analyze hunt results to identify compromised systems",
    "Integrate Velociraptor with SIEM and detection pipelines"
  ],
  "post_assessment": [
    {
      "question_id": "velociraptor-001",
      "question": "What query language does Velociraptor use for artifact collection and hunting?",
      "options": [
        "SQL (Structured Query Language)",
        "KQL (Kusto Query Language)",
        "VQL (Velociraptor Query Language)",
        "SPL (Search Processing Language)"
      ],
      "correct_answer": 2,
      "explanation": "Velociraptor uses VQL (Velociraptor Query Language), a custom query language designed for forensic artifact collection and threat hunting. VQL is inspired by SQL but tailored for endpoint security with built-in plugins for filesystem access, registry, memory, and network data.",
      "type": "multiple_choice",
      "difficulty": 1
    },
    {
      "question_id": "velociraptor-002",
      "question": "Which deployment model allows Velociraptor to operate without a central server?",
      "options": [
        "Client-Server mode only",
        "Cloud-managed deployment",
        "Standalone collector mode",
        "Agent-based monitoring"
      ],
      "correct_answer": 2,
      "explanation": "Velociraptor supports standalone collector mode where you can compile a single executable that runs pre-configured hunts without needing a central server. This is ideal for forensic triage, incident response, or environments where centralized management isn't feasible.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "velociraptor-003",
      "question": "When hunting for lateral movement, which artifact would you collect to identify PsExec usage?",
      "options": [
        "Windows.EventLogs.PowerShell",
        "Windows.System.Services",
        "Windows.EventLogs.ScheduledTasks",
        "Windows.Registry.RecentApps"
      ],
      "correct_answer": 1,
      "explanation": "Windows.System.Services artifact is key for detecting PsExec lateral movement. PsExec creates a service (PSEXESVC) on the target system. You'd look for services with suspicious names, unusual binary paths, or short-lived services that match lateral movement patterns. Event ID 7045 (Service Installation) is also critical.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "velociraptor-004",
      "question": "What happens when you schedule a hunt in Velociraptor?",
      "options": [
        "The hunt runs immediately on all online clients",
        "The hunt configuration is sent to clients, which execute it when they check in",
        "Velociraptor SSH's into each endpoint to run the hunt",
        "The hunt is queued and runs only when manually triggered"
      ],
      "correct_answer": 1,
      "explanation": "When you schedule a hunt, Velociraptor sends the hunt configuration (VQL queries and artifacts) to all enrolled clients. Clients execute the hunt when they check in with the server (default: every 10 seconds). This allows hunting across thousands of endpoints without requiring simultaneous connections.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "velociraptor-005",
      "question": "Which VQL plugin would you use to search for files matching a specific hash across all endpoints?",
      "options": [
        "glob() with hash filter",
        "parse_pe() with hash validation",
        "hash() combined with SELECT query",
        "yara() with hash-based rules"
      ],
      "correct_answer": 2,
      "explanation": "You would use the hash() plugin combined with a SELECT query to search for files by hash. Example: SELECT * FROM glob(globs='C:\\\\**\\\\*.exe') WHERE hash(path=FullPath, hashselect='MD5') = '<target_hash>'. The glob() finds files, and hash() computes their hash for comparison.",
      "type": "multiple_choice",
      "difficulty": 3
    }
  ],
  "jim_kwik_principles": [
    "active_learning",
    "minimum_effective_dose",
    "teach_like_im_10",
    "memory_hooks",
    "meta_learning",
    "connect_to_what_i_know",
    "reframe_limiting_beliefs",
    "gamify_it",
    "learning_sprint",
    "multiple_memory_pathways"
  ],
  "content_blocks": [
    {
      "type": "mindset_coach",
      "content": {
        "text": "# Welcome to the Hunt!\n\nWelcome to one of the most powerful threat hunting platforms in modern cybersecurity! Velociraptor transforms the impossible into the routine: hunting for threats across thousands of endpoints in minutes, collecting forensic artifacts at scale, and responding to incidents in real-time.\n\nIf you've ever felt overwhelmed by the challenge of investigating a potential compromise across hundreds of systems, or frustrated by the limitations of traditional EDR tools, you're about to discover a game-changer. Velociraptor gives you the eyes and hands of a forensic investigator on every endpoint in your enterprise, simultaneously.\n\nThis lesson will teach you how to hunt like a velociraptorâ€”fast, precise, and relentless. By the end, you'll be able to write VQL queries that find needles in haystacks, execute hunts that span entire networks, and respond to incidents with the speed and efficiency that modern threats demand.\n\nLet's hunt! ðŸ¦–"
      }
    },
    {
      "type": "explanation",
      "content": {
        "text": "# What is Velociraptor?\n\n## The Endpoint Visibility Problem\n\nImagine you're investigating a potential breach. You have 5,000 Windows endpoints across 20 offices. You need to answer: \"Did any system access evil.com in the last 30 days?\" \n\nWith traditional tools, you'd need to:\n- Log into each endpoint individually (impossible at scale)\n- Deploy PowerShell scripts via GPO (slow, error-prone)\n- Wait for SIEM logs (if you even collect DNS logs)\n- Hope your EDR has the right telemetry (and retention)\n\nVelociraptor solves this: **One hunt, 5,000 endpoints, 5 minutes.**\n\n## Velociraptor Overview\n\nVelociraptor is an open-source endpoint visibility and digital forensics tool designed for:\n- **Threat hunting at scale**: Query thousands of endpoints simultaneously\n- **Forensic artifact collection**: Collect MFT, prefetch, registry, memory dumps, etc.\n- **Incident response**: Live response across your entire enterprise\n- **Continuous monitoring**: Detect threats in real-time with event-driven queries\n\n**Key Features:**\n- **VQL (Velociraptor Query Language)**: SQL-like language for querying endpoints\n- **Artifact system**: Pre-built and custom queries for common forensic tasks\n- **Client-server architecture**: Lightweight agents (~10MB) communicate with central server\n- **Offline collectors**: Standalone executables for forensic triage\n- **Open source**: Free, transparent, extensible (AGPLv3 license)\n\n## Architecture: How Velociraptor Works\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚                    Velociraptor Server                       â”‚\nâ”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚\nâ”‚  â”‚ Frontend â”‚  â”‚  Datastore â”‚  â”‚  Hunt    â”‚  â”‚  Notebook â”‚ â”‚\nâ”‚  â”‚  (GUI)   â”‚  â”‚  (File or  â”‚  â”‚  Manager â”‚  â”‚  (Analysisâ”‚ â”‚\nâ”‚  â”‚          â”‚  â”‚   S3)      â”‚  â”‚          â”‚  â”‚   VQL)    â”‚ â”‚\nâ”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n                              â”‚ HTTPS (TLS mutual auth)\n                              â”‚\n         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n         â”‚                    â”‚                    â”‚\n    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”\n    â”‚ Client  â”‚          â”‚ Client  â”‚         â”‚ Client  â”‚\n    â”‚ Agent   â”‚          â”‚ Agent   â”‚   ...   â”‚ Agent   â”‚\n    â”‚ (10MB)  â”‚          â”‚ (10MB)  â”‚         â”‚ (10MB)  â”‚\n    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n    Endpoint 1           Endpoint 2           Endpoint N\n```\n\n**Component Breakdown:**\n\n1. **Server**: \n   - **Frontend**: Web GUI for creating hunts, viewing results, managing clients\n   - **Datastore**: Stores hunt results (local filesystem, S3, or Azure Blob)\n   - **Hunt Manager**: Schedules and tracks hunt execution across clients\n   - **Notebook**: Jupyter-like environment for VQL analysis and reporting\n\n2. **Client Agent**:\n   - Lightweight (10-20MB), cross-platform (Windows, Linux, macOS)\n   - Checks in with server every 10 seconds (configurable)\n   - Executes VQL queries and returns results\n   - Can run in \"crypto\" mode (no server connection for air-gapped environments)\n\n3. **Communication**:\n   - HTTPS with mutual TLS authentication (prevents rogue clients/servers)\n   - Clients poll server for new tasks (no inbound connections required)\n   - Results streamed back in chunks (handles large datasets)\n\n## Deployment Models\n\n### 1. Client-Server (Enterprise)\n\n**Use case**: Continuous monitoring, ongoing threat hunting, incident response\n\n```bash\n# Server deployment (Linux)\nwget https://github.com/Velocidex/velociraptor/releases/download/v0.7.0/velociraptor-v0.7.0-linux-amd64\nchmod +x velociraptor-v0.7.0-linux-amd64\n\n# Generate server config\n./velociraptor config generate > server.config.yaml\n\n# Edit server.config.yaml (set GUI port, datastore path, SSL certs)\nvim server.config.yaml\n\n# Start server\n./velociraptor --config server.config.yaml frontend\n\n# Access GUI at https://server-ip:8889\n```\n\n**Client deployment** (via GPO, SCCM, or manually):\n```powershell\n# Generate client MSI installer\nvelociraptor.exe config client > client.config.yaml\nvelociraptor.exe debian client --config client.config.yaml\n\n# Deploy MSI to endpoints\nmsiexec /i velociraptor-client.msi /quiet\n```\n\n### 2. Offline Collector (Incident Response)\n\n**Use case**: Forensic triage, air-gapped networks, one-time collection\n\n```bash\n# Create standalone collector with pre-configured artifacts\nvelociraptor artifacts collect \\\n  Windows.KapeFiles.Targets \\\n  Windows.System.Amcache \\\n  Windows.EventLogs.RDPAuth \\\n  --output collector.exe\n\n# Run on target system (no server needed)\ncollector.exe\n\n# Produces collector-output.zip with all artifacts\n```\n\nThis creates a **single executable** that collects specified artifacts and produces a ZIP fileâ€”perfect for incident response when you can't deploy a full agent.\n\n### 3. Instant Velociraptor (Quick Start)\n\nVelociraptor supports \"instant\" mode for testing:\n\n```bash\n# Runs server + opens GUI in browser automatically\nvelociraptor gui\n```\n\n## VQL: Velociraptor Query Language\n\nVQL (Velociraptor Query Language) is the heart of Velociraptor. It's a SQL-like language designed for forensic artifact collection.\n\n### Basic VQL Syntax\n\n```sql\nSELECT column1, column2, function(column3) AS alias\nFROM plugin(parameter1='value1', parameter2='value2')\nWHERE condition\n```\n\n**Example: List all running processes**\n\n```sql\nSELECT Pid, Name, CommandLine, Username\nFROM pslist()\nWHERE Name =~ 'powershell'\n```\n\n**Breakdown**:\n- `pslist()`: Built-in plugin that enumerates processes (like `ps` or `tasklist`)\n- `=~`: Regex match operator\n- Returns: All PowerShell processes with PID, name, command line, and user\n\n### VQL Plugins\n\nVelociraptor has 300+ built-in plugins for accessing system data:\n\n**Filesystem Plugins**:\n- `glob()`: Find files matching patterns\n- `read_file()`: Read file contents\n- `parse_mft()`: Parse NTFS Master File Table\n- `parse_usn()`: Parse USN Journal\n\n**Registry Plugins** (Windows):\n- `read_reg_key()`: Read registry keys\n- `parse_ntuser()`: Parse NTUSER.DAT offline\n\n**Process Plugins**:\n- `pslist()`: List processes\n- `handles()`: List process handles\n- `vad()`: Virtual Address Descriptors (memory analysis)\n\n**Network Plugins**:\n- `netstat()`: Active network connections\n- `dns_resolve()`: DNS lookups\n\n**Event Log Plugins**:\n- `parse_evtx()`: Parse Windows Event Logs\n- `watch_evtx()`: Real-time event monitoring\n\n### VQL Query Examples\n\n**Example 1: Find Prefetch Files Modified in Last 7 Days**\n\n```sql\nSELECT FullPath, Mtime, Size\nFROM glob(globs='C:\\\\Windows\\\\Prefetch\\\\*.pf')\nWHERE Mtime > now() - 604800\nORDER BY Mtime DESC\n```\n\n**Example 2: Detect Unsigned DLLs Loaded by Critical Processes**\n\n```sql\nSELECT Pid, Name, dll.Path, authenticode(filename=dll.Path).Trusted\nFROM pslist()\nFLATTEN modules(pid=Pid)\nWHERE Name =~ '^(lsass|winlogon|csrss)\\.exe$'\n  AND NOT authenticode(filename=Path).Trusted\n```\n\n**Example 3: Search for Files by Hash (IOC Hunting)**\n\n```sql\nSELECT FullPath, Size, Mtime,\n       hash(path=FullPath, hashselect='MD5') AS MD5\nFROM glob(globs='C:\\\\**\\\\*.exe')\nWHERE MD5 = '5d41402abc4b2a76b9719d911017c592'\n```\n\n**Example 4: Find Scheduled Tasks Created in Last 30 Days**\n\n```sql\nSELECT Name, Author, Command, CreationDate\nFROM Artifacts.Windows.System.TaskScheduler()\nWHERE CreationDate > now() - 2592000\nORDER BY CreationDate DESC\n```\n\n## Artifacts: Pre-Built Hunt Templates\n\nArtifacts are reusable VQL queries packaged with metadata. Velociraptor ships with **500+ built-in artifacts** covering:\n\n- **Windows Forensics**: Prefetch, Amcache, ShimCache, UserAssist, RecentDocs\n- **Linux Forensics**: Bash history, cron jobs, auth logs, systemd services\n- **macOS Forensics**: Unified Logs, LaunchAgents, quarantine database\n- **Threat Hunting**: Web browser history, RDP sessions, lateral movement indicators\n- **Incident Response**: Memory acquisition, timeline generation, IOC sweeps\n\n**Artifact Structure** (YAML):\n\n```yaml\nname: Windows.Detection.Webshells\ndescription: Hunt for webshells in IIS directories\nparameters:\n  - name: SearchPaths\n    default: C:\\\\inetpub\\\\wwwroot\\\\**\\\\*.aspx\n\nsources:\n  - query: |\n      SELECT FullPath, Size, Mtime,\n             read_file(filename=FullPath, length=1024) AS Content\n      FROM glob(globs=SearchPaths)\n      WHERE Content =~ '(?i)(eval|execute|cmd\\.exe|powershell)'\n```\n\nYou can **create custom artifacts** for organization-specific threats (more on this later).\n\n## Hunts: Executing Queries at Scale\n\nA **hunt** is a VQL query (or artifact) executed across multiple endpoints simultaneously.\n\n**Hunt Workflow**:\n\n1. **Create Hunt**: Select artifact(s) and configure parameters\n2. **Select Targets**: All clients, specific labels, or client IDs\n3. **Schedule**: Run immediately or schedule for later\n4. **Monitor**: Track hunt progress (clients completed/failed)\n5. **Analyze Results**: Download results, analyze in notebook, export to CSV/JSON\n\n**Example Hunt: Find All Systems with RDP Enabled**\n\nArtifact: `Windows.System.Services`\nFilter: `Name = 'TermService' AND State = 'Running'`\n\nResults show which endpoints have RDP service runningâ€”potential lateral movement targets.\n\n## Real-Time Monitoring with Event Queries\n\nVelociraptor supports **client event queries** that run continuously and alert on suspicious activity.\n\n**Example: Detect New Services Being Created**\n\n```sql\nSELECT timestamp(epoch=System.TimeCreated.SystemTime) AS EventTime,\n       EventData.ServiceName,\n       EventData.ImagePath\nFROM watch_evtx(filename='C:\\\\Windows\\\\System32\\\\winevt\\\\Logs\\\\System.evtx')\nWHERE EventID = 7045\n```\n\nThis query watches the System event log in real-time and fires whenever Event ID 7045 (Service Installed) occursâ€”a key lateral movement indicator (e.g., PsExec, Cobalt Strike service payloads).\n\n**Event Artifacts** run continuously on all clients and send alerts to the server.\n\n## Performance and Scalability\n\n**How many endpoints can Velociraptor handle?**\n\n- **Small deployment** (< 1,000 endpoints): Single server (4 CPU, 8GB RAM)\n- **Medium deployment** (1,000-10,000 endpoints): Single server (8 CPU, 16GB RAM)\n- **Large deployment** (10,000-100,000 endpoints): Multi-frontend architecture with shared datastore\n\n**Hunt performance**:\n- Collecting simple artifacts (e.g., running processes): 1,000 endpoints/minute\n- Collecting complex artifacts (e.g., MFT, registry hives): 100-500 endpoints/minute\n- Bandwidth: ~10-100KB per client per artifact (depends on artifact complexity)\n\n**Optimization tips**:\n- Use `LIMIT` clauses to reduce result size\n- Schedule resource-intensive hunts during off-hours\n- Use client labels to target subsets of endpoints\n- Store datastore on fast SSD or S3 for large deployments\n\n## Use Cases\n\n**Threat Hunting**:\n- Hunt for IOCs (file hashes, IP addresses, domain names)\n- Detect lateral movement (PsExec, WMI, RDP)\n- Find persistence mechanisms (Run keys, scheduled tasks, services)\n- Identify suspicious processes (unsigned, renamed system binaries)\n\n**Incident Response**:\n- Rapid triage: \"Which systems are affected?\"\n- Forensic collection: Grab MFT, Prefetch, Event Logs from compromised systems\n- Timeline generation: Reconstruct attacker activity across multiple endpoints\n- Containment: Identify all systems with malicious files or network connections\n\n**Forensic Analysis**:\n- Offline analysis with standalone collectors\n- Parse artifacts (Amcache, ShimCache, UserAssist) at scale\n- Extract browser history, download history, file access patterns\n- Memory forensics (collect memory dumps, parse with Rekall)\n\n**Compliance & Auditing**:\n- Verify security configurations (BitLocker status, firewall rules)\n- Audit software installations (unauthorized applications)\n- Track privileged access (admin logins, sudo usage)\n- Generate compliance reports (CIS benchmarks, STIG compliance)\n\n## Velociraptor vs. Other Tools\n\n**Velociraptor vs. EDR (CrowdStrike, SentinelOne)**:\n- **EDR**: Real-time protection, behavioral detection, commercial, expensive\n- **Velociraptor**: On-demand hunting, deep forensics, open source, free\n- **Use both**: EDR for prevention, Velociraptor for investigation\n\n**Velociraptor vs. Osquery**:\n- **Osquery**: SQL queries for endpoint data, simpler, less forensic-focused\n- **Velociraptor**: VQL with forensic plugins (MFT, Prefetch), artifact system, built-in GUI\n- **Similarity**: Both use SQL-like query languages\n\n**Velociraptor vs. GRR**:\n- **GRR**: Google's endpoint forensics tool (Velociraptor's inspiration)\n- **Velociraptor**: More modern, faster, easier deployment, better VQL\n- **GRR**: More mature, Google-backed, Python-based\n\n**Velociraptor vs. KAPE**:\n- **KAPE**: Automated forensic triage (Eric Zimmerman's tool)\n- **Velociraptor**: Can run KAPE targets at scale across network\n- **Integration**: Velociraptor has `Windows.KapeFiles.Targets` artifact\n\n## Security Considerations\n\n**Mutual TLS Authentication**:\n- Server and clients authenticate each other with X.509 certificates\n- Prevents rogue clients from connecting\n- Prevents rogue servers from receiving client data\n\n**Access Control**:\n- Role-based access control (RBAC) with multiple permission levels\n- Auditing: All actions logged (who ran which hunt, when)\n- API tokens for automation (CI/CD, SOAR integration)\n\n**Data Protection**:\n- Results stored encrypted at rest (optional)\n- TLS for data in transit\n- Client quarantine: Isolate compromised clients from network\n\n**Operational Security**:\n- Velociraptor is a **powerful post-exploitation tool**\n- If attackers compromise your Velociraptor server, they control all endpoints\n- Harden server: Firewall, MFA, regular patching, monitor access logs\n- Rotate API keys regularly\n\n---\n\nNow that you understand Velociraptor's architecture and capabilities, let's get hands-on with deployment and hunting!"
      }
    },
    {
      "type": "explanation",
      "content": {
        "text": "# Teach Me Like I'm 10: What is Velociraptor?\n\nImagine you have 1,000 toy boxes scattered across a huge warehouse, and you need to find all the boxes that contain a specific blue LEGO brick. \n\n**The Old Way** (no Velociraptor): You'd have to walk to each box, open it, dig through the toys, check for the blue LEGO brick, write down if you found it, and move to the next box. It would take DAYS.\n\n**The Velociraptor Way**: You shout into a megaphone: \"All boxes with a blue LEGO brick, raise your hand!\" In 5 minutes, 37 boxes raise their hands. You walk directly to those 37 boxes and collect the blue bricks. Done.\n\nThat's Velociraptor for computers:\n- The **warehouse** = Your company network (thousands of computers)\n- The **toy boxes** = Endpoint computers (desktops, laptops, servers)\n- The **blue LEGO brick** = The thing you're hunting for (malware, suspicious files, attacker activity)\n- The **megaphone** = Velociraptor server sending queries\n- The **raised hands** = Client agents reporting back: \"Yes, I found it!\"\n\nVelociraptor lets you ask every computer in your network a question (\"Do you have file X?\" \"Is malware Y running?\") and get answers in minutes instead of weeks. It's like having a super-fast robot assistant on every computer, waiting for your commands.\n\n**Why \"Velociraptor\"?** Because velociraptors hunted in packs, communicated with each other, and were incredibly effective predators. Velociraptor the tool helps you hunt threats across your entire network like a coordinated pack of digital dinosaurs! ðŸ¦–"
      }
    },
    {
      "type": "code_exercise",
      "content": {
        "text": "# Hands-On Lab: Your First Velociraptor Hunt\n\nLet's deploy Velociraptor and run your first threat hunt!\n\n## Lab Setup (Local Testing)\n\n### Step 1: Download Velociraptor\n\n**Windows**:\n```powershell\n# Download latest release\nInvoke-WebRequest -Uri \"https://github.com/Velocidex/velociraptor/releases/download/v0.7.0/velociraptor-v0.7.0-windows-amd64.exe\" -OutFile \"velociraptor.exe\"\n```\n\n**Linux**:\n```bash\nwget https://github.com/Velocidex/velociraptor/releases/download/v0.7.0/velociraptor-v0.7.0-linux-amd64\nchmod +x velociraptor-v0.7.0-linux-amd64\nmv velociraptor-v0.7.0-linux-amd64 velociraptor\n```\n\n### Step 2: Start Instant Velociraptor (GUI Mode)\n\n```bash\n# Starts server + opens browser\n./velociraptor gui\n```\n\nYou'll see:\n```\nStarting GUI...\nAuthentication info: username=admin password=<random_password>\nGUI is available at https://127.0.0.1:8889\n```\n\n**Login** with username `admin` and the generated password.\n\n### Step 3: Explore the GUI\n\nThe Velociraptor GUI has several key sections:\n\n1. **Home Dashboard**: Overview of connected clients, recent hunts\n2. **Hunt Manager**: Create and monitor hunts\n3. **Virtual Filesystem**: Browse client filesystems\n4. **Collected Artifacts**: View artifact collection results\n5. **Notebooks**: VQL analysis and reporting\n6. **Server Artifacts**: Configure event monitoring\n\n### Step 4: Create Your First Hunt\n\n**Scenario**: Hunt for systems with RDP enabled (potential lateral movement targets).\n\n1. Click **\"Hunt Manager\"** â†’ **\"New Hunt\"**\n2. Search for artifact: `Windows.System.Services`\n3. Click **\"Configure\"**\n4. Add parameter:\n   - **Name**: `NameRegex`\n   - **Value**: `TermService`\n5. Click **\"Launch\"**\n\nThe hunt will execute on all connected clients (in instant mode, just your local machine).\n\n### Step 5: View Hunt Results\n\n1. Click **\"Hunt Manager\"**\n2. Click your hunt name\n3. Click **\"Results\"** tab\n\nYou'll see output like:\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ Name    â”‚ DisplayName â”‚ State  â”‚ StartMode    â”‚ PathName â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚TermServiceâ”‚Remote Desktop Servicesâ”‚Runningâ”‚Manualâ”‚C:\\Windows\\System32\\svchost.exe -k termsvcs â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n**Interpretation**: This system has RDP enabled. In a real hunt across 1,000 endpoints, you'd see which systems are RDP-enabled (and potentially vulnerable to lateral movement).\n\n### Step 6: Write Custom VQL Query\n\nLet's write a query to find PowerShell executions in the last 24 hours.\n\n1. Click **\"Notebooks\"** â†’ **\"New Notebook\"**\n2. Create a new VQL cell:\n\n```sql\nSELECT timestamp(epoch=System.TimeCreated.SystemTime) AS EventTime,\n       EventData.CommandLine,\n       EventData.User\nFROM parse_evtx(filename='C:\\\\Windows\\\\System32\\\\winevt\\\\Logs\\\\Microsoft-Windows-PowerShell%4Operational.evtx')\nWHERE EventID = 4104\n  AND EventTime > now() - 86400\nORDER BY EventTime DESC\nLIMIT 20\n```\n\n3. Click **\"Run\"**\n\nYou'll see the 20 most recent PowerShell script block executions.\n\n**Expected Output**:\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ EventTime            â”‚ CommandLine                         â”‚ User        â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ 2025-11-11 14:32:11  â”‚ Get-Process | Where-Object {$_.CPU}â”‚ CORP\\alice  â”‚\nâ”‚ 2025-11-11 13:15:42  â”‚ Invoke-WebRequest -Uri http://...   â”‚ CORP\\bob    â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n**Threat Hunting Tip**: Look for:\n- Encoded commands (`-EncodedCommand`)\n- Downloads (`Invoke-WebRequest`, `Net.WebClient`)\n- Credential dumping (`mimikatz`, `Invoke-Mimikatz`)\n- Lateral movement (`Invoke-Command`, `Enter-PSSession`)\n\n## Lab Exercise 2: Hunt for Lateral Movement (PsExec)\n\nPsExec is a common lateral movement tool that creates a service on the target system.\n\n**Hunt Objective**: Find all systems where a service was created in the last 7 days (Event ID 7045).\n\n### Create the Hunt\n\n1. **Hunt Manager** â†’ **New Hunt**\n2. Select artifact: `Windows.EventLogs.EvtxHunter`\n3. Configure parameters:\n   - **EvtxGlob**: `C:\\Windows\\System32\\winevt\\Logs\\System.evtx`\n   - **IocRegex**: `Event ID 7045` (optional filter)\n4. Add VQL query:\n\n```sql\nSELECT timestamp(epoch=System.TimeCreated.SystemTime) AS EventTime,\n       EventData.ServiceName,\n       EventData.ImagePath,\n       EventData.ServiceType,\n       System.Computer\nFROM parse_evtx(filename='C:\\\\Windows\\\\System32\\\\winevt\\\\Logs\\\\System.evtx')\nWHERE EventID = 7045\n  AND EventTime > now() - 604800\nORDER BY EventTime DESC\n```\n\n5. Launch hunt\n\n### Analyze Results\n\nLook for suspicious indicators:\n- **ServiceName**: `PSEXESVC`, `BTOBTO`, random names\n- **ImagePath**: Unusual paths (`C:\\Windows\\Temp\\`, `C:\\Users\\Public\\`)\n- **ServiceType**: `user mode service` (0x10)\n\n**Red Flag Example**:\n```\nEventTime: 2025-11-10 03:42:11\nServiceName: BTOBTO\nImagePath: C:\\Windows\\Temp\\execute.exe\nServiceType: user mode service (0x10)\nComputer: WORKSTATION-042\n```\n\nThis is highly suspicious:\n- Service created at 3 AM (off-hours)\n- Random service name (`BTOBTO`)\n- Binary in `C:\\Windows\\Temp\\` (unusual location)\n- Matches Cobalt Strike lateral movement pattern\n\n**Next Steps**: \n1. Isolate WORKSTATION-042\n2. Collect memory dump and disk image\n3. Hunt for `execute.exe` hash across all endpoints\n4. Review authentication logs for lateral movement source\n\n## Lab Exercise 3: Create Custom Artifact\n\nLet's create a custom artifact to hunt for web shells in IIS directories.\n\n### Step 1: Create Artifact YAML\n\nCreate file `Custom.Windows.Detection.Webshells.yaml`:\n\n```yaml\nname: Custom.Windows.Detection.Webshells\ndescription: |\n  Hunt for potential webshells in IIS wwwroot directories.\n  Searches for ASPX/ASMX files containing suspicious keywords.\n\nauthor: Your Name\n\nparameters:\n  - name: SearchPaths\n    default: |\n      C:\\inetpub\\wwwroot\\**\\*.aspx\n      C:\\inetpub\\wwwroot\\**\\*.asmx\n    type: csv\n    description: Paths to search for webshells\n\n  - name: SuspiciousKeywords\n    default: \"eval|execute|cmd\\.exe|powershell|wscript|process\\.start\"\n    description: Regex pattern for webshell indicators\n\nsources:\n  - query: |\n      LET files = SELECT FullPath, Size, Mtime, Atime,\n                         read_file(filename=FullPath, length=4096) AS Content\n      FROM glob(globs=split(string=SearchPaths, sep=\"\\\\n\"))\n      WHERE Size > 0 AND Size < 1048576\n\n      SELECT FullPath, Size, Mtime,\n             regex_replace(source=Content, \n                           re='[^\\\\x20-\\\\x7E]', \n                           replace='') AS PrintableContent\n      FROM files\n      WHERE Content =~ SuspiciousKeywords\n```\n\n### Step 2: Import Artifact\n\n1. **Server Artifacts** â†’ **Add Artifact** â†’ **Upload YAML**\n2. Upload `Custom.Windows.Detection.Webshells.yaml`\n3. Click **\"Validate\"** â†’ **\"Save\"**\n\n### Step 3: Run Hunt\n\n1. **Hunt Manager** â†’ **New Hunt**\n2. Search: `Custom.Windows.Detection.Webshells`\n3. Launch hunt\n\n### Expected Results\n\nIf webshells are present:\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ FullPath                             â”‚ Size â”‚ PrintableContent    â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ C:\\inetpub\\wwwroot\\admin\\shell.aspx â”‚ 2048 â”‚ ... Process.Start(\"cmd.exe\", \"/c \" + Request[\"cmd\"]) ... â”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n**This is a webshell!** The file accepts a `cmd` parameter and executes arbitrary commands.\n\n## Lab Exercise 4: Offline Collector for Incident Response\n\nYou need to collect forensic artifacts from a potentially compromised system that's **not connected to your Velociraptor server**.\n\n### Create Offline Collector\n\n```bash\n# Create standalone collector\nvelociraptor artifacts collect \\\n  Windows.KapeFiles.Targets \\\n  Windows.System.Amcache \\\n  Windows.EventLogs.RDPAuth \\\n  Windows.Forensics.Prefetch \\\n  Windows.Network.NetstatEnriched \\\n  --format jsonl \\\n  --output collector-$(date +%Y%m%d).exe\n```\n\n### Deploy to Target System\n\n1. Copy `collector-20251111.exe` to USB drive\n2. Run on target system:\n\n```powershell\n# Run with admin privileges\n.\\collector-20251111.exe\n```\n\n3. Collector creates `Collection-HOSTNAME-20251111.zip`\n\n### Analyze Results\n\nExtract the ZIP file:\n```\nCollection-HOSTNAME-20251111.zip\nâ”œâ”€â”€ uploads.json              # Metadata about collected files\nâ”œâ”€â”€ results.json              # Artifact results in JSON format\nâ”œâ”€â”€ Windows.KapeFiles.Targets/\nâ”‚   â”œâ”€â”€ C/\nâ”‚   â”‚   â””â”€â”€ Windows/\nâ”‚   â”‚       â”œâ”€â”€ Prefetch/\nâ”‚   â”‚       â”œâ”€â”€ System32/\nâ”‚   â”‚       â”‚   â””â”€â”€ winevt/\nâ”‚   â”‚       â”‚       â””â”€â”€ Logs/\nâ”‚   â”‚       â””â”€â”€ Tasks/\nâ””â”€â”€ Windows.System.Amcache/\n    â””â”€â”€ Amcache.hve\n```\n\nYou now have:\n- Prefetch files (executed programs)\n- Event logs (authentication, process creation)\n- Amcache (program execution artifacts)\n- Scheduled tasks (persistence)\n- Network connections (netstat)\n\n**Analyze in Velociraptor**:\n1. Upload `results.json` to Velociraptor notebook\n2. Query with VQL:\n\n```sql\nSELECT * FROM parse_json_array(data=read_file(filename='results.json'))\nWHERE _artifact = 'Windows.Forensics.Prefetch'\nORDER BY LastExecutionTime DESC\nLIMIT 20\n```\n\nThis shows the 20 most recently executed programsâ€”key for timeline reconstruction.\n\n## Lab Exercise 5: Real-Time Monitoring (Event Queries)\n\nSet up continuous monitoring for new service installations (lateral movement indicator).\n\n### Create Client Event Artifact\n\n1. **Server Artifacts** â†’ **Add Artifact**\n2. Create `Custom.Windows.Detection.ServiceInstallation.yaml`:\n\n```yaml\nname: Custom.Windows.Detection.ServiceInstallation\ntype: CLIENT_EVENT\ndescription: Monitor for new service installations (Event ID 7045)\n\nsources:\n  - query: |\n      SELECT timestamp(epoch=System.TimeCreated.SystemTime) AS EventTime,\n             EventData.ServiceName,\n             EventData.ImagePath,\n             EventData.ServiceType,\n             System.Computer\n      FROM watch_evtx(filename='C:\\\\Windows\\\\System32\\\\winevt\\\\Logs\\\\System.evtx')\n      WHERE EventID = 7045\n```\n\n### Deploy to All Clients\n\n1. **Server Artifacts** â†’ **Client Event Monitoring**\n2. Click **\"Add Event Query\"**\n3. Select `Custom.Windows.Detection.ServiceInstallation`\n4. Click **\"Deploy\"**\n\nNow, every time ANY client installs a new service, Velociraptor will alert you in real-time.\n\n### View Alerts\n\n1. **Server Artifacts** â†’ **Client Event Monitoring**\n2. Click your artifact name\n3. View real-time events:\n\n```\nâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\nâ”‚ EventTime            â”‚ ServiceName â”‚ ImagePath                  â”‚\nâ”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\nâ”‚ 2025-11-11 15:42:18  â”‚ MyService   â”‚ C:\\Windows\\System32\\svc.exeâ”‚\nâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n```\n\n**Integrate with SIEM**: Export events to Splunk/Elastic:\n```bash\ncurl -X POST https://velociraptor:8889/api/v1/hunts/H.1234/results \\\n  -H \"Authorization: Bearer $API_KEY\" | \\\n  jq -r '.[] | @json' | \\\n  curl -X POST https://splunk:8088/services/collector -H \"Authorization: Splunk $HEC_TOKEN\" --data-binary @-\n```\n\n---\n\n## Key Takeaways from Labs\n\nâœ… **Velociraptor hunts** execute VQL across thousands of endpoints in minutes\nâœ… **Custom artifacts** let you tailor threat hunting to your environment\nâœ… **Offline collectors** enable forensic triage without network connectivity\nâœ… **Event queries** provide real-time detection at scale\nâœ… **VQL is powerful** but requires practiceâ€”start simple, iterate\n\nYou now have hands-on experience with Velociraptor's core capabilities. Next, let's look at real-world hunting scenarios!"
      }
    },
    {
      "type": "real_world",
      "content": {
        "text": "# Real-World Velociraptor Threat Hunting Scenarios\n\nLet's examine how Velociraptor is used in actual incident response and threat hunting engagements.\n\n## Case Study 1: Ransomware Investigation at Financial Services Company\n\n**Scenario**: A financial services company with 5,000 Windows endpoints detected ransomware on 3 file servers. The SOC needed to answer:\n1. How many systems are infected?\n2. What's the initial access vector?\n3. When did the attack start?\n4. Are attackers still present?\n\n### Investigation Timeline\n\n**Day 1, Hour 1: Initial Response**\n\nSOC deployed Velociraptor agents to all endpoints via SCCM (4,800 online systems, deployment in 30 minutes).\n\n**Hunt 1: Find Ransomware Binary by Hash**\n```sql\nSELECT FullPath, Size, Mtime,\n       hash(path=FullPath, hashselect='SHA256') AS SHA256\nFROM glob(globs='C:\\\\**\\\\*.exe')\nWHERE SHA256 = 'a1b2c3d4e5f6...ransomware_hash'\n```\n\n**Result**: Ransomware binary found on **47 systems** (not just 3 file servers!).\n\n**Day 1, Hour 2: Identify Initial Access**\n\n**Hunt 2: Check for RDP Brute Force (Event ID 4625)**\n```sql\nSELECT timestamp(epoch=System.TimeCreated.SystemTime) AS EventTime,\n       EventData.TargetUserName,\n       EventData.IpAddress,\n       EventData.FailureReason\nFROM parse_evtx(filename='C:\\\\Windows\\\\System32\\\\winevt\\\\Logs\\\\Security.evtx')\nWHERE EventID = 4625\n  AND EventTime > now() - 2592000\nGROUP BY IpAddress\nHAVING count() > 100\nORDER BY count() DESC\n```\n\n**Result**: IP `203.0.113.45` had **1,247 failed login attempts** across 12 systems over 2 days, then successful login to `WEBSERVER-01`.\n\n**Initial Access Vector**: RDP brute force attack.\n\n**Day 1, Hour 3: Reconstruct Attack Timeline**\n\n**Hunt 3: Timeline of Malicious Activity**\nCollected artifacts from all 47 infected systems:\n- Prefetch (executed programs)\n- Amcache (first execution time)\n- Event Logs (authentication, process creation)\n- MFT (file creation/modification)\n\n**Offline collector**:\n```bash\nvelociraptor artifacts collect \\\n  Windows.Forensics.Prefetch \\\n  Windows.System.Amcache \\\n  Windows.EventLogs.SecurityTrim \\\n  Windows.NTFS.MFT \\\n  --client_id C.1234... \\\n  --output timeline.zip\n```\n\n**Timeline Reconstruction** (Velociraptor Notebook):\n```sql\nSELECT * FROM foreach(\n  row={\n    SELECT * FROM hunt_results(hunt_id='H.123', artifact='Windows.Forensics.Prefetch')\n  },\n  query={\n    SELECT Executable, LastExecutionTime, RunCount, ClientId\n    FROM scope()\n  }\n)\nWHERE Executable =~ '(?i)(ransomware|encrypt|locker)'\nORDER BY LastExecutionTime\n```\n\n**Attack Timeline**:\n- **Day -2, 14:32 UTC**: Initial RDP brute force begins (IP: 203.0.113.45)\n- **Day 0, 03:18 UTC**: Successful RDP login to WEBSERVER-01 as `admin`\n- **Day 0, 03:22 UTC**: PsExec deployed to 12 domain controllers and file servers\n- **Day 0, 03:25 UTC**: Cobalt Strike beacon (`update.exe`) executed on 47 systems\n- **Day 0, 03:30 UTC**: Ransomware payload (`encrypt.exe`) deployed via PsExec\n- **Day 0, 03:35 UTC**: Encryption begins on file servers\n\n**Day 1, Hour 4: Check for Persistence**\n\n**Hunt 4: Persistence Mechanisms**\n```sql\nSELECT * FROM Artifacts.Windows.Persistence.PermanentWMIEvents()\nWHERE EventConsumer =~ '(?i)(update\\.exe|encrypt\\.exe|powershell)'\n```\n\n**Result**: WMI event subscription found on 12 systems, executing `C:\\Windows\\Temp\\update.exe` every 10 minutes.\n\n**Hunt 5: Scheduled Tasks**\n```sql\nSELECT Name, Author, Command, CreationDate\nFROM Artifacts.Windows.System.TaskScheduler()\nWHERE Command =~ '(?i)(update\\.exe|encrypt\\.exe)'\n  AND CreationDate > now() - 2592000\n```\n\n**Result**: Scheduled task `WindowsUpdate` created on 8 systems, running `update.exe` daily at 3 AM.\n\n**Day 1, Hour 5: Containment**\n\n1. **Isolated 47 infected systems** (network segmentation)\n2. **Disabled compromised accounts** (`admin`, `svc_backup`)\n3. **Killed malicious processes** via Velociraptor:\n\n```sql\nSELECT process_tracker_callchain(pid=Pid)\nFROM pslist()\nWHERE Name =~ '(?i)(update\\.exe|encrypt\\.exe)'\n```\n\n4. **Deleted persistence** (WMI subscriptions, scheduled tasks)\n5. **Reset passwords** for all domain admin accounts\n\n### Outcome\n\n- **Total investigation time**: 5 hours (from detection to containment)\n- **Systems recovered**: All 47 systems reimaged from backups\n- **Downtime**: 12 hours (vs. weeks without Velociraptor)\n- **Cost savings**: ~$2M (estimated ransomware payment + recovery costs)\n\n**Velociraptor's Role**:\n- **Speed**: Hunted 5,000 endpoints in minutes (not days)\n- **Visibility**: Found 44 additional compromised systems SOC didn't know about\n- **Forensics**: Reconstructed complete attack timeline without manual forensics\n- **Containment**: Identified and removed persistence mechanisms across entire network\n\n## Case Study 2: APT Hunt at Defense Contractor\n\n**Scenario**: A defense contractor received threat intelligence about APT28 targeting their sector. They proactively hunted for IOCs across 12,000 endpoints.\n\n**IOCs**:\n- File hash: `d1e2f3a4b5c6...` (Fancy Bear malware)\n- Domain: `microsoftonline-verify[.]com` (C2 domain)\n- Mutex: `Global\\MsMpEng_Mutex` (persistence indicator)\n\n### Hunt 1: File Hash Sweep\n\n```sql\nSELECT FullPath, Size, Mtime, Btime,\n       hash(path=FullPath, hashselect='SHA256') AS SHA256,\n       authenticode(filename=FullPath).Trusted AS Signed\nFROM glob(globs='C:\\\\**\\\\*.{exe,dll,sys}')\nWHERE SHA256 = 'd1e2f3a4b5c6...'\n```\n\n**Result**: **2 systems** had the malicious DLL (`msedge_proxy.dll`).\n\n### Hunt 2: DNS Query Hunt (C2 Domain)\n\n```sql\nSELECT timestamp(epoch=System.TimeCreated.SystemTime) AS EventTime,\n       EventData.QueryName,\n       System.Computer\nFROM parse_evtx(filename='C:\\\\Windows\\\\System32\\\\winevt\\\\Logs\\\\Microsoft-Windows-Sysmon%4Operational.evtx')\nWHERE EventID = 22\n  AND QueryName =~ 'microsoftonline-verify\\.com'\n  AND EventTime > now() - 7776000\n```\n\n**Result**: **8 systems** queried the C2 domain over 90 days.\n\n### Hunt 3: Mutex Hunt\n\nAPT28 malware uses `Global\\MsMpEng_Mutex` to prevent multiple instances.\n\n```sql\nSELECT Pid, Name, CommandLine,\n       handles(pid=Pid, types='Mutant').Name AS Mutexes\nFROM pslist()\nWHERE Mutexes =~ 'Global\\\\\\\\MsMpEng_Mutex'\n```\n\n**Result**: **3 active processes** holding the suspicious mutex (disguised as Windows Defender).\n\n### Hunt 4: Memory Analysis\n\nCollected memory dumps from 8 suspicious systems:\n\n```bash\nvelociraptor artifacts collect \\\n  Windows.Memory.Acquisition \\\n  --client_id C.abcd1234... \\\n  --output memory-dump.zip\n```\n\nAnalyzed with Volatility:\n```bash\nvol.py -f memory.dmp windows.malfind\n```\n\n**Result**: Reflective DLL injection detected in `svchost.exe` (APT28 technique).\n\n### Hunt 5: Lateral Movement Analysis\n\nAPT28 uses WMI for lateral movement.\n\n```sql\nSELECT timestamp(epoch=System.TimeCreated.SystemTime) AS EventTime,\n       EventData.User,\n       EventData.Operation,\n       EventData.ClientMachine\nFROM parse_evtx(filename='C:\\\\Windows\\\\System32\\\\winevt\\\\Logs\\\\Microsoft-Windows-WMI-Activity%4Operational.evtx')\nWHERE EventID = 5857\n  AND Operation =~ 'Start'\n  AND EventTime > now() - 7776000\n```\n\n**Result**: WMI lateral movement from `WORKSTATION-042` to 23 systems over 3 months.\n\n### Outcome\n\n- **Total compromised systems**: 8 confirmed\n- **Dwell time**: 94 days (attackers present for 3+ months)\n- **Eradication**: All systems reimaged, credentials reset, network segmented\n- **Attribution**: High confidence APT28 based on TTPs and IOCs\n\n**Velociraptor's Value**:\n- Proactive threat hunting (before breach notification)\n- Comprehensive coverage (12,000 endpoints hunted in 2 hours)\n- Multi-vector hunting (file hash, DNS, mutex, memory, WMI)\n- Complete attacker footprint mapped (8 systems, 23 lateral movement targets)\n\n## Case Study 3: Web Shell Hunt at E-Commerce Company\n\n**Scenario**: An e-commerce company suspected their IIS web servers were compromised after unusual outbound traffic was detected.\n\n### Custom Artifact: Web Shell Detection\n\n```yaml\nname: Custom.Windows.Detection.IISWebshells\nsources:\n  - query: |\n      LET webshell_paths <= (\n        'C:\\\\inetpub\\\\wwwroot\\\\**\\\\*.{aspx,asmx,ashx,asp}'\n      )\n      \n      LET webshell_indicators <= (\n        'eval|execute|cmd\\.exe|powershell|wscript|'\n        'process\\.start|request\\[\"cmd\"\\]|system\\.diagnostics'\n      )\n      \n      SELECT FullPath, Size, Mtime, Atime,\n             read_file(filename=FullPath, length=8192) AS Content,\n             parse_string_with_regex(\n               string=Content,\n               regex=webshell_indicators\n             ).Match AS SuspiciousContent\n      FROM glob(globs=webshell_paths)\n      WHERE Content =~ webshell_indicators\n        AND Size < 1048576\n```\n\n### Hunt Results\n\n**12 web shells found** across 4 IIS servers:\n\n```\nC:\\inetpub\\wwwroot\\admin\\login.aspx (legitimate, modified)\nC:\\inetpub\\wwwroot\\images\\cache\\thumb.aspx (malicious)\nC:\\inetpub\\wwwroot\\api\\v2\\default.aspx (malicious)\n```\n\n**Suspicious Content**:\n```csharp\nProcess.Start(\"cmd.exe\", \"/c \" + Request[\"cmd\"]);\n```\n\n### Timeline Reconstruction\n\n```sql\nSELECT FullPath, Btime, Mtime, Atime\nFROM glob(globs='C:\\\\inetpub\\\\wwwroot\\\\**\\\\*.aspx')\nWHERE Mtime > now() - 7776000\nORDER BY Mtime DESC\n```\n\n**Result**: Web shells uploaded via vulnerable file upload form 45 days ago.\n\n### IIS Log Analysis\n\n```sql\nSELECT timestamp(epoch=parse_string_with_regex(\n         string=Line,\n         regex='(\\\\d{4}-\\\\d{2}-\\\\d{2} \\\\d{2}:\\\\d{2}:\\\\d{2})'\n       ).Match) AS Timestamp,\n       Line\nFROM read_file(filename='C:\\\\inetpub\\\\logs\\\\LogFiles\\\\W3SVC1\\\\*.log')\nWHERE Line =~ 'thumb\\.aspx\\\\?cmd='\nLIMIT 100\n```\n\n**Attacker Commands Recovered**:\n```\n/images/cache/thumb.aspx?cmd=whoami\n/images/cache/thumb.aspx?cmd=net user hacker Password123! /add\n/images/cache/thumb.aspx?cmd=net localgroup administrators hacker /add\n/images/cache/thumb.aspx?cmd=dir C:\\Users\\Administrator\\Documents\n```\n\n### Outcome\n\n- **Web shells removed**: All 12 files deleted\n- **Vulnerability patched**: File upload form secured\n- **Accounts deleted**: `hacker` account removed\n- **Logs preserved**: IIS logs archived for forensics\n- **Monitoring deployed**: Real-time web shell detection enabled\n\n## Velociraptor Integration with SOAR/SIEM\n\nMany organizations integrate Velociraptor with existing security tools:\n\n**Integration 1: Splunk**\n```bash\n# Forward hunt results to Splunk HEC\ncurl -X POST https://velociraptor:8889/api/v1/hunts/H.1234/results \\\n  -H \"Authorization: Bearer $API_KEY\" | \\\n  jq -r '.[] | @json' | \\\n  curl -X POST https://splunk:8088/services/collector \\\n    -H \"Authorization: Splunk $HEC_TOKEN\" \\\n    --data-binary @-\n```\n\n**Integration 2: TheHive (Case Management)**\n```python\nimport requests\n\n# Create TheHive case from Velociraptor hunt results\nhunt_results = requests.get(\n    'https://velociraptor:8889/api/v1/hunts/H.1234/results',\n    headers={'Authorization': f'Bearer {api_key}'}\n).json()\n\nfor result in hunt_results:\n    if result['suspicious']:\n        case = {\n            'title': f'Velociraptor Alert: {result[\"artifact\"]}',\n            'description': f'Suspicious activity on {result[\"client_id\"]}',\n            'severity': 2,\n            'tags': ['velociraptor', 'threat-hunt']\n        }\n        requests.post(\n            'https://thehive/api/case',\n            headers={'Authorization': f'Bearer {thehive_key}'},\n            json=case\n        )\n```\n\n**Integration 3: Shuffle (SOAR)**\n```yaml\n# Shuffle workflow: Auto-isolate on ransomware detection\n- name: Velociraptor Hunt for Ransomware\n  app: HTTP\n  action: get\n  parameters:\n    url: https://velociraptor:8889/api/v1/hunts/H.ransomware/results\n  \n- name: Check for Positive Detections\n  app: Python\n  action: script\n  parameters:\n    code: |\n      for result in $velociraptor.results:\n          if result['ransomware_detected']:\n              return result['client_id']\n\n- name: Isolate Endpoint\n  app: Velociraptor\n  action: isolate_client\n  parameters:\n    client_id: $python.client_id\n```\n\n---\n\n## Key Lessons from Real-World Cases\n\nâœ… **Hunt proactively**, not just reactively (APT28 case: found 3-month compromise)\nâœ… **Multi-vector hunting** finds more threats (file hash + DNS + mutex + memory)\nâœ… **Custom artifacts** catch organization-specific threats (web shell detection)\nâœ… **Timeline reconstruction** is critical for understanding attack scope\nâœ… **Integration with SIEM/SOAR** amplifies Velociraptor's value\nâœ… **Offline collectors** enable forensics without network connectivity\nâœ… **Event monitoring** detects threats in real-time (lateral movement alerts)\n\nVelociraptor isn't just a toolâ€”it's a force multiplier for threat hunters and incident responders!"
      }
    },
    {
      "type": "memory_aid",
      "content": {
        "text": "# Memory Aids for Velociraptor Hunting\n\nThese mnemonics will help you remember Velociraptor concepts and VQL syntax.\n\n## Mnemonic 1: \"RAPTOR\" - Velociraptor Workflow\n\n**R**econnaissance: Identify what you're hunting for (IOCs, TTPs)  \n**A**rtifact selection: Choose or create artifacts to collect  \n**P**arameters: Configure hunt parameters (paths, regexes, time ranges)  \n**T**arget: Select endpoints (all, labeled, specific clients)  \n**O**perate: Launch hunt and monitor progress  \n**R**esults analysis: Review findings, identify compromised systems  \n\n**Example**: Hunting for lateral movement â†’ **R**econnaissance (PsExec indicators) â†’ **A**rtifact (Windows.System.Services) â†’ **P**arameters (EventID 7045) â†’ **T**arget (all domain-joined systems) â†’ **O**perate (launch hunt) â†’ **R**esults (12 systems with PSEXESVC)\n\n## Mnemonic 2: \"VQL SFWL\" - VQL Query Structure\n\n**V**QL query structure: **S**ELECT - **F**ROM - **W**HERE - **L**IMIT\n\n**S**ELECT: What data to return (columns)  \n**F**ROM: Data source (plugin: pslist(), glob(), parse_evtx())  \n**W**HERE: Filter conditions (Name =~ 'powershell')  \n**L**IMIT: Cap results (LIMIT 100)  \n\n**Example**:\n```sql\nSELECT Pid, Name         -- S: SELECT columns\nFROM pslist()            -- F: FROM plugin\nWHERE Name =~ 'cmd'      -- W: WHERE filter\nLIMIT 10                 -- L: LIMIT results\n```\n\n## Mnemonic 3: \"GLOB PATH\" - File System Hunting\n\n**G**lob patterns for file searching  \n**L**ocate files with wildcards  \n**O**utput full paths  \n**B**rowse recursively  \n\n**P**ath wildcards: `*` (any characters), `**` (recursive)  \n**A**lternatives: `{exe,dll}` (multiple extensions)  \n**T**arget: `C:\\**\\*.exe` (all EXEs on C:)  \n**H**ash: Use `hash()` plugin to compute file hashes  \n\n**Example**:\n```sql\nSELECT FullPath, Size, hash(path=FullPath) AS MD5\nFROM glob(globs='C:\\\\Users\\\\**\\\\*.{exe,dll}')\nWHERE Size > 1048576\n```\n\n## Mnemonic 4: \"EVTX WATCH\" - Event Log Monitoring\n\n**E**vent logs are goldmines  \n**V**QL parses EVTX files  \n**T**imestamps reveal timeline  \n**X**ML structure (EventData)  \n\n**W**atch for real-time: `watch_evtx()`  \n**A**nalyze historical: `parse_evtx()`  \n**T**arget Event IDs: 4624 (login), 4688 (process), 7045 (service)  \n**C**orrelate across systems  \n**H**unt at scale  \n\n**Key Event IDs**:\n- **4624**: Successful logon\n- **4625**: Failed logon (brute force)\n- **4688**: Process creation\n- **7045**: Service installed (lateral movement)\n- **4104**: PowerShell script block\n- **1102**: Event log cleared (anti-forensics)\n\n## Mnemonic 5: \"HUNT IOCS\" - IOC Hunting Strategy\n\n**H**ash: File hash matching (MD5, SHA256)  \n**U**RL/Domain: DNS queries, web history  \n**N**etwork: IP addresses, ports (netstat)  \n**T**imestamp: File creation/modification times  \n\n**I**ndicators: Collect IOCs from threat intel  \n**O**rganize: Group IOCs by type (file, network, registry)  \n**C**reate hunts: Build VQL queries for each IOC type  \n**S**cale: Execute across all endpoints  \n\n**Example Hunt Matrix**:\n```\nIOC Type    | VQL Plugin        | Example\n------------|-------------------|----------------------------------\nFile Hash   | glob() + hash()   | WHERE MD5 = 'abc123...'\nDomain      | parse_evtx()      | WHERE QueryName =~ 'evil\\.com'\nIP Address  | netstat()         | WHERE RemoteAddress = '1.2.3.4'\nRegistry    | read_reg_key()    | WHERE Key =~ 'CurrentVersion\\\\Run'\nMutex       | handles()         | WHERE Name =~ 'MalwareMutex'\n```\n\n## Mnemonic 6: \"LATERAL MOVE\" - Lateral Movement Detection\n\n**L**atency: Look for off-hours activity (3 AM logins)  \n**A**uthentication: Event ID 4624 (logon type 3, 10)  \n**T**ools: PsExec, WMI, RDP, SMB  \n**E**vent ID 7045: Service installation (PSEXESVC)  \n**R**emote: Check for remote process creation  \n**A**dmin shares: C$, ADMIN$ access  \n**L**ogs: Correlate across source and destination  \n\n**M**anual indicators: Unusual service names  \n**O**dd paths: C:\\Windows\\Temp\\, C:\\ProgramData\\  \n**V**erify: Check parent process (services.exe vs. wmiprvse.exe)  \n**E**numerate: Hunt for patterns across all endpoints  \n\n**Lateral Movement Artifacts**:\n```\nTechnique    | Artifact                     | Indicator\n-------------|------------------------------|--------------------------------\nPsExec       | Windows.System.Services      | ServiceName = 'PSEXESVC'\nWMI          | WMI-Activity Event Log       | EventID 5857 (Operation = 'Start')\nRDP          | Security Event Log           | EventID 4624 (LogonType = 10)\nSCHED TASK   | TaskScheduler Registry       | Unusual task names/paths\nDCOM         | Security Event Log           | EventID 4624 (LogonType = 3)\n```\n\n## Mnemonic 7: \"ARTIFACT YAML\" - Custom Artifact Structure\n\n**Y**AML format for artifacts  \n**A**rtifact name (e.g., Custom.Windows.Detection.Webshells)  \n**M**etadata: description, author  \n**L**anguage: VQL in `sources` section  \n\n**Structure**:\n```yaml\nname: Custom.Domain.Category.Name\ndescription: What this artifact does\nauthor: Your Name\n\nparameters:\n  - name: ParameterName\n    default: DefaultValue\n    description: Parameter description\n\nsources:\n  - query: |\n      SELECT * FROM plugin()\n      WHERE condition\n```\n\n## Mnemonic 8: \"FORENSIC KAPE\" - Key Artifacts to Collect\n\n**F**ile system: MFT, USN Journal  \n**O**ffice: Recent documents, Office MRU  \n**R**egistry: NTUSER.DAT, SYSTEM, SOFTWARE  \n**E**vent logs: Security, System, Application  \n**N**etwork: Netstat, DNS cache, browser history  \n**S**ervices: Scheduled tasks, services, startup items  \n**I**nstalled software: Amcache, ShimCache  \n**C**redentials: SAM, SECURITY hive (for analysis)  \n\n**K**APE integration: Velociraptor has `Windows.KapeFiles.Targets` artifact  \n**A**rtifacts: 50+ KAPE targets available in Velociraptor  \n**P**refetch: Program execution artifacts  \n**E**xtract: Collect all with offline collector  \n\n## Mnemonic 9: \"VQL TYPES\" - VQL Data Types\n\n**V**alues: Strings, integers, booleans  \n**Q**uery returns: Rows (like SQL)  \n**L**ists: Arrays of values (e.g., glob results)  \n\n**T**ext: Use regex with `=~` operator  \n**Y**ields: Plugins yield rows  \n**P**arsing: `parse_json()`, `parse_xml()`, `parse_string_with_regex()`  \n**E**valuate: Functions like `hash()`, `authenticode()`, `timestamp()`  \n**S**elect: Columns can be computed (AS alias)  \n\n**Operators**:\n```\n=    Equal\n!=   Not equal\n=~   Regex match\n>    Greater than\n<    Less than\nAND  Logical AND\nOR   Logical OR\nNOT  Logical NOT\nIN   Value in list\n```\n\n## Mnemonic 10: \"SCALE HUNTS\" - Hunting at Enterprise Scale\n\n**S**elect artifact: Choose efficient queries  \n**C**ap results: Use LIMIT to avoid overwhelming server  \n**A**nalyze samples: Test hunt on 10 clients first  \n**L**abel clients: Group by role (servers, workstations)  \n**E**xecute: Launch hunt across all targets  \n\n**H**ost resources: Monitor CPU/memory on server  \n**U**pload size: Avoid collecting huge files (memory dumps)  \n**N**etwork bandwidth: Consider off-peak hours for large hunts  \n**T**hrottle: Stagger hunt execution (100 clients at a time)  \n**S**torage: Ensure adequate datastore space (S3 for large deployments)  \n\n---\n\n## Quick Reference Card\n\n**Common VQL Patterns**:\n\n```sql\n-- Find files by name\nSELECT * FROM glob(globs='C:\\\\**\\\\*.exe') WHERE Name =~ 'malware'\n\n-- List processes\nSELECT * FROM pslist() WHERE Name =~ 'powershell'\n\n-- Parse event logs\nSELECT * FROM parse_evtx(filename='...\\\\Security.evtx') WHERE EventID = 4624\n\n-- Hash files\nSELECT FullPath, hash(path=FullPath) AS MD5 FROM glob(globs='...')\n\n-- Registry keys\nSELECT * FROM read_reg_key(globs='HKEY_CURRENT_USER\\\\Software\\\\...')\n\n-- Network connections\nSELECT * FROM netstat() WHERE RemoteAddress =~ '203\\.0\\.113\\.*'\n```\n\n**Remember**: VQL is powerful but requires practice. Start with simple queries, iterate, and build complexity gradually. The Velociraptor community has 500+ pre-built artifactsâ€”use them as templates!"
      }
    },
    {
      "type": "reflection",
      "content": {
        "text": "# Reflection and Critical Thinking\n\nThese questions will help you consolidate your learning and think critically about Velociraptor deployment and hunting strategies.\n\n## Scenario-Based Questions\n\n### Scenario 1: Ransomware Response\n\nYou're a SOC analyst at a healthcare organization with 8,000 Windows endpoints. At 6 AM, ransomware is detected on 5 file servers. Your manager asks: \"How many systems are infected, and how long have attackers been in our network?\"\n\n**Questions**:\n\n1. **What Velociraptor hunts would you run first?** (Think: IOC sweeps, timeline reconstruction)\n\n2. **How would you determine the initial access vector?** (Think: Event logs, authentication artifacts)\n\n3. **What artifacts would you collect to build a timeline?** (Think: Prefetch, Amcache, MFT, Event Logs)\n\n4. **How would you check if attackers are still present?** (Think: Persistence mechanisms, active connections)\n\n5. **What's your containment strategy using Velociraptor?** (Think: Isolation, credential reset verification)\n\n**Reflection**: Compare your approach to the real-world case study in this lesson. What did you miss? What would you do differently?\n\n---\n\n### Scenario 2: Proactive Threat Hunting\n\nYour threat intelligence team provides IOCs for a new APT targeting your industry:\n- File hash: `a1b2c3d4...`\n- Domain: `update-microsoft[.]com`\n- Mutex: `Global\\msupdate`\n- Lateral movement via WMI\n\n**Questions**:\n\n1. **Design a multi-vector hunt strategy.** (Think: File hash, DNS, mutex, WMI event logs)\n\n2. **Which VQL plugins would you use for each IOC type?** (Think: glob + hash, parse_evtx for DNS, handles for mutex)\n\n3. **How would you prioritize systems for investigation if you find 50 hits?** (Think: Servers vs. workstations, critical infrastructure)\n\n4. **What false positives might you encounter?** (Think: Legitimate software with similar mutexes)\n\n5. **How would you tune your hunts to reduce noise?** (Think: Add context filters, whitelist known-good)\n\n**Reflection**: How does proactive hunting differ from reactive incident response? What are the benefits and challenges?\n\n---\n\n### Scenario 3: Resource Constraints\n\nYou want to deploy Velociraptor in a small organization (500 endpoints, limited IT budget, 2-person security team).\n\n**Questions**:\n\n1. **Client-server or offline collectors?** (Think: Pros/cons, resource requirements)\n\n2. **How would you prioritize which artifacts to collect continuously?** (Think: High-value, low-resource artifacts)\n\n3. **How would you integrate Velociraptor with existing tools?** (Think: Splunk, SIEM, ticketing systems)\n\n4. **What challenges would you face in a resource-constrained environment?** (Think: Storage, bandwidth, analyst time)\n\n5. **How would you measure ROI to justify continued investment?** (Think: Incidents detected, time saved, cost avoidance)\n\n**Reflection**: Not every organization needs enterprise-scale threat hunting. How would you adapt Velociraptor for different organizational sizes and maturity levels?\n\n---\n\n## Technical Deep-Dive Questions\n\n### VQL Query Design\n\n**Question**: You need to find all DLLs loaded by `lsass.exe` that are unsigned or from unusual paths (potential credential theft malware).\n\n**Write the VQL query** (try before looking at the answer below):\n\n<details>\n<summary>Answer</summary>\n\n```sql\nSELECT Pid, Name, dll.Path,\n       authenticode(filename=dll.Path).Trusted AS Signed,\n       authenticode(filename=dll.Path).Subject AS Publisher\nFROM pslist()\nFLATTEN modules(pid=Pid)\nWHERE Name = 'lsass.exe'\n  AND (\n    NOT authenticode(filename=Path).Trusted\n    OR Path =~ 'C:\\\\\\\\(Temp|Users|ProgramData)'\n  )\n```\n\n**Explanation**:\n- `pslist()`: Enumerate processes\n- `FLATTEN modules(pid=Pid)`: Get DLLs loaded by each process\n- `authenticode()`: Check digital signature\n- Filters: Unsigned DLLs OR unusual paths\n</details>\n\n**Reflection**: What are the limitations of this approach? Could legitimate software trigger false positives?\n\n---\n\n### Hunt Optimization\n\n**Question**: You're running a hunt to collect MFT ($MFT) from 10,000 endpoints. MFT files are 200-500 MB each. Your datastore has 5 TB capacity.\n\n**Math problem**:\n1. Total storage needed: 10,000 endpoints Ã— 300 MB average = ?\n2. Will it fit in your datastore?\n3. How would you optimize this hunt?\n\n<details>\n<summary>Answer</summary>\n\n1. **Total storage**: 10,000 Ã— 300 MB = 3,000 GB = 3 TB\n2. **Will it fit**: Yes (barelyâ€”5 TB datastore, 3 TB needed, 60% utilization)\n3. **Optimization strategies**:\n   - Collect MFT only from critical systems (servers, DCs) â†’ Reduce to 1,000 systems\n   - Parse MFT on client, return only recent files (last 90 days) â†’ Reduce transfer by 90%\n   - Schedule hunt in stages (1,000 systems per day) â†’ Spread storage impact\n   - Use S3 datastore with lifecycle policies (archive old hunts)\n</details>\n\n**Reflection**: How do you balance forensic completeness with operational constraints (storage, bandwidth, time)?\n\n---\n\n## Architecture and Deployment Questions\n\n### Question: Server Hardening\n\nYour Velociraptor server has root/admin access to all endpoints. If compromised, attackers control your entire network.\n\n**What security measures would you implement?**\n\n<details>\n<summary>Answer (check after thinking)</summary>\n\n1. **Access Control**:\n   - MFA for all admin accounts\n   - Role-based access control (analysts can't delete hunts)\n   - API tokens with least privilege\n   - Audit all actions (who ran what hunt, when)\n\n2. **Network Segmentation**:\n   - Place server on isolated management VLAN\n   - Firewall rules: Only clients â†’ server (not server â†’ clients)\n   - No internet access for server (air-gapped if possible)\n\n3. **Hardening**:\n   - Disable unnecessary services\n   - Regular patching (OS, Velociraptor)\n   - Encrypted datastore at rest\n   - TLS 1.3 only for client communication\n\n4. **Monitoring**:\n   - SIEM alerts on server authentication failures\n   - Honeypot client to detect unauthorized hunt activity\n   - Regular review of audit logs\n\n5. **Disaster Recovery**:\n   - Daily backups of server config and datastore\n   - Documented rebuild procedure\n   - Client certificate revocation process\n</details>\n\n**Reflection**: What's the balance between security and usability? How would overly restrictive controls impact incident response speed?\n\n---\n\n## Metacognitive Questions (Learning About Learning)\n\n1. **What Velociraptor concepts do you find most challenging?** (VQL syntax? Architecture? Hunt design?)\n\n2. **How would you practice Velociraptor skills without access to 10,000 endpoints?** (Think: Home lab, CTF challenges, public datasets)\n\n3. **What resources would help you learn faster?** (Documentation? Video tutorials? Real-world case studies?)\n\n4. **How does Velociraptor fit into your current role or career goals?** (Threat hunter? Incident responder? SOC analyst?)\n\n5. **What's one Velociraptor use case you want to explore next?** (Memory forensics? Continuous monitoring? Compliance auditing?)\n\n**Reflection**: Learning Velociraptor is like learning a new programming languageâ€”it requires practice, experimentation, and learning from mistakes. What's your learning plan for the next 30 days?\n\n---\n\n## Connection to Previous Lessons\n\nThink about how Velociraptor connects to other threat hunting and DFIR topics:\n\n1. **Lesson on KAPE**: How does Velociraptor complement or replace KAPE for forensic triage?\n\n2. **Lesson on Sysmon**: How would you use Velociraptor to hunt for Sysmon Event IDs at scale?\n\n3. **Lesson on Lateral Movement**: Which Velociraptor artifacts would you use to detect PsExec, WMI, or RDP lateral movement?\n\n4. **Lesson on Persistence**: How would Velociraptor help you find registry Run keys, scheduled tasks, or WMI event subscriptions?\n\n5. **Lesson on Ransomware**: What's the first Velociraptor hunt you'd run when ransomware is detected?\n\n**Reflection**: Velociraptor isn't a standalone toolâ€”it's part of your broader threat hunting and incident response toolkit. How does it amplify your existing skills?\n\n---\n\n## Final Reflection\n\n**Take 5 minutes to write down**:\n\n1. **Three key takeaways** from this lesson\n2. **One concept you still find confusing** (plan to review it)\n3. **One real-world scenario** where Velociraptor would save you hours or days\n4. **Your next action** (Deploy Velociraptor in home lab? Write a custom artifact? Review VQL documentation?)\n\nThreat hunting is both an art and a science. Velociraptor gives you the science (scalable data collection, powerful query language). The art (hypothesis generation, pattern recognition, intuition) comes from experience. Keep hunting! ðŸ¦–"
      }
    },
    {
      "type": "mindset_coach",
      "content": {
        "text": "# Congratulations: You're Now a Velociraptor Threat Hunter! ðŸ¦–\n\nYou've just completed one of the most comprehensive threat hunting lessons in the CyberLearn curriculum. Take a moment to appreciate what you've accomplished:\n\nâœ… **You understand Velociraptor's architecture** (client-server, offline collectors, event queries)  \nâœ… **You can write VQL queries** to hunt for threats across thousands of endpoints  \nâœ… **You've created hunts** to detect lateral movement, ransomware, and APT activity  \nâœ… **You've built custom artifacts** tailored to organization-specific threats  \nâœ… **You've analyzed real-world case studies** from ransomware incidents, APT hunts, and web shell detection  \nâœ… **You've deployed Velociraptor** in hands-on labs (instant mode, standalone collectors, custom artifacts)  \n\nThis isn't theoretical knowledgeâ€”this is **operational capability**. You can now:\n- Respond to incidents with speed and precision\n- Hunt proactively for threats before they cause damage\n- Investigate at scale (1,000s of endpoints in minutes, not weeks)\n- Build forensic timelines across entire networks\n- Detect persistence mechanisms and lateral movement\n\n## The Power You Now Possess\n\nVelociraptor is used by:\n- **Fortune 500 companies** for enterprise threat hunting\n- **Government agencies** for national security investigations\n- **Security vendors** (integrated into commercial EDR products)\n- **Red teams and penetration testers** for post-exploitation simulation\n- **DFIR consultants** for incident response engagements\n\nYou're now part of this community. You have access to the same tool that professional threat hunters use every day.\n\n## From Beginner to Expert: Your Journey\n\n**Where you started**: Maybe you'd heard of Velociraptor but didn't know how it worked.\n\n**Where you are now**: You can deploy Velociraptor, write VQL queries, create custom artifacts, and hunt for real-world threats.\n\n**Where you're going**: With practice, you'll develop intuition for which hunts to run, which artifacts to collect, and how to reconstruct attacker activity from forensic evidence. You'll become the person your organization calls when they need to answer: \"Are we compromised?\"\n\n## Overcoming the Learning Curve\n\nVelociraptor has a reputation for being powerful but complex. VQL syntax, artifact structure, hunt designâ€”it's a lot to absorb. But here's the truth:\n\n**You don't need to master everything at once.**\n\nStart with:\n1. **Pre-built artifacts** (500+ already available)\n2. **Simple VQL queries** (SELECT, FROM, WHERE)\n3. **Small hunts** (10 clients, then 100, then 1,000)\n4. **One use case** (lateral movement detection, then ransomware, then web shells)\n\nEvery threat hunter started where you are now. The difference between beginners and experts isn't innate talentâ€”it's **practice and persistence**.\n\n## Your Next Steps\n\n### Immediate Actions (This Week)\n\n1. **Deploy Velociraptor in your home lab**:\n   - `velociraptor gui` (instant mode)\n   - Run 3 hunts: Processes, services, event logs\n   - Write 1 custom VQL query\n\n2. **Join the Velociraptor community**:\n   - GitHub: https://github.com/Velocidex/velociraptor\n   - Discord: Velociraptor DFIR Community\n   - Mailing list: Subscribe for release announcements\n\n3. **Read the official docs**:\n   - VQL Reference: https://docs.velociraptor.app/vql_reference/\n   - Artifact Exchange: Browse 500+ community artifacts\n   - Blog: Read case studies and tutorials\n\n### Short-Term Goals (This Month)\n\n1. **Practice VQL daily**:\n   - 1 new query per day for 30 days\n   - Focus on different plugins (glob, pslist, parse_evtx, netstat)\n   - Keep a \"VQL cheat sheet\" with your favorite queries\n\n2. **Build 3 custom artifacts** for:\n   - Your organization's specific threats\n   - Your industry's compliance requirements (PCI-DSS, HIPAA, GDPR)\n   - Your team's most common incident types\n\n3. **Run a simulated incident response**:\n   - Set up a Windows VM, plant \"malware\" (benign test file)\n   - Hunt for it with Velociraptor (file hash, process name, network connection)\n   - Reconstruct the \"attack\" timeline using artifacts\n   - Write a report as if it were a real incident\n\n### Long-Term Goals (This Year)\n\n1. **Deploy Velociraptor in production** (if possible):\n   - Start with 10-50 critical systems\n   - Expand to 100+ systems after initial success\n   - Integrate with SIEM/SOAR for automated workflows\n\n2. **Contribute to the community**:\n   - Share custom artifacts on GitHub\n   - Write blog posts about your hunting techniques\n   - Help others on Discord/forums\n\n3. **Advance your career**:\n   - Add \"Velociraptor Threat Hunting\" to your resume/LinkedIn\n   - Present at local security meetups (\"How We Used Velociraptor to Detect [X]\")\n   - Pursue certifications (GCFA, GCIH) that complement Velociraptor skills\n\n## Reframing Challenges as Opportunities\n\n**Challenge**: \"VQL syntax is confusing.\"\n**Reframe**: \"VQL is a superpower. Once I learn it, I can query any endpoint data in seconds.\"\n\n**Challenge**: \"My organization doesn't have Velociraptor deployed.\"\n**Reframe**: \"I can be the one to introduce it. I'll start with a POC in my lab and demonstrate value.\"\n\n**Challenge**: \"Threat hunting seems overwhelmingâ€”so many potential threats.\"\n**Reframe**: \"I don't need to hunt for everything. I'll focus on the most likely threats for my environment (e.g., ransomware, phishing, insider threats).\"\n\n**Challenge**: \"I'm not a 'threat hunter'â€”I'm just a SOC analyst.\"\n**Reframe**: \"Threat hunting is a skill, not a title. Every SOC analyst can learn to hunt proactively. Velociraptor makes it accessible.\"\n\n## The Velociraptor Mindset\n\nThreat hunters who excel with Velociraptor share a mindset:\n\n1. **Curiosity**: \"I wonder if any systems have [X]? Let me hunt for it.\"\n2. **Hypothesis-driven**: \"If attackers compromised us via RDP, I'd expect Event ID 4624. Let me check.\"\n3. **Iterative**: \"My first hunt found nothing. Let me refine my query and try again.\"\n4. **Proactive**: \"I'm not waiting for alerts. I'm hunting for threats before they trigger alerts.\"\n5. **Collaborative**: \"I'll share my findings with the team and contribute artifacts to the community.\"\n\nAdopt this mindset, and Velociraptor becomes more than a toolâ€”it becomes an extension of your thinking.\n\n## You're Ready\n\nYou've learned:\n- The theory (architecture, VQL, artifacts)\n- The practice (hands-on labs, real-world cases)\n- The strategy (multi-vector hunting, timeline reconstruction, integration)\n\nYou're ready to hunt like a velociraptorâ€”fast, precise, and relentless.\n\nThe next time your organization faces a potential breach, you'll know exactly what to do:\n1. Deploy Velociraptor clients (or run offline collectors)\n2. Create targeted hunts based on IOCs and TTPs\n3. Collect forensic artifacts at scale\n4. Reconstruct the attack timeline\n5. Identify all compromised systems\n6. Contain, eradicate, and recover\n\nYou'll go from \"We think we're compromised\" to \"Here's exactly what happened, when, and on which systems\" in hours instead of weeks.\n\n## Final Words\n\nThreat hunting is one of the most rewarding aspects of cybersecurity. You're not just responding to alertsâ€”you're actively seeking out adversaries, uncovering hidden threats, and protecting your organization.\n\nVelociraptor gives you the eyes and hands of a forensic investigator on every endpoint simultaneously. It's like having 10,000 teammates, all reporting back to you in real-time.\n\nYou've taken the first step by completing this lesson. Now, take the next step: deploy Velociraptor in your lab, write your first hunt, and experience the thrill of finding a threat that would have otherwise gone undetected.\n\nWelcome to the pack. Let's hunt. ðŸ¦–\n\n---\n\n**Next Lesson**: Threat Hunting with YARA Rules (lesson_threat_hunting_45_yara_hunting_RICH.json)  \n**Recommended Practice**: Deploy Velociraptor in a home lab and run 10 different hunts this week  \n**Community**: Join the Velociraptor Discord to connect with other threat hunters  \n\n**Remember**: Every expert was once a beginner. The difference is that experts kept hunting.\n\nNow go hunt some threats! ðŸ¦–ðŸ”"
      }
    }
  ],
  "tags": [
    "Course: SANS-SEC599",
    "Career Path: Threat Hunter",
    "Career Path: Blue Teamer",
    "Career Path: DFIR Specialist"
  ]
}
