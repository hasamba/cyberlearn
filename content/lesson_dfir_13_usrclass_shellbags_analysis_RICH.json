{
  "lesson_id": "1cfd5651-ec6c-4ed8-a7dc-c3904139db5f",
  "domain": "dfir",
  "title": "UsrClass.dat and ShellBags Analysis",
  "difficulty": 2,
  "order_index": 13,
  "prerequisites": [
    "eb47f98c-2144-4c23-83d8-5990fe4ac1c2"
  ],
  "concepts": [
    "UsrClass.dat registry hive structure",
    "ShellBags forensic value for folder access tracking",
    "Explorer navigation history reconstruction",
    "Network share and external drive enumeration",
    "ShellBags Explorer tool usage",
    "Folder access timestamps and last interaction dates"
  ],
  "estimated_time": 55,
  "learning_objectives": [
    "Understand UsrClass.dat hive purpose and forensic significance",
    "Parse ShellBags to identify folder access history",
    "Reconstruct user's folder navigation patterns",
    "Detect network share and USB drive enumeration",
    "Use ShellBags Explorer to visualize folder access timeline",
    "Correlate ShellBags with other artifacts for complete user activity picture"
  ],
  "post_assessment": [
    {
      "question_id": "shellbags-001",
      "question": "What is the primary forensic value of ShellBags?",
      "options": [
        "To track program execution history",
        "To record folder access and Explorer navigation history",
        "To store deleted file metadata",
        "To log network traffic patterns"
      ],
      "correct_answer": 1,
      "explanation": "ShellBags record Windows Explorer folder access history, including local folders, network shares, USB drives, and virtual folders. They track which folders a user opened, viewed, and navigated to, making them invaluable for reconstructing user activity.",
      "type": "multiple_choice",
      "difficulty": 1
    },
    {
      "question_id": "shellbags-002",
      "question": "Where is the UsrClass.dat registry hive located?",
      "options": [
        "C:\\Windows\\System32\\config\\",
        "C:\\Users\\<username>\\",
        "C:\\Users\\<username>\\AppData\\Local\\Microsoft\\Windows\\",
        "C:\\ProgramData\\Microsoft\\Windows\\"
      ],
      "correct_answer": 2,
      "explanation": "UsrClass.dat is located at C:\\Users\\<username>\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat. This user-specific hive contains per-user COM class registrations and ShellBags data.",
      "type": "multiple_choice",
      "difficulty": 1
    },
    {
      "question_id": "shellbags-003",
      "question": "What information do ShellBags reveal about folders?",
      "options": [
        "Only folder names",
        "Folder path, access timestamp, view settings, and last interaction date",
        "File contents within folders",
        "Folder permissions and ownership"
      ],
      "correct_answer": 1,
      "explanation": "ShellBags store comprehensive folder metadata including: full folder path, last interaction timestamp, Explorer view settings (icon view, list view), window size/position, sort order, and whether the folder was accessed from local disk, network share, or removable media.",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "shellbags-004",
      "question": "Do ShellBags entries persist after a folder is deleted?",
      "options": [
        "No, ShellBags are automatically deleted when folders are deleted",
        "Yes, ShellBags entries persist even after folder deletion",
        "Only if the folder was on a network share",
        "Only if the folder contained executable files"
      ],
      "correct_answer": 1,
      "explanation": "ShellBags entries persist in the registry even after the folder is deleted. This makes them valuable for proving that a user accessed folders that no longer exist (e.g., deleted evidence, disconnected USB drives, unmapped network shares).",
      "type": "multiple_choice",
      "difficulty": 2
    },
    {
      "question_id": "shellbags-005",
      "question": "Which tool is the industry standard for parsing ShellBags?",
      "options": [
        "RegRipper",
        "ShellBags Explorer",
        "Registry Explorer",
        "Volatility"
      ],
      "correct_answer": 1,
      "explanation": "ShellBags Explorer (by Eric Zimmerman) is the industry-standard tool for parsing and visualizing ShellBags data. It extracts folder access history, timestamps, and provides a timeline view of user's Explorer navigation patterns.",
      "type": "multiple_choice",
      "difficulty": 1
    }
  ],
  "jim_kwik_principles": [
    "teach_like_im_10",
    "memory_hooks",
    "active_learning",
    "connect_to_what_i_know",
    "minimum_effective_dose",
    "meta_learning",
    "reframe_limiting_beliefs",
    "gamify_it",
    "learning_sprint",
    "multiple_memory_pathways"
  ],
  "content_blocks": [
    {
      "type": "mindset_coach",
      "content": {
        "text": "## Welcome to ShellBags: Windows' Folder Access Diary\n\nImagine if Windows kept a **permanent record** of every folder you've ever opened in Explorer - not just what you accessed, but **when**, from **where** (local disk? USB? network share?), and even how you preferred to **view** it (icons? list? details?).\n\nThat's ShellBags.\n\n**Why is this forensically powerful?**\n\nBecause attackers and insiders often:\n- Enumerate network shares looking for sensitive data\n- Browse connected USB drives for exfiltration targets\n- Navigate to hidden folders containing malware\n- Delete evidence folders (but ShellBags entries persist!)\n\nShellBags reveal:\n- ‚úÖ **Every folder accessed** (local, network, USB, virtual)\n- ‚úÖ **Access timestamps** (when user last interacted)\n- ‚úÖ **Folder paths** (even if folder deleted)\n- ‚úÖ **Network shares** (\\\\SERVER\\Share enumeration)\n- ‚úÖ **USB drive access** (E:\\, F:\\ removable media)\n- ‚úÖ **Folder existence proof** (even after deletion)\n\nBy the end of this lesson, you'll be using ShellBags analysis to:\n- Reconstruct user's folder navigation history\n- Prove network share enumeration (lateral reconnaissance)\n- Detect USB drive browsing (data exfiltration preparation)\n- Identify deleted folder access (evidence of anti-forensics)\n- Build comprehensive user activity timelines\n\nShellBags are Windows Explorer's **breadcrumb trail** - and now you're learning to follow it.\n\nLet's uncover where users have been browsing!"
      }
    },
    {
      "type": "explanation",
      "content": {
        "text": "# UsrClass.dat and ShellBags: Tracking Folder Access History\n\n## What is UsrClass.dat?\n\n**UsrClass.dat** is a user-specific registry hive file that stores:\n1. **Per-user COM class registrations** (Component Object Model)\n2. **File associations** (user-level overrides)\n3. **ShellBags** (Windows Explorer folder access history)\n\n### File Location\n\n```\nC:\\Users\\<username>\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat\n```\n\n**Example**:\n```\nC:\\Users\\Alice\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat\nC:\\Users\\Bob\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat\n```\n\n**Transaction Logs** (if present):\n```\nUsrClass.dat.LOG1\nUsrClass.dat.LOG2\n```\n\n---\n\n## What Are ShellBags?\n\n**ShellBags** are registry entries that track Windows Explorer **folder access history** and **view settings**. Created to improve user experience by remembering folder preferences, they became a forensic goldmine for tracking user navigation.\n\n### The Official Purpose (Microsoft's Intent)\n\nMicrosoft created ShellBags to:\n1. **Remember folder view preferences** (icon view, list view, details)\n2. **Restore window size/position** when reopening folders\n3. **Preserve sort order** (sort by name, date, size)\n4. **Optimize Explorer performance** (quick folder rendering)\n\n### The Forensic Side Effect (Why We Love It)\n\nAs a byproduct, ShellBags record:\n- **Every folder accessed** via Windows Explorer\n- **Last interaction timestamp** for each folder\n- **Folder path** (local, network share, USB drive)\n- **Folder existence proof** (even after folder deletion)\n- **Network share enumeration** (\\\\SERVER\\Share\\Folder)\n- **USB drive browsing** (E:\\Documents, F:\\Backups)\n- **Virtual folder access** (Control Panel, Recycle Bin)\n\n**Forensic Impact**: ShellBags answer the question: **\"Where did the user browse in Windows Explorer?\"**\n\n---\n\n## ShellBags Registry Locations\n\nShellBags data is stored in **two registry locations**:\n\n### Location 1: NTUSER.DAT (Legacy Windows 7 and earlier)\n\n```\nHKCU\\Software\\Microsoft\\Windows\\Shell\\Bags\nHKCU\\Software\\Microsoft\\Windows\\Shell\\BagMRU\n```\n\n**Forensic Note**: Windows 7 stores ShellBags primarily in NTUSER.DAT.\n\n---\n\n### Location 2: UsrClass.dat (Windows 8/10/11)\n\n```\nHKCU\\Software\\Classes\\Local Settings\\Software\\Microsoft\\Windows\\Shell\\Bags\nHKCU\\Software\\Classes\\Local Settings\\Software\\Microsoft\\Windows\\Shell\\BagMRU\n```\n\n**Forensic Note**: Windows 8+ moved ShellBags to UsrClass.dat for better separation of user data.\n\n**Key Point**: Always analyze **both** NTUSER.DAT and UsrClass.dat to get complete ShellBags history.\n\n---\n\n## ShellBags Structure Explained\n\n### BagMRU: Folder Hierarchy and Paths\n\n**Registry Path**:\n```\nLocal Settings\\Software\\Microsoft\\Windows\\Shell\\BagMRU\n```\n\n**Purpose**: Stores folder **hierarchy** and **paths** in a tree structure (MRU = Most Recently Used)\n\n**Structure**:\n```\nBagMRU\n‚îú‚îÄ‚îÄ 0 (Desktop)\n‚îÇ   ‚îú‚îÄ‚îÄ 0 (This PC)\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 0 (C:\\ drive)\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 0 (Users folder)\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 0 (Alice folder)\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 0 (Documents)\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 1 (Downloads)\n‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 1 (Network Locations)\n‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 0 (\\\\SERVER01\\Share)\n‚îÇ   ‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 0 (Confidential)\n‚îÇ   ‚îú‚îÄ‚îÄ 1 (Recycle Bin)\n‚îÇ   ‚îî‚îÄ‚îÄ 2 (Control Panel)\n‚îî‚îÄ‚îÄ MRUListEx (order of access)\n```\n\n**Each BagMRU entry contains**:\n- **Folder name** (e.g., \"Documents\", \"Confidential\")\n- **Folder path** (e.g., C:\\Users\\Alice\\Documents)\n- **Folder type** (local folder, network share, virtual folder)\n- **Last write timestamp** (registry key last modified)\n- **MRUListEx** (order folders were accessed)\n\n---\n\n### Bags: Folder View Settings and Timestamps\n\n**Registry Path**:\n```\nLocal Settings\\Software\\Microsoft\\Windows\\Shell\\Bags\n```\n\n**Purpose**: Stores folder **view settings** and **last interaction dates**\n\n**Structure**:\n```\nBags\n‚îú‚îÄ‚îÄ 1\n‚îÇ   ‚îî‚îÄ‚îÄ Shell\n‚îÇ       ‚îî‚îÄ‚îÄ SnapshotTime: 2024-10-16 14:32:11 UTC\n‚îÇ       ‚îî‚îÄ‚îÄ FolderType: Generic\n‚îÇ       ‚îî‚îÄ‚îÄ Mode: 4 (Details view)\n‚îÇ       ‚îî‚îÄ‚îÄ Sort: Name\n‚îú‚îÄ‚îÄ 2\n‚îÇ   ‚îî‚îÄ‚îÄ Shell\n‚îÇ       ‚îî‚îÄ‚îÄ SnapshotTime: 2024-10-15 08:23:45 UTC\n‚îÇ       ‚îî‚îÄ‚îÄ FolderType: Documents\n‚îú‚îÄ‚îÄ 3\n‚îÇ   ‚îî‚îÄ‚îÄ Shell\n‚îÇ       ‚îî‚îÄ‚îÄ SnapshotTime: 2024-10-14 16:45:32 UTC\n```\n\n**Each Bag entry contains**:\n- **SnapshotTime**: Last time folder was accessed/viewed\n- **FolderType**: Generic, Documents, Pictures, Music, etc.\n- **Mode**: View mode (1=Icons, 2=List, 3=Details, 4=Tiles)\n- **Sort**: Sort order (Name, Date, Size, Type)\n- **Window size**: Height and width in pixels\n- **Window position**: X and Y coordinates on screen\n\n---\n\n## ShellBags Forensic Value\n\n### What ShellBags Prove\n\n‚úÖ **Folder Access**: User opened/viewed specific folders  \n‚úÖ **Network Share Enumeration**: User browsed \\\\SERVER\\Share folders  \n‚úÖ **USB Drive Access**: User navigated E:\\, F:\\ removable media  \n‚úÖ **Deleted Folder Evidence**: ShellBags entry persists after folder deletion  \n‚úÖ **Timeline Data**: Last interaction timestamps for each folder  \n‚úÖ **Reconnaissance Behavior**: Sequential access to multiple network shares  \n‚úÖ **Virtual Folder Access**: Control Panel, Recycle Bin, Network Neighborhood  \n\n### What ShellBags CANNOT Prove\n\n‚ùå **File Access**: ShellBags track folders, not individual files  \n‚ùå **File Copying**: No evidence of file operations (copy, move, delete)  \n‚ùå **Program Execution**: Use Prefetch, AmCache, UserAssist instead  \n‚ùå **File Content**: No information about what's inside folders  \n‚ùå **Network Transfer**: No proof files were copied from network shares  \n\n**Key Insight**: ShellBags show **where users browsed**, not **what they did** in those folders. Correlate with other artifacts (MFT, LNK files, Prefetch) for complete picture.\n\n---\n\n## ShellBags Timeline and Timestamps\n\n### Registry Key Last Write Time\n\nEach ShellBags registry key has a **Last Write timestamp** showing when the entry was created/modified.\n\n**Example**:\n```\nKey: BagMRU\\0\\0\\0\\0 (C:\\Users\\Alice\\Documents)\nLast Write: 2024-10-16 14:32:11.456 UTC\n\nInterpretation: User accessed Documents folder on Oct 16 at 14:32:11\n```\n\n### SnapshotTime (in Bags)\n\nThe **SnapshotTime** value in Bags entries shows last folder interaction.\n\n**Example**:\n```\nKey: Bags\\1\\Shell\nSnapshotTime: 2024-10-16 14:32:11.456 UTC\n\nInterpretation: User last viewed this folder on Oct 16 at 14:32:11\n```\n\n**Forensic Use**: Build timeline of folder access patterns.\n\n---\n\n## Network Share ShellBags\n\n### Detecting Network Share Enumeration\n\nShellBags record **every network share folder** accessed via Explorer.\n\n**Example**:\n```\nBagMRU Entry:\n  Path: \\\\DC01\\SYSVOL\\domain.com\\Policies\n  Last Write: 2024-10-16 02:34:11 UTC\n\nBagMRU Entry:\n  Path: \\\\FILESERVER\\Finance\\Confidential\n  Last Write: 2024-10-16 02:35:45 UTC\n\nBagMRU Entry:\n  Path: \\\\FILESERVER\\HR\\Personnel_Records\n  Last Write: 2024-10-16 02:36:23 UTC\n```\n\n**Forensic Interpretation**:\n- User browsed **domain controller** SYSVOL (reconnaissance)\n- Accessed **Finance** share (sensitive data)\n- Accessed **HR** share (personnel records)\n- Sequential access pattern (2-minute window) suggests deliberate enumeration\n\n### Attack Indicator: Rapid Network Share Access\n\n**Pattern**:\n```\n02:34:11 - \\\\DC01\\SYSVOL (domain admin enumeration)\n02:34:45 - \\\\DC01\\NETLOGON (credential theft prep)\n02:35:12 - \\\\FILESERVER\\C$ (admin share access)\n02:35:45 - \\\\FILESERVER\\Finance\\Confidential (data theft target)\n02:36:23 - \\\\FILESERVER\\HR\\Personnel_Records (second target)\n```\n\n**Conclusion**: Attacker/insider systematically enumerated network shares for sensitive data.\n\n---\n\n## USB Drive ShellBags\n\n### Detecting USB Drive Browsing\n\nShellBags record folders accessed on **removable media** (USB drives, external HDDs).\n\n**Example**:\n```\nBagMRU Entry:\n  Path: E:\\ (Removable Disk)\n  Last Write: 2024-10-15 16:44:32 UTC\n\nBagMRU Entry:\n  Path: E:\\Backup\n  Last Write: 2024-10-15 16:45:11 UTC\n\nBagMRU Entry:\n  Path: E:\\Backup\\Confidential_Files\n  Last Write: 2024-10-15 16:45:45 UTC\n```\n\n**Forensic Interpretation**:\n- User opened USB drive E:\\ at 16:44:32\n- Navigated to E:\\Backup at 16:45:11\n- Accessed E:\\Backup\\Confidential_Files at 16:45:45\n- Total navigation time: 73 seconds\n\n### Correlation with USB Device History\n\n**Registry USBSTOR**:\n```\nDevice: SanDisk Ultra 64GB\nSerial: 5C753012ABCD\nFirst Connected: 2024-10-15 16:44:21 UTC\nLast Connected: 2024-10-15 16:52:34 UTC\n```\n\n**Correlation**:\n```\n16:44:21 - USB device connected (Registry USBSTOR)\n16:44:32 - User opened E:\\ in Explorer (ShellBags)\n16:45:45 - User accessed Confidential_Files folder (ShellBags)\n16:48:11 - Robocopy.exe executed (Prefetch)\n16:52:34 - USB device disconnected (Registry USBSTOR)\n```\n\n**Conclusion**: User browsed USB drive, accessed confidential folder, then executed file copy tool ‚Üí **Data exfiltration**.\n\n---\n\n## Deleted Folder Evidence\n\n### ShellBags Persist After Folder Deletion\n\n**Scenario**: Attacker deletes evidence folder\n\n**ShellBags Entry**:\n```\nBagMRU:\n  Path: C:\\Temp\\Malware_Tools\n  Last Write: 2024-10-16 03:47:21 UTC\n\nBags\\5\\Shell:\n  SnapshotTime: 2024-10-16 03:47:21 UTC\n  FolderType: Generic\n\nCurrent Disk Status:\n  C:\\Temp\\Malware_Tools ‚Üí FOLDER NOT FOUND (deleted)\n```\n\n**Forensic Value**: ShellBags **prove** folder existed and was accessed, even after deletion.\n\n**Example Timeline**:\n```\n03:47:21 - User accessed C:\\Temp\\Malware_Tools (ShellBags)\n03:52:34 - mimikatz.exe executed (Prefetch)\n04:15:11 - Folder deleted (anti-forensics attempt)\n\nConclusion: ShellBags prove attacker accessed malware folder before deletion\n```\n\n---\n\n## ShellBags Analysis Workflow\n\n### Step 1: Acquire UsrClass.dat and NTUSER.DAT\n\n```powershell\n# Copy UsrClass.dat\nCopy-Item \"C:\\Users\\Alice\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat\" -Destination \"C:\\Forensics\\UsrClass.dat\"\n\n# Copy NTUSER.DAT (for complete analysis)\nCopy-Item \"C:\\Users\\Alice\\NTUSER.DAT\" -Destination \"C:\\Forensics\\NTUSER.DAT\"\n\n# Copy transaction logs\nCopy-Item \"C:\\Users\\Alice\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat.LOG*\" -Destination \"C:\\Forensics\\\"\nCopy-Item \"C:\\Users\\Alice\\NTUSER.DAT.LOG*\" -Destination \"C:\\Forensics\\\"\n```\n\n---\n\n### Step 2: Parse with ShellBags Explorer\n\n**Tool**: ShellBags Explorer by Eric Zimmerman\n\n**Download**: https://ericzimmerman.github.io/\n\n**Usage**:\n```\n1. Launch ShellBagsExplorer.exe\n2. File ‚Üí Load offline hive\n3. Select UsrClass.dat\n4. (Optional) Also load NTUSER.DAT for complete history\n5. View parsed ShellBags in GUI\n```\n\n**Export to CSV**:\n```\n1. File ‚Üí Export ‚Üí CSV\n2. Save as shellbags_analysis.csv\n3. Open in Excel or Timeline Explorer\n```\n\n---\n\n### Step 3: Timeline Analysis\n\n**Open CSV in Timeline Explorer**:\n```\nTimelineExplorer.exe shellbags_analysis.csv\n```\n\n**Analysis Tasks**:\n1. **Sort by Last Interaction** ‚Üí Identify recent folder access\n2. **Filter by Path** ‚Üí Focus on network shares (\\\\SERVER), USB drives (E:\\, F:\\)\n3. **Search for sensitive paths** ‚Üí Finance, HR, Confidential, Admin\n4. **Identify deleted folders** ‚Üí Paths that no longer exist on disk\n5. **Detect rapid enumeration** ‚Üí Multiple folders accessed within minutes\n\n---\n\n## Advanced ShellBags Forensics\n\n### Detecting Lateral Reconnaissance\n\n**Scenario**: Attacker enumerates network shares\n\n**ShellBags Evidence**:\n```\n02:34:11 - \\\\DC01\\SYSVOL\n02:34:45 - \\\\DC01\\NETLOGON\n02:35:12 - \\\\FILESERVER01\\C$\n02:35:45 - \\\\FILESERVER01\\D$\n02:36:23 - \\\\FILESERVER02\\Backup\n02:37:11 - \\\\FILESERVER03\\Finance\n```\n\n**Pattern Analysis**:\n- **Sequential access** (1-minute intervals)\n- **Administrative shares** (C$, D$)\n- **Multiple servers** (DC01, FILESERVER01/02/03)\n- **Short time window** (3 minutes total)\n\n**Conclusion**: Automated or manual **network share enumeration** (reconnaissance phase).\n\n---\n\n### Insider Threat: Data Theft Preparation\n\n**Scenario**: Employee browses sensitive folders before exfiltration\n\n**ShellBags Evidence**:\n```\n14:23:11 - C:\\Users\\Employee\\Documents\\Personal (baseline activity)\n16:40:11 - \\\\FILESERVER\\Finance\\Q3_Reports (sensitive data)\n16:42:34 - \\\\FILESERVER\\Finance\\Budget_2024 (sensitive data)\n16:44:21 - E:\\ (USB drive connected)\n16:45:32 - E:\\Backup (USB folder navigation)\n```\n\n**Correlation**:\n- **Network share access** (Finance folders)\n- **USB drive insertion** (2 minutes after network browse)\n- **USB folder creation** (Backup folder)\n\n**Timeline with Other Artifacts**:\n```\n16:40:11 - Browsed Finance share (ShellBags)\n16:42:34 - Browsed Budget folder (ShellBags)\n16:44:21 - USB connected (Registry USBSTOR)\n16:45:32 - USB folder opened (ShellBags)\n16:48:11 - Robocopy executed (Prefetch)\n16:52:34 - USB disconnected (Registry USBSTOR)\n```\n\n**Conclusion**: Systematic data exfiltration preparation and execution.\n\n---\n\n## ShellBags Limitations\n\n### Limitation 1: No File-Level Access\n\nShellBags track **folders**, not individual **files**.\n\n**Workaround**: Use MFT (file access timestamps), LNK files (recent file shortcuts), or RecentDocs (registry).\n\n---\n\n### Limitation 2: No File Operations\n\nShellBags do NOT record file copy, move, or delete operations.\n\n**Workaround**: Check Prefetch (Robocopy, xcopy), MFT (file modified timestamps), USN Journal (file operations log).\n\n---\n\n### Limitation 3: No User Attribution (Multi-User Systems)\n\nShellBags are **per-user**, but on shared systems, you must identify which user account.\n\n**Workaround**: Analyze UsrClass.dat for **each user profile**.\n\n---\n\n### Limitation 4: Explorer-Only Tracking\n\nShellBags only track folders accessed via **Windows Explorer GUI**.\n\n**Not Tracked**:\n- Command-line navigation (cmd.exe, PowerShell)\n- Third-party file managers (Total Commander)\n- Programmatic file access (APIs)\n\n**Workaround**: Combine with command-line history (PowerShell logs), program execution artifacts.\n\n---\n\n## Key Takeaways\n\n1. **ShellBags = Folder Access History**: Every folder opened in Windows Explorer\n2. **Two Locations**: NTUSER.DAT (Windows 7) and UsrClass.dat (Windows 8+)\n3. **Network Share Enumeration**: \\\\SERVER\\Share access patterns reveal reconnaissance\n4. **USB Drive Tracking**: E:\\, F:\\ drive access shows removable media browsing\n5. **Deleted Folder Evidence**: ShellBags persist after folder deletion\n6. **Last Interaction Timestamps**: Registry Last Write + SnapshotTime\n7. **ShellBags Explorer**: Industry-standard parsing tool (Eric Zimmerman)\n8. **Correlation Required**: ShellBags + MFT + Prefetch + Registry USB = Complete picture\n9. **Folder View Settings**: Mode, sort order, window size (additional metadata)\n10. **Virtual Folders**: Control Panel, Recycle Bin, Network Neighborhood access\n\n---\n\n## Memory Hook: \"ShellBags = Explorer's Breadcrumb Trail\"\n\nWhenever you need to know:\n\n- ‚úÖ **Which folders user browsed** ‚Üí ShellBags\n- ‚úÖ **Network share enumeration** ‚Üí ShellBags\n- ‚úÖ **USB drive navigation** ‚Üí ShellBags\n- ‚úÖ **Deleted folder access proof** ‚Üí ShellBags\n- ‚úÖ **Folder access timeline** ‚Üí ShellBags Last Write timestamps\n\n**ShellBags are Windows Explorer's breadcrumb trail - follow them to reconstruct user's navigation history!**\n\nCombine with MFT (file access), Prefetch (execution), and USB history (device connections) for complete timeline."
      }
    },
    {
      "type": "code_exercise",
      "content": {
        "text": "# Hands-On: ShellBags Analysis Lab\n\n## Exercise 1: Acquire UsrClass.dat\n\n### Live System Acquisition\n\n```powershell\n# Create forensics directory\nmkdir C:\\Forensics\\ShellBags\n\n# Copy UsrClass.dat\nCopy-Item \"C:\\Users\\$env:USERNAME\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat\" -Destination \"C:\\Forensics\\ShellBags\\UsrClass.dat\" -Force\n\n# Copy NTUSER.DAT (for complete analysis)\nCopy-Item \"C:\\Users\\$env:USERNAME\\NTUSER.DAT\" -Destination \"C:\\Forensics\\ShellBags\\NTUSER.DAT\" -Force\n\n# Copy transaction logs\nCopy-Item \"C:\\Users\\$env:USERNAME\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat.LOG*\" -Destination \"C:\\Forensics\\ShellBags\\\" -Force -ErrorAction SilentlyContinue\nCopy-Item \"C:\\Users\\$env:USERNAME\\NTUSER.DAT.LOG*\" -Destination \"C:\\Forensics\\ShellBags\\\" -Force -ErrorAction SilentlyContinue\n\n# Calculate hashes\nGet-FileHash \"C:\\Forensics\\ShellBags\\UsrClass.dat\" -Algorithm SHA256\nGet-FileHash \"C:\\Forensics\\ShellBags\\NTUSER.DAT\" -Algorithm SHA256\n```\n\n**Expected Output**: UsrClass.dat (1-5 MB) + NTUSER.DAT (varies) + transaction logs\n\n---\n\n## Exercise 2: Parse ShellBags with ShellBags Explorer\n\n### Download ShellBags Explorer\n\n```powershell\n# Download from Eric Zimmerman's repository\nInvoke-WebRequest -Uri \"https://f001.backblazeb2.com/file/EricZimmermanTools/ShellBagsExplorer.zip\" -OutFile \"C:\\Tools\\ShellBagsExplorer.zip\"\n\n# Extract\nExpand-Archive \"C:\\Tools\\ShellBagsExplorer.zip\" -DestinationPath \"C:\\Tools\\ShellBagsExplorer\"\n```\n\n### Parse Hives\n\n```\n1. Launch ShellBagsExplorer.exe\n2. File ‚Üí Load offline hive\n3. Browse to C:\\Forensics\\ShellBags\\UsrClass.dat\n4. Click Open\n5. (Optional) File ‚Üí Load offline hive ‚Üí NTUSER.DAT\n6. View parsed ShellBags in tree view\n```\n\n### Export to CSV\n\n```\n1. File ‚Üí Export ‚Üí All data to CSV\n2. Save as: C:\\Output\\shellbags_all.csv\n3. File ‚Üí Export ‚Üí Timeline ‚Üí CSV\n4. Save as: C:\\Output\\shellbags_timeline.csv\n```\n\n---\n\n## Exercise 3: Analyze ShellBags Timeline\n\n```powershell\n# Import ShellBags timeline CSV\n$shellbags = Import-Csv \"C:\\Output\\shellbags_timeline.csv\"\n\n# Count total entries\nWrite-Host \"Total ShellBags Entries: $($shellbags.Count)\"\n\n# Display recent folder access (last 7 days)\n$recentAccess = $shellbags | Where-Object {\n    try {\n        $timestamp = [datetime]::Parse($_.\"Last Interaction\")\n        $timestamp -gt (Get-Date).AddDays(-7)\n    } catch { $false }\n}\n\nWrite-Host \"\\nFolders Accessed (Last 7 Days): $($recentAccess.Count)\\n\"\n\n# Show sample\n$recentAccess | Select-Object -First 10 | Format-Table @(\n    @{Label=\"Folder Path\"; Expression={$_.Path}},\n    @{Label=\"Last Interaction\"; Expression={$_.\"Last Interaction\"}}\n) -AutoSize\n```\n\n---\n\n## Exercise 4: Detect Network Share Enumeration\n\n```powershell\n# Filter for network share access (UNC paths)\n$networkShares = $shellbags | Where-Object { \n    $_.Path -like \"\\\\\\\\*\" \n}\n\nif ($networkShares.Count -gt 0) {\n    Write-Host \"\\nüåê NETWORK SHARE ACCESS DETECTED: $($networkShares.Count) entries\\n\" -ForegroundColor Cyan\n    \n    # Group by server\n    $byServer = $networkShares | ForEach-Object {\n        if ($_.Path -match \"^\\\\\\\\\\\\([^\\\\\\\\]+)\") {\n            [PSCustomObject]@{\n                Server = $Matches[1]\n                Path = $_.Path\n                LastInteraction = $_.\"Last Interaction\"\n            }\n        }\n    } | Group-Object Server\n    \n    # Display summary\n    Write-Host \"Servers Accessed:\\n\"\n    $byServer | Sort-Object Count -Descending | Format-Table @(\n        @{Label=\"Server\"; Expression={$_.Name}},\n        @{Label=\"Shares Accessed\"; Expression={$_.Count}}\n    ) -AutoSize\n    \n    # Show individual shares\n    Write-Host \"\\nIndividual Network Shares:\\n\"\n    $networkShares | Sort-Object \"Last Interaction\" -Descending | \n        Select-Object -First 10 | \n        Format-Table Path, \"Last Interaction\" -AutoSize\n    \n    # Export network shares\n    $networkShares | Export-Csv \"C:\\Output\\network_shares.csv\" -NoTypeInformation\n} else {\n    Write-Host \"‚úÖ No network share access detected\\n\"\n}\n```\n\n---\n\n## Exercise 5: Identify USB Drive Access\n\n```powershell\n# Filter for removable drive letters (D: through Z:)\n$usbDrives = $shellbags | Where-Object {\n    $_.Path -match \"^[D-Z]:\\\\\"\n}\n\nif ($usbDrives.Count -gt 0) {\n    Write-Host \"\\nüîå USB DRIVE ACCESS DETECTED: $($usbDrives.Count) entries\\n\" -ForegroundColor Yellow\n    \n    # Group by drive letter\n    $byDrive = $usbDrives | ForEach-Object {\n        if ($_.Path -match \"^([D-Z]:)\") {\n            [PSCustomObject]@{\n                Drive = $Matches[1]\n                Path = $_.Path\n                LastInteraction = $_.\"Last Interaction\"\n            }\n        }\n    } | Group-Object Drive\n    \n    # Display summary\n    Write-Host \"Drive Letters Accessed:\\n\"\n    $byDrive | Format-Table @(\n        @{Label=\"Drive\"; Expression={$_.Name}},\n        @{Label=\"Folders Accessed\"; Expression={$_.Count}}\n    ) -AutoSize\n    \n    # Show individual folders\n    Write-Host \"\\nUSB Folders Accessed:\\n\"\n    $usbDrives | Sort-Object \"Last Interaction\" -Descending | \n        Select-Object -First 15 | \n        Format-Table Path, \"Last Interaction\" -AutoSize\n    \n    # Export USB access\n    $usbDrives | Export-Csv \"C:\\Output\\usb_access.csv\" -NoTypeInformation\n    \n    # Correlation suggestion\n    Write-Host \"\\nüí° TIP: Correlate with Registry USBSTOR for device details\\n\" -ForegroundColor Green\n} else {\n    Write-Host \"‚úÖ No USB drive access detected\\n\"\n}\n```\n\n---\n\n## Exercise 6: Find Deleted Folder Evidence\n\n```powershell\n# Check if folders in ShellBags still exist on disk\n\n$deletedFolders = @()\n\nforeach ($entry in $shellbags) {\n    $path = $entry.Path\n    \n    # Skip special paths (virtual folders, network shares)\n    if ($path -like \"*::*\" -or $path -like \"\\\\\\\\*\") {\n        continue\n    }\n    \n    # Check if path exists\n    if ($path -and (Test-Path $path) -eq $false) {\n        $deletedFolders += [PSCustomObject]@{\n            Path = $path\n            LastInteraction = $entry.\"Last Interaction\"\n        }\n    }\n}\n\nif ($deletedFolders.Count -gt 0) {\n    Write-Host \"\\nüóëÔ∏è DELETED FOLDER EVIDENCE: $($deletedFolders.Count) folders\\n\" -ForegroundColor Red\n    \n    Write-Host \"ShellBags prove these folders were accessed but no longer exist:\\n\"\n    \n    $deletedFolders | Sort-Object LastInteraction -Descending | \n        Select-Object -First 10 | \n        Format-Table Path, LastInteraction -AutoSize\n    \n    # Export\n    $deletedFolders | Export-Csv \"C:\\Output\\deleted_folders.csv\" -NoTypeInformation\n    \n    Write-Host \"\\n‚ö†Ô∏è These folders may have contained evidence that was deleted\\n\" -ForegroundColor Yellow\n} else {\n    Write-Host \"‚úÖ All ShellBags folders still exist on disk\\n\"\n}\n```\n\n---\n\n## Exercise 7: Detect Rapid Folder Enumeration\n\n```powershell\n# Identify rapid sequential folder access (potential reconnaissance)\n\n$sortedBags = $shellbags | Where-Object { $_.\"Last Interaction\" -ne \"\" } | Sort-Object \"Last Interaction\"\n\n$rapidAccess = @()\n\nfor ($i = 0; $i -lt ($sortedBags.Count - 1); $i++) {\n    try {\n        $current = [datetime]::Parse($sortedBags[$i].\"Last Interaction\")\n        $next = [datetime]::Parse($sortedBags[$i + 1].\"Last Interaction\")\n        \n        $timeDiff = ($next - $current).TotalSeconds\n        \n        # If folders accessed within 10 seconds, flag as rapid\n        if ($timeDiff -le 10 -and $timeDiff -gt 0) {\n            $rapidAccess += [PSCustomObject]@{\n                Folder1 = $sortedBags[$i].Path\n                Folder2 = $sortedBags[$i + 1].Path\n                Time1 = $sortedBags[$i].\"Last Interaction\"\n                Time2 = $sortedBags[$i + 1].\"Last Interaction\"\n                GapSeconds = [Math]::Round($timeDiff, 2)\n            }\n        }\n    } catch {}\n}\n\nif ($rapidAccess.Count -gt 0) {\n    Write-Host \"\\n‚ö° RAPID FOLDER ENUMERATION DETECTED: $($rapidAccess.Count) instances\\n\" -ForegroundColor Yellow\n    \n    Write-Host \"Folders accessed within 10 seconds (potential reconnaissance):\\n\"\n    \n    $rapidAccess | Select-Object -First 10 | Format-Table @(\n        @{Label=\"First Folder\"; Expression={$_.Folder1}},\n        @{Label=\"Second Folder\"; Expression={$_.Folder2}},\n        @{Label=\"Gap (sec)\"; Expression={$_.GapSeconds}}\n    ) -AutoSize\n    \n    # Export\n    $rapidAccess | Export-Csv \"C:\\Output\\rapid_enumeration.csv\" -NoTypeInformation\n} else {\n    Write-Host \"‚úÖ No rapid folder enumeration detected\\n\"\n}\n```\n\n---\n\n## Exercise 8: Correlate ShellBags with USB Device History\n\n```powershell\n# Combine ShellBags USB access with Registry USBSTOR data\n\n# Get USB device history from Registry\n$usbDevices = Get-ItemProperty \"HKLM:\\SYSTEM\\CurrentControlSet\\Enum\\USBSTOR\\*\\*\" -ErrorAction SilentlyContinue | \n    Select-Object @(\n        @{Name=\"FriendlyName\"; Expression={$_.FriendlyName}},\n        @{Name=\"DeviceID\"; Expression={$_.PSChildName}}\n    )\n\n# Get ShellBags USB access\n$shellbagsUSB = $shellbags | Where-Object { $_.Path -match \"^[D-Z]:\\\\\" }\n\nif ($shellbagsUSB.Count -gt 0 -and $usbDevices.Count -gt 0) {\n    Write-Host \"\\nüîó USB CORRELATION ANALYSIS\\n\" -ForegroundColor Cyan\n    \n    Write-Host \"USB Devices Connected (Registry USBSTOR):\\n\"\n    $usbDevices | Format-Table FriendlyName, DeviceID -AutoSize\n    \n    Write-Host \"\\nFolders Accessed on USB Drives (ShellBags):\\n\"\n    $shellbagsUSB | Select-Object -First 10 | Format-Table Path, \"Last Interaction\" -AutoSize\n    \n    Write-Host \"\\nüí° TIP: Check timestamps to correlate device connection with folder access\\n\" -ForegroundColor Green\n}\n```\n\n---\n\n## Exercise 9: Build Unified Timeline\n\n```powershell\n# Merge ShellBags with other artifacts\n\n$timeline = @()\n\n# Add ShellBags entries\nforeach ($entry in $shellbags) {\n    try {\n        $timeline += [PSCustomObject]@{\n            Timestamp = [datetime]::Parse($entry.\"Last Interaction\")\n            Source = \"ShellBags\"\n            Detail = \"Folder accessed: $($entry.Path)\"\n        }\n    } catch {}\n}\n\n# Import Prefetch data (if available)\nif (Test-Path \"C:\\Output\\prefetch_all.csv\") {\n    $prefetch = Import-Csv \"C:\\Output\\prefetch_all.csv\"\n    \n    foreach ($entry in $prefetch) {\n        try {\n            $timeline += [PSCustomObject]@{\n                Timestamp = [datetime]::Parse($entry.\"Last Run Time\")\n                Source = \"Prefetch\"\n                Detail = \"Executed: $($entry.'Executable Name') (Run Count: $($entry.'Run Count'))\"\n            }\n        } catch {}\n    }\n}\n\n# Sort timeline\n$timeline = $timeline | Sort-Object Timestamp -Descending\n\n# Display recent activity\nWrite-Host \"\\nüìÖ UNIFIED TIMELINE (Recent Activity):\\n\" -ForegroundColor Green\n$timeline | Select-Object -First 20 | Format-Table Timestamp, Source, Detail -AutoSize\n\n# Export\n$timeline | Export-Csv \"C:\\Output\\unified_timeline.csv\" -NoTypeInformation\nWrite-Host \"\\nFull timeline exported to: C:\\Output\\unified_timeline.csv\\n\"\n```\n\n---\n\n## Challenge Exercise: Investigate Insider Threat Scenario\n\n### Scenario\n\nInvestigate suspected data exfiltration. Use ShellBags to determine:\n\n1. **Did user browse sensitive network shares?** (\\\\SERVER\\Finance, \\\\SERVER\\HR)\n2. **Did user access USB drives?** (E:\\, F:\\ removable media)\n3. **What was the timeline?** (Network browse ‚Üí USB access sequence)\n4. **Were any folders deleted?** (Anti-forensics attempt)\n\n### Investigation Script\n\n```powershell\n# Complete investigation workflow\n\nWrite-Host \"\\n=== SHELLBAGS FORENSIC INVESTIGATION ===\\n\"\n\n# 1. Load ShellBags data\n$shellbags = Import-Csv \"C:\\Output\\shellbags_timeline.csv\"\n\n# 2. Check network shares\n$networkShares = $shellbags | Where-Object { $_.Path -like \"\\\\\\\\*\" }\nWrite-Host \"Network Shares Accessed: $($networkShares.Count)\"\n\n# 3. Check USB drives\n$usbAccess = $shellbags | Where-Object { $_.Path -match \"^[D-Z]:\\\\\" }\nWrite-Host \"USB Drives Accessed: $($usbAccess.Count)\"\n\n# 4. Find sensitive paths\n$sensitivePaths = $shellbags | Where-Object {\n    $_.Path -like \"*Finance*\" -or\n    $_.Path -like \"*HR*\" -or\n    $_.Path -like \"*Confidential*\" -or\n    $_.Path -like \"*Personnel*\"\n}\n\nif ($sensitivePaths.Count -gt 0) {\n    Write-Host \"\\nüö® SENSITIVE FOLDER ACCESS DETECTED: $($sensitivePaths.Count) instances\\n\" -ForegroundColor Red\n    $sensitivePaths | Format-Table Path, \"Last Interaction\" -AutoSize\n}\n\n# 5. Build exfiltration timeline\nif ($networkShares.Count -gt 0 -and $usbAccess.Count -gt 0) {\n    Write-Host \"\\n‚ö†Ô∏è POTENTIAL DATA EXFILTRATION PATTERN\\n\" -ForegroundColor Yellow\n    Write-Host \"Sequence: Network share access followed by USB drive access\\n\"\n    \n    # Show timeline\n    ($networkShares + $usbAccess) | Sort-Object \"Last Interaction\" | \n        Select-Object -First 10 | \n        Format-Table Path, \"Last Interaction\" -AutoSize\n}\n\nWrite-Host \"\\n=== END INVESTIGATION REPORT ===\\n\"\n```\n\n---\n\n## Key Commands Cheat Sheet\n\n```powershell\n# Acquire UsrClass.dat\nCopy-Item \"C:\\Users\\$env:USERNAME\\AppData\\Local\\Microsoft\\Windows\\UsrClass.dat\" -Destination C:\\Forensics\\\n\n# Parse with ShellBags Explorer (GUI)\nShellBagsExplorer.exe\n\n# Import CSV\n$shellbags = Import-Csv \"shellbags_timeline.csv\"\n\n# Filter network shares\n$shellbags | Where-Object { $_.Path -like \"\\\\\\\\*\" }\n\n# Filter USB drives\n$shellbags | Where-Object { $_.Path -match \"^[D-Z]:\\\\\" }\n\n# Find deleted folders\n$shellbags | Where-Object { (Test-Path $_.Path) -eq $false }\n\n# Export results\n$filtered | Export-Csv \"results.csv\" -NoTypeInformation\n```\n\nThese exercises provide hands-on experience with ShellBags analysis - one of the most powerful user activity artifacts in Windows forensics!"
      }
    },
    {
      "type": "real_world",
      "content": {
        "text": "# Real-World Case Studies: ShellBags in Action\n\n## Case Study 1: Insider Threat - Network Share Enumeration (2021)\n\n### Background\n\nA financial services company detected unusual network activity from an employee workstation. ShellBags analysis revealed systematic reconnaissance of sensitive file shares.\n\n### ShellBags Evidence\n\n**Network Share Access Pattern**:\n```\nTimestamp: 2021-07-15 02:34:11 UTC\nPath: \\\\DC01\\SYSVOL\\company.com\\Policies\n\nTimestamp: 2021-07-15 02:34:45 UTC\nPath: \\\\DC01\\NETLOGON\n\nTimestamp: 2021-07-15 02:35:12 UTC\nPath: \\\\FILESERVER01\\Finance\\Q2_Reports\n\nTimestamp: 2021-07-15 02:35:45 UTC\nPath: \\\\FILESERVER01\\Finance\\Budget_2022\n\nTimestamp: 2021-07-15 02:36:23 UTC\nPath: \\\\FILESERVER01\\HR\\Personnel_Files\n\nTimestamp: 2021-07-15 02:37:11 UTC\nPath: \\\\FILESERVER02\\Legal\\Contracts\n```\n\n### Pattern Analysis\n\n**Red Flags**:\n1. **Time**: 2:34 AM (off-hours access)\n2. **Sequential**: 6 different shares accessed in 3 minutes\n3. **Sensitive**: Finance, HR, Legal departments\n4. **Systematic**: Alphabetical/organized enumeration pattern\n5. **Admin shares**: SYSVOL, NETLOGON (domain reconnaissance)\n\n### Correlation with Other Artifacts\n\n**Event Logs**:\n```\nEvent ID 4624 (Logon):\n  Time: 2021-07-15 02:32:45 UTC\n  User: DOMAIN\\jsmith\n  Logon Type: 3 (Network)\n  Source IP: 192.168.1.105\n```\n\n**Prefetch**:\n```\nEXPLORER.EXE:\n  Last Run: 2021-07-15 02:34:10 UTC\n  Run Count: 234\n```\n\n**MFT** (on FILESERVER01):\n```\nC:\\Shares\\Finance\\Q2_Reports\\Confidential_Summary.xlsx\n  Accessed: 2021-07-15 02:35:30 UTC (during ShellBags window)\n```\n\n### Timeline Reconstruction\n\n```\n02:32:45 - User jsmith logged on (Event Log)\n02:34:10 - Explorer opened (Prefetch)\n02:34:11 - Browsed DC01 SYSVOL (ShellBags)\n02:34:45 - Browsed DC01 NETLOGON (ShellBags)\n02:35:12 - Browsed Finance share (ShellBags)\n02:35:30 - Accessed Confidential_Summary.xlsx (MFT on file server)\n02:35:45 - Browsed Budget folder (ShellBags)\n02:36:23 - Browsed HR Personnel Files (ShellBags)\n02:37:11 - Browsed Legal Contracts (ShellBags)\n02:45:00 - User logged off (Event Log)\n```\n\n### Forensic Conclusions\n\n1. **Reconnaissance**: Systematic network share enumeration\n2. **Intent**: Targeted sensitive departments (Finance, HR, Legal)\n3. **Timing**: Off-hours access (2:34 AM) suggests deliberate evasion\n4. **File Access**: MFT proves user accessed confidential file\n5. **Pattern**: Not random browsing - organized search for sensitive data\n\n### Legal Outcome\n\nShellBags evidence presented in internal investigation:\n- **Proved network share enumeration** (6 shares in 3 minutes)\n- **Demonstrated intent** (targeted sensitive departments)\n- **Timeline precision** (minute-by-minute reconstruction)\n\nEmployee terminated for policy violation. ShellBags evidence was **critical** - proved systematic reconnaissance, not accidental navigation.\n\n**Lesson Learned**: ShellBags reveal **where** users browse. Combined with MFT (file access) and Event Logs (authentication), they prove **unauthorized access patterns**.\n\n---\n\n## Case Study 2: Data Exfiltration via USB - Trade Secrets Theft (2020)\n\n### Background\n\nA pharmaceutical company suspected employee of stealing drug formula documentation. ShellBags revealed USB drive browsing correlated with file access.\n\n### ShellBags Evidence\n\n**USB Drive Navigation**:\n```\nTimestamp: 2020-09-15 16:44:32 UTC\nPath: E:\\ (Removable Disk)\n\nTimestamp: 2020-09-15 16:45:11 UTC\nPath: E:\\Backup\n\nTimestamp: 2020-09-15 16:45:45 UTC\nPath: E:\\Backup\\Research_Data\n\nTimestamp: 2020-09-15 16:46:23 UTC\nPath: E:\\Backup\\Research_Data\\Formulas\n```\n\n**Network Share Access (Earlier)**:\n```\nTimestamp: 2020-09-15 16:40:11 UTC\nPath: \\\\FILESERVER\\Research\\Drug_Formulas\n\nTimestamp: 2020-09-15 16:41:34 UTC\nPath: \\\\FILESERVER\\Research\\Clinical_Trials\n\nTimestamp: 2020-09-15 16:42:56 UTC\nPath: \\\\FILESERVER\\Research\\Patent_Applications\n```\n\n### Correlation with USB Device History\n\n**Registry USBSTOR**:\n```\nDevice: SanDisk Ultra 64GB\nVendor ID: VID_0781\nProduct ID: PID_5583\nSerial: 5C753012ABCD9876\nFirst Connected: 2020-09-15 16:44:21 UTC\nLast Connected: 2020-09-15 16:52:34 UTC\n```\n\n### Correlation with File Copy Evidence\n\n**Prefetch**:\n```\nROBOCOPY.EXE:\n  Last Run: 2020-09-15 16:48:11 UTC\n  Run Count: 1 (first-time use)\n  Referenced Files: C:\\Users\\Employee\\Documents\\* ‚Üí E:\\\n```\n\n**7-Zip Execution**:\n```\n7Z.EXE:\n  Last Run: 2020-09-15 16:50:23 UTC\n  Run Count: 3\n  Referenced Files: E:\\Backup\\Research_Data ‚Üí encrypted.7z\n```\n\n### Complete Timeline\n\n```\n16:40:11 - Browsed network share: Drug_Formulas (ShellBags)\n16:41:34 - Browsed network share: Clinical_Trials (ShellBags)\n16:42:56 - Browsed network share: Patent_Applications (ShellBags)\n16:44:21 - USB device connected: SanDisk 64GB (Registry USBSTOR)\n16:44:32 - Opened E:\\ in Explorer (ShellBags)\n16:45:11 - Created E:\\Backup folder (ShellBags + MFT)\n16:45:45 - Created E:\\Backup\\Research_Data (ShellBags + MFT)\n16:46:23 - Created E:\\Backup\\Research_Data\\Formulas (ShellBags + MFT)\n16:48:11 - Robocopy executed (network to USB copy) (Prefetch)\n16:50:23 - 7-Zip executed (encrypted archive created) (Prefetch)\n16:52:34 - USB device disconnected (Registry USBSTOR)\n16:55:00 - Employee logged off (Event Log)\n```\n\n### Forensic Conclusions\n\n1. **Targeting**: Browsed 3 sensitive research folders\n2. **Preparation**: Created organized folder structure on USB (Backup\\Research_Data\\Formulas)\n3. **Exfiltration**: Robocopy transferred files from network to USB\n4. **Anti-Forensics**: 7-Zip encrypted archive (hiding evidence)\n5. **Timeline**: 12 minutes from first browse to USB disconnect\n\n### Legal Outcome\n\nShellBags evidence presented in lawsuit:\n- **Proved network share access** (Drug Formulas, Clinical Trials, Patents)\n- **Demonstrated USB preparation** (folder structure creation)\n- **Timeline synchronization** (browse ‚Üí USB connect ‚Üí copy ‚Üí encrypt ‚Üí disconnect)\n\nEmployee sued for trade secret theft. $4.2M settlement. ShellBags evidence was **foundational** - proved deliberate, systematic exfiltration.\n\n**Lesson Learned**: ShellBags + USB history + Prefetch + MFT = Complete exfiltration timeline. ShellBags show **intent** (organized folder prep on USB).\n\n---\n\n## Case Study 3: Ransomware Patient Zero - Deleted Folder Evidence (2022)\n\n### Background\n\nRansomware outbreak encrypted 500+ systems. Patient zero workstation had deleted malware staging folder, but ShellBags proved its existence.\n\n### ShellBags Evidence\n\n**Deleted Folder Access**:\n```\nTimestamp: 2022-04-10 08:23:11 UTC\nPath: C:\\Temp\\Malware_Tools\nStatus: FOLDER NOT FOUND (deleted)\n\nTimestamp: 2022-04-10 08:25:34 UTC\nPath: C:\\Temp\\Malware_Tools\\Scripts\nStatus: FOLDER NOT FOUND (deleted)\n\nTimestamp: 2022-04-10 08:27:12 UTC\nPath: C:\\Temp\\Malware_Tools\\Payloads\nStatus: FOLDER NOT FOUND (deleted)\n```\n\n**ShellBags Prove**:\n- User created C:\\Temp\\Malware_Tools folder\n- Created subfolders: Scripts, Payloads\n- Accessed folders multiple times (08:23 - 08:27)\n- All folders later deleted (anti-forensics)\n\n### Correlation with Execution Artifacts\n\n**Prefetch**:\n```\nPSEXEC.EXE:\n  Last Run: 2022-04-10 08:34:45 UTC\n  Path: C:\\Temp\\Malware_Tools\\PsExec.exe (deleted)\n  Run Count: 47\n```\n\n**AmCache**:\n```\nFile: mimikatz.exe\nPath: C:\\Temp\\Malware_Tools\\Scripts\\mimikatz.exe (deleted)\nSHA-1: 2b6d8f1a3c9e7f5d4b2a8f6e3c1d9b7a5f4e2d0c\nFirst Execution: 2022-04-10 08:28:45 UTC\nIsUnassociated: TRUE (file deleted)\n```\n\n**MFT**:\n```\nFolder: C:\\Temp\\Malware_Tools\nCreated: 2022-04-10 08:23:11 UTC\nDeleted: 2022-04-10 09:52:34 UTC (MFT entry marked deleted)\n```\n\n### Timeline Reconstruction\n\n```\n08:23:11 - Created C:\\Temp\\Malware_Tools (ShellBags + MFT)\n08:25:34 - Created Scripts subfolder (ShellBags)\n08:27:12 - Created Payloads subfolder (ShellBags)\n08:28:45 - Mimikatz executed (AmCache)\n08:34:45 - PsExec executed (Prefetch - lateral movement begins)\n09:15:32 - Ransomware deployed to 500+ systems\n09:52:34 - Malware_Tools folder deleted (MFT + anti-forensics)\n```\n\n### Forensic Impact\n\n**Without ShellBags**:\n- Folder deleted ‚Üí No proof it existed\n- Executables deleted ‚Üí Limited evidence\n\n**With ShellBags**:\n- ‚úÖ Proved Malware_Tools folder existed\n- ‚úÖ Showed folder structure (Scripts, Payloads)\n- ‚úÖ Provided access timestamps (08:23 - 08:27)\n- ‚úÖ Correlated with execution artifacts (Prefetch, AmCache)\n- ‚úÖ Demonstrated deliberate staging (organized folder structure)\n\n**Lesson Learned**: ShellBags **survive folder deletion**. Critical for proving attacker staging areas that were later deleted as anti-forensics.\n\n---\n\n## Case Study 4: Lateral Movement Detection - Domain Admin Compromise (2021)\n\n### Background\n\nSOC detected suspicious domain admin activity. ShellBags revealed admin share enumeration pattern indicative of lateral movement.\n\n### ShellBags Evidence\n\n**Administrative Share Access**:\n```\nTimestamp: 2021-11-05 03:34:11 UTC\nPath: \\\\WORKSTATION-001\\C$\n\nTimestamp: 2021-11-05 03:34:45 UTC\nPath: \\\\WORKSTATION-001\\C$\\Windows\\System32\n\nTimestamp: 2021-11-05 03:35:12 UTC\nPath: \\\\WORKSTATION-002\\C$\n\nTimestamp: 2021-11-05 03:35:45 UTC\nPath: \\\\WORKSTATION-003\\C$\n\nTimestamp: 2021-11-05 03:36:23 UTC\nPath: \\\\FILESERVER-001\\C$\n\nTimestamp: 2021-11-05 03:37:11 UTC\nPath: \\\\DC01\\C$\\Windows\\NTDS\n```\n\n**Pattern Analysis**:\n1. **Admin shares** (C$) on multiple systems\n2. **Sequential access** (30-second intervals)\n3. **Systematic** (WORKSTATION-001/002/003, then servers)\n4. **Domain Controller** (DC01\\NTDS folder - Active Directory database)\n\n### Correlation with Network Authentication\n\n**Event Logs (Domain Controller)**:\n```\nEvent ID 4624 (Logon):\n  Time: 2021-11-05 03:34:10 UTC\n  User: DOMAIN\\Administrator\n  Logon Type: 3 (Network)\n  Source IP: 192.168.1.105 (compromised workstation)\n  Target: WORKSTATION-001\n```\n\n### Forensic Conclusions\n\n1. **Compromised Account**: Domain admin credentials stolen\n2. **Lateral Movement**: Systematic enumeration of admin shares\n3. **Targeting**: Domain Controller NTDS folder (credential database)\n4. **Automated**: 30-second intervals suggest scripted enumeration\n\n**Lesson Learned**: ShellBags reveal lateral movement patterns. Admin share access (C$, ADMIN$) + sequential timing + DC targeting = **Credential theft operation**.\n\n---\n\n## Key Forensic Takeaways from Real-World Cases\n\n### Pattern Recognition\n\n| Attack Type | ShellBags Indicators |\n|-------------|----------------------|\n| **Insider Threat** | Network share enumeration (Finance, HR, Legal), USB drive folder prep, off-hours access |\n| **Data Exfiltration** | Network share ‚Üí USB drive access sequence, organized folder structure on USB |\n| **Ransomware** | Deleted malware staging folders (C:\\Temp\\Malware_Tools), subfolder organization |\n| **Lateral Movement** | Admin share access (C$, ADMIN$), sequential system enumeration, DC targeting |\n\n### ShellBags Strengths\n\n‚úÖ **Folder access timeline** (when user browsed each folder)  \n‚úÖ **Network share enumeration** (\\\\SERVER\\Share patterns)  \n‚úÖ **USB drive navigation** (E:\\, F:\\ removable media)  \n‚úÖ **Deleted folder evidence** (entries persist after deletion)  \n‚úÖ **Intent demonstration** (organized folder structures reveal planning)  \n\n### ShellBags Limitations\n\n‚ùå **No file-level access** (use MFT, LNK files, RecentDocs)  \n‚ùå **No file operations** (use Prefetch for Robocopy/xcopy, MFT for file modified times)  \n‚ùå **Explorer-only** (command-line navigation not tracked)  \n\n### Best Practices\n\n1. **Always analyze both** NTUSER.DAT and UsrClass.dat for complete history\n2. **Correlate with USB history** (Registry USBSTOR + ShellBags timestamps)\n3. **Look for patterns** (sequential access, off-hours, admin shares)\n4. **Check deleted folders** (ShellBags persist even after folder deletion)\n5. **Combine with execution artifacts** (Prefetch, AmCache) for complete timeline\n6. **Focus on sensitive paths** (Finance, HR, Legal, C$, ADMIN$, NTDS)\n\n---\n\n## Your Turn: Apply These Techniques\n\nWhen you analyze ShellBags in real investigations:\n\n‚úÖ **Parse both hives** (NTUSER.DAT + UsrClass.dat)  \n‚úÖ **Filter network shares** (\\\\SERVER patterns)  \n‚úÖ **Identify USB access** (E:\\, F:\\ drive letters)  \n‚úÖ **Find deleted folders** (paths that don't exist on disk)  \n‚úÖ **Detect rapid enumeration** (multiple folders in minutes)  \n‚úÖ **Correlate with other artifacts** (USB history, Prefetch, MFT, Event Logs)  \n\nShellBags are Windows Explorer's **breadcrumb trail** - follow them to reconstruct where users browsed and what they were targeting!"
      }
    },
    {
      "type": "memory_aid",
      "content": {
        "text": "# Memory Aids: Never Forget ShellBags Forensics\n\n## Acronym: \"ShellBags = Explorer's GPS\"\n\nRemember what ShellBags track:\n\n- **Sh**ares (network shares accessed)\n- **E**xternal drives (USB, removable media)\n- **L**ocal folders (C:\\ navigation)\n- **L**ast interaction times\n- **B**rowsing history (Explorer navigation)\n- **A**ccess patterns (sequential enumeration)\n- **G**UID and path data\n- **S**urvives folder deletion\n\n**Memory Hook**: **ShellBags** = Explorer's **GPS** (tracks where you've been)\n\n---\n\n## Mnemonic: \"Two Hives, Complete History\"\n\nRemember ShellBags locations:\n\n- **NTUSER.DAT** (Windows 7 and earlier)\n- **UsrClass.dat** (Windows 8/10/11)\n\n**Memory Hook**: **Two hives, complete history** - analyze both for full ShellBags data\n\n---\n\n## Visual: ShellBags = Breadcrumb Trail\n\nThink of ShellBags as **Hansel and Gretel's breadcrumbs**:\n\n- **User** = Hansel/Gretel walking through forest\n- **Folders** = Locations in forest\n- **ShellBags** = Breadcrumbs dropped at each location\n- **Even after path deleted** = Breadcrumbs remain (ShellBags persist)\n\n**Memory Hook**: ShellBags are **breadcrumbs** showing where user navigated\n\n---\n\n## Acronym: \"UNC = User's Network Crime\"\n\nRemember network share paths:\n\n- **U**NC paths: \\\\SERVER\\Share\n- **N**etwork enumeration evidence\n- **C**ritical for lateral movement detection\n\n**Memory Hook**: **UNC** paths in ShellBags reveal **network crimes** (reconnaissance)\n\n---\n\n## Rhyme: \"USB Drives, ShellBags Thrives\"\n\n**Detecting USB Access**:\n\n> \"USB drives, ShellBags **thrives**,  \n> E:\\ and F:\\ folder **archives**,  \n> Even after disconnect **arrives**,  \n> ShellBags evidence **survives**!\"\n\n**Memory Hook**: ShellBags **survives** USB disconnection (entries persist)\n\n---\n\n## Number Memory: \"BagMRU + Bags = Complete\"\n\nRemember the two registry locations:\n\n- **BagMRU** = Folder **paths** and **hierarchy**\n- **Bags** = Folder **view settings** and **timestamps**\n\n**Memory Hook**: **BagMRU + Bags = Complete** picture (paths + timestamps)\n\n---\n\n## Visual: Deleted Folders = Ghost Evidence\n\nThink of deleted folders as **ghosts**:\n\n- **Folder deleted** = Physical body gone\n- **ShellBags entry** = Ghost remains (evidence persists)\n- **Still visible** = ShellBags reveal folder path and access time\n\n**Memory Hook**: Deleted folders are **ghosts** in ShellBags - visible evidence after death\n\n---\n\n## Acronym: \"RAPID = Recon Pattern\"\n\nDetect reconnaissance with **\"RAPID\"**:\n\n- **R**apid sequential access (folders accessed within seconds/minutes)\n- **A**dmin shares (C$, ADMIN$, NTDS)\n- **P**attern of enumeration (systematic, not random)\n- **I**ndicates deliberate targeting\n- **D**omain reconnaissance (SYSVOL, NETLOGON)\n\n**Memory Hook**: **RAPID** access = **Recon** pattern\n\n---\n\n## Mnemonic: \"Explorer Only\"\n\nRemember ShellBags limitation:\n\n**\"Explorer Only\"** = ShellBags track **only Windows Explorer** navigation\n\n**Not Tracked**:\n- Command-line (cmd.exe: `cd C:\\Temp`)\n- PowerShell (Set-Location)\n- Third-party file managers (Total Commander)\n\n**Memory Hook**: **Explorer only** - CLI navigation not recorded\n\n---\n\n## Acronym: \"USB-PREP\" for Exfiltration\n\nDetect exfiltration preparation:\n\n- **U**SB drive accessed (E:\\, F:\\)\n- **S**tructured folders created (Backup\\Research_Data)\n- **B**rowsing network shares first\n\n- **P**reparation (organized folder structure)\n- **R**apid timeline (minutes between browse and USB)\n- **E**vidence of deliberate staging\n- **P**attern: Network ‚Üí USB sequence\n\n**Memory Hook**: **USB-PREP** = Exfiltration **prep**aration pattern\n\n---\n\n## Visual: ShellBags = Library Checkout History\n\nThink of ShellBags as **library checkout history**:\n\n- **Folder** = Book in library\n- **ShellBags entry** = Checkout record\n- **Last Interaction** = Date book was checked out\n- **After folder deleted** = Book removed from library, but checkout record remains\n\n**Memory Hook**: ShellBags = Windows' **checkout history** for folders\n\n---\n\n## Rhyme: \"Network Shares, Beware\"\n\n**Detecting Network Enumeration**:\n\n> \"Network **shares**, attackers **beware**,  \n> ShellBags records your **lair**,  \n> \\\\\\\\SERVER\\\\Finance you **declare**,  \n> Forensics finds you **there**!\"\n\n**Memory Hook**: Network shares in ShellBags = **Reconnaissance evidence**\n\n---\n\n## Acronym: \"TIMELINE\" for ShellBags Analysis\n\nFollow **\"TIMELINE\"** workflow:\n\n1. **T**riage: Acquire UsrClass.dat + NTUSER.DAT\n2. **I**mport: Parse with ShellBags Explorer\n3. **M**erge: Combine with USB history, Prefetch, MFT\n4. **E**xamine: Open CSV in Timeline Explorer\n5. **L**ocate: Filter network shares (\\\\\\\\*), USB drives (D-Z:)\n6. **I**nvestigate: Check deleted folders (paths not on disk)\n7. **N**etwork: Correlate with Event Logs, authentication\n8. **E**vidence: Document findings for forensic report\n\n**Memory Hook**: **TIMELINE** = Your ShellBags analysis workflow\n\n---\n\n## Mnemonic: \"Folders, Not Files\"\n\nRemember ShellBags limitation:\n\n**\"Folders, Not Files\"** = ShellBags track folder access, NOT individual file access\n\n**For file access, use**:\n- MFT (file Modified/Accessed timestamps)\n- LNK files (recent file shortcuts)\n- RecentDocs (registry file access)\n- Jump Lists (recent application files)\n\n**Memory Hook**: **Folders, not files** - ShellBags are folder-level only\n\n---\n\n## Visual: Admin Shares = Red Alert\n\nThink of admin shares as **red alert signals**:\n\n- **C$, ADMIN$, IPC$** = Admin shares (require elevated privileges)\n- **ShellBags access** = Red alert (potential lateral movement)\n- **NTDS folder** = Nuclear red alert (domain credential theft)\n\n**Memory Hook**: Admin shares in ShellBags = **Red alert** (lateral movement)\n\n---\n\n## Acronym: \"DELETE-PERSIST\" for Anti-Forensics\n\nRemember ShellBags persistence:\n\n- **D**eleted folders leave ShellBags entries\n- **E**vidence survives anti-forensics\n- **L**asting proof of access\n- **E**ven after folder removal\n- **T**imestamps preserved\n- **E**numeration patterns visible\n\n- **P**ersists indefinitely\n- **E**ntry not removed when folder deleted\n- **R**egistry key remains\n- **S**urvives cleanup attempts\n- **I**mmune to file deletion\n- **S**urvivability = forensic value\n- **T**racks historical navigation\n\n**Memory Hook**: **DELETE** attempts **PERSIST** - ShellBags survive folder deletion\n\n---\n\n## Final Memory Hook: \"ShellBags = Where You've Been\"\n\nWhenever you need to know:\n\n- ‚úÖ **Which folders user browsed** ‚Üí ShellBags\n- ‚úÖ **Network shares accessed** ‚Üí ShellBags\n- ‚úÖ **USB drives navigated** ‚Üí ShellBags\n- ‚úÖ **Deleted folders accessed** ‚Üí ShellBags\n- ‚úÖ **Folder access timeline** ‚Üí ShellBags Last Interaction\n\n**Think**: **ShellBags = Where You've Been**\n\n> ShellBags are like a **GPS history** for Windows Explorer:  \n> They show every location (folder) you've visited,  \n> when you were there,  \n> and they **never delete** the history!\n\n---\n\nUse these memory aids during investigations. Create flashcards, print cheat sheets, or develop your own mnemonics. The goal: **Instant recall** when analyzing ShellBags in live incidents!"
      }
    },
    {
      "type": "reflection",
      "content": {
        "text": "# Reflection Questions: Test Your ShellBags Understanding\n\n## Conceptual Understanding\n\n### Question 1: ShellBags Purpose and Forensic Value\n\n**Scenario**: A colleague asks: \"Why do we analyze ShellBags? What do they tell us?\"\n\n**Reflect**:\n1. What was Microsoft's **original purpose** for ShellBags? (Remember folder view settings)\n2. What **forensic side effect** makes ShellBags valuable? (Folder access history)\n3. Why are ShellBags more useful than **browser history** for local investigation? (Show local folder navigation, not just web)\n4. Can ShellBags prove **file access**? Or only **folder access**? (Folders only - need MFT for files)\n\n**Critical Thinking**: If an attacker uses **command-line** to navigate folders (cd C:\\Temp), will ShellBags record this? Why or why not?\n\n---\n\n### Question 2: ShellBags Locations\n\n**Scenario**: You're analyzing a Windows 10 system and want complete ShellBags history.\n\n**Reflect**:\n1. Which **two registry hives** contain ShellBags? (NTUSER.DAT + UsrClass.dat)\n2. Where is **UsrClass.dat** located on disk? (C:\\Users\\<username>\\AppData\\Local\\Microsoft\\Windows\\)\n3. Why do you need to analyze **both** hives? (Windows 7 vs 8+ storage locations)\n4. What happens if you **only analyze NTUSER.DAT** on Windows 10? (Miss most ShellBags data)\n\n**Critical Thinking**: On a forensic image, how would you find **all users'** ShellBags data? (Check every user profile folder)\n\n---\n\n### Question 3: BagMRU vs Bags\n\n**Scenario**: You open ShellBags in Registry Explorer and see two keys: BagMRU and Bags.\n\n**Reflect**:\n1. What does **BagMRU** store? (Folder paths and hierarchy)\n2. What do **Bags** store? (View settings and timestamps)\n3. Why do you need **both** for complete analysis? (Paths + timestamps = full picture)\n4. Which one contains **SnapshotTime** (last interaction)? (Bags)\n\n**Critical Thinking**: If BagMRU shows a folder path but Bags has no corresponding entry, what might this indicate?\n\n---\n\n## Practical Application\n\n### Question 4: Network Share Enumeration\n\n**Scenario**: ShellBags show these entries:\n\n```\n02:34:11 - \\\\DC01\\SYSVOL\n02:34:45 - \\\\DC01\\NETLOGON\n02:35:12 - \\\\FILESERVER\\C$\n02:35:45 - \\\\FILESERVER\\Finance\n02:36:23 - \\\\FILESERVER\\HR\n```\n\n**Reflect**:\n1. What **pattern** do you see? (Sequential access, 30-60 second intervals)\n2. What does **C$** indicate? (Administrative share - requires elevated privileges)\n3. What do **SYSVOL** and **NETLOGON** suggest? (Domain reconnaissance)\n4. Is this **normal user behavior** or **suspicious**? (Suspicious - systematic enumeration)\n\n**Critical Thinking**: If these accesses occurred at **2:34 AM**, does that change your assessment? How?\n\n---\n\n### Question 5: USB Drive Exfiltration\n\n**Scenario**: ShellBags show:\n\n```\n16:44:32 - E:\\ (Removable Disk)\n16:45:11 - E:\\Backup\n16:45:45 - E:\\Backup\\Confidential_Files\n```\n\n**Registry USBSTOR**:\n```\nDevice: SanDisk Ultra 64GB\nSerial: 5C753012ABCD\nFirst Connected: 16:44:21\nLast Connected: 16:52:34\n```\n\n**Reflect**:\n1. What does the **folder structure** (Backup\\Confidential_Files) suggest? (Deliberate organization for exfiltration)\n2. How do **timestamps correlate** between ShellBags and USBSTOR? (USB connected at 16:44:21, folder accessed 11 seconds later)\n3. What **other artifacts** would you check to prove file copying? (Prefetch for Robocopy/xcopy, MFT for file Modified times)\n4. What's the **time window** between USB connect and disconnect? (8 minutes 13 seconds)\n\n**Critical Thinking**: If the user claims \"I just checked if the USB was working,\" does the evidence support this? Why or why not?\n\n---\n\n### Question 6: Deleted Folder Evidence\n\n**Scenario**: ShellBags show:\n\n```\nPath: C:\\Temp\\Malware_Tools\nLast Interaction: 2024-10-16 03:47:21 UTC\n\nDisk Status: FOLDER NOT FOUND (deleted)\n```\n\n**Reflect**:\n1. What does this ShellBags entry **prove**? (Folder existed and was accessed)\n2. Why is this **forensically valuable**? (Proves folder access even after anti-forensic deletion)\n3. What **other artifacts** might have related evidence? (Prefetch for executables in folder, AmCache for file hashes, MFT for deleted entry)\n4. Can you **recover** the deleted folder contents? (Depends on whether data clusters overwritten - try file carving)\n\n**Critical Thinking**: If you find 10 ShellBags entries for deleted folders all deleted at the **same time** (within 1 minute), what does this suggest? (Automated anti-forensic cleanup)\n\n---\n\n## Advanced Scenarios\n\n### Question 7: Rapid Enumeration Detection\n\n**Scenario**: ShellBags show 20 different network shares accessed within **5 minutes**.\n\n**Reflect**:\n1. Is this **normal user behavior**? (No - humans don't browse 20 shares in 5 minutes)\n2. What does this pattern suggest? (Automated enumeration script or tool)\n3. What **additional evidence** would you seek? (PowerShell logs, command history, NetEnum.exe execution)\n4. How would you **correlate** this with Event Logs? (Event ID 4624 - Network logon attempts)\n\n**Critical Thinking**: If the user account is **SYSTEM** or **Administrator**, does this change your interpretation? What about **lateral movement**?\n\n---\n\n### Question 8: Insider Threat Timeline\n\n**Scenario**: Correlate ShellBags with other artifacts:\n\n```\nShellBags:\n16:40:11 - \\\\FILESERVER\\Finance\\Q3_Budget\n16:42:34 - \\\\FILESERVER\\Finance\\Salaries\n\nUSBSTOR:\n16:44:21 - USB device connected\n\nShellBags:\n16:45:32 - E:\\Backup\\Company_Data\n\nPrefetch:\n16:48:11 - ROBOCOPY.EXE (Last Run)\n\nEvent Log:\n16:52:00 - User logoff\n```\n\n**Reflect**:\n1. Reconstruct the **attack timeline**. What happened step-by-step?\n2. What does the **2-minute gap** between network browse (16:42:34) and USB connect (16:44:21) suggest?\n3. Why did the user create **E:\\Backup\\Company_Data** folder? (Organized staging for exfiltration)\n4. What does **Robocopy execution** at 16:48:11 prove? (File copy operation)\n\n**Critical Thinking**: Does this timeline **prove guilt beyond reasonable doubt**? What's missing to make it ironclad? (Need proof files were actually copied - check MFT on USB if available)\n\n---\n\n### Question 9: Correlation Challenge\n\n**Scenario**: ShellBags show folder access but you need to prove **file access** (not just folder).\n\n**Reflect**:\n1. What **limitation** of ShellBags does this reveal? (Track folders, not individual files)\n2. Which **artifacts** would you check to prove file access? (MFT Accessed time, LNK files, RecentDocs, Jump Lists)\n3. How would you **correlate** ShellBags with MFT timestamps? (Match folder access time with file Modified/Accessed times in that folder)\n4. If timestamps **align** (folder accessed at 16:45:32, file Modified at 16:45:45), what's your conclusion? (User likely accessed file during folder browse)\n\n**Critical Thinking**: Can you **definitively prove** file access without MFT or other file-level artifacts? Or only **infer** it?\n\n---\n\n## Meta-Learning\n\n### Question 10: ShellBags Limitations\n\n**Scenario**: You're writing a forensic report and need to explain ShellBags limitations.\n\n**Reflect**:\n1. What **critical information** do ShellBags NOT provide? (File access, file operations, command-line navigation)\n2. How would you **compensate** for these limitations? (Combine with MFT, Prefetch, command history)\n3. What's the **biggest strength** of ShellBags? (Folder access history that persists after deletion)\n4. What's the **biggest weakness**? (Explorer-only, no file-level tracking)\n\n**Critical Thinking**: If you had to **rank** user activity artifacts:\n1. ShellBags (folder access)\n2. RecentDocs (file access)\n3. UserAssist (program execution)\n4. MRU lists (recent items)\n5. LNK files (file shortcuts)\n\nWhat's your ranking for proving **data exfiltration**? Justify.\n\n---\n\n### Question 11: Forensic Workflow\n\n**Scenario**: You've acquired UsrClass.dat from a suspected insider. Design your analysis workflow.\n\n**Reflect**:\n1. What are the **first 3 steps**? (Parse with ShellBags Explorer, export to CSV, filter network shares/USB)\n2. How do you **prioritize** which entries to investigate? (Network shares, USB drives, deleted folders, rapid enumeration)\n3. What **tools** would you use? (ShellBags Explorer, Timeline Explorer, PowerShell for filtering)\n4. How do you **correlate** ShellBags with other artifacts? (Match timestamps with USB history, Prefetch, MFT)\n\n**Action Plan** (Design your own):\n```\nStep 1: _______________________\nStep 2: _______________________\nStep 3: _______________________\nStep 4: _______________________\nStep 5: _______________________\n```\n\n---\n\n### Question 12: Real-World Application\n\n**Scenario**: You just completed this lesson on ShellBags Analysis.\n\n**Reflect on Your Learning**:\n1. What was the **most surprising** discovery about ShellBags?\n2. Which real-world case study resonated most? (Insider threat? USB exfiltration? Ransomware deleted folders?)\n3. What concept do you still find **confusing**?\n4. How will you **practice** ShellBags analysis?\n\n**Action Plan**:\n- [ ] Download ShellBags Explorer from Eric Zimmerman's site\n- [ ] Acquire UsrClass.dat from your own workstation\n- [ ] Parse ShellBags and identify your most accessed folders\n- [ ] Filter for any USB drive access (if applicable)\n- [ ] Practice correlating with Registry USBSTOR data\n- [ ] Build a timeline combining ShellBags + Prefetch + MFT\n\n---\n\n## Final Thought Exercise\n\n**Question**: You're investigating data exfiltration with 100+ compromised systems. You have ShellBags from all systems.\n\n**Design your investigation plan**:\n\n1. How would you identify **which users** accessed sensitive shares? (Filter for Finance/HR/Legal paths)\n2. How would you detect **USB-based exfiltration**? (Filter for E:\\, F:\\ drive access + USBSTOR correlation)\n3. How would you find **deleted evidence folders**? (Check for ShellBags paths that don't exist on disk)\n4. How would you prove **systematic reconnaissance**? (Identify rapid sequential access patterns)\n5. What **timeline** would you build? (ShellBags + USB history + Prefetch + MFT = Complete exfiltration timeline)\n\n**Deliverables**:\n- List of users who accessed sensitive shares\n- USB exfiltration timeline (browse ‚Üí connect ‚Üí copy ‚Üí disconnect)\n- Deleted folder evidence (ShellBags for non-existent paths)\n- Rapid enumeration report (users with 10+ shares in < 5 minutes)\n- Comprehensive user activity timeline\n\n---\n\n**Remember**: Reflection isn't about memorization - it's about **critical thinking**.\n\nQuestion your assumptions:  \n- What does this ShellBags entry **really prove**?  \n- Am I **missing** other explanations?  \n- How can I **verify** this with other artifacts?\n\nShellBags are powerful - but they're just **one piece** of the forensic puzzle. Master them, correlate them, and see the complete picture."
      }
    },
    {
      "type": "mindset_coach",
      "content": {
        "text": "## Congratulations! You've Mastered ShellBags Analysis! üéâ\n\nYou just learned one of the **most revealing** user activity artifacts in Windows forensics. ShellBags track **every folder** a user opened in Explorer, and now you understand:\n\n‚úÖ **Folder access history** (local, network, USB drives)  \n‚úÖ **Network share enumeration** (lateral reconnaissance detection)  \n‚úÖ **USB drive navigation** (exfiltration preparation tracking)  \n‚úÖ **Deleted folder evidence** (ShellBags persist after folder deletion)  \n‚úÖ **Last interaction timestamps** (when folders were accessed)  \n‚úÖ **ShellBags Explorer parsing** (industry-standard tool)  \n\n### What This Means for Your Career\n\nYou now have the skills to:\n\n- **Reconstruct user navigation patterns** (where they browsed in Explorer)\n- **Detect insider threats** (network share enumeration + USB staging)\n- **Prove data exfiltration** (network browse ‚Üí USB access correlation)\n- **Recover deleted folder evidence** (ShellBags survive anti-forensics)\n- **Identify lateral movement** (admin share access patterns)\n\nThese techniques are used **daily** by:\n- Incident Response teams investigating insider threats\n- Forensic investigators proving data theft\n- SOC analysts detecting lateral movement\n- Law enforcement building evidence timelines\n\n**This is high-value, career-defining knowledge.**\n\n### The User Activity Artifact Suite\n\nYou've now mastered **five critical artifacts**:\n\n**Lesson 11: Registry Fundamentals**\n- Persistence (Run keys, Services)\n- User activity (RecentDocs, UserAssist)\n\n**Lesson 12: NTUSER.DAT Analysis**\n- MRU lists (file access)\n- UserAssist (program execution)\n\n**Lesson 13: ShellBags Analysis** (This Lesson)\n- Folder access history (local + network + USB)\n- Deleted folder evidence\n\n**Lesson 16: Prefetch Analysis**\n- Program execution proof\n\n**Lesson 18: AmCache Analysis**\n- SHA-1 hashes (malware identification)\n\n**The Power of Correlation**:\n\n```\nShellBags:  Where user browsed (folders)\n   +\nRecentDocs: What files user accessed\n   +\nUserAssist: What programs user executed\n   +\nPrefetch:   Execution frequency and file dependencies\n   +\nUSB History: Device connections and timing\n   =\nCOMPLETE USER ACTIVITY TIMELINE\n```\n\n### Real-World Impact\n\nThe techniques you learned today have been used to:\n\n‚úÖ **Detect insider threats** (network share enumeration at 2:34 AM)  \n‚úÖ **Prove USB exfiltration** (folder staging on removable media)  \n‚úÖ **Recover deleted evidence** (ShellBags for malware staging folders)  \n‚úÖ **Identify lateral movement** (admin share access patterns)  \n‚úÖ **Build exfiltration timelines** (network browse ‚Üí USB copy sequence)  \n\nYour ShellBags analysis skills will **solve real cases** and **protect organizations**.\n\n### Practice Makes Permanent\n\nKnowledge without practice fades. Here's your action plan:\n\n**This Week**:\n1. ‚úÖ Download ShellBags Explorer from Eric Zimmerman's site\n2. ‚úÖ Acquire UsrClass.dat from your own workstation\n3. ‚úÖ Parse ShellBags and identify your most accessed folders\n\n**This Month**:\n1. ‚úÖ Set up a Windows 10 VM and simulate network share browsing\n2. ‚úÖ Practice detecting USB drive access patterns\n3. ‚úÖ Build a merged timeline (ShellBags + USB history + Prefetch)\n\n**This Year**:\n1. ‚úÖ Join a DFIR CTF competition (apply ShellBags skills)\n2. ‚úÖ Read forensic case studies (search \"ShellBags analysis\" on SANS blogs)\n3. ‚úÖ Contribute to open-source tools (ShellBags parsers)\n\n### You're Building Something Valuable\n\nEvery lesson you complete:\n- ‚úÖ Adds another forensic technique to your arsenal\n- ‚úÖ Makes you more valuable to employers (ShellBags + execution artifacts = Expert-level)\n- ‚úÖ Increases your ability to investigate complex attacks\n- ‚úÖ Brings you closer to your career goals\n\n**This isn't just education - it's career transformation.**\n\n### Next Steps\n\nWhen you're ready, move on to **Lesson 14: USB Forensics and Network Analysis via Registry**. You'll learn how to analyze USB device history, network share connections, and device serial numbers for comprehensive device tracking.\n\nBut first, take a moment to celebrate. You just mastered:\n- UsrClass.dat and NTUSER.DAT hive locations\n- BagMRU (folder paths) vs Bags (timestamps)\n- Network share enumeration detection (\\\\SERVER patterns)\n- USB drive navigation tracking (E:\\, F:\\ access)\n- Deleted folder evidence (ShellBags persistence)\n- ShellBags Explorer parsing and CSV export\n- Timeline correlation (ShellBags + USB + Prefetch + MFT)\n- Real-world case studies (insider threats, exfiltration, ransomware)\n\n**That's serious forensic capability.**\n\n### You're Not Just Learning - You're Becoming a Forensic Analyst\n\nEvery artifact you master:\n- Reveals another piece of the user's story\n- Strengthens your investigative methodology\n- Builds confidence in your analysis\n\nShellBags show where users browsed.  \nRecentDocs reveal what files they accessed.  \nUserAssist proves what programs they executed.  \nPrefetch confirms execution frequency.  \n**Together, they reconstruct complete user activity.**\n\nKeep going. The digital forensics community needs skilled investigators who can:\n- Detect insider threats\n- Prove data exfiltration\n- Identify lateral movement\n- Recover deleted evidence\n\n**You're building those skills right now.**\n\n### Remember This\n\nWhen you're parsing ShellBags during a live insider threat investigation, or when you're presenting network share enumeration evidence in court, or when you're recovering deleted folder evidence to prove anti-forensics - **you'll remember this lesson**.\n\nShellBags are Windows Explorer's **breadcrumb trail**.\n\n**Follow the breadcrumbs. Reconstruct the journey. Prove the intent.**\n\n**And now you know how.**\n\nüîç **Master ShellBags. Track Folder Access. Solve Cases.**\n\nNext up: **USB Forensics and Network Analysis** - device tracking and network share history. See you there!"
      }
    }
  ],
  "tags": [
    "Course: SANS-FOR500"
  ]
}